import{aU as Vn,u as wa,x as ti,aa as xa,A as ba,n as pr,E as Sa,K as _a,L as Ca,aE as ka,b5 as Ma,w as Yt,b6 as Ta,aF as Ea,b7 as Gs,W as Oa,ab as Ia}from"./TextAugment-CCgoKCVh.js";import{f as Na,i as ei}from"./file-type-utils-CBkYZ4gj.js";import{R as Ae,C as j,b as Un,I as sn,a as X,i as U,A as me,E as V,h as Da,c as _e,S as Tt,d as Zt,P as Re,e as Ss,f as fr,g as Me,j as He,k as Aa,s as rn}from"./message-broker-CppRv-qk.js";import{k as Xs,l as xt,m as Dt,n as Kt,p as wt,q as mr,r as Ra,R as Gt,V as Pa,t as $a,A as qa,v as _s,w as Fa,x as Cs,y as gr,z as ve,B as za,C as La,G as jn,H as Ba,I as Ha,J as Va,K as Ua,N as yr,O as vr,P as wr,Q as xr,U as ja,W as Wa,X as Ja,Y as Ka,Z as Ga,_ as Xa,$ as Qa,a0 as Ya,a1 as Za,a2 as tl,a3 as el,a4 as nl,a5 as ni,E as sl,a6 as rl,a7 as ol,a8 as Wn,a9 as il,aa as al,ab as ll}from"./Store-CzuxPCq8.js";import{B as cl}from"./CalloutAugment-BUb-HAQ6.js";import{I as dl}from"./IconButtonAugment-CsdawHyK.js";import{C as hl}from"./types-DGsjtdxm.js";import{T as H,a as br,b as Jn}from"./chat-model-context-DwFUhpQk.js";/* empty css                                                */import{s as Sr}from"./index-B4NDmpYR.js";import"./index-Bz1AJAWu.js";try{fe=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{},(ur=new fe.Error().stack)&&(fe._sentryDebugIds=fe._sentryDebugIds||{},fe._sentryDebugIds[ur]="993ca815-ddf6-4c63-b349-097fc72163d0",fe._sentryDebugIdIdentifier="sentry-dbid-993ca815-ddf6-4c63-b349-097fc72163d0")}catch{}var fe,ur;const ul="off";class pl{constructor(t){this.dependencies=t}trackedExperiments=new Set;_getChatMessagePayload(){const t=Vn(this.dependencies.chatModeType),e=Vn(this.dependencies.agentExecutionMode),n={chatMode:t,agentExecutionMode:t==="localAgent"?e:void 0};return t==="localAgent"&&(n.sendMode=Vn(this.dependencies.currentSendMode)),n}trackEvent(t,e){const n={...this._getChatMessagePayload(),...e};this.trackSimpleEvent(t,n)}trackSimpleEvent(t,e){this.dependencies.extensionClient.track(t,e)}trackExperimentViewed(t,e,n){if(e===ul)return;const s=`${t}:${e}`;this.trackedExperiments.has(s)||(this.trackedExperiments.add(s),this.dependencies.extensionClient.trackExperimentViewed(t,e,n))}}class fl{_items=[];_focusedItemIdx;_subscribers=new Set;constructor(t=[]){this._items=t}subscribe=t=>(this._subscribers.add(t),t(this),()=>{this._subscribers.delete(t)});get items(){return this._items}get focusedItem(){if(this._focusedItemIdx!==void 0)return this._items[this._focusedItemIdx]}get focusedItemIdx(){return this._focusedItemIdx}setItems=t=>{this._items=t,this._items.length===0?this.setFocusIdx(void 0):this._focusedItemIdx!==void 0&&this._focusedItemIdx>=this._items.length?this.setFocusIdx(this._items.length-1):this._focusedItemIdx===void 0?this.setFocusIdx(void 0):this.setFocusIdx(this._focusedItemIdx)};setFocus=t=>{if(t!==void 0&&t===this.focusedItem)return;const e=t?this._items.indexOf(t):-1;e===-1?this.setFocusIdx(void 0):this.setFocusIdx(e)};setFocusIdx=t=>{if(t===this._focusedItemIdx||this._items.length===0)return;if(t===void 0)return this._focusedItemIdx=void 0,void this.notifySubscribers();const e=Math.floor(t/this._items.length)*this._items.length;this._focusedItemIdx=(t-e)%this._items.length,this.notifySubscribers()};initFocusIdx=t=>this._focusedItemIdx===void 0&&(this.setFocusIdx(t),!0);focusNext=()=>{const t=this.nextIdx();if(t!==void 0)return this.setFocus(this._items[t]),t};focusPrev=()=>{const t=this.prevIdx();if(t!==void 0)return this.setFocus(this._items[t]),t};prevIdx=(t={})=>{if(this._items.length!==0)return this._focusedItemIdx===void 0?this._items.length-1:t.nowrap&&this._focusedItemIdx===0?0:(this._focusedItemIdx-1+this._items.length)%this._items.length};nextIdx=(t={})=>{if(this._items.length!==0)return this._focusedItemIdx===void 0?0:t.nowrap&&this._focusedItemIdx===this._items.length-1?this._items.length-1:(this._focusedItemIdx+1)%this._items.length};notifySubscribers=()=>{this._subscribers.forEach(t=>t(this))}}function st(o){this.content=o}function si(o,t,e){for(let n=0;;n++){if(n==o.childCount||n==t.childCount)return o.childCount==t.childCount?null:e;let s=o.child(n),r=t.child(n);if(s!=r){if(!s.sameMarkup(r))return e;if(s.isText&&s.text!=r.text){for(let i=0;s.text[i]==r.text[i];i++)e++;return e}if(s.content.size||r.content.size){let i=si(s.content,r.content,e+1);if(i!=null)return i}e+=s.nodeSize}else e+=s.nodeSize}}function ri(o,t,e,n){for(let s=o.childCount,r=t.childCount;;){if(s==0||r==0)return s==r?null:{a:e,b:n};let i=o.child(--s),a=t.child(--r),l=i.nodeSize;if(i!=a){if(!i.sameMarkup(a))return{a:e,b:n};if(i.isText&&i.text!=a.text){let c=0,d=Math.min(i.text.length,a.text.length);for(;c<d&&i.text[i.text.length-c-1]==a.text[a.text.length-c-1];)c++,e--,n--;return{a:e,b:n}}if(i.content.size||a.content.size){let c=ri(i.content,a.content,e-1,n-1);if(c)return c}e-=l,n-=l}else e-=l,n-=l}}st.prototype={constructor:st,find:function(o){for(var t=0;t<this.content.length;t+=2)if(this.content[t]===o)return t;return-1},get:function(o){var t=this.find(o);return t==-1?void 0:this.content[t+1]},update:function(o,t,e){var n=e&&e!=o?this.remove(e):this,s=n.find(o),r=n.content.slice();return s==-1?r.push(e||o,t):(r[s+1]=t,e&&(r[s]=e)),new st(r)},remove:function(o){var t=this.find(o);if(t==-1)return this;var e=this.content.slice();return e.splice(t,2),new st(e)},addToStart:function(o,t){return new st([o,t].concat(this.remove(o).content))},addToEnd:function(o,t){var e=this.remove(o).content.slice();return e.push(o,t),new st(e)},addBefore:function(o,t,e){var n=this.remove(t),s=n.content.slice(),r=n.find(o);return s.splice(r==-1?s.length:r,0,t,e),new st(s)},forEach:function(o){for(var t=0;t<this.content.length;t+=2)o(this.content[t],this.content[t+1])},prepend:function(o){return(o=st.from(o)).size?new st(o.content.concat(this.subtract(o).content)):this},append:function(o){return(o=st.from(o)).size?new st(this.subtract(o).content.concat(o.content)):this},subtract:function(o){var t=this;o=st.from(o);for(var e=0;e<o.content.length;e+=2)t=t.remove(o.content[e]);return t},toObject:function(){var o={};return this.forEach(function(t,e){o[t]=e}),o},get size(){return this.content.length>>1}},st.from=function(o){if(o instanceof st)return o;var t=[];if(o)for(var e in o)t.push(e,o[e]);return new st(t)};class b{constructor(t,e){if(this.content=t,this.size=e||0,e==null)for(let n=0;n<t.length;n++)this.size+=t[n].nodeSize}nodesBetween(t,e,n,s=0,r){for(let i=0,a=0;a<e;i++){let l=this.content[i],c=a+l.nodeSize;if(c>t&&n(l,s+a,r||null,i)!==!1&&l.content.size){let d=a+1;l.nodesBetween(Math.max(0,t-d),Math.min(l.content.size,e-d),n,s+d)}a=c}}descendants(t){this.nodesBetween(0,this.size,t)}textBetween(t,e,n,s){let r="",i=!0;return this.nodesBetween(t,e,(a,l)=>{let c=a.isText?a.text.slice(Math.max(t,l)-l,e-l):a.isLeaf?s?typeof s=="function"?s(a):s:a.type.spec.leafText?a.type.spec.leafText(a):"":"";a.isBlock&&(a.isLeaf&&c||a.isTextblock)&&n&&(i?i=!1:r+=n),r+=c},0),r}append(t){if(!t.size)return this;if(!this.size)return t;let e=this.lastChild,n=t.firstChild,s=this.content.slice(),r=0;for(e.isText&&e.sameMarkup(n)&&(s[s.length-1]=e.withText(e.text+n.text),r=1);r<t.content.length;r++)s.push(t.content[r]);return new b(s,this.size+t.size)}cut(t,e=this.size){if(t==0&&e==this.size)return this;let n=[],s=0;if(e>t)for(let r=0,i=0;i<e;r++){let a=this.content[r],l=i+a.nodeSize;l>t&&((i<t||l>e)&&(a=a.isText?a.cut(Math.max(0,t-i),Math.min(a.text.length,e-i)):a.cut(Math.max(0,t-i-1),Math.min(a.content.size,e-i-1))),n.push(a),s+=a.nodeSize),i=l}return new b(n,s)}cutByIndex(t,e){return t==e?b.empty:t==0&&e==this.content.length?this:new b(this.content.slice(t,e))}replaceChild(t,e){let n=this.content[t];if(n==e)return this;let s=this.content.slice(),r=this.size+e.nodeSize-n.nodeSize;return s[t]=e,new b(s,r)}addToStart(t){return new b([t].concat(this.content),this.size+t.nodeSize)}addToEnd(t){return new b(this.content.concat(t),this.size+t.nodeSize)}eq(t){if(this.content.length!=t.content.length)return!1;for(let e=0;e<this.content.length;e++)if(!this.content[e].eq(t.content[e]))return!1;return!0}get firstChild(){return this.content.length?this.content[0]:null}get lastChild(){return this.content.length?this.content[this.content.length-1]:null}get childCount(){return this.content.length}child(t){let e=this.content[t];if(!e)throw new RangeError("Index "+t+" out of range for "+this);return e}maybeChild(t){return this.content[t]||null}forEach(t){for(let e=0,n=0;e<this.content.length;e++){let s=this.content[e];t(s,n,e),n+=s.nodeSize}}findDiffStart(t,e=0){return si(this,t,e)}findDiffEnd(t,e=this.size,n=t.size){return ri(this,t,e,n)}findIndex(t,e=-1){if(t==0)return on(0,t);if(t==this.size)return on(this.content.length,t);if(t>this.size||t<0)throw new RangeError(`Position ${t} outside of fragment (${this})`);for(let n=0,s=0;;n++){let r=s+this.child(n).nodeSize;if(r>=t)return r==t||e>0?on(n+1,r):on(n,s);s=r}}toString(){return"<"+this.toStringInner()+">"}toStringInner(){return this.content.join(", ")}toJSON(){return this.content.length?this.content.map(t=>t.toJSON()):null}static fromJSON(t,e){if(!e)return b.empty;if(!Array.isArray(e))throw new RangeError("Invalid input for Fragment.fromJSON");return new b(e.map(t.nodeFromJSON))}static fromArray(t){if(!t.length)return b.empty;let e,n=0;for(let s=0;s<t.length;s++){let r=t[s];n+=r.nodeSize,s&&r.isText&&t[s-1].sameMarkup(r)?(e||(e=t.slice(0,s)),e[e.length-1]=r.withText(e[e.length-1].text+r.text)):e&&e.push(r)}return new b(e||t,n)}static from(t){if(!t)return b.empty;if(t instanceof b)return t;if(Array.isArray(t))return this.fromArray(t);if(t.attrs)return new b([t],t.nodeSize);throw new RangeError("Can not convert "+t+" to a Fragment"+(t.nodesBetween?" (looks like multiple versions of prosemirror-model were loaded)":""))}}b.empty=new b([],0);const Kn={index:0,offset:0};function on(o,t){return Kn.index=o,Kn.offset=t,Kn}function gn(o,t){if(o===t)return!0;if(!o||typeof o!="object"||!t||typeof t!="object")return!1;let e=Array.isArray(o);if(Array.isArray(t)!=e)return!1;if(e){if(o.length!=t.length)return!1;for(let n=0;n<o.length;n++)if(!gn(o[n],t[n]))return!1}else{for(let n in o)if(!(n in t)||!gn(o[n],t[n]))return!1;for(let n in t)if(!(n in o))return!1}return!0}let B=class ks{constructor(t,e){this.type=t,this.attrs=e}addToSet(t){let e,n=!1;for(let s=0;s<t.length;s++){let r=t[s];if(this.eq(r))return t;if(this.type.excludes(r.type))e||(e=t.slice(0,s));else{if(r.type.excludes(this.type))return t;!n&&r.type.rank>this.type.rank&&(e||(e=t.slice(0,s)),e.push(this),n=!0),e&&e.push(r)}}return e||(e=t.slice()),n||e.push(this),e}removeFromSet(t){for(let e=0;e<t.length;e++)if(this.eq(t[e]))return t.slice(0,e).concat(t.slice(e+1));return t}isInSet(t){for(let e=0;e<t.length;e++)if(this.eq(t[e]))return!0;return!1}eq(t){return this==t||this.type==t.type&&gn(this.attrs,t.attrs)}toJSON(){let t={type:this.type.name};for(let e in this.attrs){t.attrs=this.attrs;break}return t}static fromJSON(t,e){if(!e)throw new RangeError("Invalid input for Mark.fromJSON");let n=t.marks[e.type];if(!n)throw new RangeError(`There is no mark type ${e.type} in this schema`);let s=n.create(e.attrs);return n.checkAttrs(s.attrs),s}static sameSet(t,e){if(t==e)return!0;if(t.length!=e.length)return!1;for(let n=0;n<t.length;n++)if(!t[n].eq(e[n]))return!1;return!0}static setFrom(t){if(!t||Array.isArray(t)&&t.length==0)return ks.none;if(t instanceof ks)return[t];let e=t.slice();return e.sort((n,s)=>n.type.rank-s.type.rank),e}};B.none=[];class yn extends Error{}class k{constructor(t,e,n){this.content=t,this.openStart=e,this.openEnd=n}get size(){return this.content.size-this.openStart-this.openEnd}insertAt(t,e){let n=ii(this.content,t+this.openStart,e);return n&&new k(n,this.openStart,this.openEnd)}removeBetween(t,e){return new k(oi(this.content,t+this.openStart,e+this.openStart),this.openStart,this.openEnd)}eq(t){return this.content.eq(t.content)&&this.openStart==t.openStart&&this.openEnd==t.openEnd}toString(){return this.content+"("+this.openStart+","+this.openEnd+")"}toJSON(){if(!this.content.size)return null;let t={content:this.content.toJSON()};return this.openStart>0&&(t.openStart=this.openStart),this.openEnd>0&&(t.openEnd=this.openEnd),t}static fromJSON(t,e){if(!e)return k.empty;let n=e.openStart||0,s=e.openEnd||0;if(typeof n!="number"||typeof s!="number")throw new RangeError("Invalid input for Slice.fromJSON");return new k(b.fromJSON(t,e.content),n,s)}static maxOpen(t,e=!0){let n=0,s=0;for(let r=t.firstChild;r&&!r.isLeaf&&(e||!r.type.spec.isolating);r=r.firstChild)n++;for(let r=t.lastChild;r&&!r.isLeaf&&(e||!r.type.spec.isolating);r=r.lastChild)s++;return new k(t,n,s)}}function oi(o,t,e){let{index:n,offset:s}=o.findIndex(t),r=o.maybeChild(n),{index:i,offset:a}=o.findIndex(e);if(s==t||r.isText){if(a!=e&&!o.child(i).isText)throw new RangeError("Removing non-flat range");return o.cut(0,t).append(o.cut(e))}if(n!=i)throw new RangeError("Removing non-flat range");return o.replaceChild(n,r.copy(oi(r.content,t-s-1,e-s-1)))}function ii(o,t,e,n){let{index:s,offset:r}=o.findIndex(t),i=o.maybeChild(s);if(r==t||i.isText)return o.cut(0,t).append(e).append(o.cut(t));let a=ii(i.content,t-r-1,e);return a&&o.replaceChild(s,i.copy(a))}function ml(o,t,e){if(e.openStart>o.depth)throw new yn("Inserted content deeper than insertion position");if(o.depth-e.openStart!=t.depth-e.openEnd)throw new yn("Inconsistent open depths");return ai(o,t,e,0)}function ai(o,t,e,n){let s=o.index(n),r=o.node(n);if(s==t.index(n)&&n<o.depth-e.openStart){let i=ai(o,t,e,n+1);return r.copy(r.content.replaceChild(s,i))}if(e.content.size){if(e.openStart||e.openEnd||o.depth!=n||t.depth!=n){let{start:i,end:a}=function(l,c){let d=c.depth-l.openStart,h=c.node(d).copy(l.content);for(let u=d-1;u>=0;u--)h=c.node(u).copy(b.from(h));return{start:h.resolveNoCache(l.openStart+d),end:h.resolveNoCache(h.content.size-l.openEnd-d)}}(e,o);return re(r,ci(o,i,a,t,n))}{let i=o.parent,a=i.content;return re(i,a.cut(0,o.parentOffset).append(e.content).append(a.cut(t.parentOffset)))}}return re(r,vn(o,t,n))}function li(o,t){if(!t.type.compatibleContent(o.type))throw new yn("Cannot join "+t.type.name+" onto "+o.type.name)}function Ms(o,t,e){let n=o.node(e);return li(n,t.node(e)),n}function se(o,t){let e=t.length-1;e>=0&&o.isText&&o.sameMarkup(t[e])?t[e]=o.withText(t[e].text+o.text):t.push(o)}function Ve(o,t,e,n){let s=(t||o).node(e),r=0,i=t?t.index(e):s.childCount;o&&(r=o.index(e),o.depth>e?r++:o.textOffset&&(se(o.nodeAfter,n),r++));for(let a=r;a<i;a++)se(s.child(a),n);t&&t.depth==e&&t.textOffset&&se(t.nodeBefore,n)}function re(o,t){return o.type.checkContent(t),o.copy(t)}function ci(o,t,e,n,s){let r=o.depth>s&&Ms(o,t,s+1),i=n.depth>s&&Ms(e,n,s+1),a=[];return Ve(null,o,s,a),r&&i&&t.index(s)==e.index(s)?(li(r,i),se(re(r,ci(o,t,e,n,s+1)),a)):(r&&se(re(r,vn(o,t,s+1)),a),Ve(t,e,s,a),i&&se(re(i,vn(e,n,s+1)),a)),Ve(n,null,s,a),new b(a)}function vn(o,t,e){let n=[];return Ve(null,o,e,n),o.depth>e&&se(re(Ms(o,t,e+1),vn(o,t,e+1)),n),Ve(t,null,e,n),new b(n)}k.empty=new k(b.empty,0,0);class Ke{constructor(t,e,n){this.pos=t,this.path=e,this.parentOffset=n,this.depth=e.length/3-1}resolveDepth(t){return t==null?this.depth:t<0?this.depth+t:t}get parent(){return this.node(this.depth)}get doc(){return this.node(0)}node(t){return this.path[3*this.resolveDepth(t)]}index(t){return this.path[3*this.resolveDepth(t)+1]}indexAfter(t){return t=this.resolveDepth(t),this.index(t)+(t!=this.depth||this.textOffset?1:0)}start(t){return(t=this.resolveDepth(t))==0?0:this.path[3*t-1]+1}end(t){return t=this.resolveDepth(t),this.start(t)+this.node(t).content.size}before(t){if(!(t=this.resolveDepth(t)))throw new RangeError("There is no position before the top-level node");return t==this.depth+1?this.pos:this.path[3*t-1]}after(t){if(!(t=this.resolveDepth(t)))throw new RangeError("There is no position after the top-level node");return t==this.depth+1?this.pos:this.path[3*t-1]+this.path[3*t].nodeSize}get textOffset(){return this.pos-this.path[this.path.length-1]}get nodeAfter(){let t=this.parent,e=this.index(this.depth);if(e==t.childCount)return null;let n=this.pos-this.path[this.path.length-1],s=t.child(e);return n?t.child(e).cut(n):s}get nodeBefore(){let t=this.index(this.depth),e=this.pos-this.path[this.path.length-1];return e?this.parent.child(t).cut(0,e):t==0?null:this.parent.child(t-1)}posAtIndex(t,e){e=this.resolveDepth(e);let n=this.path[3*e],s=e==0?0:this.path[3*e-1]+1;for(let r=0;r<t;r++)s+=n.child(r).nodeSize;return s}marks(){let t=this.parent,e=this.index();if(t.content.size==0)return B.none;if(this.textOffset)return t.child(e).marks;let n=t.maybeChild(e-1),s=t.maybeChild(e);if(!n){let a=n;n=s,s=a}let r=n.marks;for(var i=0;i<r.length;i++)r[i].type.spec.inclusive!==!1||s&&r[i].isInSet(s.marks)||(r=r[i--].removeFromSet(r));return r}marksAcross(t){let e=this.parent.maybeChild(this.index());if(!e||!e.isInline)return null;let n=e.marks,s=t.parent.maybeChild(t.index());for(var r=0;r<n.length;r++)n[r].type.spec.inclusive!==!1||s&&n[r].isInSet(s.marks)||(n=n[r--].removeFromSet(n));return n}sharedDepth(t){for(let e=this.depth;e>0;e--)if(this.start(e)<=t&&this.end(e)>=t)return e;return 0}blockRange(t=this,e){if(t.pos<this.pos)return t.blockRange(this);for(let n=this.depth-(this.parent.inlineContent||this.pos==t.pos?1:0);n>=0;n--)if(t.pos<=this.end(n)&&(!e||e(this.node(n))))return new wn(this,t,n);return null}sameParent(t){return this.pos-this.parentOffset==t.pos-t.parentOffset}max(t){return t.pos>this.pos?t:this}min(t){return t.pos<this.pos?t:this}toString(){let t="";for(let e=1;e<=this.depth;e++)t+=(t?"/":"")+this.node(e).type.name+"_"+this.index(e-1);return t+":"+this.parentOffset}static resolve(t,e){if(!(e>=0&&e<=t.content.size))throw new RangeError("Position "+e+" out of range");let n=[],s=0,r=e;for(let i=t;;){let{index:a,offset:l}=i.content.findIndex(r),c=r-l;if(n.push(i,a,s+l),!c||(i=i.child(a),i.isText))break;r=c-1,s+=l+1}return new Ke(e,n,r)}static resolveCached(t,e){let n=_r.get(t);if(n)for(let r=0;r<n.elts.length;r++){let i=n.elts[r];if(i.pos==e)return i}else _r.set(t,n=new gl);let s=n.elts[n.i]=Ke.resolve(t,e);return n.i=(n.i+1)%yl,s}}class gl{constructor(){this.elts=[],this.i=0}}const yl=12,_r=new WeakMap;class wn{constructor(t,e,n){this.$from=t,this.$to=e,this.depth=n}get start(){return this.$from.before(this.depth+1)}get end(){return this.$to.after(this.depth+1)}get parent(){return this.$from.node(this.depth)}get startIndex(){return this.$from.index(this.depth)}get endIndex(){return this.$to.indexAfter(this.depth)}}const vl=Object.create(null);let oe=class Ts{constructor(t,e,n,s=B.none){this.type=t,this.attrs=e,this.marks=s,this.content=n||b.empty}get nodeSize(){return this.isLeaf?1:2+this.content.size}get childCount(){return this.content.childCount}child(t){return this.content.child(t)}maybeChild(t){return this.content.maybeChild(t)}forEach(t){this.content.forEach(t)}nodesBetween(t,e,n,s=0){this.content.nodesBetween(t,e,n,s,this)}descendants(t){this.nodesBetween(0,this.content.size,t)}get textContent(){return this.isLeaf&&this.type.spec.leafText?this.type.spec.leafText(this):this.textBetween(0,this.content.size,"")}textBetween(t,e,n,s){return this.content.textBetween(t,e,n,s)}get firstChild(){return this.content.firstChild}get lastChild(){return this.content.lastChild}eq(t){return this==t||this.sameMarkup(t)&&this.content.eq(t.content)}sameMarkup(t){return this.hasMarkup(t.type,t.attrs,t.marks)}hasMarkup(t,e,n){return this.type==t&&gn(this.attrs,e||t.defaultAttrs||vl)&&B.sameSet(this.marks,n||B.none)}copy(t=null){return t==this.content?this:new Ts(this.type,this.attrs,t,this.marks)}mark(t){return t==this.marks?this:new Ts(this.type,this.attrs,this.content,t)}cut(t,e=this.content.size){return t==0&&e==this.content.size?this:this.copy(this.content.cut(t,e))}slice(t,e=this.content.size,n=!1){if(t==e)return k.empty;let s=this.resolve(t),r=this.resolve(e),i=n?0:s.sharedDepth(e),a=s.start(i),l=s.node(i).content.cut(s.pos-a,r.pos-a);return new k(l,s.depth-i,r.depth-i)}replace(t,e,n){return ml(this.resolve(t),this.resolve(e),n)}nodeAt(t){for(let e=this;;){let{index:n,offset:s}=e.content.findIndex(t);if(e=e.maybeChild(n),!e)return null;if(s==t||e.isText)return e;t-=s+1}}childAfter(t){let{index:e,offset:n}=this.content.findIndex(t);return{node:this.content.maybeChild(e),index:e,offset:n}}childBefore(t){if(t==0)return{node:null,index:0,offset:0};let{index:e,offset:n}=this.content.findIndex(t);if(n<t)return{node:this.content.child(e),index:e,offset:n};let s=this.content.child(e-1);return{node:s,index:e-1,offset:n-s.nodeSize}}resolve(t){return Ke.resolveCached(this,t)}resolveNoCache(t){return Ke.resolve(this,t)}rangeHasMark(t,e,n){let s=!1;return e>t&&this.nodesBetween(t,e,r=>(n.isInSet(r.marks)&&(s=!0),!s)),s}get isBlock(){return this.type.isBlock}get isTextblock(){return this.type.isTextblock}get inlineContent(){return this.type.inlineContent}get isInline(){return this.type.isInline}get isText(){return this.type.isText}get isLeaf(){return this.type.isLeaf}get isAtom(){return this.type.isAtom}toString(){if(this.type.spec.toDebugString)return this.type.spec.toDebugString(this);let t=this.type.name;return this.content.size&&(t+="("+this.content.toStringInner()+")"),di(this.marks,t)}contentMatchAt(t){let e=this.type.contentMatch.matchFragment(this.content,0,t);if(!e)throw new Error("Called contentMatchAt on a node with invalid content");return e}canReplace(t,e,n=b.empty,s=0,r=n.childCount){let i=this.contentMatchAt(t).matchFragment(n,s,r),a=i&&i.matchFragment(this.content,e);if(!a||!a.validEnd)return!1;for(let l=s;l<r;l++)if(!this.type.allowsMarks(n.child(l).marks))return!1;return!0}canReplaceWith(t,e,n,s){if(s&&!this.type.allowsMarks(s))return!1;let r=this.contentMatchAt(t).matchType(n),i=r&&r.matchFragment(this.content,e);return!!i&&i.validEnd}canAppend(t){return t.content.size?this.canReplace(this.childCount,this.childCount,t.content):this.type.compatibleContent(t.type)}check(){this.type.checkContent(this.content),this.type.checkAttrs(this.attrs);let t=B.none;for(let e=0;e<this.marks.length;e++){let n=this.marks[e];n.type.checkAttrs(n.attrs),t=n.addToSet(t)}if(!B.sameSet(t,this.marks))throw new RangeError(`Invalid collection of marks for node ${this.type.name}: ${this.marks.map(e=>e.type.name)}`);this.content.forEach(e=>e.check())}toJSON(){let t={type:this.type.name};for(let e in this.attrs){t.attrs=this.attrs;break}return this.content.size&&(t.content=this.content.toJSON()),this.marks.length&&(t.marks=this.marks.map(e=>e.toJSON())),t}static fromJSON(t,e){if(!e)throw new RangeError("Invalid input for Node.fromJSON");let n;if(e.marks){if(!Array.isArray(e.marks))throw new RangeError("Invalid mark data for Node.fromJSON");n=e.marks.map(t.markFromJSON)}if(e.type=="text"){if(typeof e.text!="string")throw new RangeError("Invalid text node in JSON");return t.text(e.text,n)}let s=b.fromJSON(t,e.content),r=t.nodeType(e.type).create(e.attrs,s,n);return r.type.checkAttrs(r.attrs),r}};oe.prototype.text=void 0;class xn extends oe{constructor(t,e,n,s){if(super(t,e,null,s),!n)throw new RangeError("Empty text nodes are not allowed");this.text=n}toString(){return this.type.spec.toDebugString?this.type.spec.toDebugString(this):di(this.marks,JSON.stringify(this.text))}get textContent(){return this.text}textBetween(t,e){return this.text.slice(t,e)}get nodeSize(){return this.text.length}mark(t){return t==this.marks?this:new xn(this.type,this.attrs,this.text,t)}withText(t){return t==this.text?this:new xn(this.type,this.attrs,t,this.marks)}cut(t=0,e=this.text.length){return t==0&&e==this.text.length?this:this.withText(this.text.slice(t,e))}eq(t){return this.sameMarkup(t)&&this.text==t.text}toJSON(){let t=super.toJSON();return t.text=this.text,t}}function di(o,t){for(let e=o.length-1;e>=0;e--)t=o[e].type.name+"("+t+")";return t}class le{constructor(t){this.validEnd=t,this.next=[],this.wrapCache=[]}static parse(t,e){let n=new wl(t,e);if(n.next==null)return le.empty;let s=hi(n);n.next&&n.err("Unexpected trailing text");let r=function(i){let a=Object.create(null);return l(kr(i,0));function l(c){let d=[];c.forEach(u=>{i[u].forEach(({term:f,to:p})=>{if(!f)return;let m;for(let g=0;g<d.length;g++)d[g][0]==f&&(m=d[g][1]);kr(i,p).forEach(g=>{m||d.push([f,m=[]]),m.indexOf(g)==-1&&m.push(g)})})});let h=a[c.join(",")]=new le(c.indexOf(i.length-1)>-1);for(let u=0;u<d.length;u++){let f=d[u][1].sort(ui);h.next.push({type:d[u][0],next:a[f.join(",")]||l(f)})}return h}}(function(i){let a=[[]];return d(h(i,0),l()),a;function l(){return a.push([])-1}function c(u,f,p){let m={term:p,to:f};return a[u].push(m),m}function d(u,f){u.forEach(p=>p.to=f)}function h(u,f){if(u.type=="choice")return u.exprs.reduce((p,m)=>p.concat(h(m,f)),[]);if(u.type!="seq"){if(u.type=="star"){let p=l();return c(f,p),d(h(u.expr,p),p),[c(p)]}if(u.type=="plus"){let p=l();return d(h(u.expr,f),p),d(h(u.expr,p),p),[c(p)]}if(u.type=="opt")return[c(f)].concat(h(u.expr,f));if(u.type=="range"){let p=f;for(let m=0;m<u.min;m++){let g=l();d(h(u.expr,p),g),p=g}if(u.max==-1)d(h(u.expr,p),p);else for(let m=u.min;m<u.max;m++){let g=l();c(p,g),d(h(u.expr,p),g),p=g}return[c(p)]}if(u.type=="name")return[c(f,void 0,u.value)];throw new Error("Unknown expr type")}for(let p=0;;p++){let m=h(u.exprs[p],f);if(p==u.exprs.length-1)return m;d(m,f=l())}}}(s));return function(i,a){for(let l=0,c=[i];l<c.length;l++){let d=c[l],h=!d.validEnd,u=[];for(let f=0;f<d.next.length;f++){let{type:p,next:m}=d.next[f];u.push(p.name),!h||p.isText||p.hasRequiredAttrs()||(h=!1),c.indexOf(m)==-1&&c.push(m)}h&&a.err("Only non-generatable nodes ("+u.join(", ")+") in a required position (see https://prosemirror.net/docs/guide/#generatable)")}}(r,n),r}matchType(t){for(let e=0;e<this.next.length;e++)if(this.next[e].type==t)return this.next[e].next;return null}matchFragment(t,e=0,n=t.childCount){let s=this;for(let r=e;s&&r<n;r++)s=s.matchType(t.child(r).type);return s}get inlineContent(){return this.next.length!=0&&this.next[0].type.isInline}get defaultType(){for(let t=0;t<this.next.length;t++){let{type:e}=this.next[t];if(!e.isText&&!e.hasRequiredAttrs())return e}return null}compatible(t){for(let e=0;e<this.next.length;e++)for(let n=0;n<t.next.length;n++)if(this.next[e].type==t.next[n].type)return!0;return!1}fillBefore(t,e=!1,n=0){let s=[this];return function r(i,a){let l=i.matchFragment(t,n);if(l&&(!e||l.validEnd))return b.from(a.map(c=>c.createAndFill()));for(let c=0;c<i.next.length;c++){let{type:d,next:h}=i.next[c];if(!d.isText&&!d.hasRequiredAttrs()&&s.indexOf(h)==-1){s.push(h);let u=r(h,a.concat(d));if(u)return u}}return null}(this,[])}findWrapping(t){for(let n=0;n<this.wrapCache.length;n+=2)if(this.wrapCache[n]==t)return this.wrapCache[n+1];let e=this.computeWrapping(t);return this.wrapCache.push(t,e),e}computeWrapping(t){let e=Object.create(null),n=[{match:this,type:null,via:null}];for(;n.length;){let s=n.shift(),r=s.match;if(r.matchType(t)){let i=[];for(let a=s;a.type;a=a.via)i.push(a.type);return i.reverse()}for(let i=0;i<r.next.length;i++){let{type:a,next:l}=r.next[i];a.isLeaf||a.hasRequiredAttrs()||a.name in e||s.type&&!l.validEnd||(n.push({match:a.contentMatch,type:a,via:s}),e[a.name]=!0)}}return null}get edgeCount(){return this.next.length}edge(t){if(t>=this.next.length)throw new RangeError(`There's no ${t}th edge in this content match`);return this.next[t]}toString(){let t=[];return function e(n){t.push(n);for(let s=0;s<n.next.length;s++)t.indexOf(n.next[s].next)==-1&&e(n.next[s].next)}(this),t.map((e,n)=>{let s=n+(e.validEnd?"*":" ")+" ";for(let r=0;r<e.next.length;r++)s+=(r?", ":"")+e.next[r].type.name+"->"+t.indexOf(e.next[r].next);return s}).join(`
`)}}le.empty=new le(!0);class wl{constructor(t,e){this.string=t,this.nodeTypes=e,this.inline=null,this.pos=0,this.tokens=t.split(/\s*(?=\b|\W|$)/),this.tokens[this.tokens.length-1]==""&&this.tokens.pop(),this.tokens[0]==""&&this.tokens.shift()}get next(){return this.tokens[this.pos]}eat(t){return this.next==t&&(this.pos++||!0)}err(t){throw new SyntaxError(t+" (in content expression '"+this.string+"')")}}function hi(o){let t=[];do t.push(xl(o));while(o.eat("|"));return t.length==1?t[0]:{type:"choice",exprs:t}}function xl(o){let t=[];do t.push(bl(o));while(o.next&&o.next!=")"&&o.next!="|");return t.length==1?t[0]:{type:"seq",exprs:t}}function bl(o){let t=function(e){if(e.eat("(")){let n=hi(e);return e.eat(")")||e.err("Missing closing paren"),n}if(!/\W/.test(e.next)){let n=function(s,r){let i=s.nodeTypes,a=i[r];if(a)return[a];let l=[];for(let c in i){let d=i[c];d.isInGroup(r)&&l.push(d)}return l.length==0&&s.err("No node type or group '"+r+"' found"),l}(e,e.next).map(s=>(e.inline==null?e.inline=s.isInline:e.inline!=s.isInline&&e.err("Mixing inline and block content"),{type:"name",value:s}));return e.pos++,n.length==1?n[0]:{type:"choice",exprs:n}}e.err("Unexpected token '"+e.next+"'")}(o);for(;;)if(o.eat("+"))t={type:"plus",expr:t};else if(o.eat("*"))t={type:"star",expr:t};else if(o.eat("?"))t={type:"opt",expr:t};else{if(!o.eat("{"))break;t=Sl(o,t)}return t}function Cr(o){/\D/.test(o.next)&&o.err("Expected number, got '"+o.next+"'");let t=Number(o.next);return o.pos++,t}function Sl(o,t){let e=Cr(o),n=e;return o.eat(",")&&(n=o.next!="}"?Cr(o):-1),o.eat("}")||o.err("Unclosed braced range"),{type:"range",min:e,max:n,expr:t}}function ui(o,t){return t-o}function kr(o,t){let e=[];return function n(s){let r=o[s];if(r.length==1&&!r[0].term)return n(r[0].to);e.push(s);for(let i=0;i<r.length;i++){let{term:a,to:l}=r[i];a||e.indexOf(l)!=-1||n(l)}}(t),e.sort(ui)}function pi(o){let t=Object.create(null);for(let e in o){let n=o[e];if(!n.hasDefault)return null;t[e]=n.default}return t}function fi(o,t){let e=Object.create(null);for(let n in o){let s=t&&t[n];if(s===void 0){let r=o[n];if(!r.hasDefault)throw new RangeError("No value supplied for attribute "+n);s=r.default}e[n]=s}return e}function mi(o,t,e,n){for(let s in t)if(!(s in o))throw new RangeError(`Unsupported attribute ${s} for ${e} of type ${s}`);for(let s in o){let r=o[s];r.validate&&r.validate(t[s])}}function gi(o,t){let e=Object.create(null);if(t)for(let n in t)e[n]=new _l(o,n,t[n]);return e}let Mr=class yi{constructor(t,e,n){this.name=t,this.schema=e,this.spec=n,this.markSet=null,this.groups=n.group?n.group.split(" "):[],this.attrs=gi(t,n.attrs),this.defaultAttrs=pi(this.attrs),this.contentMatch=null,this.inlineContent=null,this.isBlock=!(n.inline||t=="text"),this.isText=t=="text"}get isInline(){return!this.isBlock}get isTextblock(){return this.isBlock&&this.inlineContent}get isLeaf(){return this.contentMatch==le.empty}get isAtom(){return this.isLeaf||!!this.spec.atom}isInGroup(t){return this.groups.indexOf(t)>-1}get whitespace(){return this.spec.whitespace||(this.spec.code?"pre":"normal")}hasRequiredAttrs(){for(let t in this.attrs)if(this.attrs[t].isRequired)return!0;return!1}compatibleContent(t){return this==t||this.contentMatch.compatible(t.contentMatch)}computeAttrs(t){return!t&&this.defaultAttrs?this.defaultAttrs:fi(this.attrs,t)}create(t=null,e,n){if(this.isText)throw new Error("NodeType.create can't construct text nodes");return new oe(this,this.computeAttrs(t),b.from(e),B.setFrom(n))}createChecked(t=null,e,n){return e=b.from(e),this.checkContent(e),new oe(this,this.computeAttrs(t),e,B.setFrom(n))}createAndFill(t=null,e,n){if(t=this.computeAttrs(t),(e=b.from(e)).size){let i=this.contentMatch.fillBefore(e);if(!i)return null;e=i.append(e)}let s=this.contentMatch.matchFragment(e),r=s&&s.fillBefore(b.empty,!0);return r?new oe(this,t,e.append(r),B.setFrom(n)):null}validContent(t){let e=this.contentMatch.matchFragment(t);if(!e||!e.validEnd)return!1;for(let n=0;n<t.childCount;n++)if(!this.allowsMarks(t.child(n).marks))return!1;return!0}checkContent(t){if(!this.validContent(t))throw new RangeError(`Invalid content for node ${this.name}: ${t.toString().slice(0,50)}`)}checkAttrs(t){mi(this.attrs,t,"node",this.name)}allowsMarkType(t){return this.markSet==null||this.markSet.indexOf(t)>-1}allowsMarks(t){if(this.markSet==null)return!0;for(let e=0;e<t.length;e++)if(!this.allowsMarkType(t[e].type))return!1;return!0}allowedMarks(t){if(this.markSet==null)return t;let e;for(let n=0;n<t.length;n++)this.allowsMarkType(t[n].type)?e&&e.push(t[n]):e||(e=t.slice(0,n));return e?e.length?e:B.none:t}static compile(t,e){let n=Object.create(null);t.forEach((r,i)=>n[r]=new yi(r,e,i));let s=e.spec.topNode||"doc";if(!n[s])throw new RangeError("Schema is missing its top node type ('"+s+"')");if(!n.text)throw new RangeError("Every schema needs a 'text' type");for(let r in n.text.attrs)throw new RangeError("The text node type should not have attributes");return n}};class _l{constructor(t,e,n){this.hasDefault=Object.prototype.hasOwnProperty.call(n,"default"),this.default=n.default,this.validate=typeof n.validate=="string"?function(s,r,i){let a=i.split("|");return l=>{let c=l===null?"null":typeof l;if(a.indexOf(c)<0)throw new RangeError(`Expected value of type ${a} for attribute ${r} on type ${s}, got ${c}`)}}(t,e,n.validate):n.validate}get isRequired(){return!this.hasDefault}}class Dn{constructor(t,e,n,s){this.name=t,this.rank=e,this.schema=n,this.spec=s,this.attrs=gi(t,s.attrs),this.excluded=null;let r=pi(this.attrs);this.instance=r?new B(this,r):null}create(t=null){return!t&&this.instance?this.instance:new B(this,fi(this.attrs,t))}static compile(t,e){let n=Object.create(null),s=0;return t.forEach((r,i)=>n[r]=new Dn(r,s++,e,i)),n}removeFromSet(t){for(var e=0;e<t.length;e++)t[e].type==this&&(t=t.slice(0,e).concat(t.slice(e+1)),e--);return t}isInSet(t){for(let e=0;e<t.length;e++)if(t[e].type==this)return t[e]}checkAttrs(t){mi(this.attrs,t,"mark",this.name)}excludes(t){return this.excluded.indexOf(t)>-1}}class Cl{constructor(t){this.linebreakReplacement=null,this.cached=Object.create(null);let e=this.spec={};for(let s in t)e[s]=t[s];e.nodes=st.from(t.nodes),e.marks=st.from(t.marks||{}),this.nodes=Mr.compile(this.spec.nodes,this),this.marks=Dn.compile(this.spec.marks,this);let n=Object.create(null);for(let s in this.nodes){if(s in this.marks)throw new RangeError(s+" can not be both a node and a mark");let r=this.nodes[s],i=r.spec.content||"",a=r.spec.marks;if(r.contentMatch=n[i]||(n[i]=le.parse(i,this.nodes)),r.inlineContent=r.contentMatch.inlineContent,r.spec.linebreakReplacement){if(this.linebreakReplacement)throw new RangeError("Multiple linebreak nodes defined");if(!r.isInline||!r.isLeaf)throw new RangeError("Linebreak replacement nodes must be inline leaf nodes");this.linebreakReplacement=r}r.markSet=a=="_"?null:a?Tr(this,a.split(" ")):a!=""&&r.inlineContent?null:[]}for(let s in this.marks){let r=this.marks[s],i=r.spec.excludes;r.excluded=i==null?[r]:i==""?[]:Tr(this,i.split(" "))}this.nodeFromJSON=this.nodeFromJSON.bind(this),this.markFromJSON=this.markFromJSON.bind(this),this.topNodeType=this.nodes[this.spec.topNode||"doc"],this.cached.wrappings=Object.create(null)}node(t,e=null,n,s){if(typeof t=="string")t=this.nodeType(t);else{if(!(t instanceof Mr))throw new RangeError("Invalid node type: "+t);if(t.schema!=this)throw new RangeError("Node type from different schema used ("+t.name+")")}return t.createChecked(e,n,s)}text(t,e){let n=this.nodes.text;return new xn(n,n.defaultAttrs,t,B.setFrom(e))}mark(t,e){return typeof t=="string"&&(t=this.marks[t]),t.create(e)}nodeFromJSON(t){return oe.fromJSON(this,t)}markFromJSON(t){return B.fromJSON(this,t)}nodeType(t){let e=this.nodes[t];if(!e)throw new RangeError("Unknown node type: "+t);return e}}function Tr(o,t){let e=[];for(let n=0;n<t.length;n++){let s=t[n],r=o.marks[s],i=r;if(r)e.push(r);else for(let a in o.marks){let l=o.marks[a];(s=="_"||l.spec.group&&l.spec.group.split(" ").indexOf(s)>-1)&&e.push(i=l)}if(!i)throw new SyntaxError("Unknown mark type: '"+t[n]+"'")}return e}class Oe{constructor(t,e){this.schema=t,this.rules=e,this.tags=[],this.styles=[];let n=this.matchedStyles=[];e.forEach(s=>{if(function(r){return r.tag!=null}(s))this.tags.push(s);else if(function(r){return r.style!=null}(s)){let r=/[^=]*/.exec(s.style)[0];n.indexOf(r)<0&&n.push(r),this.styles.push(s)}}),this.normalizeLists=!this.tags.some(s=>{if(!/^(ul|ol)\b/.test(s.tag)||!s.node)return!1;let r=t.nodes[s.node];return r.contentMatch.matchType(r)})}parse(t,e={}){let n=new Ir(this,e,!1);return n.addAll(t,B.none,e.from,e.to),n.finish()}parseSlice(t,e={}){let n=new Ir(this,e,!0);return n.addAll(t,B.none,e.from,e.to),k.maxOpen(n.finish())}matchTag(t,e,n){for(let s=n?this.tags.indexOf(n)+1:0;s<this.tags.length;s++){let r=this.tags[s];if(Ml(t,r.tag)&&(r.namespace===void 0||t.namespaceURI==r.namespace)&&(!r.context||e.matchesContext(r.context))){if(r.getAttrs){let i=r.getAttrs(t);if(i===!1)continue;r.attrs=i||void 0}return r}}}matchStyle(t,e,n,s){for(let r=s?this.styles.indexOf(s)+1:0;r<this.styles.length;r++){let i=this.styles[r],a=i.style;if(!(a.indexOf(t)!=0||i.context&&!n.matchesContext(i.context)||a.length>t.length&&(a.charCodeAt(t.length)!=61||a.slice(t.length+1)!=e))){if(i.getAttrs){let l=i.getAttrs(e);if(l===!1)continue;i.attrs=l||void 0}return i}}}static schemaRules(t){let e=[];function n(s){let r=s.priority==null?50:s.priority,i=0;for(;i<e.length;i++){let a=e[i];if((a.priority==null?50:a.priority)<r)break}e.splice(i,0,s)}for(let s in t.marks){let r=t.marks[s].spec.parseDOM;r&&r.forEach(i=>{n(i=Nr(i)),i.mark||i.ignore||i.clearMark||(i.mark=s)})}for(let s in t.nodes){let r=t.nodes[s].spec.parseDOM;r&&r.forEach(i=>{n(i=Nr(i)),i.node||i.ignore||i.mark||(i.node=s)})}return e}static fromSchema(t){return t.cached.domParser||(t.cached.domParser=new Oe(t,Oe.schemaRules(t)))}}const vi={address:!0,article:!0,aside:!0,blockquote:!0,canvas:!0,dd:!0,div:!0,dl:!0,fieldset:!0,figcaption:!0,figure:!0,footer:!0,form:!0,h1:!0,h2:!0,h3:!0,h4:!0,h5:!0,h6:!0,header:!0,hgroup:!0,hr:!0,li:!0,noscript:!0,ol:!0,output:!0,p:!0,pre:!0,section:!0,table:!0,tfoot:!0,ul:!0},kl={head:!0,noscript:!0,object:!0,script:!0,style:!0,title:!0},Er={ol:!0,ul:!0};function Or(o,t,e){return t!=null?(t?1:0)|(t==="full"?2:0):o&&o.whitespace=="pre"?3:-5&e}class Gn{constructor(t,e,n,s,r,i){this.type=t,this.attrs=e,this.marks=n,this.solid=s,this.options=i,this.content=[],this.activeMarks=B.none,this.match=r||(4&i?null:t.contentMatch)}findWrapping(t){if(!this.match){if(!this.type)return[];let e=this.type.contentMatch.fillBefore(b.from(t));if(!e){let n,s=this.type.contentMatch;return(n=s.findWrapping(t.type))?(this.match=s,n):null}this.match=this.type.contentMatch.matchFragment(e)}return this.match.findWrapping(t.type)}finish(t){if(!(1&this.options)){let n,s=this.content[this.content.length-1];if(s&&s.isText&&(n=/[ \t\r\n\u000c]+$/.exec(s.text))){let r=s;s.text.length==n[0].length?this.content.pop():this.content[this.content.length-1]=r.withText(r.text.slice(0,r.text.length-n[0].length))}}let e=b.from(this.content);return!t&&this.match&&(e=e.append(this.match.fillBefore(b.empty,!0))),this.type?this.type.create(this.attrs,e,this.marks):e}inlineContext(t){return this.type?this.type.inlineContent:this.content.length?this.content[0].isInline:t.parentNode&&!vi.hasOwnProperty(t.parentNode.nodeName.toLowerCase())}}class Ir{constructor(t,e,n){this.parser=t,this.options=e,this.isOpen=n,this.open=0;let s,r=e.topNode,i=Or(null,e.preserveWhitespace,0)|(n?4:0);s=r?new Gn(r.type,r.attrs,B.none,!0,e.topMatch||r.type.contentMatch,i):new Gn(n?null:t.schema.topNodeType,null,B.none,!0,null,i),this.nodes=[s],this.find=e.findPositions,this.needsBlock=!1}get top(){return this.nodes[this.open]}addDOM(t,e){t.nodeType==3?this.addTextNode(t,e):t.nodeType==1&&this.addElement(t,e)}addTextNode(t,e){let n=t.nodeValue,s=this.top;if(2&s.options||s.inlineContext(t)||/[^ \t\r\n\u000c]/.test(n)){if(1&s.options)n=2&s.options?n.replace(/\r\n?/g,`
`):n.replace(/\r?\n|\r/g," ");else if(n=n.replace(/[ \t\r\n\u000c]+/g," "),/^[ \t\r\n\u000c]/.test(n)&&this.open==this.nodes.length-1){let r=s.content[s.content.length-1],i=t.previousSibling;(!r||i&&i.nodeName=="BR"||r.isText&&/[ \t\r\n\u000c]$/.test(r.text))&&(n=n.slice(1))}n&&this.insertNode(this.parser.schema.text(n),e),this.findInText(t)}else this.findInside(t)}addElement(t,e,n){let s,r=t.nodeName.toLowerCase();Er.hasOwnProperty(r)&&this.parser.normalizeLists&&function(a){for(let l=a.firstChild,c=null;l;l=l.nextSibling){let d=l.nodeType==1?l.nodeName.toLowerCase():null;d&&Er.hasOwnProperty(d)&&c?(c.appendChild(l),l=c):d=="li"?c=l:d&&(c=null)}}(t);let i=this.options.ruleFromNode&&this.options.ruleFromNode(t)||(s=this.parser.matchTag(t,this,n));if(i?i.ignore:kl.hasOwnProperty(r))this.findInside(t),this.ignoreFallback(t,e);else if(!i||i.skip||i.closeParent){i&&i.closeParent?this.open=Math.max(0,this.open-1):i&&i.skip.nodeType&&(t=i.skip);let a,l=this.top,c=this.needsBlock;if(vi.hasOwnProperty(r))l.content.length&&l.content[0].isInline&&this.open&&(this.open--,l=this.top),a=!0,l.type||(this.needsBlock=!0);else if(!t.firstChild)return void this.leafFallback(t,e);let d=i&&i.skip?e:this.readStyles(t,e);d&&this.addAll(t,d),a&&this.sync(l),this.needsBlock=c}else{let a=this.readStyles(t,e);a&&this.addElementByRule(t,i,a,i.consuming===!1?s:void 0)}}leafFallback(t,e){t.nodeName=="BR"&&this.top.type&&this.top.type.inlineContent&&this.addTextNode(t.ownerDocument.createTextNode(`
`),e)}ignoreFallback(t,e){t.nodeName!="BR"||this.top.type&&this.top.type.inlineContent||this.findPlace(this.parser.schema.text("-"),e)}readStyles(t,e){let n=t.style;if(n&&n.length)for(let s=0;s<this.parser.matchedStyles.length;s++){let r=this.parser.matchedStyles[s],i=n.getPropertyValue(r);if(i)for(let a;;){let l=this.parser.matchStyle(r,i,this,a);if(!l)break;if(l.ignore)return null;if(e=l.clearMark?e.filter(c=>!l.clearMark(c)):e.concat(this.parser.schema.marks[l.mark].create(l.attrs)),l.consuming!==!1)break;a=l}}return e}addElementByRule(t,e,n,s){let r,i;if(e.node)if(i=this.parser.schema.nodes[e.node],i.isLeaf)this.insertNode(i.create(e.attrs),n)||this.leafFallback(t,n);else{let l=this.enter(i,e.attrs||null,n,e.preserveWhitespace);l&&(r=!0,n=l)}else{let l=this.parser.schema.marks[e.mark];n=n.concat(l.create(e.attrs))}let a=this.top;if(i&&i.isLeaf)this.findInside(t);else if(s)this.addElement(t,n,s);else if(e.getContent)this.findInside(t),e.getContent(t,this.parser.schema).forEach(l=>this.insertNode(l,n));else{let l=t;typeof e.contentElement=="string"?l=t.querySelector(e.contentElement):typeof e.contentElement=="function"?l=e.contentElement(t):e.contentElement&&(l=e.contentElement),this.findAround(t,l,!0),this.addAll(l,n),this.findAround(t,l,!1)}r&&this.sync(a)&&this.open--}addAll(t,e,n,s){let r=n||0;for(let i=n?t.childNodes[n]:t.firstChild,a=s==null?null:t.childNodes[s];i!=a;i=i.nextSibling,++r)this.findAtPoint(t,r),this.addDOM(i,e);this.findAtPoint(t,r)}findPlace(t,e){let n,s;for(let r=this.open;r>=0;r--){let i=this.nodes[r],a=i.findWrapping(t);if(a&&(!n||n.length>a.length)&&(n=a,s=i,!a.length)||i.solid)break}if(!n)return null;this.sync(s);for(let r=0;r<n.length;r++)e=this.enterInner(n[r],null,e,!1);return e}insertNode(t,e){if(t.isInline&&this.needsBlock&&!this.top.type){let s=this.textblockFromContext();s&&(e=this.enterInner(s,null,e))}let n=this.findPlace(t,e);if(n){this.closeExtra();let s=this.top;s.match&&(s.match=s.match.matchType(t.type));let r=B.none;for(let i of n.concat(t.marks))(s.type?s.type.allowsMarkType(i.type):Dr(i.type,t.type))&&(r=i.addToSet(r));return s.content.push(t.mark(r)),!0}return!1}enter(t,e,n,s){let r=this.findPlace(t.create(e),n);return r&&(r=this.enterInner(t,e,n,!0,s)),r}enterInner(t,e,n,s=!1,r){this.closeExtra();let i=this.top;i.match=i.match&&i.match.matchType(t);let a=Or(t,r,i.options);4&i.options&&i.content.length==0&&(a|=4);let l=B.none;return n=n.filter(c=>!(i.type?i.type.allowsMarkType(c.type):Dr(c.type,t))||(l=c.addToSet(l),!1)),this.nodes.push(new Gn(t,e,l,s,null,a)),this.open++,n}closeExtra(t=!1){let e=this.nodes.length-1;if(e>this.open){for(;e>this.open;e--)this.nodes[e-1].content.push(this.nodes[e].finish(t));this.nodes.length=this.open+1}}finish(){return this.open=0,this.closeExtra(this.isOpen),this.nodes[0].finish(this.isOpen||this.options.topOpen)}sync(t){for(let e=this.open;e>=0;e--)if(this.nodes[e]==t)return this.open=e,!0;return!1}get currentPos(){this.closeExtra();let t=0;for(let e=this.open;e>=0;e--){let n=this.nodes[e].content;for(let s=n.length-1;s>=0;s--)t+=n[s].nodeSize;e&&t++}return t}findAtPoint(t,e){if(this.find)for(let n=0;n<this.find.length;n++)this.find[n].node==t&&this.find[n].offset==e&&(this.find[n].pos=this.currentPos)}findInside(t){if(this.find)for(let e=0;e<this.find.length;e++)this.find[e].pos==null&&t.nodeType==1&&t.contains(this.find[e].node)&&(this.find[e].pos=this.currentPos)}findAround(t,e,n){if(t!=e&&this.find)for(let s=0;s<this.find.length;s++)this.find[s].pos==null&&t.nodeType==1&&t.contains(this.find[s].node)&&e.compareDocumentPosition(this.find[s].node)&(n?2:4)&&(this.find[s].pos=this.currentPos)}findInText(t){if(this.find)for(let e=0;e<this.find.length;e++)this.find[e].node==t&&(this.find[e].pos=this.currentPos-(t.nodeValue.length-this.find[e].offset))}matchesContext(t){if(t.indexOf("|")>-1)return t.split(/\s*\|\s*/).some(this.matchesContext,this);let e=t.split("/"),n=this.options.context,s=!(this.isOpen||n&&n.parent.type!=this.nodes[0].type),r=-(n?n.depth+1:0)+(s?0:1),i=(a,l)=>{for(;a>=0;a--){let c=e[a];if(c==""){if(a==e.length-1||a==0)continue;for(;l>=r;l--)if(i(a-1,l))return!0;return!1}{let d=l>0||l==0&&s?this.nodes[l].type:n&&l>=r?n.node(l-r).type:null;if(!d||d.name!=c&&!d.isInGroup(c))return!1;l--}}return!0};return i(e.length-1,this.open)}textblockFromContext(){let t=this.options.context;if(t)for(let e=t.depth;e>=0;e--){let n=t.node(e).contentMatchAt(t.indexAfter(e)).defaultType;if(n&&n.isTextblock&&n.defaultAttrs)return n}for(let e in this.parser.schema.nodes){let n=this.parser.schema.nodes[e];if(n.isTextblock&&n.defaultAttrs)return n}}}function Ml(o,t){return(o.matches||o.msMatchesSelector||o.webkitMatchesSelector||o.mozMatchesSelector).call(o,t)}function Nr(o){let t={};for(let e in o)t[e]=o[e];return t}function Dr(o,t){let e=t.schema.nodes;for(let n in e){let s=e[n];if(!s.allowsMarkType(o))continue;let r=[],i=a=>{r.push(a);for(let l=0;l<a.edgeCount;l++){let{type:c,next:d}=a.edge(l);if(c==t||r.indexOf(d)<0&&i(d))return!0}};if(i(s.contentMatch))return!0}}class ue{constructor(t,e){this.nodes=t,this.marks=e}serializeFragment(t,e={},n){n||(n=Xn(e).createDocumentFragment());let s=n,r=[];return t.forEach(i=>{if(r.length||i.marks.length){let a=0,l=0;for(;a<r.length&&l<i.marks.length;){let c=i.marks[l];if(this.marks[c.type.name]){if(!c.eq(r[a][0])||c.type.spec.spanning===!1)break;a++,l++}else l++}for(;a<r.length;)s=r.pop()[1];for(;l<i.marks.length;){let c=i.marks[l++],d=this.serializeMark(c,i.isInline,e);d&&(r.push([c,s]),s.appendChild(d.dom),s=d.contentDOM||d.dom)}}s.appendChild(this.serializeNodeInner(i,e))}),n}serializeNodeInner(t,e){let{dom:n,contentDOM:s}=pn(Xn(e),this.nodes[t.type.name](t),null,t.attrs);if(s){if(t.isLeaf)throw new RangeError("Content hole not allowed in a leaf node spec");this.serializeFragment(t.content,e,s)}return n}serializeNode(t,e={}){let n=this.serializeNodeInner(t,e);for(let s=t.marks.length-1;s>=0;s--){let r=this.serializeMark(t.marks[s],t.isInline,e);r&&((r.contentDOM||r.dom).appendChild(n),n=r.dom)}return n}serializeMark(t,e,n={}){let s=this.marks[t.type.name];return s&&pn(Xn(n),s(t,e),null,t.attrs)}static renderSpec(t,e,n=null,s){return pn(t,e,n,s)}static fromSchema(t){return t.cached.domSerializer||(t.cached.domSerializer=new ue(this.nodesFromSchema(t),this.marksFromSchema(t)))}static nodesFromSchema(t){let e=Ar(t.nodes);return e.text||(e.text=n=>n.text),e}static marksFromSchema(t){return Ar(t.marks)}}function Ar(o){let t={};for(let e in o){let n=o[e].spec.toDOM;n&&(t[e]=n)}return t}function Xn(o){return o.document||window.document}const Rr=new WeakMap;function Tl(o){let t=Rr.get(o);return t===void 0&&Rr.set(o,t=function(e){let n=null;function s(r){if(r&&typeof r=="object")if(Array.isArray(r))if(typeof r[0]=="string")n||(n=[]),n.push(r);else for(let i=0;i<r.length;i++)s(r[i]);else for(let i in r)s(r[i])}return s(e),n}(o)),t}function pn(o,t,e,n){if(typeof t=="string")return{dom:o.createTextNode(t)};if(t.nodeType!=null)return{dom:t};if(t.dom&&t.dom.nodeType!=null)return t;let s,r=t[0];if(typeof r!="string")throw new RangeError("Invalid array passed to renderSpec");if(n&&(s=Tl(n))&&s.indexOf(t)>-1)throw new RangeError("Using an array from an attribute object as a DOM spec. This may be an attempted cross site scripting attack.");let i,a=r.indexOf(" ");a>0&&(e=r.slice(0,a),r=r.slice(a+1));let l=e?o.createElementNS(e,r):o.createElement(r),c=t[1],d=1;if(c&&typeof c=="object"&&c.nodeType==null&&!Array.isArray(c)){d=2;for(let h in c)if(c[h]!=null){let u=h.indexOf(" ");u>0?l.setAttributeNS(h.slice(0,u),h.slice(u+1),c[h]):l.setAttribute(h,c[h])}}for(let h=d;h<t.length;h++){let u=t[h];if(u===0){if(h<t.length-1||h>d)throw new RangeError("Content hole must be the only child of its parent node");return{dom:l,contentDOM:l}}{let{dom:f,contentDOM:p}=pn(o,u,e,n);if(l.appendChild(f),p){if(i)throw new RangeError("Multiple content holes");i=p}}}return{dom:l,contentDOM:i}}const Pr=Math.pow(2,16);function $r(o){return 65535&o}class Es{constructor(t,e,n){this.pos=t,this.delInfo=e,this.recover=n}get deleted(){return(8&this.delInfo)>0}get deletedBefore(){return(5&this.delInfo)>0}get deletedAfter(){return(6&this.delInfo)>0}get deletedAcross(){return(4&this.delInfo)>0}}class pt{constructor(t,e=!1){if(this.ranges=t,this.inverted=e,!t.length&&pt.empty)return pt.empty}recover(t){let e=0,n=$r(t);if(!this.inverted)for(let s=0;s<n;s++)e+=this.ranges[3*s+2]-this.ranges[3*s+1];return this.ranges[3*n]+e+function(s){return(s-(65535&s))/Pr}(t)}mapResult(t,e=1){return this._map(t,e,!1)}map(t,e=1){return this._map(t,e,!0)}_map(t,e,n){let s=0,r=this.inverted?2:1,i=this.inverted?1:2;for(let a=0;a<this.ranges.length;a+=3){let l=this.ranges[a]-(this.inverted?s:0);if(l>t)break;let c=this.ranges[a+r],d=this.ranges[a+i],h=l+c;if(t<=h){let u=l+s+((c?t==l?-1:t==h?1:e:e)<0?0:d);if(n)return u;let f=t==(e<0?l:h)?null:a/3+(t-l)*Pr,p=t==l?2:t==h?1:4;return(e<0?t!=l:t!=h)&&(p|=8),new Es(u,p,f)}s+=d-c}return n?t+s:new Es(t+s,0,null)}touches(t,e){let n=0,s=$r(e),r=this.inverted?2:1,i=this.inverted?1:2;for(let a=0;a<this.ranges.length;a+=3){let l=this.ranges[a]-(this.inverted?n:0);if(l>t)break;let c=this.ranges[a+r];if(t<=l+c&&a==3*s)return!0;n+=this.ranges[a+i]-c}return!1}forEach(t){let e=this.inverted?2:1,n=this.inverted?1:2;for(let s=0,r=0;s<this.ranges.length;s+=3){let i=this.ranges[s],a=i-(this.inverted?r:0),l=i+(this.inverted?0:r),c=this.ranges[s+e],d=this.ranges[s+n];t(a,a+c,l,l+d),r+=d-c}}invert(){return new pt(this.ranges,!this.inverted)}toString(){return(this.inverted?"-":"")+JSON.stringify(this.ranges)}static offset(t){return t==0?pt.empty:new pt(t<0?[0,-t,0]:[0,0,t])}}pt.empty=new pt([]);class bn{constructor(t,e,n=0,s=t?t.length:0){this.mirror=e,this.from=n,this.to=s,this._maps=t||[],this.ownData=!(t||e)}get maps(){return this._maps}slice(t=0,e=this.maps.length){return new bn(this._maps,this.mirror,t,e)}appendMap(t,e){this.ownData||(this._maps=this._maps.slice(),this.mirror=this.mirror&&this.mirror.slice(),this.ownData=!0),this.to=this._maps.push(t),e!=null&&this.setMirror(this._maps.length-1,e)}appendMapping(t){for(let e=0,n=this._maps.length;e<t._maps.length;e++){let s=t.getMirror(e);this.appendMap(t._maps[e],s!=null&&s<e?n+s:void 0)}}getMirror(t){if(this.mirror){for(let e=0;e<this.mirror.length;e++)if(this.mirror[e]==t)return this.mirror[e+(e%2?-1:1)]}}setMirror(t,e){this.mirror||(this.mirror=[]),this.mirror.push(t,e)}appendMappingInverted(t){for(let e=t.maps.length-1,n=this._maps.length+t._maps.length;e>=0;e--){let s=t.getMirror(e);this.appendMap(t._maps[e].invert(),s!=null&&s>e?n-s-1:void 0)}}invert(){let t=new bn;return t.appendMappingInverted(this),t}map(t,e=1){if(this.mirror)return this._map(t,e,!0);for(let n=this.from;n<this.to;n++)t=this._maps[n].map(t,e);return t}mapResult(t,e=1){return this._map(t,e,!1)}_map(t,e,n){let s=0;for(let r=this.from;r<this.to;r++){let i=this._maps[r].mapResult(t,e);if(i.recover!=null){let a=this.getMirror(r);if(a!=null&&a>r&&a<this.to){r=a,t=this._maps[a].recover(i.recover);continue}}s|=i.delInfo,t=i.pos}return n?t:new Es(t,s,null)}}const Qn=Object.create(null);class at{getMap(){return pt.empty}merge(t){return null}static fromJSON(t,e){if(!e||!e.stepType)throw new RangeError("Invalid input for Step.fromJSON");let n=Qn[e.stepType];if(!n)throw new RangeError(`No step type ${e.stepType} defined`);return n.fromJSON(t,e)}static jsonID(t,e){if(t in Qn)throw new RangeError("Duplicate use of step JSON ID "+t);return Qn[t]=e,e.prototype.jsonID=t,e}}class K{constructor(t,e){this.doc=t,this.failed=e}static ok(t){return new K(t,null)}static fail(t){return new K(null,t)}static fromReplace(t,e,n,s){try{return K.ok(t.replace(e,n,s))}catch(r){if(r instanceof yn)return K.fail(r.message);throw r}}}function Qs(o,t,e){let n=[];for(let s=0;s<o.childCount;s++){let r=o.child(s);r.content.size&&(r=r.copy(Qs(r.content,t,r))),r.isInline&&(r=t(r,e,s)),n.push(r)}return b.fromArray(n)}class qt extends at{constructor(t,e,n){super(),this.from=t,this.to=e,this.mark=n}apply(t){let e=t.slice(this.from,this.to),n=t.resolve(this.from),s=n.node(n.sharedDepth(this.to)),r=new k(Qs(e.content,(i,a)=>i.isAtom&&a.type.allowsMarkType(this.mark.type)?i.mark(this.mark.addToSet(i.marks)):i,s),e.openStart,e.openEnd);return K.fromReplace(t,this.from,this.to,r)}invert(){return new St(this.from,this.to,this.mark)}map(t){let e=t.mapResult(this.from,1),n=t.mapResult(this.to,-1);return e.deleted&&n.deleted||e.pos>=n.pos?null:new qt(e.pos,n.pos,this.mark)}merge(t){return t instanceof qt&&t.mark.eq(this.mark)&&this.from<=t.to&&this.to>=t.from?new qt(Math.min(this.from,t.from),Math.max(this.to,t.to),this.mark):null}toJSON(){return{stepType:"addMark",mark:this.mark.toJSON(),from:this.from,to:this.to}}static fromJSON(t,e){if(typeof e.from!="number"||typeof e.to!="number")throw new RangeError("Invalid input for AddMarkStep.fromJSON");return new qt(e.from,e.to,t.markFromJSON(e.mark))}}at.jsonID("addMark",qt);class St extends at{constructor(t,e,n){super(),this.from=t,this.to=e,this.mark=n}apply(t){let e=t.slice(this.from,this.to),n=new k(Qs(e.content,s=>s.mark(this.mark.removeFromSet(s.marks)),t),e.openStart,e.openEnd);return K.fromReplace(t,this.from,this.to,n)}invert(){return new qt(this.from,this.to,this.mark)}map(t){let e=t.mapResult(this.from,1),n=t.mapResult(this.to,-1);return e.deleted&&n.deleted||e.pos>=n.pos?null:new St(e.pos,n.pos,this.mark)}merge(t){return t instanceof St&&t.mark.eq(this.mark)&&this.from<=t.to&&this.to>=t.from?new St(Math.min(this.from,t.from),Math.max(this.to,t.to),this.mark):null}toJSON(){return{stepType:"removeMark",mark:this.mark.toJSON(),from:this.from,to:this.to}}static fromJSON(t,e){if(typeof e.from!="number"||typeof e.to!="number")throw new RangeError("Invalid input for RemoveMarkStep.fromJSON");return new St(e.from,e.to,t.markFromJSON(e.mark))}}at.jsonID("removeMark",St);class Ft extends at{constructor(t,e){super(),this.pos=t,this.mark=e}apply(t){let e=t.nodeAt(this.pos);if(!e)return K.fail("No node at mark step's position");let n=e.type.create(e.attrs,null,this.mark.addToSet(e.marks));return K.fromReplace(t,this.pos,this.pos+1,new k(b.from(n),0,e.isLeaf?0:1))}invert(t){let e=t.nodeAt(this.pos);if(e){let n=this.mark.addToSet(e.marks);if(n.length==e.marks.length){for(let s=0;s<e.marks.length;s++)if(!e.marks[s].isInSet(n))return new Ft(this.pos,e.marks[s]);return new Ft(this.pos,this.mark)}}return new ce(this.pos,this.mark)}map(t){let e=t.mapResult(this.pos,1);return e.deletedAfter?null:new Ft(e.pos,this.mark)}toJSON(){return{stepType:"addNodeMark",pos:this.pos,mark:this.mark.toJSON()}}static fromJSON(t,e){if(typeof e.pos!="number")throw new RangeError("Invalid input for AddNodeMarkStep.fromJSON");return new Ft(e.pos,t.markFromJSON(e.mark))}}at.jsonID("addNodeMark",Ft);class ce extends at{constructor(t,e){super(),this.pos=t,this.mark=e}apply(t){let e=t.nodeAt(this.pos);if(!e)return K.fail("No node at mark step's position");let n=e.type.create(e.attrs,null,this.mark.removeFromSet(e.marks));return K.fromReplace(t,this.pos,this.pos+1,new k(b.from(n),0,e.isLeaf?0:1))}invert(t){let e=t.nodeAt(this.pos);return e&&this.mark.isInSet(e.marks)?new Ft(this.pos,this.mark):this}map(t){let e=t.mapResult(this.pos,1);return e.deletedAfter?null:new ce(e.pos,this.mark)}toJSON(){return{stepType:"removeNodeMark",pos:this.pos,mark:this.mark.toJSON()}}static fromJSON(t,e){if(typeof e.pos!="number")throw new RangeError("Invalid input for RemoveNodeMarkStep.fromJSON");return new ce(e.pos,t.markFromJSON(e.mark))}}at.jsonID("removeNodeMark",ce);class Z extends at{constructor(t,e,n,s=!1){super(),this.from=t,this.to=e,this.slice=n,this.structure=s}apply(t){return this.structure&&Os(t,this.from,this.to)?K.fail("Structure replace would overwrite content"):K.fromReplace(t,this.from,this.to,this.slice)}getMap(){return new pt([this.from,this.to-this.from,this.slice.size])}invert(t){return new Z(this.from,this.from+this.slice.size,t.slice(this.from,this.to))}map(t){let e=t.mapResult(this.from,1),n=t.mapResult(this.to,-1);return e.deletedAcross&&n.deletedAcross?null:new Z(e.pos,Math.max(e.pos,n.pos),this.slice,this.structure)}merge(t){if(!(t instanceof Z)||t.structure||this.structure)return null;if(this.from+this.slice.size!=t.from||this.slice.openEnd||t.slice.openStart){if(t.to!=this.from||this.slice.openStart||t.slice.openEnd)return null;{let e=this.slice.size+t.slice.size==0?k.empty:new k(t.slice.content.append(this.slice.content),t.slice.openStart,this.slice.openEnd);return new Z(t.from,this.to,e,this.structure)}}{let e=this.slice.size+t.slice.size==0?k.empty:new k(this.slice.content.append(t.slice.content),this.slice.openStart,t.slice.openEnd);return new Z(this.from,this.to+(t.to-t.from),e,this.structure)}}toJSON(){let t={stepType:"replace",from:this.from,to:this.to};return this.slice.size&&(t.slice=this.slice.toJSON()),this.structure&&(t.structure=!0),t}static fromJSON(t,e){if(typeof e.from!="number"||typeof e.to!="number")throw new RangeError("Invalid input for ReplaceStep.fromJSON");return new Z(e.from,e.to,k.fromJSON(t,e.slice),!!e.structure)}}at.jsonID("replace",Z);class tt extends at{constructor(t,e,n,s,r,i,a=!1){super(),this.from=t,this.to=e,this.gapFrom=n,this.gapTo=s,this.slice=r,this.insert=i,this.structure=a}apply(t){if(this.structure&&(Os(t,this.from,this.gapFrom)||Os(t,this.gapTo,this.to)))return K.fail("Structure gap-replace would overwrite content");let e=t.slice(this.gapFrom,this.gapTo);if(e.openStart||e.openEnd)return K.fail("Gap is not a flat range");let n=this.slice.insertAt(this.insert,e.content);return n?K.fromReplace(t,this.from,this.to,n):K.fail("Content does not fit in gap")}getMap(){return new pt([this.from,this.gapFrom-this.from,this.insert,this.gapTo,this.to-this.gapTo,this.slice.size-this.insert])}invert(t){let e=this.gapTo-this.gapFrom;return new tt(this.from,this.from+this.slice.size+e,this.from+this.insert,this.from+this.insert+e,t.slice(this.from,this.to).removeBetween(this.gapFrom-this.from,this.gapTo-this.from),this.gapFrom-this.from,this.structure)}map(t){let e=t.mapResult(this.from,1),n=t.mapResult(this.to,-1),s=this.from==this.gapFrom?e.pos:t.map(this.gapFrom,-1),r=this.to==this.gapTo?n.pos:t.map(this.gapTo,1);return e.deletedAcross&&n.deletedAcross||s<e.pos||r>n.pos?null:new tt(e.pos,n.pos,s,r,this.slice,this.insert,this.structure)}toJSON(){let t={stepType:"replaceAround",from:this.from,to:this.to,gapFrom:this.gapFrom,gapTo:this.gapTo,insert:this.insert};return this.slice.size&&(t.slice=this.slice.toJSON()),this.structure&&(t.structure=!0),t}static fromJSON(t,e){if(typeof e.from!="number"||typeof e.to!="number"||typeof e.gapFrom!="number"||typeof e.gapTo!="number"||typeof e.insert!="number")throw new RangeError("Invalid input for ReplaceAroundStep.fromJSON");return new tt(e.from,e.to,e.gapFrom,e.gapTo,k.fromJSON(t,e.slice),e.insert,!!e.structure)}}function Os(o,t,e){let n=o.resolve(t),s=e-t,r=n.depth;for(;s>0&&r>0&&n.indexAfter(r)==n.node(r).childCount;)r--,s--;if(s>0){let i=n.node(r).maybeChild(n.indexAfter(r));for(;s>0;){if(!i||i.isLeaf)return!0;i=i.firstChild,s--}}return!1}function Yn(o,t,e,n=e.contentMatch,s=!0){let r=o.doc.nodeAt(t),i=[],a=t+1;for(let l=0;l<r.childCount;l++){let c=r.child(l),d=a+c.nodeSize,h=n.matchType(c.type);if(h){n=h;for(let u=0;u<c.marks.length;u++)e.allowsMarkType(c.marks[u].type)||o.step(new St(a,d,c.marks[u]));if(s&&c.isText&&e.whitespace!="pre"){let u,f,p=/\r?\n|\r/g;for(;u=p.exec(c.text);)f||(f=new k(b.from(e.schema.text(" ",e.allowedMarks(c.marks))),0,0)),i.push(new Z(a+u.index,a+u.index+u[0].length,f))}}else i.push(new Z(a,d,k.empty));a=d}if(!n.validEnd){let l=n.fillBefore(b.empty,!0);o.replace(a,a,new k(l,0,0))}for(let l=i.length-1;l>=0;l--)o.step(i[l])}function El(o,t,e){return(t==0||o.canReplace(t,o.childCount))&&(e==o.childCount||o.canReplace(0,e))}function Ie(o){let t=o.parent.content.cutByIndex(o.startIndex,o.endIndex);for(let e=o.depth;;--e){let n=o.$from.node(e),s=o.$from.index(e),r=o.$to.indexAfter(e);if(e<o.depth&&n.canReplace(s,r,t))return e;if(e==0||n.type.spec.isolating||!El(n,s,r))break}return null}function wi(o,t,e=null,n=o){let s=function(i,a){let{parent:l,startIndex:c,endIndex:d}=i,h=l.contentMatchAt(c).findWrapping(a);if(!h)return null;let u=h.length?h[0]:a;return l.canReplaceWith(c,d,u)?h:null}(o,t),r=s&&function(i,a){let{parent:l,startIndex:c,endIndex:d}=i,h=l.child(c),u=a.contentMatch.findWrapping(h.type);if(!u)return null;let f=(u.length?u[u.length-1]:a).contentMatch;for(let p=c;f&&p<d;p++)f=f.matchType(l.child(p).type);return f&&f.validEnd?u:null}(n,t);return r?s.map(qr).concat({type:t,attrs:e}).concat(r.map(qr)):null}function qr(o){return{type:o,attrs:null}}function Fr(o,t,e,n){t.forEach((s,r)=>{if(s.isText){let i,a=/\r?\n|\r/g;for(;i=a.exec(s.text);){let l=o.mapping.slice(n).map(e+1+r+i.index);o.replaceWith(l,l+1,t.type.schema.linebreakReplacement.create())}}})}function zr(o,t,e,n){t.forEach((s,r)=>{if(s.type==s.type.schema.linebreakReplacement){let i=o.mapping.slice(n).map(e+1+r);o.replaceWith(i,i+1,t.type.schema.text(`
`))}})}function Et(o,t,e=1,n){let s=o.resolve(t),r=s.depth-e,i=n&&n[n.length-1]||s.parent;if(r<0||s.parent.type.spec.isolating||!s.parent.canReplace(s.index(),s.parent.childCount)||!i.type.validContent(s.parent.content.cutByIndex(s.index(),s.parent.childCount)))return!1;for(let c=s.depth-1,d=e-2;c>r;c--,d--){let h=s.node(c),u=s.index(c);if(h.type.spec.isolating)return!1;let f=h.content.cutByIndex(u,h.childCount),p=n&&n[d+1];p&&(f=f.replaceChild(0,p.type.create(p.attrs)));let m=n&&n[d]||h;if(!h.canReplace(u+1,h.childCount)||!m.type.validContent(f))return!1}let a=s.indexAfter(r),l=n&&n[0];return s.node(r).canReplaceWith(a,a,l?l.type:s.node(r+1).type)}function de(o,t){let e=o.resolve(t),n=e.index();return xi(e.nodeBefore,e.nodeAfter)&&e.parent.canReplace(n,n+1)}function xi(o,t){return!(!o||!t||o.isLeaf||!function(e,n){n.content.size||e.type.compatibleContent(n.type);let s=e.contentMatchAt(e.childCount),{linebreakReplacement:r}=e.type.schema;for(let i=0;i<n.childCount;i++){let a=n.child(i),l=a.type==r?e.type.schema.nodes.text:a.type;if(s=s.matchType(l),!s||!e.type.allowsMarks(a.marks))return!1}return s.validEnd}(o,t))}function an(o,t,e=-1){let n=o.resolve(t);for(let s=n.depth;;s--){let r,i,a=n.index(s);if(s==n.depth?(r=n.nodeBefore,i=n.nodeAfter):e>0?(r=n.node(s+1),a++,i=n.node(s).maybeChild(a)):(r=n.node(s).maybeChild(a-1),i=n.node(s+1)),r&&!r.isTextblock&&xi(r,i)&&n.node(s).canReplace(a,a+1))return t;if(s==0)break;t=e<0?n.before(s):n.after(s)}}function An(o,t,e=t,n=k.empty){if(t==e&&!n.size)return null;let s=o.resolve(t),r=o.resolve(e);return bi(s,r,n)?new Z(t,e,n):new Ol(s,r,n).fit()}function bi(o,t,e){return!e.openStart&&!e.openEnd&&o.start()==t.start()&&o.parent.canReplace(o.index(),t.index(),e.content)}at.jsonID("replaceAround",tt);class Ol{constructor(t,e,n){this.$from=t,this.$to=e,this.unplaced=n,this.frontier=[],this.placed=b.empty;for(let s=0;s<=t.depth;s++){let r=t.node(s);this.frontier.push({type:r.type,match:r.contentMatchAt(t.indexAfter(s))})}for(let s=t.depth;s>0;s--)this.placed=b.from(t.node(s).copy(this.placed))}get depth(){return this.frontier.length-1}fit(){for(;this.unplaced.size;){let c=this.findFittable();c?this.placeNodes(c):this.openMore()||this.dropNode()}let t=this.mustMoveInline(),e=this.placed.size-this.depth-this.$from.depth,n=this.$from,s=this.close(t<0?this.$to:n.doc.resolve(t));if(!s)return null;let r=this.placed,i=n.depth,a=s.depth;for(;i&&a&&r.childCount==1;)r=r.firstChild.content,i--,a--;let l=new k(r,i,a);return t>-1?new tt(n.pos,t,this.$to.pos,this.$to.end(),l,e):l.size||n.pos!=this.$to.pos?new Z(n.pos,s.pos,l):null}findFittable(){let t=this.unplaced.openStart;for(let e=this.unplaced.content,n=0,s=this.unplaced.openEnd;n<t;n++){let r=e.firstChild;if(e.childCount>1&&(s=0),r.type.spec.isolating&&s<=n){t=n;break}e=r.content}for(let e=1;e<=2;e++)for(let n=e==1?t:this.unplaced.openStart;n>=0;n--){let s,r=null;n?(r=Zn(this.unplaced.content,n-1).firstChild,s=r.content):s=this.unplaced.content;let i=s.firstChild;for(let a=this.depth;a>=0;a--){let l,{type:c,match:d}=this.frontier[a],h=null;if(e==1&&(i?d.matchType(i.type)||(h=d.fillBefore(b.from(i),!1)):r&&c.compatibleContent(r.type)))return{sliceDepth:n,frontierDepth:a,parent:r,inject:h};if(e==2&&i&&(l=d.findWrapping(i.type)))return{sliceDepth:n,frontierDepth:a,parent:r,wrap:l};if(r&&d.matchType(r.type))break}}}openMore(){let{content:t,openStart:e,openEnd:n}=this.unplaced,s=Zn(t,e);return!(!s.childCount||s.firstChild.isLeaf)&&(this.unplaced=new k(t,e+1,Math.max(n,s.size+e>=t.size-n?e+1:0)),!0)}dropNode(){let{content:t,openStart:e,openEnd:n}=this.unplaced,s=Zn(t,e);if(s.childCount<=1&&e>0){let r=t.size-e<=e+s.size;this.unplaced=new k(Fe(t,e-1,1),e-1,r?e-1:n)}else this.unplaced=new k(Fe(t,e,1),e,n)}placeNodes({sliceDepth:t,frontierDepth:e,parent:n,inject:s,wrap:r}){for(;this.depth>e;)this.closeFrontierNode();if(r)for(let m=0;m<r.length;m++)this.openFrontierNode(r[m]);let i=this.unplaced,a=n?n.content:i.content,l=i.openStart-t,c=0,d=[],{match:h,type:u}=this.frontier[e];if(s){for(let m=0;m<s.childCount;m++)d.push(s.child(m));h=h.matchFragment(s)}let f=a.size+t-(i.content.size-i.openEnd);for(;c<a.childCount;){let m=a.child(c),g=h.matchType(m.type);if(!g)break;c++,(c>1||l==0||m.content.size)&&(h=g,d.push(Si(m.mark(u.allowedMarks(m.marks)),c==1?l:0,c==a.childCount?f:-1)))}let p=c==a.childCount;p||(f=-1),this.placed=ze(this.placed,e,b.from(d)),this.frontier[e].match=h,p&&f<0&&n&&n.type==this.frontier[this.depth].type&&this.frontier.length>1&&this.closeFrontierNode();for(let m=0,g=a;m<f;m++){let y=g.lastChild;this.frontier.push({type:y.type,match:y.contentMatchAt(y.childCount)}),g=y.content}this.unplaced=p?t==0?k.empty:new k(Fe(i.content,t-1,1),t-1,f<0?i.openEnd:t-1):new k(Fe(i.content,t,c),i.openStart,i.openEnd)}mustMoveInline(){if(!this.$to.parent.isTextblock)return-1;let t,e=this.frontier[this.depth];if(!e.type.isTextblock||!ts(this.$to,this.$to.depth,e.type,e.match,!1)||this.$to.depth==this.depth&&(t=this.findCloseLevel(this.$to))&&t.depth==this.depth)return-1;let{depth:n}=this.$to,s=this.$to.after(n);for(;n>1&&s==this.$to.end(--n);)++s;return s}findCloseLevel(t){t:for(let e=Math.min(this.depth,t.depth);e>=0;e--){let{match:n,type:s}=this.frontier[e],r=e<t.depth&&t.end(e+1)==t.pos+(t.depth-(e+1)),i=ts(t,e,s,n,r);if(i){for(let a=e-1;a>=0;a--){let{match:l,type:c}=this.frontier[a],d=ts(t,a,c,l,!0);if(!d||d.childCount)continue t}return{depth:e,fit:i,move:r?t.doc.resolve(t.after(e+1)):t}}}}close(t){let e=this.findCloseLevel(t);if(!e)return null;for(;this.depth>e.depth;)this.closeFrontierNode();e.fit.childCount&&(this.placed=ze(this.placed,e.depth,e.fit)),t=e.move;for(let n=e.depth+1;n<=t.depth;n++){let s=t.node(n),r=s.type.contentMatch.fillBefore(s.content,!0,t.index(n));this.openFrontierNode(s.type,s.attrs,r)}return t}openFrontierNode(t,e=null,n){let s=this.frontier[this.depth];s.match=s.match.matchType(t),this.placed=ze(this.placed,this.depth,b.from(t.create(e,n))),this.frontier.push({type:t,match:t.contentMatch})}closeFrontierNode(){let t=this.frontier.pop().match.fillBefore(b.empty,!0);t.childCount&&(this.placed=ze(this.placed,this.frontier.length,t))}}function Fe(o,t,e){return t==0?o.cutByIndex(e,o.childCount):o.replaceChild(0,o.firstChild.copy(Fe(o.firstChild.content,t-1,e)))}function ze(o,t,e){return t==0?o.append(e):o.replaceChild(o.childCount-1,o.lastChild.copy(ze(o.lastChild.content,t-1,e)))}function Zn(o,t){for(let e=0;e<t;e++)o=o.firstChild.content;return o}function Si(o,t,e){if(t<=0)return o;let n=o.content;return t>1&&(n=n.replaceChild(0,Si(n.firstChild,t-1,n.childCount==1?e-1:0))),t>0&&(n=o.type.contentMatch.fillBefore(n).append(n),e<=0&&(n=n.append(o.type.contentMatch.matchFragment(n).fillBefore(b.empty,!0)))),o.copy(n)}function ts(o,t,e,n,s){let r=o.node(t),i=s?o.indexAfter(t):o.index(t);if(i==r.childCount&&!e.compatibleContent(r.type))return null;let a=n.fillBefore(r.content,!0,i);return a&&!function(l,c,d){for(let h=d;h<c.childCount;h++)if(!l.allowsMarks(c.child(h).marks))return!0;return!1}(e,r.content,i)?a:null}function _i(o,t,e,n,s){if(t<e){let r=o.firstChild;o=o.replaceChild(0,r.copy(_i(r.content,t+1,e,n,r)))}if(t>n){let r=s.contentMatchAt(0),i=r.fillBefore(o).append(o);o=i.append(r.matchFragment(i).fillBefore(b.empty,!0))}return o}function Lr(o,t){let e=[];for(let n=Math.min(o.depth,t.depth);n>=0;n--){let s=o.start(n);if(s<o.pos-(o.depth-n)||t.end(n)>t.pos+(t.depth-n)||o.node(n).type.spec.isolating||t.node(n).type.spec.isolating)break;(s==t.start(n)||n==o.depth&&n==t.depth&&o.parent.inlineContent&&t.parent.inlineContent&&n&&t.start(n-1)==s-1)&&e.push(n)}return e}class Te extends at{constructor(t,e,n){super(),this.pos=t,this.attr=e,this.value=n}apply(t){let e=t.nodeAt(this.pos);if(!e)return K.fail("No node at attribute step's position");let n=Object.create(null);for(let r in e.attrs)n[r]=e.attrs[r];n[this.attr]=this.value;let s=e.type.create(n,null,e.marks);return K.fromReplace(t,this.pos,this.pos+1,new k(b.from(s),0,e.isLeaf?0:1))}getMap(){return pt.empty}invert(t){return new Te(this.pos,this.attr,t.nodeAt(this.pos).attrs[this.attr])}map(t){let e=t.mapResult(this.pos,1);return e.deletedAfter?null:new Te(e.pos,this.attr,this.value)}toJSON(){return{stepType:"attr",pos:this.pos,attr:this.attr,value:this.value}}static fromJSON(t,e){if(typeof e.pos!="number"||typeof e.attr!="string")throw new RangeError("Invalid input for AttrStep.fromJSON");return new Te(e.pos,e.attr,e.value)}}at.jsonID("attr",Te);class Ge extends at{constructor(t,e){super(),this.attr=t,this.value=e}apply(t){let e=Object.create(null);for(let s in t.attrs)e[s]=t.attrs[s];e[this.attr]=this.value;let n=t.type.create(e,t.content,t.marks);return K.ok(n)}getMap(){return pt.empty}invert(t){return new Ge(this.attr,t.attrs[this.attr])}map(t){return this}toJSON(){return{stepType:"docAttr",attr:this.attr,value:this.value}}static fromJSON(t,e){if(typeof e.attr!="string")throw new RangeError("Invalid input for DocAttrStep.fromJSON");return new Ge(e.attr,e.value)}}at.jsonID("docAttr",Ge);let Le=class extends Error{};Le=function o(t){let e=Error.call(this,t);return e.__proto__=o.prototype,e},(Le.prototype=Object.create(Error.prototype)).constructor=Le,Le.prototype.name="TransformError";class Il{constructor(t){this.doc=t,this.steps=[],this.docs=[],this.mapping=new bn}get before(){return this.docs.length?this.docs[0]:this.doc}step(t){let e=this.maybeStep(t);if(e.failed)throw new Le(e.failed);return this}maybeStep(t){let e=t.apply(this.doc);return e.failed||this.addStep(t,e.doc),e}get docChanged(){return this.steps.length>0}addStep(t,e){this.docs.push(this.doc),this.steps.push(t),this.mapping.appendMap(t.getMap()),this.doc=e}replace(t,e=t,n=k.empty){let s=An(this.doc,t,e,n);return s&&this.step(s),this}replaceWith(t,e,n){return this.replace(t,e,new k(b.from(n),0,0))}delete(t,e){return this.replace(t,e,k.empty)}insert(t,e){return this.replaceWith(t,t,e)}replaceRange(t,e,n){return function(s,r,i,a){if(!a.size)return s.deleteRange(r,i);let l=s.doc.resolve(r),c=s.doc.resolve(i);if(bi(l,c,a))return s.step(new Z(r,i,a));let d=Lr(l,s.doc.resolve(i));d[d.length-1]==0&&d.pop();let h=-(l.depth+1);d.unshift(h);for(let y=l.depth,v=l.pos-1;y>0;y--,v--){let w=l.node(y).type.spec;if(w.defining||w.definingAsContext||w.isolating)break;d.indexOf(y)>-1?h=y:l.before(y)==v&&d.splice(1,0,-y)}let u=d.indexOf(h),f=[],p=a.openStart;for(let y=a.content,v=0;;v++){let w=y.firstChild;if(f.push(w),v==a.openStart)break;y=w.content}for(let y=p-1;y>=0;y--){let v=f[y],w=(m=v.type).spec.defining||m.spec.definingForContent;if(w&&!v.sameMarkup(l.node(Math.abs(h)-1)))p=y;else if(w||!v.type.isTextblock)break}var m;for(let y=a.openStart;y>=0;y--){let v=(y+p+1)%(a.openStart+1),w=f[v];if(w)for(let x=0;x<d.length;x++){let _=d[(x+u)%d.length],T=!0;_<0&&(T=!1,_=-_);let E=l.node(_-1),C=l.index(_-1);if(E.canReplaceWith(C,C,w.type,w.marks))return s.replace(l.before(_),T?c.after(_):i,new k(_i(a.content,0,a.openStart,v),v,a.openEnd))}}let g=s.steps.length;for(let y=d.length-1;y>=0&&(s.replace(r,i,a),!(s.steps.length>g));y--){let v=d[y];v<0||(r=l.before(v),i=c.after(v))}}(this,t,e,n),this}replaceRangeWith(t,e,n){return function(s,r,i,a){if(!a.isInline&&r==i&&s.doc.resolve(r).parent.content.size){let l=function(c,d,h){let u=c.resolve(d);if(u.parent.canReplaceWith(u.index(),u.index(),h))return d;if(u.parentOffset==0)for(let f=u.depth-1;f>=0;f--){let p=u.index(f);if(u.node(f).canReplaceWith(p,p,h))return u.before(f+1);if(p>0)return null}if(u.parentOffset==u.parent.content.size)for(let f=u.depth-1;f>=0;f--){let p=u.indexAfter(f);if(u.node(f).canReplaceWith(p,p,h))return u.after(f+1);if(p<u.node(f).childCount)return null}return null}(s.doc,r,a.type);l!=null&&(r=i=l)}s.replaceRange(r,i,new k(b.from(a),0,0))}(this,t,e,n),this}deleteRange(t,e){return function(n,s,r){let i=n.doc.resolve(s),a=n.doc.resolve(r),l=Lr(i,a);for(let c=0;c<l.length;c++){let d=l[c],h=c==l.length-1;if(h&&d==0||i.node(d).type.contentMatch.validEnd)return n.delete(i.start(d),a.end(d));if(d>0&&(h||i.node(d-1).canReplace(i.index(d-1),a.indexAfter(d-1))))return n.delete(i.before(d),a.after(d))}for(let c=1;c<=i.depth&&c<=a.depth;c++)if(s-i.start(c)==i.depth-c&&r>i.end(c)&&a.end(c)-r!=a.depth-c&&i.start(c-1)==a.start(c-1)&&i.node(c-1).canReplace(i.index(c-1),a.index(c-1)))return n.delete(i.before(c),r);n.delete(s,r)}(this,t,e),this}lift(t,e){return function(n,s,r){let{$from:i,$to:a,depth:l}=s,c=i.before(l+1),d=a.after(l+1),h=c,u=d,f=b.empty,p=0;for(let y=l,v=!1;y>r;y--)v||i.index(y)>0?(v=!0,f=b.from(i.node(y).copy(f)),p++):h--;let m=b.empty,g=0;for(let y=l,v=!1;y>r;y--)v||a.after(y+1)<a.end(y)?(v=!0,m=b.from(a.node(y).copy(m)),g++):u++;n.step(new tt(h,u,c,d,new k(f.append(m),p,g),f.size-p,!0))}(this,t,e),this}join(t,e=1){return function(n,s,r){let i=null,{linebreakReplacement:a}=n.doc.type.schema,l=n.doc.resolve(s-r),c=l.node().type;if(a&&c.inlineContent){let f=c.whitespace=="pre",p=!!c.contentMatch.matchType(a);f&&!p?i=!1:!f&&p&&(i=!0)}let d=n.steps.length;if(i===!1){let f=n.doc.resolve(s+r);zr(n,f.node(),f.before(),d)}c.inlineContent&&Yn(n,s+r-1,c,l.node().contentMatchAt(l.index()),i==null);let h=n.mapping.slice(d),u=h.map(s-r);if(n.step(new Z(u,h.map(s+r,-1),k.empty,!0)),i===!0){let f=n.doc.resolve(u);Fr(n,f.node(),f.before(),n.steps.length)}}(this,t,e),this}wrap(t,e){return function(n,s,r){let i=b.empty;for(let c=r.length-1;c>=0;c--){if(i.size){let d=r[c].type.contentMatch.matchFragment(i);if(!d||!d.validEnd)throw new RangeError("Wrapper type given to Transform.wrap does not form valid content of its parent wrapper")}i=b.from(r[c].type.create(r[c].attrs,i))}let a=s.start,l=s.end;n.step(new tt(a,l,a,l,new k(i,0,0),r.length,!0))}(this,t,e),this}setBlockType(t,e=t,n,s=null){return function(r,i,a,l,c){if(!l.isTextblock)throw new RangeError("Type given to setBlockType should be a textblock");let d=r.steps.length;r.doc.nodesBetween(i,a,(h,u)=>{let f=typeof c=="function"?c(h):c;if(h.isTextblock&&!h.hasMarkup(l,f)&&function(p,m,g){let y=p.resolve(m),v=y.index();return y.parent.canReplaceWith(v,v+1,g)}(r.doc,r.mapping.slice(d).map(u),l)){let p=null;if(l.schema.linebreakReplacement){let v=l.whitespace=="pre",w=!!l.contentMatch.matchType(l.schema.linebreakReplacement);v&&!w?p=!1:!v&&w&&(p=!0)}p===!1&&zr(r,h,u,d),Yn(r,r.mapping.slice(d).map(u,1),l,void 0,p===null);let m=r.mapping.slice(d),g=m.map(u,1),y=m.map(u+h.nodeSize,1);return r.step(new tt(g,y,g+1,y-1,new k(b.from(l.create(f,null,h.marks)),0,0),1,!0)),p===!0&&Fr(r,h,u,d),!1}})}(this,t,e,n,s),this}setNodeMarkup(t,e,n=null,s){return function(r,i,a,l,c){let d=r.doc.nodeAt(i);if(!d)throw new RangeError("No node at given position");a||(a=d.type);let h=a.create(l,null,c||d.marks);if(d.isLeaf)return r.replaceWith(i,i+d.nodeSize,h);if(!a.validContent(d.content))throw new RangeError("Invalid content for node type "+a.name);r.step(new tt(i,i+d.nodeSize,i+1,i+d.nodeSize-1,new k(b.from(h),0,0),1,!0))}(this,t,e,n,s),this}setNodeAttribute(t,e,n){return this.step(new Te(t,e,n)),this}setDocAttribute(t,e){return this.step(new Ge(t,e)),this}addNodeMark(t,e){return this.step(new Ft(t,e)),this}removeNodeMark(t,e){let n=this.doc.nodeAt(t);if(!n)throw new RangeError("No node at position "+t);if(e instanceof B)e.isInSet(n.marks)&&this.step(new ce(t,e));else{let s,r=n.marks,i=[];for(;s=e.isInSet(r);)i.push(new ce(t,s)),r=s.removeFromSet(r);for(let a=i.length-1;a>=0;a--)this.step(i[a])}return this}split(t,e=1,n){return function(s,r,i=1,a){let l=s.doc.resolve(r),c=b.empty,d=b.empty;for(let h=l.depth,u=l.depth-i,f=i-1;h>u;h--,f--){c=b.from(l.node(h).copy(c));let p=a&&a[f];d=b.from(p?p.type.create(p.attrs,d):l.node(h).copy(d))}s.step(new Z(r,r,new k(c.append(d),i,i),!0))}(this,t,e,n),this}addMark(t,e,n){return function(s,r,i,a){let l,c,d=[],h=[];s.doc.nodesBetween(r,i,(u,f,p)=>{if(!u.isInline)return;let m=u.marks;if(!a.isInSet(m)&&p.type.allowsMarkType(a.type)){let g=Math.max(f,r),y=Math.min(f+u.nodeSize,i),v=a.addToSet(m);for(let w=0;w<m.length;w++)m[w].isInSet(v)||(l&&l.to==g&&l.mark.eq(m[w])?l.to=y:d.push(l=new St(g,y,m[w])));c&&c.to==g?c.to=y:h.push(c=new qt(g,y,a))}}),d.forEach(u=>s.step(u)),h.forEach(u=>s.step(u))}(this,t,e,n),this}removeMark(t,e,n){return function(s,r,i,a){let l=[],c=0;s.doc.nodesBetween(r,i,(d,h)=>{if(!d.isInline)return;c++;let u=null;if(a instanceof Dn){let f,p=d.marks;for(;f=a.isInSet(p);)(u||(u=[])).push(f),p=f.removeFromSet(p)}else a?a.isInSet(d.marks)&&(u=[a]):u=d.marks;if(u&&u.length){let f=Math.min(h+d.nodeSize,i);for(let p=0;p<u.length;p++){let m,g=u[p];for(let y=0;y<l.length;y++){let v=l[y];v.step==c-1&&g.eq(l[y].style)&&(m=v)}m?(m.to=f,m.step=c):l.push({style:g,from:Math.max(h,r),to:f,step:c})}}}),l.forEach(d=>s.step(new St(d.from,d.to,d.style)))}(this,t,e,n),this}clearIncompatible(t,e,n){return Yn(this,t,e,n),this}}const es=Object.create(null);class R{constructor(t,e,n){this.$anchor=t,this.$head=e,this.ranges=n||[new Nl(t.min(e),t.max(e))]}get anchor(){return this.$anchor.pos}get head(){return this.$head.pos}get from(){return this.$from.pos}get to(){return this.$to.pos}get $from(){return this.ranges[0].$from}get $to(){return this.ranges[0].$to}get empty(){let t=this.ranges;for(let e=0;e<t.length;e++)if(t[e].$from.pos!=t[e].$to.pos)return!1;return!0}content(){return this.$from.doc.slice(this.from,this.to,!0)}replace(t,e=k.empty){let n=e.content.lastChild,s=null;for(let a=0;a<e.openEnd;a++)s=n,n=n.lastChild;let r=t.steps.length,i=this.ranges;for(let a=0;a<i.length;a++){let{$from:l,$to:c}=i[a],d=t.mapping.slice(r);t.replaceRange(d.map(l.pos),d.map(c.pos),a?k.empty:e),a==0&&Vr(t,r,(n?n.isInline:s&&s.isTextblock)?-1:1)}}replaceWith(t,e){let n=t.steps.length,s=this.ranges;for(let r=0;r<s.length;r++){let{$from:i,$to:a}=s[r],l=t.mapping.slice(n),c=l.map(i.pos),d=l.map(a.pos);r?t.deleteRange(c,d):(t.replaceRangeWith(c,d,e),Vr(t,n,e.isInline?-1:1))}}static findFrom(t,e,n=!1){let s=t.parent.inlineContent?new A(t):we(t.node(0),t.parent,t.pos,t.index(),e,n);if(s)return s;for(let r=t.depth-1;r>=0;r--){let i=e<0?we(t.node(0),t.node(r),t.before(r+1),t.index(r),e,n):we(t.node(0),t.node(r),t.after(r+1),t.index(r)+1,e,n);if(i)return i}return null}static near(t,e=1){return this.findFrom(t,e)||this.findFrom(t,-e)||new mt(t.node(0))}static atStart(t){return we(t,t,0,0,1)||new mt(t)}static atEnd(t){return we(t,t,t.content.size,t.childCount,-1)||new mt(t)}static fromJSON(t,e){if(!e||!e.type)throw new RangeError("Invalid input for Selection.fromJSON");let n=es[e.type];if(!n)throw new RangeError(`No selection type ${e.type} defined`);return n.fromJSON(t,e)}static jsonID(t,e){if(t in es)throw new RangeError("Duplicate use of selection JSON ID "+t);return es[t]=e,e.prototype.jsonID=t,e}getBookmark(){return A.between(this.$anchor,this.$head).getBookmark()}}R.prototype.visible=!0;class Nl{constructor(t,e){this.$from=t,this.$to=e}}let Br=!1;function Hr(o){Br||o.parent.inlineContent||(Br=!0,console.warn("TextSelection endpoint not pointing into a node with inline content ("+o.parent.type.name+")"))}class A extends R{constructor(t,e=t){Hr(t),Hr(e),super(t,e)}get $cursor(){return this.$anchor.pos==this.$head.pos?this.$head:null}map(t,e){let n=t.resolve(e.map(this.head));if(!n.parent.inlineContent)return R.near(n);let s=t.resolve(e.map(this.anchor));return new A(s.parent.inlineContent?s:n,n)}replace(t,e=k.empty){if(super.replace(t,e),e==k.empty){let n=this.$from.marksAcross(this.$to);n&&t.ensureMarks(n)}}eq(t){return t instanceof A&&t.anchor==this.anchor&&t.head==this.head}getBookmark(){return new Rn(this.anchor,this.head)}toJSON(){return{type:"text",anchor:this.anchor,head:this.head}}static fromJSON(t,e){if(typeof e.anchor!="number"||typeof e.head!="number")throw new RangeError("Invalid input for TextSelection.fromJSON");return new A(t.resolve(e.anchor),t.resolve(e.head))}static create(t,e,n=e){let s=t.resolve(e);return new this(s,n==e?s:t.resolve(n))}static between(t,e,n){let s=t.pos-e.pos;if(n&&!s||(n=s>=0?1:-1),!e.parent.inlineContent){let r=R.findFrom(e,n,!0)||R.findFrom(e,-n,!0);if(!r)return R.near(e,n);e=r.$head}return t.parent.inlineContent||(s==0||(t=(R.findFrom(t,-n,!0)||R.findFrom(t,n,!0)).$anchor).pos<e.pos!=s<0)&&(t=e),new A(t,e)}}R.jsonID("text",A);class Rn{constructor(t,e){this.anchor=t,this.head=e}map(t){return new Rn(t.map(this.anchor),t.map(this.head))}resolve(t){return A.between(t.resolve(this.anchor),t.resolve(this.head))}}class I extends R{constructor(t){let e=t.nodeAfter,n=t.node(0).resolve(t.pos+e.nodeSize);super(t,n),this.node=e}map(t,e){let{deleted:n,pos:s}=e.mapResult(this.anchor),r=t.resolve(s);return n?R.near(r):new I(r)}content(){return new k(b.from(this.node),0,0)}eq(t){return t instanceof I&&t.anchor==this.anchor}toJSON(){return{type:"node",anchor:this.anchor}}getBookmark(){return new Ys(this.anchor)}static fromJSON(t,e){if(typeof e.anchor!="number")throw new RangeError("Invalid input for NodeSelection.fromJSON");return new I(t.resolve(e.anchor))}static create(t,e){return new I(t.resolve(e))}static isSelectable(t){return!t.isText&&t.type.spec.selectable!==!1}}I.prototype.visible=!1,R.jsonID("node",I);class Ys{constructor(t){this.anchor=t}map(t){let{deleted:e,pos:n}=t.mapResult(this.anchor);return e?new Rn(n,n):new Ys(n)}resolve(t){let e=t.resolve(this.anchor),n=e.nodeAfter;return n&&I.isSelectable(n)?new I(e):R.near(e)}}class mt extends R{constructor(t){super(t.resolve(0),t.resolve(t.content.size))}replace(t,e=k.empty){if(e==k.empty){t.delete(0,t.doc.content.size);let n=R.atStart(t.doc);n.eq(t.selection)||t.setSelection(n)}else super.replace(t,e)}toJSON(){return{type:"all"}}static fromJSON(t){return new mt(t)}map(t){return new mt(t)}eq(t){return t instanceof mt}getBookmark(){return Dl}}R.jsonID("all",mt);const Dl={map(){return this},resolve:o=>new mt(o)};function we(o,t,e,n,s,r=!1){if(t.inlineContent)return A.create(o,e);for(let i=n-(s>0?0:1);s>0?i<t.childCount:i>=0;i+=s){let a=t.child(i);if(a.isAtom){if(!r&&I.isSelectable(a))return I.create(o,e-(s<0?a.nodeSize:0))}else{let l=we(o,a,e+s,s<0?a.childCount:0,s,r);if(l)return l}e+=a.nodeSize*s}return null}function Vr(o,t,e){let n=o.steps.length-1;if(n<t)return;let s,r=o.steps[n];(r instanceof Z||r instanceof tt)&&(o.mapping.maps[n].forEach((i,a,l,c)=>{s==null&&(s=c)}),o.setSelection(R.near(o.doc.resolve(s),e)))}class Al extends Il{constructor(t){super(t.doc),this.curSelectionFor=0,this.updated=0,this.meta=Object.create(null),this.time=Date.now(),this.curSelection=t.selection,this.storedMarks=t.storedMarks}get selection(){return this.curSelectionFor<this.steps.length&&(this.curSelection=this.curSelection.map(this.doc,this.mapping.slice(this.curSelectionFor)),this.curSelectionFor=this.steps.length),this.curSelection}setSelection(t){if(t.$from.doc!=this.doc)throw new RangeError("Selection passed to setSelection must point at the current document");return this.curSelection=t,this.curSelectionFor=this.steps.length,this.updated=-3&this.updated|1,this.storedMarks=null,this}get selectionSet(){return(1&this.updated)>0}setStoredMarks(t){return this.storedMarks=t,this.updated|=2,this}ensureMarks(t){return B.sameSet(this.storedMarks||this.selection.$from.marks(),t)||this.setStoredMarks(t),this}addStoredMark(t){return this.ensureMarks(t.addToSet(this.storedMarks||this.selection.$head.marks()))}removeStoredMark(t){return this.ensureMarks(t.removeFromSet(this.storedMarks||this.selection.$head.marks()))}get storedMarksSet(){return(2&this.updated)>0}addStep(t,e){super.addStep(t,e),this.updated=-3&this.updated,this.storedMarks=null}setTime(t){return this.time=t,this}replaceSelection(t){return this.selection.replace(this,t),this}replaceSelectionWith(t,e=!0){let n=this.selection;return e&&(t=t.mark(this.storedMarks||(n.empty?n.$from.marks():n.$from.marksAcross(n.$to)||B.none))),n.replaceWith(this,t),this}deleteSelection(){return this.selection.replace(this),this}insertText(t,e,n){let s=this.doc.type.schema;if(e==null)return t?this.replaceSelectionWith(s.text(t),!0):this.deleteSelection();{if(n==null&&(n=e),n=n??e,!t)return this.deleteRange(e,n);let r=this.storedMarks;if(!r){let i=this.doc.resolve(e);r=n==e?i.marks():i.marksAcross(this.doc.resolve(n))}return this.replaceRangeWith(e,n,s.text(t,r)),this.selection.empty||this.setSelection(R.near(this.selection.$to)),this}}setMeta(t,e){return this.meta[typeof t=="string"?t:t.key]=e,this}getMeta(t){return this.meta[typeof t=="string"?t:t.key]}get isGeneric(){for(let t in this.meta)return!1;return!0}scrollIntoView(){return this.updated|=4,this}get scrolledIntoView(){return(4&this.updated)>0}}function Ur(o,t){return t&&o?o.bind(t):o}class Be{constructor(t,e,n){this.name=t,this.init=Ur(e.init,n),this.apply=Ur(e.apply,n)}}const Rl=[new Be("doc",{init:o=>o.doc||o.schema.topNodeType.createAndFill(),apply:o=>o.doc}),new Be("selection",{init:(o,t)=>o.selection||R.atStart(t.doc),apply:o=>o.selection}),new Be("storedMarks",{init:o=>o.storedMarks||null,apply:(o,t,e,n)=>n.selection.$cursor?o.storedMarks:null}),new Be("scrollToSelection",{init:()=>0,apply:(o,t)=>o.scrolledIntoView?t+1:t})];class ns{constructor(t,e){this.schema=t,this.plugins=[],this.pluginsByKey=Object.create(null),this.fields=Rl.slice(),e&&e.forEach(n=>{if(this.pluginsByKey[n.key])throw new RangeError("Adding different instances of a keyed plugin ("+n.key+")");this.plugins.push(n),this.pluginsByKey[n.key]=n,n.spec.state&&this.fields.push(new Be(n.key,n.spec.state,n))})}}class Ce{constructor(t){this.config=t}get schema(){return this.config.schema}get plugins(){return this.config.plugins}apply(t){return this.applyTransaction(t).state}filterTransaction(t,e=-1){for(let n=0;n<this.config.plugins.length;n++)if(n!=e){let s=this.config.plugins[n];if(s.spec.filterTransaction&&!s.spec.filterTransaction.call(s,t,this))return!1}return!0}applyTransaction(t){if(!this.filterTransaction(t))return{state:this,transactions:[]};let e=[t],n=this.applyInner(t),s=null;for(;;){let r=!1;for(let i=0;i<this.config.plugins.length;i++){let a=this.config.plugins[i];if(a.spec.appendTransaction){let l=s?s[i].n:0,c=s?s[i].state:this,d=l<e.length&&a.spec.appendTransaction.call(a,l?e.slice(l):e,c,n);if(d&&n.filterTransaction(d,i)){if(d.setMeta("appendedTransaction",t),!s){s=[];for(let h=0;h<this.config.plugins.length;h++)s.push(h<i?{state:n,n:e.length}:{state:this,n:0})}e.push(d),n=n.applyInner(d),r=!0}s&&(s[i]={state:n,n:e.length})}}if(!r)return{state:n,transactions:e}}}applyInner(t){if(!t.before.eq(this.doc))throw new RangeError("Applying a mismatched transaction");let e=new Ce(this.config),n=this.config.fields;for(let s=0;s<n.length;s++){let r=n[s];e[r.name]=r.apply(t,this[r.name],this,e)}return e}get tr(){return new Al(this)}static create(t){let e=new ns(t.doc?t.doc.type.schema:t.schema,t.plugins),n=new Ce(e);for(let s=0;s<e.fields.length;s++)n[e.fields[s].name]=e.fields[s].init(t,n);return n}reconfigure(t){let e=new ns(this.schema,t.plugins),n=e.fields,s=new Ce(e);for(let r=0;r<n.length;r++){let i=n[r].name;s[i]=this.hasOwnProperty(i)?this[i]:n[r].init(t,s)}return s}toJSON(t){let e={doc:this.doc.toJSON(),selection:this.selection.toJSON()};if(this.storedMarks&&(e.storedMarks=this.storedMarks.map(n=>n.toJSON())),t&&typeof t=="object")for(let n in t){if(n=="doc"||n=="selection")throw new RangeError("The JSON fields `doc` and `selection` are reserved");let s=t[n],r=s.spec.state;r&&r.toJSON&&(e[n]=r.toJSON.call(s,this[s.key]))}return e}static fromJSON(t,e,n){if(!e)throw new RangeError("Invalid input for EditorState.fromJSON");if(!t.schema)throw new RangeError("Required config field 'schema' missing");let s=new ns(t.schema,t.plugins),r=new Ce(s);return s.fields.forEach(i=>{if(i.name=="doc")r.doc=oe.fromJSON(t.schema,e.doc);else if(i.name=="selection")r.selection=R.fromJSON(r.doc,e.selection);else if(i.name=="storedMarks")e.storedMarks&&(r.storedMarks=e.storedMarks.map(t.schema.markFromJSON));else{if(n)for(let a in n){let l=n[a],c=l.spec.state;if(l.key==i.name&&c&&c.fromJSON&&Object.prototype.hasOwnProperty.call(e,a))return void(r[i.name]=c.fromJSON.call(l,t,e[a],r))}r[i.name]=i.init(t,r)}}),r}}function Ci(o,t,e){for(let n in o){let s=o[n];s instanceof Function?s=s.bind(t):n=="handleDOMEvents"&&(s=Ci(s,t,{})),e[n]=s}return e}class Ut{constructor(t){this.spec=t,this.props={},t.props&&Ci(t.props,this,this.props),this.key=t.key?t.key.key:ki("plugin")}getState(t){return t[this.key]}}const ss=Object.create(null);function ki(o){return o in ss?o+"$"+ ++ss[o]:(ss[o]=0,o+"$")}class tn{constructor(t="key"){this.key=ki(t)}get(t){return t.config.pluginsByKey[this.key]}getState(t){return t[this.key]}}const ot=function(o){for(var t=0;;t++)if(!(o=o.previousSibling))return t},Xe=function(o){let t=o.assignedSlot||o.parentNode;return t&&t.nodeType==11?t.host:t};let Is=null;const Mt=function(o,t,e){let n=Is||(Is=document.createRange());return n.setEnd(o,e??o.nodeValue.length),n.setStart(o,t||0),n},he=function(o,t,e,n){return e&&(jr(o,t,e,n,-1)||jr(o,t,e,n,1))},Pl=/^(img|br|input|textarea|hr)$/i;function jr(o,t,e,n,s){for(;;){if(o==e&&t==n)return!0;if(t==(s<0?0:bt(o))){let r=o.parentNode;if(!r||r.nodeType!=1||Qe(o)||Pl.test(o.nodeName)||o.contentEditable=="false")return!1;t=ot(o)+(s<0?0:1),o=r}else{if(o.nodeType!=1||(o=o.childNodes[t+(s<0?-1:0)]).contentEditable=="false")return!1;t=s<0?bt(o):0}}}function bt(o){return o.nodeType==3?o.nodeValue.length:o.childNodes.length}function Qe(o){let t;for(let e=o;e&&!(t=e.pmViewDesc);e=e.parentNode);return t&&t.node&&t.node.isBlock&&(t.dom==o||t.contentDOM==o)}const Pn=function(o){return o.focusNode&&he(o.focusNode,o.focusOffset,o.anchorNode,o.anchorOffset)};function Xt(o,t){let e=document.createEvent("Event");return e.initEvent("keydown",!0,!0),e.keyCode=o,e.key=e.code=t,e}const _t=typeof navigator<"u"?navigator:null,Wr=typeof document<"u"?document:null,jt=_t&&_t.userAgent||"",Ns=/Edge\/(\d+)/.exec(jt),Mi=/MSIE \d/.exec(jt),Ds=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(jt),ut=!!(Mi||Ds||Ns),Lt=Mi?document.documentMode:Ds?+Ds[1]:Ns?+Ns[1]:0,vt=!ut&&/gecko\/(\d+)/i.test(jt);vt&&(/Firefox\/(\d+)/.exec(jt)||[0,0])[1];const As=!ut&&/Chrome\/(\d+)/.exec(jt),lt=!!As,$l=As?+As[1]:0,ht=!ut&&!!_t&&/Apple Computer/.test(_t.vendor),Ne=ht&&(/Mobile\/\w+/.test(jt)||!!_t&&_t.maxTouchPoints>2),ft=Ne||!!_t&&/Mac/.test(_t.platform),ql=!!_t&&/Win/.test(_t.platform),gt=/Android \d/.test(jt),en=!!Wr&&"webkitFontSmoothing"in Wr.documentElement.style,Fl=en?+(/\bAppleWebKit\/(\d+)/.exec(navigator.userAgent)||[0,0])[1]:0;function zl(o){let t=o.defaultView&&o.defaultView.visualViewport;return t?{left:0,right:t.width,top:0,bottom:t.height}:{left:0,right:o.documentElement.clientWidth,top:0,bottom:o.documentElement.clientHeight}}function Ct(o,t){return typeof o=="number"?o:o[t]}function Ll(o){let t=o.getBoundingClientRect(),e=t.width/o.offsetWidth||1,n=t.height/o.offsetHeight||1;return{left:t.left,right:t.left+o.clientWidth*e,top:t.top,bottom:t.top+o.clientHeight*n}}function Jr(o,t,e){let n=o.someProp("scrollThreshold")||0,s=o.someProp("scrollMargin")||5,r=o.dom.ownerDocument;for(let i=e||o.dom;i;i=Xe(i)){if(i.nodeType!=1)continue;let a=i,l=a==r.body,c=l?zl(r):Ll(a),d=0,h=0;if(t.top<c.top+Ct(n,"top")?h=-(c.top-t.top+Ct(s,"top")):t.bottom>c.bottom-Ct(n,"bottom")&&(h=t.bottom-t.top>c.bottom-c.top?t.top+Ct(s,"top")-c.top:t.bottom-c.bottom+Ct(s,"bottom")),t.left<c.left+Ct(n,"left")?d=-(c.left-t.left+Ct(s,"left")):t.right>c.right-Ct(n,"right")&&(d=t.right-c.right+Ct(s,"right")),d||h)if(l)r.defaultView.scrollBy(d,h);else{let u=a.scrollLeft,f=a.scrollTop;h&&(a.scrollTop+=h),d&&(a.scrollLeft+=d);let p=a.scrollLeft-u,m=a.scrollTop-f;t={left:t.left-p,top:t.top-m,right:t.right-p,bottom:t.bottom-m}}if(l||/^(fixed|sticky)$/.test(getComputedStyle(i).position))break}}function Kr(o){let t=[],e=o.ownerDocument;for(let n=o;n&&(t.push({dom:n,top:n.scrollTop,left:n.scrollLeft}),o!=e);n=Xe(n));return t}function Gr(o,t){for(let e=0;e<o.length;e++){let{dom:n,top:s,left:r}=o[e];n.scrollTop!=s+t&&(n.scrollTop=s+t),n.scrollLeft!=r&&(n.scrollLeft=r)}}let ge=null;function Ti(o,t){let e,n,s,r,i=2e8,a=0,l=t.top,c=t.top;for(let d=o.firstChild,h=0;d;d=d.nextSibling,h++){let u;if(d.nodeType==1)u=d.getClientRects();else{if(d.nodeType!=3)continue;u=Mt(d).getClientRects()}for(let f=0;f<u.length;f++){let p=u[f];if(p.top<=l&&p.bottom>=c){l=Math.max(p.bottom,l),c=Math.min(p.top,c);let m=p.left>t.left?p.left-t.left:p.right<t.left?t.left-p.right:0;if(m<i){e=d,i=m,n=m&&e.nodeType==3?{left:p.right<t.left?p.right:p.left,top:t.top}:t,d.nodeType==1&&m&&(a=h+(t.left>=(p.left+p.right)/2?1:0));continue}}else p.top>t.top&&!s&&p.left<=t.left&&p.right>=t.left&&(s=d,r={left:Math.max(p.left,Math.min(p.right,t.left)),top:p.top});!e&&(t.left>=p.right&&t.top>=p.top||t.left>=p.left&&t.top>=p.bottom)&&(a=h+1)}}return!e&&s&&(e=s,n=r,i=0),e&&e.nodeType==3?function(d,h){let u=d.nodeValue.length,f=document.createRange();for(let p=0;p<u;p++){f.setEnd(d,p+1),f.setStart(d,p);let m=Nt(f,1);if(m.top!=m.bottom&&Zs(h,m))return{node:d,offset:p+(h.left>=(m.left+m.right)/2?1:0)}}return{node:d,offset:0}}(e,n):!e||i&&e.nodeType==1?{node:o,offset:a}:Ti(e,n)}function Zs(o,t){return o.left>=t.left-1&&o.left<=t.right+1&&o.top>=t.top-1&&o.top<=t.bottom+1}function Ei(o,t,e){let n=o.childNodes.length;if(n&&e.top<e.bottom)for(let s=Math.max(0,Math.min(n-1,Math.floor(n*(t.top-e.top)/(e.bottom-e.top))-2)),r=s;;){let i=o.childNodes[r];if(i.nodeType==1){let a=i.getClientRects();for(let l=0;l<a.length;l++){let c=a[l];if(Zs(t,c))return Ei(i,t,c)}}if((r=(r+1)%n)==s)break}return o}function Bl(o,t){let e,n=o.dom.ownerDocument,s=0,r=function(c,d,h){if(c.caretPositionFromPoint)try{let u=c.caretPositionFromPoint(d,h);if(u)return{node:u.offsetNode,offset:u.offset}}catch{}if(c.caretRangeFromPoint){let u=c.caretRangeFromPoint(d,h);if(u)return{node:u.startContainer,offset:u.startOffset}}}(n,t.left,t.top);r&&({node:e,offset:s}=r);let i,a=(o.root.elementFromPoint?o.root:n).elementFromPoint(t.left,t.top);if(!a||!o.dom.contains(a.nodeType!=1?a.parentNode:a)){let c=o.dom.getBoundingClientRect();if(!Zs(t,c)||(a=Ei(o.dom,t,c),!a))return null}if(ht)for(let c=a;e&&c;c=Xe(c))c.draggable&&(e=void 0);if(a=function(c,d){let h=c.parentNode;return h&&/^li$/i.test(h.nodeName)&&d.left<c.getBoundingClientRect().left?h:c}(a,t),e){if(vt&&e.nodeType==1&&(s=Math.min(s,e.childNodes.length),s<e.childNodes.length)){let d,h=e.childNodes[s];h.nodeName=="IMG"&&(d=h.getBoundingClientRect()).right<=t.left&&d.bottom>t.top&&s++}let c;en&&s&&e.nodeType==1&&(c=e.childNodes[s-1]).nodeType==1&&c.contentEditable=="false"&&c.getBoundingClientRect().top>=t.top&&s--,e==o.dom&&s==e.childNodes.length-1&&e.lastChild.nodeType==1&&t.top>e.lastChild.getBoundingClientRect().bottom?i=o.state.doc.content.size:s!=0&&e.nodeType==1&&e.childNodes[s-1].nodeName=="BR"||(i=function(d,h,u,f){let p=-1;for(let m=h,g=!1;m!=d.dom;){let y=d.docView.nearestDesc(m,!0);if(!y)return null;if(y.dom.nodeType==1&&(y.node.isBlock&&y.parent&&!g||!y.contentDOM)){let v=y.dom.getBoundingClientRect();if(y.node.isBlock&&y.parent&&!g&&(g=!0,v.left>f.left||v.top>f.top?p=y.posBefore:(v.right<f.left||v.bottom<f.top)&&(p=y.posAfter)),!y.contentDOM&&p<0&&!y.node.isText)return(y.node.isBlock?f.top<(v.top+v.bottom)/2:f.left<(v.left+v.right)/2)?y.posBefore:y.posAfter}m=y.dom.parentNode}return p>-1?p:d.docView.posFromDOM(h,u,-1)}(o,e,s,t))}i==null&&(i=function(c,d,h){let{node:u,offset:f}=Ti(d,h),p=-1;if(u.nodeType==1&&!u.firstChild){let m=u.getBoundingClientRect();p=m.left!=m.right&&h.left>(m.left+m.right)/2?1:-1}return c.docView.posFromDOM(u,f,p)}(o,a,t));let l=o.docView.nearestDesc(a,!0);return{pos:i,inside:l?l.posAtStart-l.border:-1}}function Xr(o){return o.top<o.bottom||o.left<o.right}function Nt(o,t){let e=o.getClientRects();if(e.length){let n=e[t<0?0:e.length-1];if(Xr(n))return n}return Array.prototype.find.call(e,Xr)||o.getBoundingClientRect()}const Hl=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/;function Oi(o,t,e){let{node:n,offset:s,atom:r}=o.docView.domFromPos(t,e<0?-1:1),i=en||vt;if(n.nodeType==3){if(!i||!Hl.test(n.nodeValue)&&(e<0?s:s!=n.nodeValue.length)){let a=s,l=s,c=e<0?1:-1;return e<0&&!s?(l++,c=-1):e>=0&&s==n.nodeValue.length?(a--,c=1):e<0?a--:l++,Pe(Nt(Mt(n,a,l),c),c<0)}{let a=Nt(Mt(n,s,s),e);if(vt&&s&&/\s/.test(n.nodeValue[s-1])&&s<n.nodeValue.length){let l=Nt(Mt(n,s-1,s-1),-1);if(l.top==a.top){let c=Nt(Mt(n,s,s+1),-1);if(c.top!=a.top)return Pe(c,c.left<l.left)}}return a}}if(!o.state.doc.resolve(t-(r||0)).parent.inlineContent){if(r==null&&s&&(e<0||s==bt(n))){let a=n.childNodes[s-1];if(a.nodeType==1)return rs(a.getBoundingClientRect(),!1)}if(r==null&&s<bt(n)){let a=n.childNodes[s];if(a.nodeType==1)return rs(a.getBoundingClientRect(),!0)}return rs(n.getBoundingClientRect(),e>=0)}if(r==null&&s&&(e<0||s==bt(n))){let a=n.childNodes[s-1],l=a.nodeType==3?Mt(a,bt(a)-(i?0:1)):a.nodeType!=1||a.nodeName=="BR"&&a.nextSibling?null:a;if(l)return Pe(Nt(l,1),!1)}if(r==null&&s<bt(n)){let a=n.childNodes[s];for(;a.pmViewDesc&&a.pmViewDesc.ignoreForCoords;)a=a.nextSibling;let l=a?a.nodeType==3?Mt(a,0,i?0:1):a.nodeType==1?a:null:null;if(l)return Pe(Nt(l,-1),!0)}return Pe(Nt(n.nodeType==3?Mt(n):n,-e),e>=0)}function Pe(o,t){if(o.width==0)return o;let e=t?o.left:o.right;return{top:o.top,bottom:o.bottom,left:e,right:e}}function rs(o,t){if(o.height==0)return o;let e=t?o.top:o.bottom;return{top:e,bottom:e,left:o.left,right:o.right}}function Qr(o,t,e){let n=o.state,s=o.root.activeElement;n!=t&&o.updateState(t),s!=o.dom&&o.focus();try{return e()}finally{n!=t&&o.updateState(n),s!=o.dom&&s&&s.focus()}}const Vl=/[\u0590-\u08ac]/;let Yr=null,Zr=null,to=!1;function Ul(o,t,e){return Yr==t&&Zr==e?to:(Yr=t,Zr=e,to=e=="up"||e=="down"?function(n,s,r){let i=s.selection,a=r=="up"?i.$from:i.$to;return Qr(n,s,()=>{let{node:l}=n.docView.domFromPos(a.pos,r=="up"?-1:1);for(;;){let d=n.docView.nearestDesc(l,!0);if(!d)break;if(d.node.isBlock){l=d.contentDOM||d.dom;break}l=d.dom.parentNode}let c=Oi(n,a.pos,1);for(let d=l.firstChild;d;d=d.nextSibling){let h;if(d.nodeType==1)h=d.getClientRects();else{if(d.nodeType!=3)continue;h=Mt(d,0,d.nodeValue.length).getClientRects()}for(let u=0;u<h.length;u++){let f=h[u];if(f.bottom>f.top+1&&(r=="up"?c.top-f.top>2*(f.bottom-c.top):f.bottom-c.bottom>2*(c.bottom-f.top)))return!1}}return!0})}(o,t,e):function(n,s,r){let{$head:i}=s.selection;if(!i.parent.isTextblock)return!1;let a=i.parentOffset,l=!a,c=a==i.parent.content.size,d=n.domSelection();return Vl.test(i.parent.textContent)&&d.modify?Qr(n,s,()=>{let{focusNode:h,focusOffset:u,anchorNode:f,anchorOffset:p}=n.domSelectionRange(),m=d.caretBidiLevel;d.modify("move",r,"character");let g=i.depth?n.docView.domAfterPos(i.before()):n.dom,{focusNode:y,focusOffset:v}=n.domSelectionRange(),w=y&&!g.contains(y.nodeType==1?y:y.parentNode)||h==y&&u==v;try{d.collapse(f,p),h&&(h!=f||u!=p)&&d.extend&&d.extend(h,u)}catch{}return m!=null&&(d.caretBidiLevel=m),w}):r=="left"||r=="backward"?l:c}(o,t,e))}class nn{constructor(t,e,n,s){this.parent=t,this.children=e,this.dom=n,this.contentDOM=s,this.dirty=0,n.pmViewDesc=this}matchesWidget(t){return!1}matchesMark(t){return!1}matchesNode(t,e,n){return!1}matchesHack(t){return!1}parseRule(){return null}stopEvent(t){return!1}get size(){let t=0;for(let e=0;e<this.children.length;e++)t+=this.children[e].size;return t}get border(){return 0}destroy(){this.parent=void 0,this.dom.pmViewDesc==this&&(this.dom.pmViewDesc=void 0);for(let t=0;t<this.children.length;t++)this.children[t].destroy()}posBeforeChild(t){for(let e=0,n=this.posAtStart;;e++){let s=this.children[e];if(s==t)return n;n+=s.size}}get posBefore(){return this.parent.posBeforeChild(this)}get posAtStart(){return this.parent?this.parent.posBeforeChild(this)+this.border:0}get posAfter(){return this.posBefore+this.size}get posAtEnd(){return this.posAtStart+this.size-2*this.border}localPosFromDOM(t,e,n){if(this.contentDOM&&this.contentDOM.contains(t.nodeType==1?t:t.parentNode)){if(n<0){let r,i;if(t==this.contentDOM)r=t.childNodes[e-1];else{for(;t.parentNode!=this.contentDOM;)t=t.parentNode;r=t.previousSibling}for(;r&&(!(i=r.pmViewDesc)||i.parent!=this);)r=r.previousSibling;return r?this.posBeforeChild(i)+i.size:this.posAtStart}{let r,i;if(t==this.contentDOM)r=t.childNodes[e];else{for(;t.parentNode!=this.contentDOM;)t=t.parentNode;r=t.nextSibling}for(;r&&(!(i=r.pmViewDesc)||i.parent!=this);)r=r.nextSibling;return r?this.posBeforeChild(i):this.posAtEnd}}let s;if(t==this.dom&&this.contentDOM)s=e>ot(this.contentDOM);else if(this.contentDOM&&this.contentDOM!=this.dom&&this.dom.contains(this.contentDOM))s=2&t.compareDocumentPosition(this.contentDOM);else if(this.dom.firstChild){if(e==0)for(let r=t;;r=r.parentNode){if(r==this.dom){s=!1;break}if(r.previousSibling)break}if(s==null&&e==t.childNodes.length)for(let r=t;;r=r.parentNode){if(r==this.dom){s=!0;break}if(r.nextSibling)break}}return s??n>0?this.posAtEnd:this.posAtStart}nearestDesc(t,e=!1){for(let n=!0,s=t;s;s=s.parentNode){let r,i=this.getDesc(s);if(i&&(!e||i.node)){if(!n||!(r=i.nodeDOM)||(r.nodeType==1?r.contains(t.nodeType==1?t:t.parentNode):r==t))return i;n=!1}}}getDesc(t){let e=t.pmViewDesc;for(let n=e;n;n=n.parent)if(n==this)return e}posFromDOM(t,e,n){for(let s=t;s;s=s.parentNode){let r=this.getDesc(s);if(r)return r.localPosFromDOM(t,e,n)}return-1}descAt(t){for(let e=0,n=0;e<this.children.length;e++){let s=this.children[e],r=n+s.size;if(n==t&&r!=n){for(;!s.border&&s.children.length;)s=s.children[0];return s}if(t<r)return s.descAt(t-n-s.border);n=r}}domFromPos(t,e){if(!this.contentDOM)return{node:this.dom,offset:0,atom:t+1};let n=0,s=0;for(let r=0;n<this.children.length;n++){let i=this.children[n],a=r+i.size;if(a>t||i instanceof Ni){s=t-r;break}r=a}if(s)return this.children[n].domFromPos(s-this.children[n].border,e);for(let r;n&&!(r=this.children[n-1]).size&&r instanceof Ii&&r.side>=0;n--);if(e<=0){let r,i=!0;for(;r=n?this.children[n-1]:null,r&&r.dom.parentNode!=this.contentDOM;n--,i=!1);return r&&e&&i&&!r.border&&!r.domAtom?r.domFromPos(r.size,e):{node:this.contentDOM,offset:r?ot(r.dom)+1:0}}{let r,i=!0;for(;r=n<this.children.length?this.children[n]:null,r&&r.dom.parentNode!=this.contentDOM;n++,i=!1);return r&&i&&!r.border&&!r.domAtom?r.domFromPos(0,e):{node:this.contentDOM,offset:r?ot(r.dom):this.contentDOM.childNodes.length}}}parseRange(t,e,n=0){if(this.children.length==0)return{node:this.contentDOM,from:t,to:e,fromOffset:0,toOffset:this.contentDOM.childNodes.length};let s=-1,r=-1;for(let i=n,a=0;;a++){let l=this.children[a],c=i+l.size;if(s==-1&&t<=c){let d=i+l.border;if(t>=d&&e<=c-l.border&&l.node&&l.contentDOM&&this.contentDOM.contains(l.contentDOM))return l.parseRange(t,e,d);t=i;for(let h=a;h>0;h--){let u=this.children[h-1];if(u.size&&u.dom.parentNode==this.contentDOM&&!u.emptyChildAt(1)){s=ot(u.dom)+1;break}t-=u.size}s==-1&&(s=0)}if(s>-1&&(c>e||a==this.children.length-1)){e=c;for(let d=a+1;d<this.children.length;d++){let h=this.children[d];if(h.size&&h.dom.parentNode==this.contentDOM&&!h.emptyChildAt(-1)){r=ot(h.dom);break}e+=h.size}r==-1&&(r=this.contentDOM.childNodes.length);break}i=c}return{node:this.contentDOM,from:t,to:e,fromOffset:s,toOffset:r}}emptyChildAt(t){if(this.border||!this.contentDOM||!this.children.length)return!1;let e=this.children[t<0?0:this.children.length-1];return e.size==0||e.emptyChildAt(t)}domAfterPos(t){let{node:e,offset:n}=this.domFromPos(t,0);if(e.nodeType!=1||n==e.childNodes.length)throw new RangeError("No node after pos "+t);return e.childNodes[n]}setSelection(t,e,n,s=!1){let r=Math.min(t,e),i=Math.max(t,e);for(let u=0,f=0;u<this.children.length;u++){let p=this.children[u],m=f+p.size;if(r>f&&i<m)return p.setSelection(t-f-p.border,e-f-p.border,n,s);f=m}let a=this.domFromPos(t,t?-1:1),l=e==t?a:this.domFromPos(e,e?-1:1),c=n.getSelection(),d=!1;if((vt||ht)&&t==e){let{node:u,offset:f}=a;if(u.nodeType==3){if(d=!(!f||u.nodeValue[f-1]!=`
`),d&&f==u.nodeValue.length)for(let p,m=u;m;m=m.parentNode){if(p=m.nextSibling){p.nodeName=="BR"&&(a=l={node:p.parentNode,offset:ot(p)+1});break}let g=m.pmViewDesc;if(g&&g.node&&g.node.isBlock)break}}else{let p=u.childNodes[f-1];d=p&&(p.nodeName=="BR"||p.contentEditable=="false")}}if(vt&&c.focusNode&&c.focusNode!=l.node&&c.focusNode.nodeType==1){let u=c.focusNode.childNodes[c.focusOffset];u&&u.contentEditable=="false"&&(s=!0)}if(!(s||d&&ht)&&he(a.node,a.offset,c.anchorNode,c.anchorOffset)&&he(l.node,l.offset,c.focusNode,c.focusOffset))return;let h=!1;if((c.extend||t==e)&&!d){c.collapse(a.node,a.offset);try{t!=e&&c.extend(l.node,l.offset),h=!0}catch{}}if(!h){if(t>e){let f=a;a=l,l=f}let u=document.createRange();u.setEnd(l.node,l.offset),u.setStart(a.node,a.offset),c.removeAllRanges(),c.addRange(u)}}ignoreMutation(t){return!this.contentDOM&&t.type!="selection"}get contentLost(){return this.contentDOM&&this.contentDOM!=this.dom&&!this.dom.contains(this.contentDOM)}markDirty(t,e){for(let n=0,s=0;s<this.children.length;s++){let r=this.children[s],i=n+r.size;if(n==i?t<=i&&e>=n:t<i&&e>n){let a=n+r.border,l=i-r.border;if(t>=a&&e<=l)return this.dirty=t==n||e==i?2:1,void(t!=a||e!=l||!r.contentLost&&r.dom.parentNode==this.contentDOM?r.markDirty(t-a,e-a):r.dirty=3);r.dirty=r.dom!=r.contentDOM||r.dom.parentNode!=this.contentDOM||r.children.length?3:2}n=i}this.dirty=2}markParentsDirty(){let t=1;for(let e=this.parent;e;e=e.parent,t++){let n=t==1?2:1;e.dirty<n&&(e.dirty=n)}}get domAtom(){return!1}get ignoreForCoords(){return!1}isText(t){return!1}}class Ii extends nn{constructor(t,e,n,s){let r,i=e.type.toDOM;if(typeof i=="function"&&(i=i(n,()=>r?r.parent?r.parent.posBeforeChild(r):void 0:s)),!e.type.spec.raw){if(i.nodeType!=1){let a=document.createElement("span");a.appendChild(i),i=a}i.contentEditable="false",i.classList.add("ProseMirror-widget")}super(t,[],i,null),this.widget=e,this.widget=e,r=this}matchesWidget(t){return this.dirty==0&&t.type.eq(this.widget.type)}parseRule(){return{ignore:!0}}stopEvent(t){let e=this.widget.spec.stopEvent;return!!e&&e(t)}ignoreMutation(t){return t.type!="selection"||this.widget.spec.ignoreSelection}destroy(){this.widget.type.destroy(this.dom),super.destroy()}get domAtom(){return!0}get side(){return this.widget.type.side}}class jl extends nn{constructor(t,e,n,s){super(t,[],e,null),this.textDOM=n,this.text=s}get size(){return this.text.length}localPosFromDOM(t,e){return t!=this.textDOM?this.posAtStart+(e?this.size:0):this.posAtStart+e}domFromPos(t){return{node:this.textDOM,offset:t}}ignoreMutation(t){return t.type==="characterData"&&t.target.nodeValue==t.oldValue}}class ie extends nn{constructor(t,e,n,s){super(t,[],n,s),this.mark=e}static create(t,e,n,s){let r=s.nodeViews[e.type.name],i=r&&r(e,s,n);return i&&i.dom||(i=ue.renderSpec(document,e.type.spec.toDOM(e,n))),new ie(t,e,i.dom,i.contentDOM||i.dom)}parseRule(){return 3&this.dirty||this.mark.type.spec.reparseInView?null:{mark:this.mark.type.name,attrs:this.mark.attrs,contentElement:this.contentDOM}}matchesMark(t){return this.dirty!=3&&this.mark.eq(t)}markDirty(t,e){if(super.markDirty(t,e),this.dirty!=0){let n=this.parent;for(;!n.node;)n=n.parent;n.dirty<this.dirty&&(n.dirty=this.dirty),this.dirty=0}}slice(t,e,n){let s=ie.create(this.parent,this.mark,!0,n),r=this.children,i=this.size;e<i&&(r=$s(r,e,i,n)),t>0&&(r=$s(r,0,t,n));for(let a=0;a<r.length;a++)r[a].parent=s;return s.children=r,s}}class Bt extends nn{constructor(t,e,n,s,r,i,a,l,c){super(t,[],r,i),this.node=e,this.outerDeco=n,this.innerDeco=s,this.nodeDOM=a}static create(t,e,n,s,r,i){let a,l=r.nodeViews[e.type.name],c=l&&l(e,r,()=>a?a.parent?a.parent.posBeforeChild(a):void 0:i,n,s),d=c&&c.dom,h=c&&c.contentDOM;if(e.isText)if(d){if(d.nodeType!=3)throw new RangeError("Text must be rendered as a DOM text node")}else d=document.createTextNode(e.text);else d||({dom:d,contentDOM:h}=ue.renderSpec(document,e.type.spec.toDOM(e)));h||e.isText||d.nodeName=="BR"||(d.hasAttribute("contenteditable")||(d.contentEditable="false"),e.type.spec.draggable&&(d.draggable=!0));let u=d;return d=Ri(d,n,e),c?a=new Wl(t,e,n,s,d,h||null,u,c,r,i+1):e.isText?new $n(t,e,n,s,d,u,r):new Bt(t,e,n,s,d,h||null,u,r,i+1)}parseRule(){if(this.node.type.spec.reparseInView)return null;let t={node:this.node.type.name,attrs:this.node.attrs};if(this.node.type.whitespace=="pre"&&(t.preserveWhitespace="full"),this.contentDOM)if(this.contentLost){for(let e=this.children.length-1;e>=0;e--){let n=this.children[e];if(this.dom.contains(n.dom.parentNode)){t.contentElement=n.dom.parentNode;break}}t.contentElement||(t.getContent=()=>b.empty)}else t.contentElement=this.contentDOM;else t.getContent=()=>this.node.content;return t}matchesNode(t,e,n){return this.dirty==0&&t.eq(this.node)&&Ps(e,this.outerDeco)&&n.eq(this.innerDeco)}get size(){return this.node.nodeSize}get border(){return this.node.isLeaf?0:1}updateChildren(t,e){let n=this.node.inlineContent,s=e,r=t.composing?this.localCompositionInfo(t,e):null,i=r&&r.pos>-1?r:null,a=r&&r.pos<0,l=new Kl(this,i&&i.node,t);(function(c,d,h,u){let f=d.locals(c),p=0;if(f.length==0){for(let v=0;v<c.childCount;v++){let w=c.child(v);u(w,f,d.forChild(p,w),v),p+=w.nodeSize}return}let m=0,g=[],y=null;for(let v=0;;){let w,x,_,T;for(;m<f.length&&f[m].to==p;){let C=f[m++];C.widget&&(w?(x||(x=[w])).push(C):w=C)}if(w)if(x){x.sort(Gl);for(let C=0;C<x.length;C++)h(x[C],v,!!y)}else h(w,v,!!y);if(y)T=-1,_=y,y=null;else{if(!(v<c.childCount))break;T=v,_=c.child(v++)}for(let C=0;C<g.length;C++)g[C].to<=p&&g.splice(C--,1);for(;m<f.length&&f[m].from<=p&&f[m].to>p;)g.push(f[m++]);let E=p+_.nodeSize;if(_.isText){let C=E;m<f.length&&f[m].from<C&&(C=f[m].from);for(let S=0;S<g.length;S++)g[S].to<C&&(C=g[S].to);C<E&&(y=_.cut(C-p),_=_.cut(0,C-p),E=C,T=-1)}else for(;m<f.length&&f[m].to<E;)m++;u(_,_.isInline&&!_.isLeaf?g.filter(C=>!C.inline):g.slice(),d.forChild(p,_),T),p=E}})(this.node,this.innerDeco,(c,d,h)=>{c.spec.marks?l.syncToMarks(c.spec.marks,n,t):c.type.side>=0&&!h&&l.syncToMarks(d==this.node.childCount?B.none:this.node.child(d).marks,n,t),l.placeWidget(c,t,s)},(c,d,h,u)=>{let f;l.syncToMarks(c.marks,n,t),l.findNodeMatch(c,d,h,u)||a&&t.state.selection.from>s&&t.state.selection.to<s+c.nodeSize&&(f=l.findIndexWithChild(r.node))>-1&&l.updateNodeAt(c,d,h,f,t)||l.updateNextNode(c,d,h,t,u,s)||l.addNode(c,d,h,t,s),s+=c.nodeSize}),l.syncToMarks([],n,t),this.node.isTextblock&&l.addTextblockHacks(),l.destroyRest(),(l.changed||this.dirty==2)&&(i&&this.protectLocalComposition(t,i),Di(this.contentDOM,this.children,t),Ne&&function(c){if(c.nodeName=="UL"||c.nodeName=="OL"){let d=c.style.cssText;c.style.cssText=d+"; list-style: square !important",window.getComputedStyle(c).listStyle,c.style.cssText=d}}(this.dom))}localCompositionInfo(t,e){let{from:n,to:s}=t.state.selection;if(!(t.state.selection instanceof A)||n<e||s>e+this.node.content.size)return null;let r=t.input.compositionNode;if(!r||!this.dom.contains(r.parentNode))return null;if(this.node.inlineContent){let i=r.nodeValue,a=function(l,c,d,h){for(let u=0,f=0;u<l.childCount&&f<=h;){let p=l.child(u++),m=f;if(f+=p.nodeSize,!p.isText)continue;let g=p.text;for(;u<l.childCount;){let y=l.child(u++);if(f+=y.nodeSize,!y.isText)break;g+=y.text}if(f>=d){if(f>=h&&g.slice(h-c.length-m,h-m)==c)return h-c.length;let y=m<h?g.lastIndexOf(c,h-m-1):-1;if(y>=0&&y+c.length+m>=d)return m+y;if(d==h&&g.length>=h+c.length-m&&g.slice(h-m,h-m+c.length)==c)return h}}return-1}(this.node.content,i,n-e,s-e);return a<0?null:{node:r,pos:a,text:i}}return{node:r,pos:-1,text:""}}protectLocalComposition(t,{node:e,pos:n,text:s}){if(this.getDesc(e))return;let r=e;for(;r.parentNode!=this.contentDOM;r=r.parentNode){for(;r.previousSibling;)r.parentNode.removeChild(r.previousSibling);for(;r.nextSibling;)r.parentNode.removeChild(r.nextSibling);r.pmViewDesc&&(r.pmViewDesc=void 0)}let i=new jl(this,r,e,s);t.input.compositionNodes.push(i),this.children=$s(this.children,n,n+s.length,t,i)}update(t,e,n,s){return!(this.dirty==3||!t.sameMarkup(this.node))&&(this.updateInner(t,e,n,s),!0)}updateInner(t,e,n,s){this.updateOuterDeco(e),this.node=t,this.innerDeco=n,this.contentDOM&&this.updateChildren(s,this.posAtStart),this.dirty=0}updateOuterDeco(t){if(Ps(t,this.outerDeco))return;let e=this.nodeDOM.nodeType!=1,n=this.dom;this.dom=Ai(this.dom,this.nodeDOM,Rs(this.outerDeco,this.node,e),Rs(t,this.node,e)),this.dom!=n&&(n.pmViewDesc=void 0,this.dom.pmViewDesc=this),this.outerDeco=t}selectNode(){this.nodeDOM.nodeType==1&&this.nodeDOM.classList.add("ProseMirror-selectednode"),!this.contentDOM&&this.node.type.spec.draggable||(this.dom.draggable=!0)}deselectNode(){this.nodeDOM.nodeType==1&&this.nodeDOM.classList.remove("ProseMirror-selectednode"),!this.contentDOM&&this.node.type.spec.draggable||this.dom.removeAttribute("draggable")}get domAtom(){return this.node.isAtom}}function eo(o,t,e,n,s){Ri(n,t,o);let r=new Bt(void 0,o,t,e,n,n,n,s,0);return r.contentDOM&&r.updateChildren(s,0),r}class $n extends Bt{constructor(t,e,n,s,r,i,a){super(t,e,n,s,r,null,i,a,0)}parseRule(){let t=this.nodeDOM.parentNode;for(;t&&t!=this.dom&&!t.pmIsDeco;)t=t.parentNode;return{skip:t||!0}}update(t,e,n,s){return!(this.dirty==3||this.dirty!=0&&!this.inParent()||!t.sameMarkup(this.node))&&(this.updateOuterDeco(e),this.dirty==0&&t.text==this.node.text||t.text==this.nodeDOM.nodeValue||(this.nodeDOM.nodeValue=t.text,s.trackWrites==this.nodeDOM&&(s.trackWrites=null)),this.node=t,this.dirty=0,!0)}inParent(){let t=this.parent.contentDOM;for(let e=this.nodeDOM;e;e=e.parentNode)if(e==t)return!0;return!1}domFromPos(t){return{node:this.nodeDOM,offset:t}}localPosFromDOM(t,e,n){return t==this.nodeDOM?this.posAtStart+Math.min(e,this.node.text.length):super.localPosFromDOM(t,e,n)}ignoreMutation(t){return t.type!="characterData"&&t.type!="selection"}slice(t,e,n){let s=this.node.cut(t,e),r=document.createTextNode(s.text);return new $n(this.parent,s,this.outerDeco,this.innerDeco,r,r,n)}markDirty(t,e){super.markDirty(t,e),this.dom==this.nodeDOM||t!=0&&e!=this.nodeDOM.nodeValue.length||(this.dirty=3)}get domAtom(){return!1}isText(t){return this.node.text==t}}class Ni extends nn{parseRule(){return{ignore:!0}}matchesHack(t){return this.dirty==0&&this.dom.nodeName==t}get domAtom(){return!0}get ignoreForCoords(){return this.dom.nodeName=="IMG"}}class Wl extends Bt{constructor(t,e,n,s,r,i,a,l,c,d){super(t,e,n,s,r,i,a,c,d),this.spec=l}update(t,e,n,s){if(this.dirty==3)return!1;if(this.spec.update){let r=this.spec.update(t,e,n);return r&&this.updateInner(t,e,n,s),r}return!(!this.contentDOM&&!t.isLeaf)&&super.update(t,e,n,s)}selectNode(){this.spec.selectNode?this.spec.selectNode():super.selectNode()}deselectNode(){this.spec.deselectNode?this.spec.deselectNode():super.deselectNode()}setSelection(t,e,n,s){this.spec.setSelection?this.spec.setSelection(t,e,n):super.setSelection(t,e,n,s)}destroy(){this.spec.destroy&&this.spec.destroy(),super.destroy()}stopEvent(t){return!!this.spec.stopEvent&&this.spec.stopEvent(t)}ignoreMutation(t){return this.spec.ignoreMutation?this.spec.ignoreMutation(t):super.ignoreMutation(t)}}function Di(o,t,e){let n=o.firstChild,s=!1;for(let r=0;r<t.length;r++){let i=t[r],a=i.dom;if(a.parentNode==o){for(;a!=n;)n=no(n),s=!0;n=n.nextSibling}else s=!0,o.insertBefore(a,n);if(i instanceof ie){let l=n?n.previousSibling:o.lastChild;Di(i.contentDOM,i.children,e),n=l?l.nextSibling:o.firstChild}}for(;n;)n=no(n),s=!0;s&&e.trackWrites==o&&(e.trackWrites=null)}const Ue=function(o){o&&(this.nodeName=o)};Ue.prototype=Object.create(null);const te=[new Ue];function Rs(o,t,e){if(o.length==0)return te;let n=e?te[0]:new Ue,s=[n];for(let r=0;r<o.length;r++){let i=o[r].type.attrs;if(i){i.nodeName&&s.push(n=new Ue(i.nodeName));for(let a in i){let l=i[a];l!=null&&(e&&s.length==1&&s.push(n=new Ue(t.isInline?"span":"div")),a=="class"?n.class=(n.class?n.class+" ":"")+l:a=="style"?n.style=(n.style?n.style+";":"")+l:a!="nodeName"&&(n[a]=l))}}}return s}function Ai(o,t,e,n){if(e==te&&n==te)return t;let s=t;for(let r=0;r<n.length;r++){let i=n[r],a=e[r];if(r){let l;a&&a.nodeName==i.nodeName&&s!=o&&(l=s.parentNode)&&l.nodeName.toLowerCase()==i.nodeName||(l=document.createElement(i.nodeName),l.pmIsDeco=!0,l.appendChild(s),a=te[0]),s=l}Jl(s,a||te[0],i)}return s}function Jl(o,t,e){for(let n in t)n=="class"||n=="style"||n=="nodeName"||n in e||o.removeAttribute(n);for(let n in e)n!="class"&&n!="style"&&n!="nodeName"&&e[n]!=t[n]&&o.setAttribute(n,e[n]);if(t.class!=e.class){let n=t.class?t.class.split(" ").filter(Boolean):[],s=e.class?e.class.split(" ").filter(Boolean):[];for(let r=0;r<n.length;r++)s.indexOf(n[r])==-1&&o.classList.remove(n[r]);for(let r=0;r<s.length;r++)n.indexOf(s[r])==-1&&o.classList.add(s[r]);o.classList.length==0&&o.removeAttribute("class")}if(t.style!=e.style){if(t.style){let n,s=/\s*([\w\-\xa1-\uffff]+)\s*:(?:"(?:\\.|[^"])*"|'(?:\\.|[^'])*'|\(.*?\)|[^;])*/g;for(;n=s.exec(t.style);)o.style.removeProperty(n[1])}e.style&&(o.style.cssText+=e.style)}}function Ri(o,t,e){return Ai(o,o,te,Rs(t,e,o.nodeType!=1))}function Ps(o,t){if(o.length!=t.length)return!1;for(let e=0;e<o.length;e++)if(!o[e].type.eq(t[e].type))return!1;return!0}function no(o){let t=o.nextSibling;return o.parentNode.removeChild(o),t}class Kl{constructor(t,e,n){this.lock=e,this.view=n,this.index=0,this.stack=[],this.changed=!1,this.top=t,this.preMatch=function(s,r){let i=r,a=i.children.length,l=s.childCount,c=new Map,d=[];t:for(;l>0;){let h;for(;;)if(a){let f=i.children[a-1];if(!(f instanceof ie)){h=f,a--;break}i=f,a=f.children.length}else{if(i==r)break t;a=i.parent.children.indexOf(i),i=i.parent}let u=h.node;if(u){if(u!=s.child(l-1))break;--l,c.set(h,l),d.push(h)}}return{index:l,matched:c,matches:d.reverse()}}(t.node.content,t)}destroyBetween(t,e){if(t!=e){for(let n=t;n<e;n++)this.top.children[n].destroy();this.top.children.splice(t,e-t),this.changed=!0}}destroyRest(){this.destroyBetween(this.index,this.top.children.length)}syncToMarks(t,e,n){let s=0,r=this.stack.length>>1,i=Math.min(r,t.length);for(;s<i&&(s==r-1?this.top:this.stack[s+1<<1]).matchesMark(t[s])&&t[s].type.spec.spanning!==!1;)s++;for(;s<r;)this.destroyRest(),this.top.dirty=0,this.index=this.stack.pop(),this.top=this.stack.pop(),r--;for(;r<t.length;){this.stack.push(this.top,this.index+1);let a=-1;for(let l=this.index;l<Math.min(this.index+3,this.top.children.length);l++){let c=this.top.children[l];if(c.matchesMark(t[r])&&!this.isLocked(c.dom)){a=l;break}}if(a>-1)a>this.index&&(this.changed=!0,this.destroyBetween(this.index,a)),this.top=this.top.children[this.index];else{let l=ie.create(this.top,t[r],e,n);this.top.children.splice(this.index,0,l),this.top=l,this.changed=!0}this.index=0,r++}}findNodeMatch(t,e,n,s){let r,i=-1;if(s>=this.preMatch.index&&(r=this.preMatch.matches[s-this.preMatch.index]).parent==this.top&&r.matchesNode(t,e,n))i=this.top.children.indexOf(r,this.index);else for(let a=this.index,l=Math.min(this.top.children.length,a+5);a<l;a++){let c=this.top.children[a];if(c.matchesNode(t,e,n)&&!this.preMatch.matched.has(c)){i=a;break}}return!(i<0)&&(this.destroyBetween(this.index,i),this.index++,!0)}updateNodeAt(t,e,n,s,r){let i=this.top.children[s];return i.dirty==3&&i.dom==i.contentDOM&&(i.dirty=2),!!i.update(t,e,n,r)&&(this.destroyBetween(this.index,s),this.index++,!0)}findIndexWithChild(t){for(;;){let e=t.parentNode;if(!e)return-1;if(e==this.top.contentDOM){let n=t.pmViewDesc;if(n){for(let s=this.index;s<this.top.children.length;s++)if(this.top.children[s]==n)return s}return-1}t=e}}updateNextNode(t,e,n,s,r,i){for(let a=this.index;a<this.top.children.length;a++){let l=this.top.children[a];if(l instanceof Bt){let c=this.preMatch.matched.get(l);if(c!=null&&c!=r)return!1;let d,h=l.dom,u=this.isLocked(h)&&!(t.isText&&l.node&&l.node.isText&&l.nodeDOM.nodeValue==t.text&&l.dirty!=3&&Ps(e,l.outerDeco));if(!u&&l.update(t,e,n,s))return this.destroyBetween(this.index,a),l.dom!=h&&(this.changed=!0),this.index++,!0;if(!u&&(d=this.recreateWrapper(l,t,e,n,s,i)))return this.top.children[this.index]=d,d.contentDOM&&(d.dirty=2,d.updateChildren(s,i+1),d.dirty=0),this.changed=!0,this.index++,!0;break}}return!1}recreateWrapper(t,e,n,s,r,i){if(t.dirty||e.isAtom||!t.children.length||!t.node.content.eq(e.content))return null;let a=Bt.create(this.top,e,n,s,r,i);if(a.contentDOM){a.children=t.children,t.children=[];for(let l of a.children)l.parent=a}return t.destroy(),a}addNode(t,e,n,s,r){let i=Bt.create(this.top,t,e,n,s,r);i.contentDOM&&i.updateChildren(s,r+1),this.top.children.splice(this.index++,0,i),this.changed=!0}placeWidget(t,e,n){let s=this.index<this.top.children.length?this.top.children[this.index]:null;if(!s||!s.matchesWidget(t)||t!=s.widget&&s.widget.type.toDOM.parentNode){let r=new Ii(this.top,t,e,n);this.top.children.splice(this.index++,0,r),this.changed=!0}else this.index++}addTextblockHacks(){let t=this.top.children[this.index-1],e=this.top;for(;t instanceof ie;)e=t,t=e.children[e.children.length-1];(!t||!(t instanceof $n)||/\n$/.test(t.node.text)||this.view.requiresGeckoHackNode&&/\s$/.test(t.node.text))&&((ht||lt)&&t&&t.dom.contentEditable=="false"&&this.addHackNode("IMG",e),this.addHackNode("BR",this.top))}addHackNode(t,e){if(e==this.top&&this.index<e.children.length&&e.children[this.index].matchesHack(t))this.index++;else{let n=document.createElement(t);t=="IMG"&&(n.className="ProseMirror-separator",n.alt=""),t=="BR"&&(n.className="ProseMirror-trailingBreak");let s=new Ni(this.top,[],n,null);e!=this.top?e.children.push(s):e.children.splice(this.index++,0,s),this.changed=!0}}isLocked(t){return this.lock&&(t==this.lock||t.nodeType==1&&t.contains(this.lock.parentNode))}}function Gl(o,t){return o.type.side-t.type.side}function $s(o,t,e,n,s){let r=[];for(let i=0,a=0;i<o.length;i++){let l=o[i],c=a,d=a+=l.size;c>=e||d<=t?r.push(l):(c<t&&r.push(l.slice(0,t-c,n)),s&&(r.push(s),s=void 0),d>e&&r.push(l.slice(e-c,l.size,n)))}return r}function tr(o,t=null){let e=o.domSelectionRange(),n=o.state.doc;if(!e.focusNode)return null;let s=o.docView.nearestDesc(e.focusNode),r=s&&s.size==0,i=o.docView.posFromDOM(e.focusNode,e.focusOffset,1);if(i<0)return null;let a,l,c=n.resolve(i);if(Pn(e)){for(a=c;s&&!s.node;)s=s.parent;let d=s.node;if(s&&d.isAtom&&I.isSelectable(d)&&s.parent&&(!d.isInline||!function(h,u,f){for(let p=u==0,m=u==bt(h);p||m;){if(h==f)return!0;let g=ot(h);if(!(h=h.parentNode))return!1;p=p&&g==0,m=m&&g==bt(h)}}(e.focusNode,e.focusOffset,s.dom))){let h=s.posBefore;l=new I(i==h?c:n.resolve(h))}}else{let d=o.docView.posFromDOM(e.anchorNode,e.anchorOffset,1);if(d<0)return null;a=n.resolve(d)}return l||(l=er(o,a,c,t=="pointer"||o.state.selection.head<c.pos&&!r?1:-1)),l}function so(o){return o.editable?o.hasFocus():$i(o)&&document.activeElement&&document.activeElement.contains(o.dom)}function Ot(o,t=!1){let e=o.state.selection;if(Pi(o,e),so(o)){if(!t&&o.input.mouseDown&&o.input.mouseDown.allowDefault&&lt){let n=o.domSelectionRange(),s=o.domObserver.currentSelection;if(n.anchorNode&&s.anchorNode&&he(n.anchorNode,n.anchorOffset,s.anchorNode,s.anchorOffset))return o.input.mouseDown.delayedSelectionSync=!0,void o.domObserver.setCurSelection()}if(o.domObserver.disconnectSelection(),o.cursorWrapper)(function(n){let s=n.domSelection(),r=document.createRange(),i=n.cursorWrapper.dom,a=i.nodeName=="IMG";a?r.setEnd(i.parentNode,ot(i)+1):r.setEnd(i,0),r.collapse(!1),s.removeAllRanges(),s.addRange(r),!a&&!n.state.selection.visible&&ut&&Lt<=11&&(i.disabled=!0,i.disabled=!1)})(o);else{let n,s,{anchor:r,head:i}=e;!ro||e instanceof A||(e.$from.parent.inlineContent||(n=oo(o,e.from)),e.empty||e.$from.parent.inlineContent||(s=oo(o,e.to))),o.docView.setSelection(r,i,o.root,t),ro&&(n&&io(n),s&&io(s)),e.visible?o.dom.classList.remove("ProseMirror-hideselection"):(o.dom.classList.add("ProseMirror-hideselection"),"onselectionchange"in document&&function(a){let l=a.dom.ownerDocument;l.removeEventListener("selectionchange",a.input.hideSelectionGuard);let c=a.domSelectionRange(),d=c.anchorNode,h=c.anchorOffset;l.addEventListener("selectionchange",a.input.hideSelectionGuard=()=>{c.anchorNode==d&&c.anchorOffset==h||(l.removeEventListener("selectionchange",a.input.hideSelectionGuard),setTimeout(()=>{so(a)&&!a.state.selection.visible||a.dom.classList.remove("ProseMirror-hideselection")},20))})}(o))}o.domObserver.setCurSelection(),o.domObserver.connectSelection()}}const ro=ht||lt&&$l<63;function oo(o,t){let{node:e,offset:n}=o.docView.domFromPos(t,0),s=n<e.childNodes.length?e.childNodes[n]:null,r=n?e.childNodes[n-1]:null;if(ht&&s&&s.contentEditable=="false")return is(s);if(!(s&&s.contentEditable!="false"||r&&r.contentEditable!="false")){if(s)return is(s);if(r)return is(r)}}function is(o){return o.contentEditable="true",ht&&o.draggable&&(o.draggable=!1,o.wasDraggable=!0),o}function io(o){o.contentEditable="false",o.wasDraggable&&(o.draggable=!0,o.wasDraggable=null)}function Pi(o,t){if(t instanceof I){let e=o.docView.descAt(t.from);e!=o.lastSelectedViewDesc&&(ao(o),e&&e.selectNode(),o.lastSelectedViewDesc=e)}else ao(o)}function ao(o){o.lastSelectedViewDesc&&(o.lastSelectedViewDesc.parent&&o.lastSelectedViewDesc.deselectNode(),o.lastSelectedViewDesc=void 0)}function er(o,t,e,n){return o.someProp("createSelectionBetween",s=>s(o,t,e))||A.between(t,e,n)}function lo(o){return!(o.editable&&!o.hasFocus())&&$i(o)}function $i(o){let t=o.domSelectionRange();if(!t.anchorNode)return!1;try{return o.dom.contains(t.anchorNode.nodeType==3?t.anchorNode.parentNode:t.anchorNode)&&(o.editable||o.dom.contains(t.focusNode.nodeType==3?t.focusNode.parentNode:t.focusNode))}catch{return!1}}function qs(o,t){let{$anchor:e,$head:n}=o.selection,s=t>0?e.max(n):e.min(n),r=s.parent.inlineContent?s.depth?o.doc.resolve(t>0?s.after():s.before()):null:s;return r&&R.findFrom(r,t)}function At(o,t){return o.dispatch(o.state.tr.setSelection(t).scrollIntoView()),!0}function co(o,t,e){let n=o.state.selection;if(!(n instanceof A)){if(n instanceof I&&n.node.isInline)return At(o,new A(t>0?n.$to:n.$from));{let s=qs(o.state,t);return!!s&&At(o,s)}}if(e.indexOf("s")>-1){let{$head:s}=n,r=s.textOffset?null:t<0?s.nodeBefore:s.nodeAfter;if(!r||r.isText||!r.isLeaf)return!1;let i=o.state.doc.resolve(s.pos+r.nodeSize*(t<0?-1:1));return At(o,new A(n.$anchor,i))}if(!n.empty)return!1;if(o.endOfTextblock(t>0?"forward":"backward")){let s=qs(o.state,t);return!!(s&&s instanceof I)&&At(o,s)}if(!(ft&&e.indexOf("m")>-1)){let s,r=n.$head,i=r.textOffset?null:t<0?r.nodeBefore:r.nodeAfter;if(!i||i.isText)return!1;let a=t<0?r.pos-i.nodeSize:r.pos;return!!(i.isAtom||(s=o.docView.descAt(a))&&!s.contentDOM)&&(I.isSelectable(i)?At(o,new I(t<0?o.state.doc.resolve(r.pos-i.nodeSize):r)):!!en&&At(o,new A(o.state.doc.resolve(t<0?a:a+i.nodeSize))))}}function ln(o){return o.nodeType==3?o.nodeValue.length:o.childNodes.length}function $e(o,t){let e=o.pmViewDesc;return e&&e.size==0&&(t<0||o.nextSibling||o.nodeName!="BR")}function ye(o,t){return t<0?function(e){let n=e.domSelectionRange(),s=n.focusNode,r=n.focusOffset;if(!s)return;let i,a,l=!1;for(vt&&s.nodeType==1&&r<ln(s)&&$e(s.childNodes[r],-1)&&(l=!0);;)if(r>0){if(s.nodeType!=1)break;{let c=s.childNodes[r-1];if($e(c,-1))i=s,a=--r;else{if(c.nodeType!=3)break;s=c,r=s.nodeValue.length}}}else{if(ho(s))break;{let c=s.previousSibling;for(;c&&$e(c,-1);)i=s.parentNode,a=ot(c),c=c.previousSibling;if(c)s=c,r=ln(s);else{if(s=s.parentNode,s==e.dom)break;r=0}}}l?as(e,s,r):i&&as(e,i,a)}(o):function(e){let n=e.domSelectionRange(),s=n.focusNode,r=n.focusOffset;if(!s)return;let i,a,l=ln(s);for(;;)if(r<l){if(s.nodeType!=1||!$e(s.childNodes[r],1))break;i=s,a=++r}else{if(ho(s))break;{let c=s.nextSibling;for(;c&&$e(c,1);)i=c.parentNode,a=ot(c)+1,c=c.nextSibling;if(c)s=c,r=0,l=ln(s);else{if(s=s.parentNode,s==e.dom)break;r=l=0}}}i&&as(e,i,a)}(o)}function ho(o){let t=o.pmViewDesc;return t&&t.node&&t.node.isBlock}function as(o,t,e){if(t.nodeType!=3){let r,i;(i=function(a,l){for(;a&&l==a.childNodes.length&&!Qe(a);)l=ot(a)+1,a=a.parentNode;for(;a&&l<a.childNodes.length;){let c=a.childNodes[l];if(c.nodeType==3)return c;if(c.nodeType==1&&c.contentEditable=="false")break;a=c,l=0}}(t,e))?(t=i,e=0):(r=function(a,l){for(;a&&!l&&!Qe(a);)l=ot(a),a=a.parentNode;for(;a&&l;){let c=a.childNodes[l-1];if(c.nodeType==3)return c;if(c.nodeType==1&&c.contentEditable=="false")break;l=(a=c).childNodes.length}}(t,e))&&(t=r,e=r.nodeValue.length)}let n=o.domSelection();if(Pn(n)){let r=document.createRange();r.setEnd(t,e),r.setStart(t,e),n.removeAllRanges(),n.addRange(r)}else n.extend&&n.extend(t,e);o.domObserver.setCurSelection();let{state:s}=o;setTimeout(()=>{o.state==s&&Ot(o)},50)}function uo(o,t){let e=o.state.doc.resolve(t);if(!lt&&!ql&&e.parent.inlineContent){let n=o.coordsAtPos(t);if(t>e.start()){let s=o.coordsAtPos(t-1),r=(s.top+s.bottom)/2;if(r>n.top&&r<n.bottom&&Math.abs(s.left-n.left)>1)return s.left<n.left?"ltr":"rtl"}if(t<e.end()){let s=o.coordsAtPos(t+1),r=(s.top+s.bottom)/2;if(r>n.top&&r<n.bottom&&Math.abs(s.left-n.left)>1)return s.left>n.left?"ltr":"rtl"}}return getComputedStyle(o.dom).direction=="rtl"?"rtl":"ltr"}function po(o,t,e){let n=o.state.selection;if(n instanceof A&&!n.empty||e.indexOf("s")>-1||ft&&e.indexOf("m")>-1)return!1;let{$from:s,$to:r}=n;if(!s.parent.inlineContent||o.endOfTextblock(t<0?"up":"down")){let i=qs(o.state,t);if(i&&i instanceof I)return At(o,i)}if(!s.parent.inlineContent){let i=t<0?s:r,a=n instanceof mt?R.near(i,t):R.findFrom(i,t);return!!a&&At(o,a)}return!1}function fo(o,t){if(!(o.state.selection instanceof A))return!0;let{$head:e,$anchor:n,empty:s}=o.state.selection;if(!e.sameParent(n))return!0;if(!s)return!1;if(o.endOfTextblock(t>0?"forward":"backward"))return!0;let r=!e.textOffset&&(t<0?e.nodeBefore:e.nodeAfter);if(r&&!r.isText){let i=o.state.tr;return t<0?i.delete(e.pos-r.nodeSize,e.pos):i.delete(e.pos,e.pos+r.nodeSize),o.dispatch(i),!0}return!1}function mo(o,t,e){o.domObserver.stop(),t.contentEditable=e,o.domObserver.start()}function Xl(o,t){let e=t.keyCode,n=function(s){let r="";return s.ctrlKey&&(r+="c"),s.metaKey&&(r+="m"),s.altKey&&(r+="a"),s.shiftKey&&(r+="s"),r}(t);if(e==8||ft&&e==72&&n=="c")return fo(o,-1)||ye(o,-1);if(e==46&&!t.shiftKey||ft&&e==68&&n=="c")return fo(o,1)||ye(o,1);if(e==13||e==27)return!0;if(e==37||ft&&e==66&&n=="c"){let s=e==37?uo(o,o.state.selection.from)=="ltr"?-1:1:-1;return co(o,s,n)||ye(o,s)}if(e==39||ft&&e==70&&n=="c"){let s=e==39?uo(o,o.state.selection.from)=="ltr"?1:-1:1;return co(o,s,n)||ye(o,s)}return e==38||ft&&e==80&&n=="c"?po(o,-1,n)||ye(o,-1):e==40||ft&&e==78&&n=="c"?function(s){if(!ht||s.state.selection.$head.parentOffset>0)return!1;let{focusNode:r,focusOffset:i}=s.domSelectionRange();if(r&&r.nodeType==1&&i==0&&r.firstChild&&r.firstChild.contentEditable=="false"){let a=r.firstChild;mo(s,a,"true"),setTimeout(()=>mo(s,a,"false"),20)}return!1}(o)||po(o,1,n)||ye(o,1):n==(ft?"m":"c")&&(e==66||e==73||e==89||e==90)}function qi(o,t){o.someProp("transformCopied",u=>{t=u(t,o)});let e=[],{content:n,openStart:s,openEnd:r}=t;for(;s>1&&r>1&&n.childCount==1&&n.firstChild.childCount==1;){s--,r--;let u=n.firstChild;e.push(u.type.name,u.attrs!=u.type.defaultAttrs?u.attrs:null),n=u.content}let i=o.someProp("clipboardSerializer")||ue.fromSchema(o.state.schema),a=Vi(),l=a.createElement("div");l.appendChild(i.serializeFragment(n,{document:a}));let c,d=l.firstChild,h=0;for(;d&&d.nodeType==1&&(c=Hi[d.nodeName.toLowerCase()]);){for(let u=c.length-1;u>=0;u--){let f=a.createElement(c[u]);for(;l.firstChild;)f.appendChild(l.firstChild);l.appendChild(f),h++}d=l.firstChild}return d&&d.nodeType==1&&d.setAttribute("data-pm-slice",`${s} ${r}${h?` -${h}`:""} ${JSON.stringify(e)}`),{dom:l,text:o.someProp("clipboardTextSerializer",u=>u(t,o))||t.content.textBetween(0,t.content.size,`

`),slice:t}}function Fi(o,t,e,n,s){let r,i,a=s.parent.type.spec.code;if(!e&&!t)return null;let l=t&&(n||a||!e);if(l){if(o.someProp("transformPastedText",u=>{t=u(t,a||n,o)}),a)return t?new k(b.from(o.state.schema.text(t.replace(/\r\n?/g,`
`))),0,0):k.empty;let h=o.someProp("clipboardTextParser",u=>u(t,s,n,o));if(h)i=h;else{let u=s.marks(),{schema:f}=o.state,p=ue.fromSchema(f);r=document.createElement("div"),t.split(/(?:\r\n?|\n)+/).forEach(m=>{let g=r.appendChild(document.createElement("p"));m&&g.appendChild(p.serializeNode(f.text(m,u)))})}}else o.someProp("transformPastedHTML",h=>{e=h(e,o)}),r=function(h){let u=/^(\s*<meta [^>]*>)*/.exec(h);u&&(h=h.slice(u[0].length));let f,p=Vi().createElement("div"),m=/<([a-z][^>\s]+)/i.exec(h);if((f=m&&Hi[m[1].toLowerCase()])&&(h=f.map(g=>"<"+g+">").join("")+h+f.map(g=>"</"+g+">").reverse().join("")),p.innerHTML=h,f)for(let g=0;g<f.length;g++)p=p.querySelector(f[g])||p;return p}(e),en&&function(h){let u=h.querySelectorAll(lt?"span:not([class]):not([style])":"span.Apple-converted-space");for(let f=0;f<u.length;f++){let p=u[f];p.childNodes.length==1&&p.textContent==""&&p.parentNode&&p.parentNode.replaceChild(h.ownerDocument.createTextNode(" "),p)}}(r);let c=r&&r.querySelector("[data-pm-slice]"),d=c&&/^(\d+) (\d+)(?: -(\d+))? (.*)/.exec(c.getAttribute("data-pm-slice")||"");if(d&&d[3])for(let h=+d[3];h>0;h--){let u=r.firstChild;for(;u&&u.nodeType!=1;)u=u.nextSibling;if(!u)break;r=u}if(i||(i=(o.someProp("clipboardParser")||o.someProp("domParser")||Oe.fromSchema(o.state.schema)).parseSlice(r,{preserveWhitespace:!(!l&&!d),context:s,ruleFromNode:u=>u.nodeName!="BR"||u.nextSibling||!u.parentNode||Ql.test(u.parentNode.nodeName)?null:{ignore:!0}})),d)i=function(h,u){if(!h.size)return h;let f,p=h.content.firstChild.type.schema;try{f=JSON.parse(u)}catch{return h}let{content:m,openStart:g,openEnd:y}=h;for(let v=f.length-2;v>=0;v-=2){let w=p.nodes[f[v]];if(!w||w.hasRequiredAttrs())break;m=b.from(w.create(f[v+1],m)),g++,y++}return new k(m,g,y)}(go(i,+d[1],+d[2]),d[4]);else if(i=k.maxOpen(function(h,u){if(h.childCount<2)return h;for(let f=u.depth;f>=0;f--){let p,m=u.node(f).contentMatchAt(u.index(f)),g=[];if(h.forEach(y=>{if(!g)return;let v,w=m.findWrapping(y.type);if(!w)return g=null;if(v=g.length&&p.length&&Li(w,p,y,g[g.length-1],0))g[g.length-1]=v;else{g.length&&(g[g.length-1]=Bi(g[g.length-1],p.length));let x=zi(y,w);g.push(x),m=m.matchType(x.type),p=w}}),g)return b.from(g)}return h}(i.content,s),!0),i.openStart||i.openEnd){let h=0,u=0;for(let f=i.content.firstChild;h<i.openStart&&!f.type.spec.isolating;h++,f=f.firstChild);for(let f=i.content.lastChild;u<i.openEnd&&!f.type.spec.isolating;u++,f=f.lastChild);i=go(i,h,u)}return o.someProp("transformPasted",h=>{i=h(i,o)}),i}const Ql=/^(a|abbr|acronym|b|cite|code|del|em|i|ins|kbd|label|output|q|ruby|s|samp|span|strong|sub|sup|time|u|tt|var)$/i;function zi(o,t,e=0){for(let n=t.length-1;n>=e;n--)o=t[n].create(null,b.from(o));return o}function Li(o,t,e,n,s){if(s<o.length&&s<t.length&&o[s]==t[s]){let r=Li(o,t,e,n.lastChild,s+1);if(r)return n.copy(n.content.replaceChild(n.childCount-1,r));if(n.contentMatchAt(n.childCount).matchType(s==o.length-1?e.type:o[s+1]))return n.copy(n.content.append(b.from(zi(e,o,s+1))))}}function Bi(o,t){if(t==0)return o;let e=o.content.replaceChild(o.childCount-1,Bi(o.lastChild,t-1)),n=o.contentMatchAt(o.childCount).fillBefore(b.empty,!0);return o.copy(e.append(n))}function Fs(o,t,e,n,s,r){let i=t<0?o.firstChild:o.lastChild,a=i.content;return o.childCount>1&&(r=0),s<n-1&&(a=Fs(a,t,e,n,s+1,r)),s>=e&&(a=t<0?i.contentMatchAt(0).fillBefore(a,r<=s).append(a):a.append(i.contentMatchAt(i.childCount).fillBefore(b.empty,!0))),o.replaceChild(t<0?0:o.childCount-1,i.copy(a))}function go(o,t,e){return t<o.openStart&&(o=new k(Fs(o.content,-1,t,o.openStart,0,o.openEnd),t,o.openEnd)),e<o.openEnd&&(o=new k(Fs(o.content,1,e,o.openEnd,0,0),o.openStart,e)),o}const Hi={thead:["table"],tbody:["table"],tfoot:["table"],caption:["table"],colgroup:["table"],col:["table","colgroup"],tr:["table","tbody"],td:["table","tbody","tr"],th:["table","tbody","tr"]};let yo=null;function Vi(){return yo||(yo=document.implementation.createHTMLDocument("title"))}const ct={},dt={},Yl={touchstart:!0,touchmove:!0};class Zl{constructor(){this.shiftKey=!1,this.mouseDown=null,this.lastKeyCode=null,this.lastKeyCodeTime=0,this.lastClick={time:0,x:0,y:0,type:""},this.lastSelectionOrigin=null,this.lastSelectionTime=0,this.lastIOSEnter=0,this.lastIOSEnterFallbackTimeout=-1,this.lastFocus=0,this.lastTouch=0,this.lastAndroidDelete=0,this.composing=!1,this.compositionNode=null,this.composingTimeout=-1,this.compositionNodes=[],this.compositionEndedAt=-2e8,this.compositionID=1,this.compositionPendingChanges=0,this.domChangeCount=0,this.eventHandlers=Object.create(null),this.hideSelectionGuard=null}}function zt(o,t){o.input.lastSelectionOrigin=t,o.input.lastSelectionTime=Date.now()}function ls(o){o.someProp("handleDOMEvents",t=>{for(let e in t)o.input.eventHandlers[e]||o.dom.addEventListener(e,o.input.eventHandlers[e]=n=>zs(o,n))})}function zs(o,t){return o.someProp("handleDOMEvents",e=>{let n=e[t.type];return!!n&&(n(o,t)||t.defaultPrevented)})}function tc(o,t){if(!t.bubbles)return!0;if(t.defaultPrevented)return!1;for(let e=t.target;e!=o.dom;e=e.parentNode)if(!e||e.nodeType==11||e.pmViewDesc&&e.pmViewDesc.stopEvent(t))return!1;return!0}function Sn(o){return{left:o.clientX,top:o.clientY}}function nr(o,t,e,n,s){if(n==-1)return!1;let r=o.state.doc.resolve(n);for(let i=r.depth+1;i>0;i--)if(o.someProp(t,a=>i>r.depth?a(o,e,r.nodeAfter,r.before(i),s,!0):a(o,e,r.node(i),r.before(i),s,!1)))return!0;return!1}function Ee(o,t,e){o.focused||o.focus();let n=o.state.tr.setSelection(t);n.setMeta("pointer",!0),o.dispatch(n)}function ec(o,t,e,n,s){return nr(o,"handleClickOn",t,e,n)||o.someProp("handleClick",r=>r(o,t,n))||(s?function(r,i){if(i==-1)return!1;let a,l,c=r.state.selection;c instanceof I&&(a=c.node);let d=r.state.doc.resolve(i);for(let h=d.depth+1;h>0;h--){let u=h>d.depth?d.nodeAfter:d.node(h);if(I.isSelectable(u)){l=a&&c.$from.depth>0&&h>=c.$from.depth&&d.before(c.$from.depth+1)==c.$from.pos?d.before(c.$from.depth):d.before(h);break}}return l!=null&&(Ee(r,I.create(r.state.doc,l)),!0)}(o,e):function(r,i){if(i==-1)return!1;let a=r.state.doc.resolve(i),l=a.nodeAfter;return!!(l&&l.isAtom&&I.isSelectable(l))&&(Ee(r,new I(a)),!0)}(o,e))}function nc(o,t,e,n){return nr(o,"handleDoubleClickOn",t,e,n)||o.someProp("handleDoubleClick",s=>s(o,t,n))}function sc(o,t,e,n){return nr(o,"handleTripleClickOn",t,e,n)||o.someProp("handleTripleClick",s=>s(o,t,n))||function(s,r,i){if(i.button!=0)return!1;let a=s.state.doc;if(r==-1)return!!a.inlineContent&&(Ee(s,A.create(a,0,a.content.size)),!0);let l=a.resolve(r);for(let c=l.depth+1;c>0;c--){let d=c>l.depth?l.nodeAfter:l.node(c),h=l.before(c);if(d.inlineContent)Ee(s,A.create(a,h+1,h+1+d.content.size));else{if(!I.isSelectable(d))continue;Ee(s,I.create(a,h))}return!0}}(o,e,n)}function Ls(o){return _n(o)}dt.keydown=(o,t)=>{let e=t;if(o.input.shiftKey=e.keyCode==16||e.shiftKey,!vo(o,e)&&(o.input.lastKeyCode=e.keyCode,o.input.lastKeyCodeTime=Date.now(),!gt||!lt||e.keyCode!=13))if(e.keyCode!=229&&o.domObserver.forceFlush(),!Ne||e.keyCode!=13||e.ctrlKey||e.altKey||e.metaKey)o.someProp("handleKeyDown",n=>n(o,e))||Xl(o,e)?e.preventDefault():zt(o,"key");else{let n=Date.now();o.input.lastIOSEnter=n,o.input.lastIOSEnterFallbackTimeout=setTimeout(()=>{o.input.lastIOSEnter==n&&(o.someProp("handleKeyDown",s=>s(o,Xt(13,"Enter"))),o.input.lastIOSEnter=0)},200)}},dt.keyup=(o,t)=>{t.keyCode==16&&(o.input.shiftKey=!1)},dt.keypress=(o,t)=>{let e=t;if(vo(o,e)||!e.charCode||e.ctrlKey&&!e.altKey||ft&&e.metaKey)return;if(o.someProp("handleKeyPress",s=>s(o,e)))return void e.preventDefault();let n=o.state.selection;if(!(n instanceof A&&n.$from.sameParent(n.$to))){let s=String.fromCharCode(e.charCode);/[\r\n]/.test(s)||o.someProp("handleTextInput",r=>r(o,n.$from.pos,n.$to.pos,s))||o.dispatch(o.state.tr.insertText(s).scrollIntoView()),e.preventDefault()}};const Ui=ft?"metaKey":"ctrlKey";ct.mousedown=(o,t)=>{let e=t;o.input.shiftKey=e.shiftKey;let n=Ls(o),s=Date.now(),r="singleClick";s-o.input.lastClick.time<500&&function(a,l){let c=l.x-a.clientX,d=l.y-a.clientY;return c*c+d*d<100}(e,o.input.lastClick)&&!e[Ui]&&(o.input.lastClick.type=="singleClick"?r="doubleClick":o.input.lastClick.type=="doubleClick"&&(r="tripleClick")),o.input.lastClick={time:s,x:e.clientX,y:e.clientY,type:r};let i=o.posAtCoords(Sn(e));i&&(r=="singleClick"?(o.input.mouseDown&&o.input.mouseDown.done(),o.input.mouseDown=new rc(o,i,e,!!n)):(r=="doubleClick"?nc:sc)(o,i.pos,i.inside,e)?e.preventDefault():zt(o,"pointer"))};class rc{constructor(t,e,n,s){let r,i;if(this.view=t,this.pos=e,this.event=n,this.flushed=s,this.delayedSelectionSync=!1,this.mightDrag=null,this.startDoc=t.state.doc,this.selectNode=!!n[Ui],this.allowDefault=n.shiftKey,e.inside>-1)r=t.state.doc.nodeAt(e.inside),i=e.inside;else{let d=t.state.doc.resolve(e.pos);r=d.parent,i=d.depth?d.before():0}const a=s?null:n.target,l=a?t.docView.nearestDesc(a,!0):null;this.target=l?l.dom:null;let{selection:c}=t.state;(n.button==0&&r.type.spec.draggable&&r.type.spec.selectable!==!1||c instanceof I&&c.from<=i&&c.to>i)&&(this.mightDrag={node:r,pos:i,addAttr:!(!this.target||this.target.draggable),setUneditable:!(!this.target||!vt||this.target.hasAttribute("contentEditable"))}),this.target&&this.mightDrag&&(this.mightDrag.addAttr||this.mightDrag.setUneditable)&&(this.view.domObserver.stop(),this.mightDrag.addAttr&&(this.target.draggable=!0),this.mightDrag.setUneditable&&setTimeout(()=>{this.view.input.mouseDown==this&&this.target.setAttribute("contentEditable","false")},20),this.view.domObserver.start()),t.root.addEventListener("mouseup",this.up=this.up.bind(this)),t.root.addEventListener("mousemove",this.move=this.move.bind(this)),zt(t,"pointer")}done(){this.view.root.removeEventListener("mouseup",this.up),this.view.root.removeEventListener("mousemove",this.move),this.mightDrag&&this.target&&(this.view.domObserver.stop(),this.mightDrag.addAttr&&this.target.removeAttribute("draggable"),this.mightDrag.setUneditable&&this.target.removeAttribute("contentEditable"),this.view.domObserver.start()),this.delayedSelectionSync&&setTimeout(()=>Ot(this.view)),this.view.input.mouseDown=null}up(t){if(this.done(),!this.view.dom.contains(t.target))return;let e=this.pos;this.view.state.doc!=this.startDoc&&(e=this.view.posAtCoords(Sn(t))),this.updateAllowDefault(t),this.allowDefault||!e?zt(this.view,"pointer"):ec(this.view,e.pos,e.inside,t,this.selectNode)?t.preventDefault():t.button==0&&(this.flushed||ht&&this.mightDrag&&!this.mightDrag.node.isAtom||lt&&!this.view.state.selection.visible&&Math.min(Math.abs(e.pos-this.view.state.selection.from),Math.abs(e.pos-this.view.state.selection.to))<=2)?(Ee(this.view,R.near(this.view.state.doc.resolve(e.pos))),t.preventDefault()):zt(this.view,"pointer")}move(t){this.updateAllowDefault(t),zt(this.view,"pointer"),t.buttons==0&&this.done()}updateAllowDefault(t){!this.allowDefault&&(Math.abs(this.event.x-t.clientX)>4||Math.abs(this.event.y-t.clientY)>4)&&(this.allowDefault=!0)}}function vo(o,t){return!!o.composing||!!(ht&&Math.abs(t.timeStamp-o.input.compositionEndedAt)<500)&&(o.input.compositionEndedAt=-2e8,!0)}ct.touchstart=o=>{o.input.lastTouch=Date.now(),Ls(o),zt(o,"pointer")},ct.touchmove=o=>{o.input.lastTouch=Date.now(),zt(o,"pointer")},ct.contextmenu=o=>Ls(o);const oc=gt?5e3:-1;function wo(o,t){clearTimeout(o.input.composingTimeout),t>-1&&(o.input.composingTimeout=setTimeout(()=>_n(o),t))}function ji(o){for(o.composing&&(o.input.composing=!1,o.input.compositionEndedAt=function(){let t=document.createEvent("Event");return t.initEvent("event",!0,!0),t.timeStamp}());o.input.compositionNodes.length>0;)o.input.compositionNodes.pop().markParentsDirty()}function ic(o){let t=o.domSelectionRange();if(!t.focusNode)return null;let e=function(s,r){for(;;){if(s.nodeType==3&&r)return s;if(s.nodeType==1&&r>0){if(s.contentEditable=="false")return null;r=bt(s=s.childNodes[r-1])}else{if(!s.parentNode||Qe(s))return null;r=ot(s),s=s.parentNode}}}(t.focusNode,t.focusOffset),n=function(s,r){for(;;){if(s.nodeType==3&&r<s.nodeValue.length)return s;if(s.nodeType==1&&r<s.childNodes.length){if(s.contentEditable=="false")return null;s=s.childNodes[r],r=0}else{if(!s.parentNode||Qe(s))return null;r=ot(s)+1,s=s.parentNode}}}(t.focusNode,t.focusOffset);if(e&&n&&e!=n){let s=n.pmViewDesc;if(!s||!s.isText(n.nodeValue))return n;if(o.input.compositionNode==n){let r=e.pmViewDesc;if(r&&r.isText(e.nodeValue))return n}}return e||n}function _n(o,t=!1){if(!(gt&&o.domObserver.flushingSoon>=0)){if(o.domObserver.forceFlush(),ji(o),t||o.docView&&o.docView.dirty){let e=tr(o);return e&&!e.eq(o.state.selection)?o.dispatch(o.state.tr.setSelection(e)):o.updateState(o.state),!0}return!1}}dt.compositionstart=dt.compositionupdate=o=>{if(!o.composing){o.domObserver.flush();let{state:t}=o,e=t.selection.$from;if(t.selection.empty&&(t.storedMarks||!e.textOffset&&e.parentOffset&&e.nodeBefore.marks.some(n=>n.type.spec.inclusive===!1)))o.markCursor=o.state.storedMarks||e.marks(),_n(o,!0),o.markCursor=null;else if(_n(o),vt&&t.selection.empty&&e.parentOffset&&!e.textOffset&&e.nodeBefore.marks.length){let n=o.domSelectionRange();for(let s=n.focusNode,r=n.focusOffset;s&&s.nodeType==1&&r!=0;){let i=r<0?s.lastChild:s.childNodes[r-1];if(!i)break;if(i.nodeType==3){o.domSelection().collapse(i,i.nodeValue.length);break}s=i,r=-1}}o.input.composing=!0}wo(o,oc)},dt.compositionend=(o,t)=>{o.composing&&(o.input.composing=!1,o.input.compositionEndedAt=t.timeStamp,o.input.compositionPendingChanges=o.domObserver.pendingRecords().length?o.input.compositionID:0,o.input.compositionNode=null,o.input.compositionPendingChanges&&Promise.resolve().then(()=>o.domObserver.flush()),o.input.compositionID++,wo(o,20))};const je=ut&&Lt<15||Ne&&Fl<604;function We(o,t,e,n,s){let r=Fi(o,t,e,n,o.state.selection.$from);if(o.someProp("handlePaste",l=>l(o,s,r||k.empty)))return!0;if(!r)return!1;let i=function(l){return l.openStart==0&&l.openEnd==0&&l.content.childCount==1?l.content.firstChild:null}(r),a=i?o.state.tr.replaceSelectionWith(i,n):o.state.tr.replaceSelection(r);return o.dispatch(a.scrollIntoView().setMeta("paste",!0).setMeta("uiEvent","paste")),!0}function Wi(o){let t=o.getData("text/plain")||o.getData("Text");if(t)return t;let e=o.getData("text/uri-list");return e?e.replace(/\r?\n/g," "):""}ct.copy=dt.cut=(o,t)=>{let e=t,n=o.state.selection,s=e.type=="cut";if(n.empty)return;let r=je?null:e.clipboardData,i=n.content(),{dom:a,text:l}=qi(o,i);r?(e.preventDefault(),r.clearData(),r.setData("text/html",a.innerHTML),r.setData("text/plain",l)):function(c,d){if(!c.dom.parentNode)return;let h=c.dom.parentNode.appendChild(document.createElement("div"));h.appendChild(d),h.style.cssText="position: fixed; left: -10000px; top: 10px";let u=getSelection(),f=document.createRange();f.selectNodeContents(d),c.dom.blur(),u.removeAllRanges(),u.addRange(f),setTimeout(()=>{h.parentNode&&h.parentNode.removeChild(h),c.focus()},50)}(o,a),s&&o.dispatch(o.state.tr.deleteSelection().scrollIntoView().setMeta("uiEvent","cut"))},dt.paste=(o,t)=>{let e=t;if(o.composing&&!gt)return;let n=je?null:e.clipboardData,s=o.input.shiftKey&&o.input.lastKeyCode!=45;n&&We(o,Wi(n),n.getData("text/html"),s,e)?e.preventDefault():function(r,i){if(!r.dom.parentNode)return;let a=r.input.shiftKey||r.state.selection.$from.parent.type.spec.code,l=r.dom.parentNode.appendChild(document.createElement(a?"textarea":"div"));a||(l.contentEditable="true"),l.style.cssText="position: fixed; left: -10000px; top: 10px",l.focus();let c=r.input.shiftKey&&r.input.lastKeyCode!=45;setTimeout(()=>{r.focus(),l.parentNode&&l.parentNode.removeChild(l),a?We(r,l.value,null,c,i):We(r,l.textContent,l.innerHTML,c,i)},50)}(o,e)};class Ji{constructor(t,e,n){this.slice=t,this.move=e,this.node=n}}const xo=ft?"altKey":"ctrlKey";ct.dragstart=(o,t)=>{let e=t,n=o.input.mouseDown;if(n&&n.done(),!e.dataTransfer)return;let s,r=o.state.selection,i=r.empty?null:o.posAtCoords(Sn(e));if(!(i&&i.pos>=r.from&&i.pos<=(r instanceof I?r.to-1:r.to))){if(n&&n.mightDrag)s=I.create(o.state.doc,n.mightDrag.pos);else if(e.target&&e.target.nodeType==1){let h=o.docView.nearestDesc(e.target,!0);h&&h.node.type.spec.draggable&&h!=o.docView&&(s=I.create(o.state.doc,h.posBefore))}}let a=(s||o.state.selection).content(),{dom:l,text:c,slice:d}=qi(o,a);e.dataTransfer.clearData(),e.dataTransfer.setData(je?"Text":"text/html",l.innerHTML),e.dataTransfer.effectAllowed="copyMove",je||e.dataTransfer.setData("text/plain",c),o.dragging=new Ji(d,!e[xo],s)},ct.dragend=o=>{let t=o.dragging;window.setTimeout(()=>{o.dragging==t&&(o.dragging=null)},50)},dt.dragover=dt.dragenter=(o,t)=>t.preventDefault(),dt.drop=(o,t)=>{let e=t,n=o.dragging;if(o.dragging=null,!e.dataTransfer)return;let s=o.posAtCoords(Sn(e));if(!s)return;let r=o.state.doc.resolve(s.pos),i=n&&n.slice;i?o.someProp("transformPasted",p=>{i=p(i,o)}):i=Fi(o,Wi(e.dataTransfer),je?null:e.dataTransfer.getData("text/html"),!1,r);let a=!(!n||e[xo]);if(o.someProp("handleDrop",p=>p(o,e,i||k.empty,a)))return void e.preventDefault();if(!i)return;e.preventDefault();let l=i?function(p,m,g){let y=p.resolve(m);if(!g.content.size)return m;let v=g.content;for(let w=0;w<g.openStart;w++)v=v.firstChild.content;for(let w=1;w<=(g.openStart==0&&g.size?2:1);w++)for(let x=y.depth;x>=0;x--){let _=x==y.depth?0:y.pos<=(y.start(x+1)+y.end(x+1))/2?-1:1,T=y.index(x)+(_>0?1:0),E=y.node(x),C=!1;if(w==1)C=E.canReplace(T,T,v);else{let S=E.contentMatchAt(T).findWrapping(v.firstChild.type);C=S&&E.canReplaceWith(T,T,S[0])}if(C)return _==0?y.pos:_<0?y.before(x+1):y.after(x+1)}return null}(o.state.doc,r.pos,i):r.pos;l==null&&(l=r.pos);let c=o.state.tr;if(a){let{node:p}=n;p?p.replace(c):c.deleteSelection()}let d=c.mapping.map(l),h=i.openStart==0&&i.openEnd==0&&i.content.childCount==1,u=c.doc;if(h?c.replaceRangeWith(d,d,i.content.firstChild):c.replaceRange(d,d,i),c.doc.eq(u))return;let f=c.doc.resolve(d);if(h&&I.isSelectable(i.content.firstChild)&&f.nodeAfter&&f.nodeAfter.sameMarkup(i.content.firstChild))c.setSelection(new I(f));else{let p=c.mapping.map(l);c.mapping.maps[c.mapping.maps.length-1].forEach((m,g,y,v)=>p=v),c.setSelection(er(o,f,c.doc.resolve(p)))}o.focus(),o.dispatch(c.setMeta("uiEvent","drop"))},ct.focus=o=>{o.input.lastFocus=Date.now(),o.focused||(o.domObserver.stop(),o.dom.classList.add("ProseMirror-focused"),o.domObserver.start(),o.focused=!0,setTimeout(()=>{o.docView&&o.hasFocus()&&!o.domObserver.currentSelection.eq(o.domSelectionRange())&&Ot(o)},20))},ct.blur=(o,t)=>{let e=t;o.focused&&(o.domObserver.stop(),o.dom.classList.remove("ProseMirror-focused"),o.domObserver.start(),e.relatedTarget&&o.dom.contains(e.relatedTarget)&&o.domObserver.currentSelection.clear(),o.focused=!1)},ct.beforeinput=(o,t)=>{if(lt&&gt&&t.inputType=="deleteContentBackward"){o.domObserver.flushSoon();let{domChangeCount:e}=o.input;setTimeout(()=>{if(o.input.domChangeCount!=e||(o.dom.blur(),o.focus(),o.someProp("handleKeyDown",s=>s(o,Xt(8,"Backspace")))))return;let{$cursor:n}=o.state.selection;n&&n.pos>0&&o.dispatch(o.state.tr.delete(n.pos-1,n.pos).scrollIntoView())},50)}};for(let o in dt)ct[o]=dt[o];function Ye(o,t){if(o==t)return!0;for(let e in o)if(o[e]!==t[e])return!1;for(let e in t)if(!(e in o))return!1;return!0}class Cn{constructor(t,e){this.toDOM=t,this.spec=e||ae,this.side=this.spec.side||0}map(t,e,n,s){let{pos:r,deleted:i}=t.mapResult(e.from+s,this.side<0?-1:1);return i?null:new yt(r-n,r-n,this)}valid(){return!0}eq(t){return this==t||t instanceof Cn&&(this.spec.key&&this.spec.key==t.spec.key||this.toDOM==t.toDOM&&Ye(this.spec,t.spec))}destroy(t){this.spec.destroy&&this.spec.destroy(t)}}class Ht{constructor(t,e){this.attrs=t,this.spec=e||ae}map(t,e,n,s){let r=t.map(e.from+s,this.spec.inclusiveStart?-1:1)-n,i=t.map(e.to+s,this.spec.inclusiveEnd?1:-1)-n;return r>=i?null:new yt(r,i,this)}valid(t,e){return e.from<e.to}eq(t){return this==t||t instanceof Ht&&Ye(this.attrs,t.attrs)&&Ye(this.spec,t.spec)}static is(t){return t.type instanceof Ht}destroy(){}}class sr{constructor(t,e){this.attrs=t,this.spec=e||ae}map(t,e,n,s){let r=t.mapResult(e.from+s,1);if(r.deleted)return null;let i=t.mapResult(e.to+s,-1);return i.deleted||i.pos<=r.pos?null:new yt(r.pos-n,i.pos-n,this)}valid(t,e){let n,{index:s,offset:r}=t.content.findIndex(e.from);return r==e.from&&!(n=t.child(s)).isText&&r+n.nodeSize==e.to}eq(t){return this==t||t instanceof sr&&Ye(this.attrs,t.attrs)&&Ye(this.spec,t.spec)}destroy(){}}class yt{constructor(t,e,n){this.from=t,this.to=e,this.type=n}copy(t,e){return new yt(t,e,this.type)}eq(t,e=0){return this.type.eq(t.type)&&this.from+e==t.from&&this.to+e==t.to}map(t,e,n){return this.type.map(t,this,e,n)}static widget(t,e,n){return new yt(t,t,new Cn(e,n))}static inline(t,e,n,s){return new yt(t,e,new Ht(n,s))}static node(t,e,n,s){return new yt(t,e,new sr(n,s))}get spec(){return this.type.spec}get inline(){return this.type instanceof Ht}get widget(){return this.type instanceof Cn}}const xe=[],ae={};class Y{constructor(t,e){this.local=t.length?t:xe,this.children=e.length?e:xe}static create(t,e){return e.length?fn(e,t,0,ae):it}find(t,e,n){let s=[];return this.findInner(t??0,e??1e9,s,0,n),s}findInner(t,e,n,s,r){for(let i=0;i<this.local.length;i++){let a=this.local[i];a.from<=e&&a.to>=t&&(!r||r(a.spec))&&n.push(a.copy(a.from+s,a.to+s))}for(let i=0;i<this.children.length;i+=3)if(this.children[i]<e&&this.children[i+1]>t){let a=this.children[i]+1;this.children[i+2].findInner(t-a,e-a,n,s+a,r)}}map(t,e,n){return this==it||t.maps.length==0?this:this.mapInner(t,e,0,0,n||ae)}mapInner(t,e,n,s,r){let i;for(let a=0;a<this.local.length;a++){let l=this.local[a].map(t,n,s);l&&l.type.valid(e,l)?(i||(i=[])).push(l):r.onRemove&&r.onRemove(this.local[a].spec)}return this.children.length?function(a,l,c,d,h,u,f){let p=a.slice();for(let g=0,y=u;g<c.maps.length;g++){let v=0;c.maps[g].forEach((w,x,_,T)=>{let E=T-_-(x-w);for(let C=0;C<p.length;C+=3){let S=p[C+1];if(S<0||w>S+y-v)continue;let N=p[C]+y-v;x>=N?p[C+1]=w<=N?-2:-1:w>=y&&E&&(p[C]+=E,p[C+1]+=E)}v+=E}),y=c.maps[g].map(y,-1)}let m=!1;for(let g=0;g<p.length;g+=3)if(p[g+1]<0){if(p[g+1]==-2){m=!0,p[g+1]=-1;continue}let y=c.map(a[g]+u),v=y-h;if(v<0||v>=d.content.size){m=!0;continue}let w=c.map(a[g+1]+u,-1)-h,{index:x,offset:_}=d.content.findIndex(v),T=d.maybeChild(x);if(T&&_==v&&_+T.nodeSize==w){let E=p[g+2].mapInner(c,T,y+1,a[g]+u+1,f);E!=it?(p[g]=v,p[g+1]=w,p[g+2]=E):(p[g+1]=-2,m=!0)}else m=!0}if(m){let g=function(v,w,x,_,T,E,C){function S(N,L){for(let D=0;D<N.local.length;D++){let F=N.local[D].map(_,T,L);F?x.push(F):C.onRemove&&C.onRemove(N.local[D].spec)}for(let D=0;D<N.children.length;D+=3)S(N.children[D+2],N.children[D]+L+1)}for(let N=0;N<v.length;N+=3)v[N+1]==-1&&S(v[N+2],w[N]+E+1);return x}(p,a,l,c,h,u,f),y=fn(g,d,0,f);l=y.local;for(let v=0;v<p.length;v+=3)p[v+1]<0&&(p.splice(v,3),v-=3);for(let v=0,w=0;v<y.children.length;v+=3){let x=y.children[v];for(;w<p.length&&p[w]<x;)w+=3;p.splice(w,0,y.children[v],y.children[v+1],y.children[v+2])}}return new Y(l.sort(ee),p)}(this.children,i||[],t,e,n,s,r):i?new Y(i.sort(ee),xe):it}add(t,e){return e.length?this==it?Y.create(t,e):this.addInner(t,e,0):this}addInner(t,e,n){let s,r=0;t.forEach((a,l)=>{let c,d=l+n;if(c=Gi(e,a,d)){for(s||(s=this.children.slice());r<s.length&&s[r]<l;)r+=3;s[r]==l?s[r+2]=s[r+2].addInner(a,c,d+1):s.splice(r,0,l,l+a.nodeSize,fn(c,a,d+1,ae)),r+=3}});let i=Ki(r?Xi(e):e,-n);for(let a=0;a<i.length;a++)i[a].type.valid(t,i[a])||i.splice(a--,1);return new Y(i.length?this.local.concat(i).sort(ee):this.local,s||this.children)}remove(t){return t.length==0||this==it?this:this.removeInner(t,0)}removeInner(t,e){let n=this.children,s=this.local;for(let r=0;r<n.length;r+=3){let i,a=n[r]+e,l=n[r+1]+e;for(let d,h=0;h<t.length;h++)(d=t[h])&&d.from>a&&d.to<l&&(t[h]=null,(i||(i=[])).push(d));if(!i)continue;n==this.children&&(n=this.children.slice());let c=n[r+2].removeInner(i,a+1);c!=it?n[r+2]=c:(n.splice(r,3),r-=3)}if(s.length){for(let r,i=0;i<t.length;i++)if(r=t[i])for(let a=0;a<s.length;a++)s[a].eq(r,e)&&(s==this.local&&(s=this.local.slice()),s.splice(a--,1))}return n==this.children&&s==this.local?this:s.length||n.length?new Y(s,n):it}forChild(t,e){if(this==it)return this;if(e.isLeaf)return Y.empty;let n,s;for(let a=0;a<this.children.length;a+=3)if(this.children[a]>=t){this.children[a]==t&&(n=this.children[a+2]);break}let r=t+1,i=r+e.content.size;for(let a=0;a<this.local.length;a++){let l=this.local[a];if(l.from<i&&l.to>r&&l.type instanceof Ht){let c=Math.max(r,l.from)-r,d=Math.min(i,l.to)-r;c<d&&(s||(s=[])).push(l.copy(c,d))}}if(s){let a=new Y(s.sort(ee),xe);return n?new Pt([a,n]):a}return n||it}eq(t){if(this==t)return!0;if(!(t instanceof Y)||this.local.length!=t.local.length||this.children.length!=t.children.length)return!1;for(let e=0;e<this.local.length;e++)if(!this.local[e].eq(t.local[e]))return!1;for(let e=0;e<this.children.length;e+=3)if(this.children[e]!=t.children[e]||this.children[e+1]!=t.children[e+1]||!this.children[e+2].eq(t.children[e+2]))return!1;return!0}locals(t){return rr(this.localsInner(t))}localsInner(t){if(this==it)return xe;if(t.inlineContent||!this.local.some(Ht.is))return this.local;let e=[];for(let n=0;n<this.local.length;n++)this.local[n].type instanceof Ht||e.push(this.local[n]);return e}}Y.empty=new Y([],[]),Y.removeOverlap=rr;const it=Y.empty;class Pt{constructor(t){this.members=t}map(t,e){const n=this.members.map(s=>s.map(t,e,ae));return Pt.from(n)}forChild(t,e){if(e.isLeaf)return Y.empty;let n=[];for(let s=0;s<this.members.length;s++){let r=this.members[s].forChild(t,e);r!=it&&(r instanceof Pt?n=n.concat(r.members):n.push(r))}return Pt.from(n)}eq(t){if(!(t instanceof Pt)||t.members.length!=this.members.length)return!1;for(let e=0;e<this.members.length;e++)if(!this.members[e].eq(t.members[e]))return!1;return!0}locals(t){let e,n=!0;for(let s=0;s<this.members.length;s++){let r=this.members[s].localsInner(t);if(r.length)if(e){n&&(e=e.slice(),n=!1);for(let i=0;i<r.length;i++)e.push(r[i])}else e=r}return e?rr(n?e:e.sort(ee)):xe}static from(t){switch(t.length){case 0:return it;case 1:return t[0];default:return new Pt(t.every(e=>e instanceof Y)?t:t.reduce((e,n)=>e.concat(n instanceof Y?n:n.members),[]))}}}function Ki(o,t){if(!t||!o.length)return o;let e=[];for(let n=0;n<o.length;n++){let s=o[n];e.push(new yt(s.from+t,s.to+t,s.type))}return e}function Gi(o,t,e){if(t.isLeaf)return null;let n=e+t.nodeSize,s=null;for(let r,i=0;i<o.length;i++)(r=o[i])&&r.from>e&&r.to<n&&((s||(s=[])).push(r),o[i]=null);return s}function Xi(o){let t=[];for(let e=0;e<o.length;e++)o[e]!=null&&t.push(o[e]);return t}function fn(o,t,e,n){let s=[],r=!1;t.forEach((a,l)=>{let c=Gi(o,a,l+e);if(c){r=!0;let d=fn(c,a,e+l+1,n);d!=it&&s.push(l,l+a.nodeSize,d)}});let i=Ki(r?Xi(o):o,-e).sort(ee);for(let a=0;a<i.length;a++)i[a].type.valid(t,i[a])||(n.onRemove&&n.onRemove(i[a].spec),i.splice(a--,1));return i.length||s.length?new Y(i,s):it}function ee(o,t){return o.from-t.from||o.to-t.to}function rr(o){let t=o;for(let e=0;e<t.length-1;e++){let n=t[e];if(n.from!=n.to)for(let s=e+1;s<t.length;s++){let r=t[s];if(r.from!=n.from){r.from<n.to&&(t==o&&(t=o.slice()),t[e]=n.copy(n.from,r.from),bo(t,s,n.copy(r.from,n.to)));break}r.to!=n.to&&(t==o&&(t=o.slice()),t[s]=r.copy(r.from,n.to),bo(t,s+1,r.copy(n.to,r.to)))}}return t}function bo(o,t,e){for(;t<o.length&&ee(e,o[t])>0;)t++;o.splice(t,0,e)}function cs(o){let t=[];return o.someProp("decorations",e=>{let n=e(o.state);n&&n!=it&&t.push(n)}),o.cursorWrapper&&t.push(Y.create(o.state.doc,[o.cursorWrapper.deco])),Pt.from(t)}const ac={childList:!0,characterData:!0,characterDataOldValue:!0,attributes:!0,attributeOldValue:!0,subtree:!0},lc=ut&&Lt<=11;class cc{constructor(){this.anchorNode=null,this.anchorOffset=0,this.focusNode=null,this.focusOffset=0}set(t){this.anchorNode=t.anchorNode,this.anchorOffset=t.anchorOffset,this.focusNode=t.focusNode,this.focusOffset=t.focusOffset}clear(){this.anchorNode=this.focusNode=null}eq(t){return t.anchorNode==this.anchorNode&&t.anchorOffset==this.anchorOffset&&t.focusNode==this.focusNode&&t.focusOffset==this.focusOffset}}class dc{constructor(t,e){this.view=t,this.handleDOMChange=e,this.queue=[],this.flushingSoon=-1,this.observer=null,this.currentSelection=new cc,this.onCharData=null,this.suppressingSelectionUpdates=!1,this.observer=window.MutationObserver&&new window.MutationObserver(n=>{for(let s=0;s<n.length;s++)this.queue.push(n[s]);ut&&Lt<=11&&n.some(s=>s.type=="childList"&&s.removedNodes.length||s.type=="characterData"&&s.oldValue.length>s.target.nodeValue.length)?this.flushSoon():this.flush()}),lc&&(this.onCharData=n=>{this.queue.push({target:n.target,type:"characterData",oldValue:n.prevValue}),this.flushSoon()}),this.onSelectionChange=this.onSelectionChange.bind(this)}flushSoon(){this.flushingSoon<0&&(this.flushingSoon=window.setTimeout(()=>{this.flushingSoon=-1,this.flush()},20))}forceFlush(){this.flushingSoon>-1&&(window.clearTimeout(this.flushingSoon),this.flushingSoon=-1,this.flush())}start(){this.observer&&(this.observer.takeRecords(),this.observer.observe(this.view.dom,ac)),this.onCharData&&this.view.dom.addEventListener("DOMCharacterDataModified",this.onCharData),this.connectSelection()}stop(){if(this.observer){let t=this.observer.takeRecords();if(t.length){for(let e=0;e<t.length;e++)this.queue.push(t[e]);window.setTimeout(()=>this.flush(),20)}this.observer.disconnect()}this.onCharData&&this.view.dom.removeEventListener("DOMCharacterDataModified",this.onCharData),this.disconnectSelection()}connectSelection(){this.view.dom.ownerDocument.addEventListener("selectionchange",this.onSelectionChange)}disconnectSelection(){this.view.dom.ownerDocument.removeEventListener("selectionchange",this.onSelectionChange)}suppressSelectionUpdates(){this.suppressingSelectionUpdates=!0,setTimeout(()=>this.suppressingSelectionUpdates=!1,50)}onSelectionChange(){if(lo(this.view)){if(this.suppressingSelectionUpdates)return Ot(this.view);if(ut&&Lt<=11&&!this.view.state.selection.empty){let t=this.view.domSelectionRange();if(t.focusNode&&he(t.focusNode,t.focusOffset,t.anchorNode,t.anchorOffset))return this.flushSoon()}this.flush()}}setCurSelection(){this.currentSelection.set(this.view.domSelectionRange())}ignoreSelectionChange(t){if(!t.focusNode)return!0;let e,n=new Set;for(let r=t.focusNode;r;r=Xe(r))n.add(r);for(let r=t.anchorNode;r;r=Xe(r))if(n.has(r)){e=r;break}let s=e&&this.view.docView.nearestDesc(e);return s&&s.ignoreMutation({type:"selection",target:e.nodeType==3?e.parentNode:e})?(this.setCurSelection(),!0):void 0}pendingRecords(){if(this.observer)for(let t of this.observer.takeRecords())this.queue.push(t);return this.queue}flush(){let{view:t}=this;if(!t.docView||this.flushingSoon>-1)return;let e=this.pendingRecords();e.length&&(this.queue=[]);let n=t.domSelectionRange(),s=!this.suppressingSelectionUpdates&&!this.currentSelection.eq(n)&&lo(t)&&!this.ignoreSelectionChange(n),r=-1,i=-1,a=!1,l=[];if(t.editable)for(let d=0;d<e.length;d++){let h=this.registerMutation(e[d],l);h&&(r=r<0?h.from:Math.min(h.from,r),i=i<0?h.to:Math.max(h.to,i),h.typeOver&&(a=!0))}if(vt&&l.length>1){let d=l.filter(h=>h.nodeName=="BR");if(d.length==2){let h=d[0],u=d[1];h.parentNode&&h.parentNode.parentNode==u.parentNode?u.remove():h.remove()}}let c=null;r<0&&s&&t.input.lastFocus>Date.now()-200&&Math.max(t.input.lastTouch,t.input.lastClick.time)<Date.now()-300&&Pn(n)&&(c=tr(t))&&c.eq(R.near(t.state.doc.resolve(0),1))?(t.input.lastFocus=0,Ot(t),this.currentSelection.set(n),t.scrollToSelection()):(r>-1||s)&&(r>-1&&(t.docView.markDirty(r,i),function(d){if(!So.has(d)&&(So.set(d,null),["normal","nowrap","pre-line"].indexOf(getComputedStyle(d.dom).whiteSpace)!==-1)){if(d.requiresGeckoHackNode=vt,_o)return;console.warn("ProseMirror expects the CSS white-space property to be set, preferably to 'pre-wrap'. It is recommended to load style/prosemirror.css from the prosemirror-view package."),_o=!0}}(t)),this.handleDOMChange(r,i,a,l),t.docView&&t.docView.dirty?t.updateState(t.state):this.currentSelection.eq(n)||Ot(t),this.currentSelection.set(n))}registerMutation(t,e){if(e.indexOf(t.target)>-1)return null;let n=this.view.docView.nearestDesc(t.target);if(t.type=="attributes"&&(n==this.view.docView||t.attributeName=="contenteditable"||t.attributeName=="style"&&!t.oldValue&&!t.target.getAttribute("style"))||!n||n.ignoreMutation(t))return null;if(t.type=="childList"){for(let c=0;c<t.addedNodes.length;c++)e.push(t.addedNodes[c]);if(n.contentDOM&&n.contentDOM!=n.dom&&!n.contentDOM.contains(t.target))return{from:n.posBefore,to:n.posAfter};let s=t.previousSibling,r=t.nextSibling;if(ut&&Lt<=11&&t.addedNodes.length)for(let c=0;c<t.addedNodes.length;c++){let{previousSibling:d,nextSibling:h}=t.addedNodes[c];(!d||Array.prototype.indexOf.call(t.addedNodes,d)<0)&&(s=d),(!h||Array.prototype.indexOf.call(t.addedNodes,h)<0)&&(r=h)}let i=s&&s.parentNode==t.target?ot(s)+1:0,a=n.localPosFromDOM(t.target,i,-1),l=r&&r.parentNode==t.target?ot(r):t.target.childNodes.length;return{from:a,to:n.localPosFromDOM(t.target,l,1)}}return t.type=="attributes"?{from:n.posAtStart-n.border,to:n.posAtEnd+n.border}:{from:n.posAtStart,to:n.posAtEnd,typeOver:t.target.nodeValue==t.oldValue}}}let So=new WeakMap,_o=!1;function Co(o,t){let e=t.startContainer,n=t.startOffset,s=t.endContainer,r=t.endOffset,i=o.domAtPos(o.state.selection.anchor);return he(i.node,i.offset,s,r)&&([e,n,s,r]=[s,r,e,n]),{anchorNode:e,anchorOffset:n,focusNode:s,focusOffset:r}}function hc(o){let t=o.pmViewDesc;if(t)return t.parseRule();if(o.nodeName=="BR"&&o.parentNode){if(ht&&/^(ul|ol)$/i.test(o.parentNode.nodeName)){let e=document.createElement("div");return e.appendChild(document.createElement("li")),{skip:e}}if(o.parentNode.lastChild==o||ht&&/^(tr|table)$/i.test(o.parentNode.nodeName))return{ignore:!0}}else if(o.nodeName=="IMG"&&o.getAttribute("mark-placeholder"))return{ignore:!0};return null}const uc=/^(a|abbr|acronym|b|bd[io]|big|br|button|cite|code|data(list)?|del|dfn|em|i|ins|kbd|label|map|mark|meter|output|q|ruby|s|samp|small|span|strong|su[bp]|time|u|tt|var)$/i;function pc(o,t,e,n,s){let r=o.input.compositionPendingChanges||(o.composing?o.input.compositionID:0);if(o.input.compositionPendingChanges=0,t<0){let S=o.input.lastSelectionTime>Date.now()-50?o.input.lastSelectionOrigin:null,N=tr(o,S);if(N&&!o.state.selection.eq(N)){if(lt&&gt&&o.input.lastKeyCode===13&&Date.now()-100<o.input.lastKeyCodeTime&&o.someProp("handleKeyDown",D=>D(o,Xt(13,"Enter"))))return;let L=o.state.tr.setSelection(N);S=="pointer"?L.setMeta("pointer",!0):S=="key"&&L.scrollIntoView(),r&&L.setMeta("composition",r),o.dispatch(L)}return}let i=o.state.doc.resolve(t),a=i.sharedDepth(e);t=i.before(a+1),e=o.state.doc.resolve(e).after(a+1);let l,c,d=o.state.selection,h=function(S,N,L){let D,{node:F,fromOffset:O,toOffset:q,from:z,to:G}=S.docView.parseRange(N,L),et=S.domSelectionRange(),$=et.anchorNode;if($&&S.dom.contains($.nodeType==1?$:$.parentNode)&&(D=[{node:$,offset:et.anchorOffset}],Pn(et)||D.push({node:et.focusNode,offset:et.focusOffset})),lt&&S.input.lastKeyCode===8)for(let Jt=q;Jt>O;Jt--){let pe=F.childNodes[Jt-1],Hn=pe.pmViewDesc;if(pe.nodeName=="BR"&&!Hn){q=Jt;break}if(!Hn||Hn.size)break}let Ln=S.state.doc,Bn=S.someProp("domParser")||Oe.fromSchema(S.state.schema),Wt=Ln.resolve(z),hr=null,va=Bn.parse(F,{topNode:Wt.parent,topMatch:Wt.parent.contentMatchAt(Wt.index()),topOpen:!0,from:O,to:q,preserveWhitespace:Wt.parent.type.whitespace!="pre"||"full",findPositions:D,ruleFromNode:hc,context:Wt});if(D&&D[0].pos!=null){let Jt=D[0].pos,pe=D[1]&&D[1].pos;pe==null&&(pe=Jt),hr={anchor:Jt+z,head:pe+z}}return{doc:va,sel:hr,from:z,to:G}}(o,t,e),u=o.state.doc,f=u.slice(h.from,h.to);o.input.lastKeyCode===8&&Date.now()-100<o.input.lastKeyCodeTime?(l=o.state.selection.to,c="end"):(l=o.state.selection.from,c="start"),o.input.lastKeyCode=null;let p=function(S,N,L,D,F){let O=S.findDiffStart(N,L);if(O==null)return null;let{a:q,b:z}=S.findDiffEnd(N,L+S.size,L+N.size);if(F=="end"&&(D-=q+Math.max(0,O-Math.min(q,z))-O),q<O&&S.size<N.size){let G=D<=O&&D>=q?O-D:0;O-=G,O&&O<N.size&&Mo(N.textBetween(O-1,O+1))&&(O+=G?1:-1),z=O+(z-q),q=O}else if(z<O){let G=D<=O&&D>=z?O-D:0;O-=G,O&&O<S.size&&Mo(S.textBetween(O-1,O+1))&&(O+=G?1:-1),q=O+(q-z),z=O}return{start:O,endA:q,endB:z}}(f.content,h.doc.content,h.from,l,c);if((Ne&&o.input.lastIOSEnter>Date.now()-225||gt)&&s.some(S=>S.nodeType==1&&!uc.test(S.nodeName))&&(!p||p.endA>=p.endB)&&o.someProp("handleKeyDown",S=>S(o,Xt(13,"Enter"))))return void(o.input.lastIOSEnter=0);if(!p){if(!(n&&d instanceof A&&!d.empty&&d.$head.sameParent(d.$anchor))||o.composing||h.sel&&h.sel.anchor!=h.sel.head){if(h.sel){let S=ko(o,o.state.doc,h.sel);if(S&&!S.eq(o.state.selection)){let N=o.state.tr.setSelection(S);r&&N.setMeta("composition",r),o.dispatch(N)}}return}p={start:d.from,endA:d.to,endB:d.to}}o.input.domChangeCount++,o.state.selection.from<o.state.selection.to&&p.start==p.endB&&o.state.selection instanceof A&&(p.start>o.state.selection.from&&p.start<=o.state.selection.from+2&&o.state.selection.from>=h.from?p.start=o.state.selection.from:p.endA<o.state.selection.to&&p.endA>=o.state.selection.to-2&&o.state.selection.to<=h.to&&(p.endB+=o.state.selection.to-p.endA,p.endA=o.state.selection.to)),ut&&Lt<=11&&p.endB==p.start+1&&p.endA==p.start&&p.start>h.from&&h.doc.textBetween(p.start-h.from-1,p.start-h.from+1)==" "&&(p.start--,p.endA--,p.endB--);let m,g=h.doc.resolveNoCache(p.start-h.from),y=h.doc.resolveNoCache(p.endB-h.from),v=u.resolve(p.start),w=g.sameParent(y)&&g.parent.inlineContent&&v.end()>=p.endA;if((Ne&&o.input.lastIOSEnter>Date.now()-225&&(!w||s.some(S=>S.nodeName=="DIV"||S.nodeName=="P"))||!w&&g.pos<h.doc.content.size&&!g.sameParent(y)&&(m=R.findFrom(h.doc.resolve(g.pos+1),1,!0))&&m.head==y.pos)&&o.someProp("handleKeyDown",S=>S(o,Xt(13,"Enter"))))return void(o.input.lastIOSEnter=0);if(o.state.selection.anchor>p.start&&function(S,N,L,D,F){if(L-N<=F.pos-D.pos||ds(D,!0,!1)<F.pos)return!1;let O=S.resolve(N);if(!D.parent.isTextblock){let z=O.nodeAfter;return z!=null&&L==N+z.nodeSize}if(O.parentOffset<O.parent.content.size||!O.parent.isTextblock)return!1;let q=S.resolve(ds(O,!0,!0));return!(!q.parent.isTextblock||q.pos>L||ds(q,!0,!1)<L)&&D.parent.content.cut(D.parentOffset).eq(q.parent.content)}(u,p.start,p.endA,g,y)&&o.someProp("handleKeyDown",S=>S(o,Xt(8,"Backspace"))))return void(gt&&lt&&o.domObserver.suppressSelectionUpdates());lt&&gt&&p.endB==p.start&&(o.input.lastAndroidDelete=Date.now()),gt&&!w&&g.start()!=y.start()&&y.parentOffset==0&&g.depth==y.depth&&h.sel&&h.sel.anchor==h.sel.head&&h.sel.head==p.endA&&(p.endB-=2,y=h.doc.resolveNoCache(p.endB-h.from),setTimeout(()=>{o.someProp("handleKeyDown",function(S){return S(o,Xt(13,"Enter"))})},20));let x,_,T,E=p.start,C=p.endA;if(w){if(g.pos==y.pos)ut&&Lt<=11&&g.parentOffset==0&&(o.domObserver.suppressSelectionUpdates(),setTimeout(()=>Ot(o),20)),x=o.state.tr.delete(E,C),_=u.resolve(p.start).marksAcross(u.resolve(p.endA));else if(p.endA==p.endB&&(T=function(S,N){let L,D,F,O=S.firstChild.marks,q=N.firstChild.marks,z=O,G=q;for(let $=0;$<q.length;$++)z=q[$].removeFromSet(z);for(let $=0;$<O.length;$++)G=O[$].removeFromSet(G);if(z.length==1&&G.length==0)D=z[0],L="add",F=$=>$.mark(D.addToSet($.marks));else{if(z.length!=0||G.length!=1)return null;D=G[0],L="remove",F=$=>$.mark(D.removeFromSet($.marks))}let et=[];for(let $=0;$<N.childCount;$++)et.push(F(N.child($)));if(b.from(et).eq(S))return{mark:D,type:L}}(g.parent.content.cut(g.parentOffset,y.parentOffset),v.parent.content.cut(v.parentOffset,p.endA-v.start()))))x=o.state.tr,T.type=="add"?x.addMark(E,C,T.mark):x.removeMark(E,C,T.mark);else if(g.parent.child(g.index()).isText&&g.index()==y.index()-(y.textOffset?0:1)){let S=g.parent.textBetween(g.parentOffset,y.parentOffset);if(o.someProp("handleTextInput",N=>N(o,E,C,S)))return;x=o.state.tr.insertText(S,E,C)}}if(x||(x=o.state.tr.replace(E,C,h.doc.slice(p.start-h.from,p.endB-h.from))),h.sel){let S=ko(o,x.doc,h.sel);S&&!(lt&&gt&&o.composing&&S.empty&&(p.start!=p.endB||o.input.lastAndroidDelete<Date.now()-100)&&(S.head==E||S.head==x.mapping.map(C)-1)||ut&&S.empty&&S.head==E)&&x.setSelection(S)}_&&x.ensureMarks(_),r&&x.setMeta("composition",r),o.dispatch(x.scrollIntoView())}function ko(o,t,e){return Math.max(e.anchor,e.head)>t.content.size?null:er(o,t.resolve(e.anchor),t.resolve(e.head))}function ds(o,t,e){let n=o.depth,s=t?o.end():o.pos;for(;n>0&&(t||o.indexAfter(n)==o.node(n).childCount);)n--,s++,t=!1;if(e){let r=o.node(n).maybeChild(o.indexAfter(n));for(;r&&!r.isLeaf;)r=r.firstChild,s++}return s}function Mo(o){if(o.length!=2)return!1;let t=o.charCodeAt(0),e=o.charCodeAt(1);return t>=56320&&t<=57343&&e>=55296&&e<=56319}class fc{constructor(t,e){this._root=null,this.focused=!1,this.trackWrites=null,this.mounted=!1,this.markCursor=null,this.cursorWrapper=null,this.lastSelectedViewDesc=void 0,this.input=new Zl,this.prevDirectPlugins=[],this.pluginViews=[],this.requiresGeckoHackNode=!1,this.dragging=null,this._props=e,this.state=e.state,this.directPlugins=e.plugins||[],this.directPlugins.forEach(No),this.dispatch=this.dispatch.bind(this),this.dom=t&&t.mount||document.createElement("div"),t&&(t.appendChild?t.appendChild(this.dom):typeof t=="function"?t(this.dom):t.mount&&(this.mounted=!0)),this.editable=Oo(this),Eo(this),this.nodeViews=Io(this),this.docView=eo(this.state.doc,To(this),cs(this),this.dom,this),this.domObserver=new dc(this,(n,s,r,i)=>pc(this,n,s,r,i)),this.domObserver.start(),function(n){for(let s in ct){let r=ct[s];n.dom.addEventListener(s,n.input.eventHandlers[s]=i=>{!tc(n,i)||zs(n,i)||!n.editable&&i.type in dt||r(n,i)},Yl[s]?{passive:!0}:void 0)}ht&&n.dom.addEventListener("input",()=>null),ls(n)}(this),this.updatePluginViews()}get composing(){return this.input.composing}get props(){if(this._props.state!=this.state){let t=this._props;this._props={};for(let e in t)this._props[e]=t[e];this._props.state=this.state}return this._props}update(t){t.handleDOMEvents!=this._props.handleDOMEvents&&ls(this);let e=this._props;this._props=t,t.plugins&&(t.plugins.forEach(No),this.directPlugins=t.plugins),this.updateStateInner(t.state,e)}setProps(t){let e={};for(let n in this._props)e[n]=this._props[n];e.state=this.state;for(let n in t)e[n]=t[n];this.update(e)}updateState(t){this.updateStateInner(t,this._props)}updateStateInner(t,e){var n;let s=this.state,r=!1,i=!1;t.storedMarks&&this.composing&&(ji(this),i=!0),this.state=t;let a=s.plugins!=t.plugins||this._props.plugins!=e.plugins;if(a||this._props.plugins!=e.plugins||this._props.nodeViews!=e.nodeViews){let f=Io(this);(function(p,m){let g=0,y=0;for(let v in p){if(p[v]!=m[v])return!0;g++}for(let v in m)y++;return g!=y})(f,this.nodeViews)&&(this.nodeViews=f,r=!0)}(a||e.handleDOMEvents!=this._props.handleDOMEvents)&&ls(this),this.editable=Oo(this),Eo(this);let l=cs(this),c=To(this),d=s.plugins==t.plugins||s.doc.eq(t.doc)?t.scrollToSelection>s.scrollToSelection?"to selection":"preserve":"reset",h=r||!this.docView.matchesNode(t.doc,c,l);!h&&t.selection.eq(s.selection)||(i=!0);let u=d=="preserve"&&i&&this.dom.style.overflowAnchor==null&&function(f){let p,m,g=f.dom.getBoundingClientRect(),y=Math.max(0,g.top);for(let v=(g.left+g.right)/2,w=y+1;w<Math.min(innerHeight,g.bottom);w+=5){let x=f.root.elementFromPoint(v,w);if(!x||x==f.dom||!f.dom.contains(x))continue;let _=x.getBoundingClientRect();if(_.top>=y-20){p=x,m=_.top;break}}return{refDOM:p,refTop:m,stack:Kr(f.dom)}}(this);if(i){this.domObserver.stop();let f=h&&(ut||lt)&&!this.composing&&!s.selection.empty&&!t.selection.empty&&function(p,m){let g=Math.min(p.$anchor.sharedDepth(p.head),m.$anchor.sharedDepth(m.head));return p.$anchor.start(g)!=m.$anchor.start(g)}(s.selection,t.selection);if(h){let p=lt?this.trackWrites=this.domSelectionRange().focusNode:null;this.composing&&(this.input.compositionNode=ic(this)),!r&&this.docView.update(t.doc,c,l,this)||(this.docView.updateOuterDeco(c),this.docView.destroy(),this.docView=eo(t.doc,c,l,this.dom,this)),p&&!this.trackWrites&&(f=!0)}f||!(this.input.mouseDown&&this.domObserver.currentSelection.eq(this.domSelectionRange())&&function(p){let m=p.docView.domFromPos(p.state.selection.anchor,0),g=p.domSelectionRange();return he(m.node,m.offset,g.anchorNode,g.anchorOffset)}(this))?Ot(this,f):(Pi(this,t.selection),this.domObserver.setCurSelection()),this.domObserver.start()}this.updatePluginViews(s),!((n=this.dragging)===null||n===void 0)&&n.node&&!s.doc.eq(t.doc)&&this.updateDraggedNode(this.dragging,s),d=="reset"?this.dom.scrollTop=0:d=="to selection"?this.scrollToSelection():u&&function({refDOM:f,refTop:p,stack:m}){let g=f?f.getBoundingClientRect().top:0;Gr(m,g==0?0:g-p)}(u)}scrollToSelection(){let t=this.domSelectionRange().focusNode;if(!this.someProp("handleScrollToSelection",e=>e(this)))if(this.state.selection instanceof I){let e=this.docView.domAfterPos(this.state.selection.from);e.nodeType==1&&Jr(this,e.getBoundingClientRect(),t)}else Jr(this,this.coordsAtPos(this.state.selection.head,1),t)}destroyPluginViews(){let t;for(;t=this.pluginViews.pop();)t.destroy&&t.destroy()}updatePluginViews(t){if(t&&t.plugins==this.state.plugins&&this.directPlugins==this.prevDirectPlugins)for(let e=0;e<this.pluginViews.length;e++){let n=this.pluginViews[e];n.update&&n.update(this,t)}else{this.prevDirectPlugins=this.directPlugins,this.destroyPluginViews();for(let e=0;e<this.directPlugins.length;e++){let n=this.directPlugins[e];n.spec.view&&this.pluginViews.push(n.spec.view(this))}for(let e=0;e<this.state.plugins.length;e++){let n=this.state.plugins[e];n.spec.view&&this.pluginViews.push(n.spec.view(this))}}}updateDraggedNode(t,e){let n=t.node,s=-1;if(this.state.doc.nodeAt(n.from)==n.node)s=n.from;else{let r=n.from+(this.state.doc.content.size-e.doc.content.size);(r>0&&this.state.doc.nodeAt(r))==n.node&&(s=r)}this.dragging=new Ji(t.slice,t.move,s<0?void 0:I.create(this.state.doc,s))}someProp(t,e){let n,s=this._props&&this._props[t];if(s!=null&&(n=e?e(s):s))return n;for(let i=0;i<this.directPlugins.length;i++){let a=this.directPlugins[i].props[t];if(a!=null&&(n=e?e(a):a))return n}let r=this.state.plugins;if(r)for(let i=0;i<r.length;i++){let a=r[i].props[t];if(a!=null&&(n=e?e(a):a))return n}}hasFocus(){if(ut){let t=this.root.activeElement;if(t==this.dom)return!0;if(!t||!this.dom.contains(t))return!1;for(;t&&this.dom!=t&&this.dom.contains(t);){if(t.contentEditable=="false")return!1;t=t.parentElement}return!0}return this.root.activeElement==this.dom}focus(){this.domObserver.stop(),this.editable&&function(t){if(t.setActive)return t.setActive();if(ge)return t.focus(ge);let e=Kr(t);t.focus(ge==null?{get preventScroll(){return ge={preventScroll:!0},!0}}:void 0),ge||(ge=!1,Gr(e,0))}(this.dom),Ot(this),this.domObserver.start()}get root(){let t=this._root;if(t==null){for(let e=this.dom.parentNode;e;e=e.parentNode)if(e.nodeType==9||e.nodeType==11&&e.host)return e.getSelection||(Object.getPrototypeOf(e).getSelection=()=>e.ownerDocument.getSelection()),this._root=e}return t||document}updateRoot(){this._root=null}posAtCoords(t){return Bl(this,t)}coordsAtPos(t,e=1){return Oi(this,t,e)}domAtPos(t,e=0){return this.docView.domFromPos(t,e)}nodeDOM(t){let e=this.docView.descAt(t);return e?e.nodeDOM:null}posAtDOM(t,e,n=-1){let s=this.docView.posFromDOM(t,e,n);if(s==null)throw new RangeError("DOM position not inside the editor");return s}endOfTextblock(t,e){return Ul(this,e||this.state,t)}pasteHTML(t,e){return We(this,"",t,!1,e||new ClipboardEvent("paste"))}pasteText(t,e){return We(this,t,null,!0,e||new ClipboardEvent("paste"))}destroy(){this.docView&&(function(t){t.domObserver.stop();for(let e in t.input.eventHandlers)t.dom.removeEventListener(e,t.input.eventHandlers[e]);clearTimeout(t.input.composingTimeout),clearTimeout(t.input.lastIOSEnterFallbackTimeout)}(this),this.destroyPluginViews(),this.mounted?(this.docView.update(this.state.doc,[],cs(this),this),this.dom.textContent=""):this.dom.parentNode&&this.dom.parentNode.removeChild(this.dom),this.docView.destroy(),this.docView=null,Is=null)}get isDestroyed(){return this.docView==null}dispatchEvent(t){return function(e,n){zs(e,n)||!ct[n.type]||!e.editable&&n.type in dt||ct[n.type](e,n)}(this,t)}dispatch(t){let e=this._props.dispatchTransaction;e?e.call(this,t):this.updateState(this.state.apply(t))}domSelectionRange(){let t=this.domSelection();return ht&&this.root.nodeType===11&&function(e){let n=e.activeElement;for(;n&&n.shadowRoot;)n=n.shadowRoot.activeElement;return n}(this.dom.ownerDocument)==this.dom&&function(e,n){if(n.getComposedRanges){let i=n.getComposedRanges(e.root)[0];if(i)return Co(e,i)}let s;function r(i){i.preventDefault(),i.stopImmediatePropagation(),s=i.getTargetRanges()[0]}return e.dom.addEventListener("beforeinput",r,!0),document.execCommand("indent"),e.dom.removeEventListener("beforeinput",r,!0),s?Co(e,s):null}(this,t)||t}domSelection(){return this.root.getSelection()}}function To(o){let t=Object.create(null);return t.class="ProseMirror",t.contenteditable=String(o.editable),o.someProp("attributes",e=>{if(typeof e=="function"&&(e=e(o.state)),e)for(let n in e)n=="class"?t.class+=" "+e[n]:n=="style"?t.style=(t.style?t.style+";":"")+e[n]:t[n]||n=="contenteditable"||n=="nodeName"||(t[n]=String(e[n]))}),t.translate||(t.translate="no"),[yt.node(0,o.state.doc.content.size,t)]}function Eo(o){if(o.markCursor){let t=document.createElement("img");t.className="ProseMirror-separator",t.setAttribute("mark-placeholder","true"),t.setAttribute("alt",""),o.cursorWrapper={dom:t,deco:yt.widget(o.state.selection.head,t,{raw:!0,marks:o.markCursor})}}else o.cursorWrapper=null}function Oo(o){return!o.someProp("editable",t=>t(o.state)===!1)}function Io(o){let t=Object.create(null);function e(n){for(let s in n)Object.prototype.hasOwnProperty.call(t,s)||(t[s]=n[s])}return o.someProp("nodeViews",e),o.someProp("markViews",e),t}function No(o){if(o.spec.state||o.spec.filterTransaction||o.spec.appendTransaction)throw new RangeError("Plugins passed directly to the view must not have a state component")}for(var Vt={8:"Backspace",9:"Tab",10:"Enter",12:"NumLock",13:"Enter",16:"Shift",17:"Control",18:"Alt",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",44:"PrintScreen",45:"Insert",46:"Delete",59:";",61:"=",91:"Meta",92:"Meta",106:"*",107:"+",108:",",109:"-",110:".",111:"/",144:"NumLock",145:"ScrollLock",160:"Shift",161:"Shift",162:"Control",163:"Control",164:"Alt",165:"Alt",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},kn={48:")",49:"!",50:"@",51:"#",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",59:":",61:"+",173:"_",186:":",187:"+",188:"<",189:"_",190:">",191:"?",192:"~",219:"{",220:"|",221:"}",222:'"'},mc=typeof navigator<"u"&&/Mac/.test(navigator.platform),gc=typeof navigator<"u"&&/MSIE \d|Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(navigator.userAgent),rt=0;rt<10;rt++)Vt[48+rt]=Vt[96+rt]=String(rt);for(rt=1;rt<=24;rt++)Vt[rt+111]="F"+rt;for(rt=65;rt<=90;rt++)Vt[rt]=String.fromCharCode(rt+32),kn[rt]=String.fromCharCode(rt);for(var hs in Vt)kn.hasOwnProperty(hs)||(kn[hs]=Vt[hs]);const yc=typeof navigator<"u"&&/Mac|iP(hone|[oa]d)/.test(navigator.platform);function vc(o){let t,e,n,s,r=o.split(/-(?!$)/),i=r[r.length-1];i=="Space"&&(i=" ");for(let a=0;a<r.length-1;a++){let l=r[a];if(/^(cmd|meta|m)$/i.test(l))s=!0;else if(/^a(lt)?$/i.test(l))t=!0;else if(/^(c|ctrl|control)$/i.test(l))e=!0;else if(/^s(hift)?$/i.test(l))n=!0;else{if(!/^mod$/i.test(l))throw new Error("Unrecognized modifier name: "+l);yc?s=!0:e=!0}}return t&&(i="Alt-"+i),e&&(i="Ctrl-"+i),s&&(i="Meta-"+i),n&&(i="Shift-"+i),i}function us(o,t,e=!0){return t.altKey&&(o="Alt-"+o),t.ctrlKey&&(o="Ctrl-"+o),t.metaKey&&(o="Meta-"+o),e&&t.shiftKey&&(o="Shift-"+o),o}function wc(o){let t=function(e){let n=Object.create(null);for(let s in e)n[vc(s)]=e[s];return n}(o);return function(e,n){let s,r=function(a){var l=!(mc&&a.metaKey&&a.shiftKey&&!a.ctrlKey&&!a.altKey||gc&&a.shiftKey&&a.key&&a.key.length==1||a.key=="Unidentified")&&a.key||(a.shiftKey?kn:Vt)[a.keyCode]||a.key||"Unidentified";return l=="Esc"&&(l="Escape"),l=="Del"&&(l="Delete"),l=="Left"&&(l="ArrowLeft"),l=="Up"&&(l="ArrowUp"),l=="Right"&&(l="ArrowRight"),l=="Down"&&(l="ArrowDown"),l}(n),i=t[us(r,n)];if(i&&i(e.state,e.dispatch,e))return!0;if(r.length==1&&r!=" "){if(n.shiftKey){let a=t[us(r,n,!1)];if(a&&a(e.state,e.dispatch,e))return!0}if((n.shiftKey||n.altKey||n.metaKey||r.charCodeAt(0)>127)&&(s=Vt[n.keyCode])&&s!=r){let a=t[us(s,n)];if(a&&a(e.state,e.dispatch,e))return!0}}return!1}}const Bs=(o,t)=>!o.selection.empty&&(t&&t(o.tr.deleteSelection().scrollIntoView()),!0);function Qi(o,t){let{$cursor:e}=o.selection;return!e||(t?!t.endOfTextblock("backward",o):e.parentOffset>0)?null:e}const Yi=(o,t,e)=>{let n=Qi(o,e);if(!n)return!1;let s=or(n);if(!s){let i=n.blockRange(),a=i&&Ie(i);return a!=null&&(t&&t(o.tr.lift(i,a).scrollIntoView()),!0)}let r=s.nodeBefore;if(!r.type.spec.isolating&&ia(o,s,t))return!0;if(n.parent.content.size==0&&(De(r,"end")||I.isSelectable(r))){let i=An(o.doc,n.before(),n.after(),k.empty);if(i&&i.slice.size<i.to-i.from){if(t){let a=o.tr.step(i);a.setSelection(De(r,"end")?R.findFrom(a.doc.resolve(a.mapping.map(s.pos,-1)),-1):I.create(a.doc,s.pos-r.nodeSize)),t(a.scrollIntoView())}return!0}}return!(!r.isAtom||s.depth!=n.depth-1)&&(t&&t(o.tr.delete(s.pos-r.nodeSize,s.pos).scrollIntoView()),!0)};function Do(o,t,e){let n=t.nodeBefore,s=t.pos-1;for(;!n.isTextblock;s--){if(n.type.spec.isolating)return!1;let l=n.lastChild;if(!l)return!1;n=l}let r=t.nodeAfter,i=t.pos+1;for(;!r.isTextblock;i++){if(r.type.spec.isolating)return!1;let l=r.firstChild;if(!l)return!1;r=l}let a=An(o.doc,s,i,k.empty);if(!a||a.from!=s||a instanceof Z&&a.slice.size>=i-s)return!1;if(e){let l=o.tr.step(a);l.setSelection(A.create(l.doc,s)),e(l.scrollIntoView())}return!0}function De(o,t,e=!1){for(let n=o;n;n=t=="start"?n.firstChild:n.lastChild){if(n.isTextblock)return!0;if(e&&n.childCount!=1)return!1}return!1}const Zi=(o,t,e)=>{let{$head:n,empty:s}=o.selection,r=n;if(!s)return!1;if(n.parent.isTextblock){if(e?!e.endOfTextblock("backward",o):n.parentOffset>0)return!1;r=or(n)}let i=r&&r.nodeBefore;return!(!i||!I.isSelectable(i))&&(t&&t(o.tr.setSelection(I.create(o.doc,r.pos-i.nodeSize)).scrollIntoView()),!0)};function or(o){if(!o.parent.type.spec.isolating)for(let t=o.depth-1;t>=0;t--){if(o.index(t)>0)return o.doc.resolve(o.before(t+1));if(o.node(t).type.spec.isolating)break}return null}function ta(o,t){let{$cursor:e}=o.selection;return!e||(t?!t.endOfTextblock("forward",o):e.parentOffset<e.parent.content.size)?null:e}const ea=(o,t,e)=>{let n=ta(o,e);if(!n)return!1;let s=ir(n);if(!s)return!1;let r=s.nodeAfter;if(ia(o,s,t))return!0;if(n.parent.content.size==0&&(De(r,"start")||I.isSelectable(r))){let i=An(o.doc,n.before(),n.after(),k.empty);if(i&&i.slice.size<i.to-i.from){if(t){let a=o.tr.step(i);a.setSelection(De(r,"start")?R.findFrom(a.doc.resolve(a.mapping.map(s.pos)),1):I.create(a.doc,a.mapping.map(s.pos))),t(a.scrollIntoView())}return!0}}return!(!r.isAtom||s.depth!=n.depth-1)&&(t&&t(o.tr.delete(s.pos,s.pos+r.nodeSize).scrollIntoView()),!0)},na=(o,t,e)=>{let{$head:n,empty:s}=o.selection,r=n;if(!s)return!1;if(n.parent.isTextblock){if(e?!e.endOfTextblock("forward",o):n.parentOffset<n.parent.content.size)return!1;r=ir(n)}let i=r&&r.nodeAfter;return!(!i||!I.isSelectable(i))&&(t&&t(o.tr.setSelection(I.create(o.doc,r.pos)).scrollIntoView()),!0)};function ir(o){if(!o.parent.type.spec.isolating)for(let t=o.depth-1;t>=0;t--){let e=o.node(t);if(o.index(t)+1<e.childCount)return o.doc.resolve(o.after(t+1));if(e.type.spec.isolating)break}return null}const sa=(o,t)=>{let{$head:e,$anchor:n}=o.selection;return!(!e.parent.type.spec.code||!e.sameParent(n))&&(t&&t(o.tr.insertText(`
`).scrollIntoView()),!0)};function ar(o){for(let t=0;t<o.edgeCount;t++){let{type:e}=o.edge(t);if(e.isTextblock&&!e.hasRequiredAttrs())return e}return null}const ra=(o,t)=>{let e=o.selection,{$from:n,$to:s}=e;if(e instanceof mt||n.parent.inlineContent||s.parent.inlineContent)return!1;let r=ar(s.parent.contentMatchAt(s.indexAfter()));if(!r||!r.isTextblock)return!1;if(t){let i=(!n.parentOffset&&s.index()<s.parent.childCount?n:s).pos,a=o.tr.insert(i,r.createAndFill());a.setSelection(A.create(a.doc,i+1)),t(a.scrollIntoView())}return!0},oa=(o,t)=>{let{$cursor:e}=o.selection;if(!e||e.parent.content.size)return!1;if(e.depth>1&&e.after()!=e.end(-1)){let r=e.before();if(Et(o.doc,r))return t&&t(o.tr.split(r).scrollIntoView()),!0}let n=e.blockRange(),s=n&&Ie(n);return s!=null&&(t&&t(o.tr.lift(n,s).scrollIntoView()),!0)},xc=(o,t)=>{let{$from:e,$to:n}=o.selection;if(o.selection instanceof I&&o.selection.node.isBlock)return!(!e.parentOffset||!Et(o.doc,e.pos)||(t&&t(o.tr.split(e.pos).scrollIntoView()),0));if(!e.parent.isBlock)return!1;if(t){let s=n.parentOffset==n.parent.content.size,r=o.tr;(o.selection instanceof A||o.selection instanceof mt)&&r.deleteSelection();let i=e.depth==0?null:ar(e.node(-1).contentMatchAt(e.indexAfter(-1))),a=s&&i?[{type:i}]:void 0,l=Et(r.doc,r.mapping.map(e.pos),1,a);if(a||l||!Et(r.doc,r.mapping.map(e.pos),1,i?[{type:i}]:void 0)||(i&&(a=[{type:i}]),l=!0),l&&(r.split(r.mapping.map(e.pos),1,a),!s&&!e.parentOffset&&e.parent.type!=i)){let c=r.mapping.map(e.before()),d=r.doc.resolve(c);i&&e.node(-1).canReplaceWith(d.index(),d.index()+1,i)&&r.setNodeMarkup(r.mapping.map(e.before()),i)}t(r.scrollIntoView())}return!0};function ia(o,t,e){let n,s,r=t.nodeBefore,i=t.nodeAfter;if(r.type.spec.isolating||i.type.spec.isolating)return!1;if(function(h,u,f){let p=u.nodeBefore,m=u.nodeAfter,g=u.index();return!(!(p&&m&&p.type.compatibleContent(m.type))||(!p.content.size&&u.parent.canReplace(g-1,g)?(f&&f(h.tr.delete(u.pos-p.nodeSize,u.pos).scrollIntoView()),0):!u.parent.canReplace(g,g+1)||!m.isTextblock&&!de(h.doc,u.pos)||(f&&f(h.tr.clearIncompatible(u.pos,p.type,p.contentMatchAt(p.childCount)).join(u.pos).scrollIntoView()),0)))}(o,t,e))return!0;let a=t.parent.canReplace(t.index(),t.index()+1);if(a&&(n=(s=r.contentMatchAt(r.childCount)).findWrapping(i.type))&&s.matchType(n[0]||i.type).validEnd){if(e){let h=t.pos+i.nodeSize,u=b.empty;for(let m=n.length-1;m>=0;m--)u=b.from(n[m].create(null,u));u=b.from(r.copy(u));let f=o.tr.step(new tt(t.pos-1,h,t.pos,h,new k(u,1,0),n.length,!0)),p=h+2*n.length;de(f.doc,p)&&f.join(p),e(f.scrollIntoView())}return!0}let l=R.findFrom(t,1),c=l&&l.$from.blockRange(l.$to),d=c&&Ie(c);if(d!=null&&d>=t.depth)return e&&e(o.tr.lift(c,d).scrollIntoView()),!0;if(a&&De(i,"start",!0)&&De(r,"end")){let h=r,u=[];for(;u.push(h),!h.isTextblock;)h=h.lastChild;let f=i,p=1;for(;!f.isTextblock;f=f.firstChild)p++;if(h.canReplace(h.childCount,h.childCount,f.content)){if(e){let m=b.empty;for(let g=u.length-1;g>=0;g--)m=b.from(u[g].copy(m));e(o.tr.step(new tt(t.pos-u.length,t.pos+i.nodeSize,t.pos+p,t.pos+i.nodeSize-p,new k(m,u.length,0),0,!0)).scrollIntoView())}return!0}}return!1}function aa(o){return function(t,e){let n=t.selection,s=o<0?n.$from:n.$to,r=s.depth;for(;s.node(r).isInline;){if(!r)return!1;r--}return!!s.node(r).isTextblock&&(e&&e(t.tr.setSelection(A.create(t.doc,o<0?s.start(r):s.end(r)))),!0)}}const bc=aa(-1),Sc=aa(1);function Ao(o,t=null){return function(e,n){let s=!1;for(let r=0;r<e.selection.ranges.length&&!s;r++){let{$from:{pos:i},$to:{pos:a}}=e.selection.ranges[r];e.doc.nodesBetween(i,a,(l,c)=>{if(s)return!1;if(l.isTextblock&&!l.hasMarkup(o,t))if(l.type==o)s=!0;else{let d=e.doc.resolve(c),h=d.index();s=d.parent.canReplaceWith(h,h+1,o)}})}if(!s)return!1;if(n){let r=e.tr;for(let i=0;i<e.selection.ranges.length;i++){let{$from:{pos:a},$to:{pos:l}}=e.selection.ranges[i];r.setBlockType(a,l,o,t)}n(r.scrollIntoView())}return!0}}function ps(...o){return function(t,e,n){for(let s=0;s<o.length;s++)if(o[s](t,e,n))return!0;return!1}}function _c(o,t=null){return function(e,n){let{$from:s,$to:r}=e.selection,i=s.blockRange(r),a=!1,l=i;if(!i)return!1;if(i.depth>=2&&s.node(i.depth-1).type.compatibleContent(o)&&i.startIndex==0){if(s.index(i.depth-1)==0)return!1;let d=e.doc.resolve(i.start-2);l=new wn(d,d,i.depth),i.endIndex<i.parent.childCount&&(i=new wn(s,e.doc.resolve(r.end(i.depth)),i.depth)),a=!0}let c=wi(l,o,t,i);return!!c&&(n&&n(function(d,h,u,f,p){let m=b.empty;for(let x=u.length-1;x>=0;x--)m=b.from(u[x].type.create(u[x].attrs,m));d.step(new tt(h.start-(f?2:0),h.end,h.start,h.end,new k(m,0,0),u.length,!0));let g=0;for(let x=0;x<u.length;x++)u[x].type==p&&(g=x+1);let y=u.length-g,v=h.start+u.length-(f?2:0),w=h.parent;for(let x=h.startIndex,_=h.endIndex,T=!0;x<_;x++,T=!1)!T&&Et(d.doc,v,y)&&(d.split(v,y),v+=2*y),v+=w.child(x).nodeSize;return d}(e.tr,i,c,a,o).scrollIntoView()),!0)}}function Cc(o){return function(t,e){let{$from:n,$to:s}=t.selection,r=n.blockRange(s,i=>i.childCount>0&&i.firstChild.type==o);return!!r&&(!e||(n.node(r.depth-1).type==o?function(i,a,l,c){let d=i.tr,h=c.end,u=c.$to.end(c.depth);h<u&&(d.step(new tt(h-1,u,h,u,new k(b.from(l.create(null,c.parent.copy())),1,0),1,!0)),c=new wn(d.doc.resolve(c.$from.pos),d.doc.resolve(u),c.depth));const f=Ie(c);if(f==null)return!1;d.lift(c,f);let p=d.mapping.map(h,-1)-1;return de(d.doc,p)&&d.join(p),a(d.scrollIntoView()),!0}(t,e,o,r):function(i,a,l){let c=i.tr,d=l.parent;for(let w=l.end,x=l.endIndex-1,_=l.startIndex;x>_;x--)w-=d.child(x).nodeSize,c.delete(w-1,w+1);let h=c.doc.resolve(l.start),u=h.nodeAfter;if(c.mapping.map(l.end)!=l.start+h.nodeAfter.nodeSize)return!1;let f=l.startIndex==0,p=l.endIndex==d.childCount,m=h.node(-1),g=h.index(-1);if(!m.canReplace(g+(f?0:1),g+1,u.content.append(p?b.empty:b.from(d))))return!1;let y=h.pos,v=y+u.nodeSize;return c.step(new tt(y-(f?1:0),v+(p?1:0),y+1,v-1,new k((f?b.empty:b.from(d.copy(b.empty))).append(p?b.empty:b.from(d.copy(b.empty))),f?0:1,p?0:1),f?0:1)),a(c.scrollIntoView()),!0}(t,e,r)))}}function qn(o){const{state:t,transaction:e}=o;let{selection:n}=e,{doc:s}=e,{storedMarks:r}=e;return{...t,apply:t.apply.bind(t),applyTransaction:t.applyTransaction.bind(t),plugins:t.plugins,schema:t.schema,reconfigure:t.reconfigure.bind(t),toJSON:t.toJSON.bind(t),get storedMarks(){return r},get selection(){return n},get doc(){return s},get tr(){return n=e.selection,s=e.doc,r=e.storedMarks,e}}}ps(Bs,Yi,Zi),ps(Bs,ea,na),ps(sa,ra,oa,xc),typeof navigator<"u"?/Mac|iP(hone|[oa]d)/.test(navigator.platform):typeof os<"u"&&os.platform&&os.platform();class Fn{constructor(t){this.editor=t.editor,this.rawCommands=this.editor.extensionManager.commands,this.customState=t.state}get hasCustomState(){return!!this.customState}get state(){return this.customState||this.editor.state}get commands(){const{rawCommands:t,editor:e,state:n}=this,{view:s}=e,{tr:r}=n,i=this.buildProps(r);return Object.fromEntries(Object.entries(t).map(([a,l])=>[a,(...c)=>{const d=l(...c)(i);return r.getMeta("preventDispatch")||this.hasCustomState||s.dispatch(r),d}]))}get chain(){return()=>this.createChain()}get can(){return()=>this.createCan()}createChain(t,e=!0){const{rawCommands:n,editor:s,state:r}=this,{view:i}=s,a=[],l=!!t,c=t||r.tr,d={...Object.fromEntries(Object.entries(n).map(([h,u])=>[h,(...f)=>{const p=this.buildProps(c,e),m=u(...f)(p);return a.push(m),d}])),run:()=>(l||!e||c.getMeta("preventDispatch")||this.hasCustomState||i.dispatch(c),a.every(h=>h===!0))};return d}createCan(t){const{rawCommands:e,state:n}=this,s=!1,r=t||n.tr,i=this.buildProps(r,s);return{...Object.fromEntries(Object.entries(e).map(([l,c])=>[l,(...d)=>c(...d)({...i,dispatch:void 0})])),chain:()=>this.createChain(r,s)}}buildProps(t,e=!0){const{rawCommands:n,editor:s,state:r}=this,{view:i}=s,a={tr:t,editor:s,view:i,state:qn({state:r,transaction:t}),dispatch:e?()=>{}:void 0,chain:()=>this.createChain(t,e),can:()=>this.createCan(t),get commands(){return Object.fromEntries(Object.entries(n).map(([l,c])=>[l,(...d)=>c(...d)(a)]))}};return a}}class kc{constructor(){this.callbacks={}}on(t,e){return this.callbacks[t]||(this.callbacks[t]=[]),this.callbacks[t].push(e),this}emit(t,...e){const n=this.callbacks[t];return n&&n.forEach(s=>s.apply(this,e)),this}off(t,e){const n=this.callbacks[t];return n&&(e?this.callbacks[t]=n.filter(s=>s!==e):delete this.callbacks[t]),this}removeAllListeners(){this.callbacks={}}}function M(o,t,e){return o.config[t]===void 0&&o.parent?M(o.parent,t,e):typeof o.config[t]=="function"?o.config[t].bind({...e,parent:o.parent?M(o.parent,t,e):null}):o.config[t]}function Mn(o){return{baseExtensions:o.filter(t=>t.type==="extension"),nodeExtensions:o.filter(t=>t.type==="node"),markExtensions:o.filter(t=>t.type==="mark")}}function Ro(o){const t=[],{nodeExtensions:e,markExtensions:n}=Mn(o),s=[...e,...n],r={default:null,rendered:!0,renderHTML:null,parseHTML:null,keepOnSplit:!0,isRequired:!1};return o.forEach(i=>{const a=M(i,"addGlobalAttributes",{name:i.name,options:i.options,storage:i.storage});a&&a().forEach(l=>{l.types.forEach(c=>{Object.entries(l.attributes).forEach(([d,h])=>{t.push({type:c,name:d,attribute:{...r,...h}})})})})}),s.forEach(i=>{const a={name:i.name,options:i.options,storage:i.storage},l=M(i,"addAttributes",a);if(!l)return;const c=l();Object.entries(c).forEach(([d,h])=>{const u={...r,...h};typeof u?.default=="function"&&(u.default=u.default()),u?.isRequired&&u?.default===void 0&&delete u.default,t.push({type:i.name,name:d,attribute:u})})}),t}function Q(o,t){if(typeof o=="string"){if(!t.nodes[o])throw Error(`There is no node type named '${o}'. Maybe you forgot to add the extension?`);return t.nodes[o]}return o}function Mc(...o){return o.filter(t=>!!t).reduce((t,e)=>{const n={...t};return Object.entries(e).forEach(([s,r])=>{if(n[s])if(s==="class"){const i=r?r.split(" "):[],a=n[s]?n[s].split(" "):[],l=i.filter(c=>!a.includes(c));n[s]=[...a,...l].join(" ")}else n[s]=s==="style"?[n[s],r].join("; "):r;else n[s]=r}),n},{})}function fs(o,t){return t.filter(e=>e.attribute.rendered).map(e=>e.attribute.renderHTML?e.attribute.renderHTML(o.attrs)||{}:{[e.name]:o.attrs[e.name]}).reduce((e,n)=>Mc(e,n),{})}function la(o){return typeof o=="function"}function P(o,t=void 0,...e){return la(o)?t?o.bind(t)(...e):o(...e):o}function Po(o,t){return o.style?o:{...o,getAttrs:e=>{const n=o.getAttrs?o.getAttrs(e):o.attrs;if(n===!1)return!1;const s=t.reduce((r,i)=>{const a=i.attribute.parseHTML?i.attribute.parseHTML(e):function(l){return typeof l!="string"?l:l.match(/^[+-]?(?:\d*\.)?\d+$/)?Number(l):l==="true"||l!=="false"&&l}(e.getAttribute(i.name));return a==null?r:{...r,[i.name]:a}},{});return{...n,...s}}}}function $o(o){return Object.fromEntries(Object.entries(o).filter(([t,e])=>(t!=="attrs"||!function(n={}){return Object.keys(n).length===0&&n.constructor===Object}(e))&&e!=null))}function ms(o,t){return t.nodes[o]||t.marks[o]||null}function qo(o,t){return Array.isArray(t)?t.some(e=>(typeof e=="string"?e:e.name)===o.name):t}const Tc=(o,t=500)=>{let e="";const n=o.parentOffset;return o.parent.nodesBetween(Math.max(0,n-t),n,(s,r,i,a)=>{var l,c;const d=((c=(l=s.type.spec).toText)===null||c===void 0?void 0:c.call(l,{node:s,pos:r,parent:i,index:a}))||s.textContent||"%leaf%";e+=d.slice(0,Math.max(0,n-r))}),e};function lr(o){return Object.prototype.toString.call(o)==="[object RegExp]"}class Ec{constructor(t){this.find=t.find,this.handler=t.handler}}const Oc=(o,t)=>{if(lr(t))return t.exec(o);const e=t(o);if(!e)return null;const n=[e.text];return n.index=e.index,n.input=o,n.data=e.data,e.replaceWith&&(e.text.includes(e.replaceWith)||console.warn('[tiptap warn]: "inputRuleMatch.replaceWith" must be part of "inputRuleMatch.text".'),n.push(e.replaceWith)),n};function cn(o){var t;const{editor:e,from:n,to:s,text:r,rules:i,plugin:a}=o,{view:l}=e;if(l.composing)return!1;const c=l.state.doc.resolve(n);if(c.parent.type.spec.code||!((t=c.nodeBefore||c.nodeAfter)===null||t===void 0)&&t.marks.find(u=>u.type.spec.code))return!1;let d=!1;const h=Tc(c)+r;return i.forEach(u=>{if(d)return;const f=Oc(h,u.find);if(!f)return;const p=l.state.tr,m=qn({state:l.state,transaction:p}),g={from:n-(f[0].length-r.length),to:s},{commands:y,chain:v,can:w}=new Fn({editor:e,state:m});u.handler({state:m,range:g,match:f,commands:y,chain:v,can:w})!==null&&p.steps.length&&(p.setMeta(a,{transform:p,from:n,to:s,text:r}),l.dispatch(p),d=!0)}),d}function Ic(o){const{editor:t,rules:e}=o,n=new Ut({state:{init:()=>null,apply(s,r){const i=s.getMeta(n);if(i)return i;const a=s.getMeta("applyInputRules");return a&&setTimeout(()=>{const{from:l,text:c}=a,d=l+c.length;cn({editor:t,from:l,to:d,text:c,rules:e,plugin:n})}),s.selectionSet||s.docChanged?null:r}},props:{handleTextInput:(s,r,i,a)=>cn({editor:t,from:r,to:i,text:a,rules:e,plugin:n}),handleDOMEvents:{compositionend:s=>(setTimeout(()=>{const{$cursor:r}=s.state.selection;r&&cn({editor:t,from:r.pos,to:r.pos,text:"",rules:e,plugin:n})}),!1)},handleKeyDown(s,r){if(r.key!=="Enter")return!1;const{$cursor:i}=s.state.selection;return!!i&&cn({editor:t,from:i.pos,to:i.pos,text:`
`,rules:e,plugin:n})}},isInputRules:!0});return n}const Nc=(o,t,e)=>{if(lr(t))return[...o.matchAll(t)];const n=t(o,e);return n?n.map(s=>{const r=[s.text];return r.index=s.index,r.input=o,r.data=s.data,s.replaceWith&&(s.text.includes(s.replaceWith)||console.warn('[tiptap warn]: "pasteRuleMatch.replaceWith" must be part of "pasteRuleMatch.text".'),r.push(s.replaceWith)),r}):[]};function Dc(o){const{editor:t,rules:e}=o;let n=null,s=!1,r=!1,i=typeof ClipboardEvent<"u"?new ClipboardEvent("paste"):null,a=typeof DragEvent<"u"?new DragEvent("drop"):null;const l=({state:c,from:d,to:h,rule:u,pasteEvt:f})=>{const p=c.tr,m=qn({state:c,transaction:p});if(function(y){const{editor:v,state:w,from:x,to:_,rule:T,pasteEvent:E,dropEvent:C}=y,{commands:S,chain:N,can:L}=new Fn({editor:v,state:w}),D=[];return w.doc.nodesBetween(x,_,(F,O)=>{if(!F.isTextblock||F.type.spec.code)return;const q=Math.max(x,O),z=Math.min(_,O+F.content.size),G=F.textBetween(q-O,z-O,void 0,"");Nc(G,T.find,E).forEach(et=>{if(et.index===void 0)return;const $=q+et.index+1,Ln=$+et[0].length,Bn={from:w.tr.mapping.map($),to:w.tr.mapping.map(Ln)},Wt=T.handler({state:w,range:Bn,match:et,commands:S,chain:N,can:L,pasteEvent:E,dropEvent:C});D.push(Wt)})}),D.every(F=>F!==null)}({editor:t,state:m,from:Math.max(d-1,0),to:h.b-1,rule:u,pasteEvent:f,dropEvent:a})&&p.steps.length)return a=typeof DragEvent<"u"?new DragEvent("drop"):null,i=typeof ClipboardEvent<"u"?new ClipboardEvent("paste"):null,p};return e.map(c=>new Ut({view(d){const h=u=>{var f;n=!((f=d.dom.parentElement)===null||f===void 0)&&f.contains(u.target)?d.dom.parentElement:null};return window.addEventListener("dragstart",h),{destroy(){window.removeEventListener("dragstart",h)}}},props:{handleDOMEvents:{drop:(d,h)=>(r=n===d.dom.parentElement,a=h,!1),paste:(d,h)=>{var u;const f=(u=h.clipboardData)===null||u===void 0?void 0:u.getData("text/html");return i=h,s=!!f?.includes("data-pm-slice"),!1}}},appendTransaction:(d,h,u)=>{const f=d[0],p=f.getMeta("uiEvent")==="paste"&&!s,m=f.getMeta("uiEvent")==="drop"&&!r,g=f.getMeta("applyPasteRules"),y=!!g;if(!p&&!m&&!y)return;if(y){const{from:x,text:_}=g,T=x+_.length,E=(C=>{var S;const N=new ClipboardEvent("paste",{clipboardData:new DataTransfer});return(S=N.clipboardData)===null||S===void 0||S.setData("text/html",C),N})(_);return l({rule:c,state:u,from:x,to:{b:T},pasteEvt:E})}const v=h.doc.content.findDiffStart(u.doc.content),w=h.doc.content.findDiffEnd(u.doc.content);return typeof v=="number"&&w&&v!==w.b?l({rule:c,state:u,from:v,to:w,pasteEvt:i}):void 0}}))}class ke{constructor(t,e){this.splittableMarks=[],this.editor=e,this.extensions=ke.resolve(t),this.schema=function(n,s){var r;const i=Ro(n),{nodeExtensions:a,markExtensions:l}=Mn(n),c=(r=a.find(u=>M(u,"topNode")))===null||r===void 0?void 0:r.name,d=Object.fromEntries(a.map(u=>{const f=i.filter(x=>x.type===u.name),p={name:u.name,options:u.options,storage:u.storage,editor:s},m=n.reduce((x,_)=>{const T=M(_,"extendNodeSchema",p);return{...x,...T?T(u):{}}},{}),g=$o({...m,content:P(M(u,"content",p)),marks:P(M(u,"marks",p)),group:P(M(u,"group",p)),inline:P(M(u,"inline",p)),atom:P(M(u,"atom",p)),selectable:P(M(u,"selectable",p)),draggable:P(M(u,"draggable",p)),code:P(M(u,"code",p)),defining:P(M(u,"defining",p)),isolating:P(M(u,"isolating",p)),attrs:Object.fromEntries(f.map(x=>{var _;return[x.name,{default:(_=x?.attribute)===null||_===void 0?void 0:_.default}]}))}),y=P(M(u,"parseHTML",p));y&&(g.parseDOM=y.map(x=>Po(x,f)));const v=M(u,"renderHTML",p);v&&(g.toDOM=x=>v({node:x,HTMLAttributes:fs(x,f)}));const w=M(u,"renderText",p);return w&&(g.toText=w),[u.name,g]})),h=Object.fromEntries(l.map(u=>{const f=i.filter(w=>w.type===u.name),p={name:u.name,options:u.options,storage:u.storage,editor:s},m=n.reduce((w,x)=>{const _=M(x,"extendMarkSchema",p);return{...w,..._?_(u):{}}},{}),g=$o({...m,inclusive:P(M(u,"inclusive",p)),excludes:P(M(u,"excludes",p)),group:P(M(u,"group",p)),spanning:P(M(u,"spanning",p)),code:P(M(u,"code",p)),attrs:Object.fromEntries(f.map(w=>{var x;return[w.name,{default:(x=w?.attribute)===null||x===void 0?void 0:x.default}]}))}),y=P(M(u,"parseHTML",p));y&&(g.parseDOM=y.map(w=>Po(w,f)));const v=M(u,"renderHTML",p);return v&&(g.toDOM=w=>v({mark:w,HTMLAttributes:fs(w,f)})),[u.name,g]}));return new Cl({topNode:c,nodes:d,marks:h})}(this.extensions,e),this.setupExtensions()}static resolve(t){const e=ke.sort(ke.flatten(t)),n=function(s){const r=s.filter((i,a)=>s.indexOf(i)!==a);return[...new Set(r)]}(e.map(s=>s.name));return n.length&&console.warn(`[tiptap warn]: Duplicate extension names found: [${n.map(s=>`'${s}'`).join(", ")}]. This can lead to issues.`),e}static flatten(t){return t.map(e=>{const n=M(e,"addExtensions",{name:e.name,options:e.options,storage:e.storage});return n?[e,...this.flatten(n())]:e}).flat(10)}static sort(t){return t.sort((e,n)=>{const s=M(e,"priority")||100,r=M(n,"priority")||100;return s>r?-1:s<r?1:0})}get commands(){return this.extensions.reduce((t,e)=>{const n=M(e,"addCommands",{name:e.name,options:e.options,storage:e.storage,editor:this.editor,type:ms(e.name,this.schema)});return n?{...t,...n()}:t},{})}get plugins(){const{editor:t}=this,e=ke.sort([...this.extensions].reverse()),n=[],s=[],r=e.map(i=>{const a={name:i.name,options:i.options,storage:i.storage,editor:t,type:ms(i.name,this.schema)},l=[],c=M(i,"addKeyboardShortcuts",a);let d={};if(i.type==="mark"&&i.config.exitable&&(d.ArrowRight=()=>In.handleExit({editor:t,mark:i})),c){const m=Object.fromEntries(Object.entries(c()).map(([g,y])=>[g,()=>y({editor:t})]));d={...d,...m}}const h=new Ut({props:{handleKeyDown:wc(d)}});l.push(h);const u=M(i,"addInputRules",a);qo(i,t.options.enableInputRules)&&u&&n.push(...u());const f=M(i,"addPasteRules",a);qo(i,t.options.enablePasteRules)&&f&&s.push(...f());const p=M(i,"addProseMirrorPlugins",a);if(p){const m=p();l.push(...m)}return l}).flat();return[Ic({editor:t,rules:n}),...Dc({editor:t,rules:s}),...r]}get attributes(){return Ro(this.extensions)}get nodeViews(){const{editor:t}=this,{nodeExtensions:e}=Mn(this.extensions);return Object.fromEntries(e.filter(n=>!!M(n,"addNodeView")).map(n=>{const s=this.attributes.filter(a=>a.type===n.name),r={name:n.name,options:n.options,storage:n.storage,editor:t,type:Q(n.name,this.schema)},i=M(n,"addNodeView",r);return i?[n.name,(a,l,c,d)=>{const h=fs(a,s);return i()({editor:t,node:a,getPos:c,decorations:d,HTMLAttributes:h,extension:n})}]:[]}))}setupExtensions(){this.extensions.forEach(t=>{var e;this.editor.extensionStorage[t.name]=t.storage;const n={name:t.name,options:t.options,storage:t.storage,editor:this.editor,type:ms(t.name,this.schema)};t.type==="mark"&&((e=P(M(t,"keepOnSplit",n)))===null||e===void 0||e)&&this.splittableMarks.push(t.name);const s=M(t,"onBeforeCreate",n),r=M(t,"onCreate",n),i=M(t,"onUpdate",n),a=M(t,"onSelectionUpdate",n),l=M(t,"onTransaction",n),c=M(t,"onFocus",n),d=M(t,"onBlur",n),h=M(t,"onDestroy",n);s&&this.editor.on("beforeCreate",s),r&&this.editor.on("create",r),i&&this.editor.on("update",i),a&&this.editor.on("selectionUpdate",a),l&&this.editor.on("transaction",l),c&&this.editor.on("focus",c),d&&this.editor.on("blur",d),h&&this.editor.on("destroy",h)})}}function gs(o){return function(t){return Object.prototype.toString.call(t).slice(8,-1)}(o)==="Object"&&o.constructor===Object&&Object.getPrototypeOf(o)===Object.prototype}function zn(o,t){const e={...o};return gs(o)&&gs(t)&&Object.keys(t).forEach(n=>{gs(t[n])?n in o?e[n]=zn(o[n],t[n]):Object.assign(e,{[n]:t[n]}):Object.assign(e,{[n]:t[n]})}),e}class It{constructor(t={}){this.type="extension",this.name="extension",this.parent=null,this.child=null,this.config={name:this.name,defaultOptions:{}},this.config={...this.config,...t},this.name=this.config.name,t.defaultOptions&&Object.keys(t.defaultOptions).length>0&&console.warn(`[tiptap warn]: BREAKING CHANGE: "defaultOptions" is deprecated. Please use "addOptions" instead. Found in extension: "${this.name}".`),this.options=this.config.defaultOptions,this.config.addOptions&&(this.options=P(M(this,"addOptions",{name:this.name}))),this.storage=P(M(this,"addStorage",{name:this.name,options:this.options}))||{}}static create(t={}){return new It(t)}configure(t={}){const e=this.extend();return e.parent=this.parent,e.options=zn(this.options,t),e.storage=P(M(e,"addStorage",{name:e.name,options:e.options})),e}extend(t={}){const e=new It({...this.config,...t});return e.parent=this,this.child=e,e.name=t.name?t.name:e.parent.name,t.defaultOptions&&console.warn(`[tiptap warn]: BREAKING CHANGE: "defaultOptions" is deprecated. Please use "addOptions" instead. Found in extension: "${e.name}".`),e.options=P(M(e,"addOptions",{name:e.name})),e.storage=P(M(e,"addStorage",{name:e.name,options:e.options})),e}}function ca(o,t,e){const{from:n,to:s}=t,{blockSeparator:r=`

`,textSerializers:i={}}=e||{};let a="";return o.nodesBetween(n,s,(l,c,d,h)=>{var u;l.isBlock&&c>n&&(a+=r);const f=i?.[l.type.name];if(f)return d&&(a+=f({node:l,pos:c,parent:d,index:h,range:t})),!1;l.isText&&(a+=(u=l?.text)===null||u===void 0?void 0:u.slice(Math.max(n,c)-c,s-c))}),a}function da(o){return Object.fromEntries(Object.entries(o.nodes).filter(([,t])=>t.spec.toText).map(([t,e])=>[t,e.spec.toText]))}const Ac=It.create({name:"clipboardTextSerializer",addOptions:()=>({blockSeparator:void 0}),addProseMirrorPlugins(){return[new Ut({key:new tn("clipboardTextSerializer"),props:{clipboardTextSerializer:()=>{const{editor:o}=this,{state:t,schema:e}=o,{doc:n,selection:s}=t,{ranges:r}=s,i=Math.min(...r.map(c=>c.$from.pos)),a=Math.max(...r.map(c=>c.$to.pos)),l=da(e);return ca(n,{from:i,to:a},{...this.options.blockSeparator!==void 0?{blockSeparator:this.options.blockSeparator}:{},textSerializers:l})}}})]}});function Tn(o,t,e={strict:!0}){const n=Object.keys(t);return!n.length||n.every(s=>e.strict?t[s]===o[s]:lr(t[s])?t[s].test(o[s]):t[s]===o[s])}function Hs(o,t,e={}){return o.find(n=>n.type===t&&Tn(n.attrs,e))}function Rc(o,t,e={}){return!!Hs(o,t,e)}function Fo(o,t,e={}){if(!o||!t)return;let n=o.parent.childAfter(o.parentOffset);if(o.parentOffset===n.offset&&n.offset!==0&&(n=o.parent.childBefore(o.parentOffset)),!n.node)return;const s=Hs([...n.node.marks],t,e);if(!s)return;let r=n.index,i=o.start()+n.offset,a=r+1,l=i+n.node.nodeSize;for(Hs([...n.node.marks],t,e);r>0&&s.isInSet(o.parent.child(r-1).marks);)r-=1,i-=o.parent.child(r).nodeSize;for(;a<o.parent.childCount&&Rc([...o.parent.child(a).marks],t,e);)l+=o.parent.child(a).nodeSize,a+=1;return{from:i,to:l}}function Rt(o,t){if(typeof o=="string"){if(!t.marks[o])throw Error(`There is no mark type named '${o}'. Maybe you forgot to add the extension?`);return t.marks[o]}return o}function zo(o){return o instanceof A}function ne(o=0,t=0,e=0){return Math.min(Math.max(o,t),e)}function ha(o,t=null){if(!t)return null;const e=R.atStart(o),n=R.atEnd(o);if(t==="start"||t===!0)return e;if(t==="end")return n;const s=e.from,r=n.to;return t==="all"?A.create(o,ne(0,s,r),ne(o.content.size,s,r)):A.create(o,ne(t,s,r),ne(t,s,r))}function Vs(){return["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].includes(navigator.platform)||navigator.userAgent.includes("Mac")&&"ontouchend"in document}const ua=o=>{const t=o.childNodes;for(let e=t.length-1;e>=0;e-=1){const n=t[e];n.nodeType===3&&n.nodeValue&&/^(\n\s\s|\n)$/.test(n.nodeValue)?o.removeChild(n):n.nodeType===1&&ua(n)}return o};function Lo(o){const t=`<body>${o}</body>`,e=new window.DOMParser().parseFromString(t,"text/html").body;return ua(e)}function En(o,t,e){e={slice:!0,parseOptions:{},...e};const n=typeof o=="string";if(typeof o=="object"&&o!==null)try{return Array.isArray(o)&&o.length>0?b.fromArray(o.map(s=>t.nodeFromJSON(s))):t.nodeFromJSON(o)}catch(s){return console.warn("[tiptap warn]: Invalid content.","Passed value:",o,"Error:",s),En("",t,e)}if(n){const s=Oe.fromSchema(t);return e.slice?s.parseSlice(Lo(o),e.parseOptions).content:s.parse(Lo(o),e.parseOptions)}return En("",t,e)}function pa(){return typeof navigator<"u"&&/Mac/.test(navigator.platform)}function Je(o,t,e={}){const{from:n,to:s,empty:r}=o.selection,i=t?Q(t,o.schema):null,a=[];o.doc.nodesBetween(n,s,(d,h)=>{if(d.isText)return;const u=Math.max(n,h),f=Math.min(s,h+d.nodeSize);a.push({node:d,from:u,to:f})});const l=s-n,c=a.filter(d=>!i||i.name===d.node.type.name).filter(d=>Tn(d.node.attrs,e,{strict:!1}));return r?!!c.length:c.reduce((d,h)=>d+h.to-h.from,0)>=l}function On(o,t){return t.nodes[o]?"node":t.marks[o]?"mark":null}function Bo(o,t){const e=typeof t=="string"?[t]:t;return Object.keys(o).reduce((n,s)=>(e.includes(s)||(n[s]=o[s]),n),{})}function fa(o,t,e={}){return En(o,t,{slice:!1,parseOptions:e})}function ma(o,t){const e=Rt(t,o.schema),{from:n,to:s,empty:r}=o.selection,i=[];r?(o.storedMarks&&i.push(...o.storedMarks),i.push(...o.selection.$head.marks())):o.doc.nodesBetween(n,s,l=>{i.push(...l.marks)});const a=i.find(l=>l.type.name===e.name);return a?{...a.attrs}:{}}function cr(o){return t=>function(e,n){for(let s=e.depth;s>0;s-=1){const r=e.node(s);if(n(r))return{pos:s>0?e.before(s):0,start:e.start(s),depth:s,node:r}}}(t.$from,o)}function Pc(o,t){const e=On(typeof t=="string"?t:t.name,o.schema);return e==="node"?function(n,s){const r=Q(s,n.schema),{from:i,to:a}=n.selection,l=[];n.doc.nodesBetween(i,a,d=>{l.push(d)});const c=l.reverse().find(d=>d.type.name===r.name);return c?{...c.attrs}:{}}(o,t):e==="mark"?ma(o,t):{}}function dn(o,t,e){return Object.fromEntries(Object.entries(e).filter(([n])=>{const s=o.find(r=>r.type===t&&r.name===n);return!!s&&s.attribute.keepOnSplit}))}function Us(o,t,e={}){const{empty:n,ranges:s}=o.selection,r=t?Rt(t,o.schema):null;if(n)return!!(o.storedMarks||o.selection.$from.marks()).filter(d=>!r||r.name===d.type.name).find(d=>Tn(d.attrs,e,{strict:!1}));let i=0;const a=[];if(s.forEach(({$from:d,$to:h})=>{const u=d.pos,f=h.pos;o.doc.nodesBetween(u,f,(p,m)=>{if(!p.isText&&!p.marks.length)return;const g=Math.max(u,m),y=Math.min(f,m+p.nodeSize);i+=y-g,a.push(...p.marks.map(v=>({mark:v,from:g,to:y})))})}),i===0)return!1;const l=a.filter(d=>!r||r.name===d.mark.type.name).filter(d=>Tn(d.mark.attrs,e,{strict:!1})).reduce((d,h)=>d+h.to-h.from,0),c=a.filter(d=>!r||d.mark.type!==r&&d.mark.type.excludes(r)).reduce((d,h)=>d+h.to-h.from,0);return(l>0?l+c:l)>=i}function Ho(o,t){const{nodeExtensions:e}=Mn(t),n=e.find(r=>r.name===o);if(!n)return!1;const s=P(M(n,"group",{name:n.name,options:n.options,storage:n.storage}));return typeof s=="string"&&s.split(" ").includes("list")}function Vo(o,t){const e=o.storedMarks||o.selection.$to.parentOffset&&o.selection.$from.marks();if(e){const n=e.filter(s=>t?.includes(s.type.name));o.tr.ensureMarks(n)}}const ys=(o,t)=>{const e=cr(r=>r.type===t)(o.selection);if(!e)return!0;const n=o.doc.resolve(Math.max(0,e.pos-1)).before(e.depth);if(n===void 0)return!0;const s=o.doc.nodeAt(n);return e.node.type!==s?.type||!de(o.doc,e.pos)||(o.join(e.pos),!0)},vs=(o,t)=>{const e=cr(r=>r.type===t)(o.selection);if(!e)return!0;const n=o.doc.resolve(e.start).after(e.depth);if(n===void 0)return!0;const s=o.doc.nodeAt(n);return e.node.type!==s?.type||!de(o.doc,n)||(o.join(n),!0)};var $c=Object.freeze({__proto__:null,blur:()=>({editor:o,view:t})=>(requestAnimationFrame(()=>{var e;o.isDestroyed||(t.dom.blur(),(e=window?.getSelection())===null||e===void 0||e.removeAllRanges())}),!0),clearContent:(o=!1)=>({commands:t})=>t.setContent("",o),clearNodes:()=>({state:o,tr:t,dispatch:e})=>{const{selection:n}=t,{ranges:s}=n;return!e||(s.forEach(({$from:r,$to:i})=>{o.doc.nodesBetween(r.pos,i.pos,(a,l)=>{if(a.type.isText)return;const{doc:c,mapping:d}=t,h=c.resolve(d.map(l)),u=c.resolve(d.map(l+a.nodeSize)),f=h.blockRange(u);if(!f)return;const p=Ie(f);if(a.type.isTextblock){const{defaultType:m}=h.parent.contentMatchAt(h.index());t.setNodeMarkup(f.start,m)}(p||p===0)&&t.lift(f,p)})}),!0)},command:o=>t=>o(t),createParagraphNear:()=>({state:o,dispatch:t})=>ra(o,t),cut:(o,t)=>({editor:e,tr:n})=>{const{state:s}=e,r=s.doc.slice(o.from,o.to);n.deleteRange(o.from,o.to);const i=n.mapping.map(t);return n.insert(i,r.content),n.setSelection(new A(n.doc.resolve(i-1))),!0},deleteCurrentNode:()=>({tr:o,dispatch:t})=>{const{selection:e}=o,n=e.$anchor.node();if(n.content.size>0)return!1;const s=o.selection.$anchor;for(let r=s.depth;r>0;r-=1)if(s.node(r).type===n.type){if(t){const i=s.before(r),a=s.after(r);o.delete(i,a).scrollIntoView()}return!0}return!1},deleteNode:o=>({tr:t,state:e,dispatch:n})=>{const s=Q(o,e.schema),r=t.selection.$anchor;for(let i=r.depth;i>0;i-=1)if(r.node(i).type===s){if(n){const a=r.before(i),l=r.after(i);t.delete(a,l).scrollIntoView()}return!0}return!1},deleteRange:o=>({tr:t,dispatch:e})=>{const{from:n,to:s}=o;return e&&t.delete(n,s),!0},deleteSelection:()=>({state:o,dispatch:t})=>Bs(o,t),enter:()=>({commands:o})=>o.keyboardShortcut("Enter"),exitCode:()=>({state:o,dispatch:t})=>((e,n)=>{let{$head:s,$anchor:r}=e.selection;if(!s.parent.type.spec.code||!s.sameParent(r))return!1;let i=s.node(-1),a=s.indexAfter(-1),l=ar(i.contentMatchAt(a));if(!l||!i.canReplaceWith(a,a,l))return!1;if(n){let c=s.after(),d=e.tr.replaceWith(c,c,l.createAndFill());d.setSelection(R.near(d.doc.resolve(c),1)),n(d.scrollIntoView())}return!0})(o,t),extendMarkRange:(o,t={})=>({tr:e,state:n,dispatch:s})=>{const r=Rt(o,n.schema),{doc:i,selection:a}=e,{$from:l,from:c,to:d}=a;if(s){const h=Fo(l,r,t);if(h&&h.from<=c&&h.to>=d){const u=A.create(i,h.from,h.to);e.setSelection(u)}}return!0},first:o=>t=>{const e=typeof o=="function"?o(t):o;for(let n=0;n<e.length;n+=1)if(e[n](t))return!0;return!1},focus:(o=null,t={})=>({editor:e,view:n,tr:s,dispatch:r})=>{t={scrollIntoView:!0,...t};const i=()=>{Vs()&&n.dom.focus(),requestAnimationFrame(()=>{e.isDestroyed||(n.focus(),t?.scrollIntoView&&e.commands.scrollIntoView())})};if(n.hasFocus()&&o===null||o===!1)return!0;if(r&&o===null&&!zo(e.state.selection))return i(),!0;const a=ha(s.doc,o)||e.state.selection,l=e.state.selection.eq(a);return r&&(l||s.setSelection(a),l&&s.storedMarks&&s.setStoredMarks(s.storedMarks),i()),!0},forEach:(o,t)=>e=>o.every((n,s)=>t(n,{...e,index:s})),insertContent:(o,t)=>({tr:e,commands:n})=>n.insertContentAt({from:e.selection.from,to:e.selection.to},o,t),insertContentAt:(o,t,e)=>({tr:n,dispatch:s,editor:r})=>{if(s){e={parseOptions:{},updateSelection:!0,applyInputRules:!1,applyPasteRules:!1,...e};const i=En(t,r.schema,{parseOptions:{preserveWhitespace:"full",...e.parseOptions}});if(i.toString()==="<>")return!0;let{from:a,to:l}=typeof o=="number"?{from:o,to:o}:{from:o.from,to:o.to},c=!0,d=!0;if((i.toString().startsWith("<")?i:[i]).forEach(u=>{u.check(),c=!!c&&u.isText&&u.marks.length===0,d=!!d&&u.isBlock}),a===l&&d){const{parent:u}=n.doc.resolve(a);u.isTextblock&&!u.type.spec.code&&!u.childCount&&(a-=1,l+=1)}let h;c?(h=Array.isArray(t)?t.map(u=>u.text||"").join(""):typeof t=="object"&&t&&t.text?t.text:t,n.insertText(h,a,l)):(h=i,n.replaceWith(a,l,h)),e.updateSelection&&function(u,f,p){const m=u.steps.length-1;if(m<f)return;const g=u.steps[m];if(!(g instanceof Z||g instanceof tt))return;const y=u.mapping.maps[m];let v=0;y.forEach((w,x,_,T)=>{v===0&&(v=T)}),u.setSelection(R.near(u.doc.resolve(v),p))}(n,n.steps.length-1,-1),e.applyInputRules&&n.setMeta("applyInputRules",{from:a,text:h}),e.applyPasteRules&&n.setMeta("applyPasteRules",{from:a,text:h})}return!0},joinUp:()=>({state:o,dispatch:t})=>((e,n)=>{let s,r=e.selection,i=r instanceof I;if(i){if(r.node.isTextblock||!de(e.doc,r.from))return!1;s=r.from}else if(s=an(e.doc,r.from,-1),s==null)return!1;if(n){let a=e.tr.join(s);i&&a.setSelection(I.create(a.doc,s-e.doc.resolve(s).nodeBefore.nodeSize)),n(a.scrollIntoView())}return!0})(o,t),joinDown:()=>({state:o,dispatch:t})=>((e,n)=>{let s,r=e.selection;if(r instanceof I){if(r.node.isTextblock||!de(e.doc,r.to))return!1;s=r.to}else if(s=an(e.doc,r.to,1),s==null)return!1;return n&&n(e.tr.join(s).scrollIntoView()),!0})(o,t),joinBackward:()=>({state:o,dispatch:t})=>Yi(o,t),joinForward:()=>({state:o,dispatch:t})=>ea(o,t),joinItemBackward:()=>({tr:o,state:t,dispatch:e})=>{try{const n=an(t.doc,t.selection.$from.pos,-1);return n!=null&&(o.join(n,2),e&&e(o),!0)}catch{return!1}},joinItemForward:()=>({state:o,dispatch:t,tr:e})=>{try{const n=an(o.doc,o.selection.$from.pos,1);return n!=null&&(e.join(n,2),t&&t(e),!0)}catch{return!1}},joinTextblockBackward:()=>({state:o,dispatch:t})=>((e,n,s)=>{let r=Qi(e,s);if(!r)return!1;let i=or(r);return!!i&&Do(e,i,n)})(o,t),joinTextblockForward:()=>({state:o,dispatch:t})=>((e,n,s)=>{let r=ta(e,s);if(!r)return!1;let i=ir(r);return!!i&&Do(e,i,n)})(o,t),keyboardShortcut:o=>({editor:t,view:e,tr:n,dispatch:s})=>{const r=function(c){const d=c.split(/-(?!$)/);let h,u,f,p,m=d[d.length-1];m==="Space"&&(m=" ");for(let g=0;g<d.length-1;g+=1){const y=d[g];if(/^(cmd|meta|m)$/i.test(y))p=!0;else if(/^a(lt)?$/i.test(y))h=!0;else if(/^(c|ctrl|control)$/i.test(y))u=!0;else if(/^s(hift)?$/i.test(y))f=!0;else{if(!/^mod$/i.test(y))throw new Error(`Unrecognized modifier name: ${y}`);Vs()||pa()?p=!0:u=!0}}return h&&(m=`Alt-${m}`),u&&(m=`Ctrl-${m}`),p&&(m=`Meta-${m}`),f&&(m=`Shift-${m}`),m}(o).split(/-(?!$)/),i=r.find(c=>!["Alt","Ctrl","Meta","Shift"].includes(c)),a=new KeyboardEvent("keydown",{key:i==="Space"?" ":i,altKey:r.includes("Alt"),ctrlKey:r.includes("Ctrl"),metaKey:r.includes("Meta"),shiftKey:r.includes("Shift"),bubbles:!0,cancelable:!0}),l=t.captureTransaction(()=>{e.someProp("handleKeyDown",c=>c(e,a))});return l?.steps.forEach(c=>{const d=c.map(n.mapping);d&&s&&n.maybeStep(d)}),!0},lift:(o,t={})=>({state:e,dispatch:n})=>!!Je(e,Q(o,e.schema),t)&&((s,r)=>{let{$from:i,$to:a}=s.selection,l=i.blockRange(a),c=l&&Ie(l);return c!=null&&(r&&r(s.tr.lift(l,c).scrollIntoView()),!0)})(e,n),liftEmptyBlock:()=>({state:o,dispatch:t})=>oa(o,t),liftListItem:o=>({state:t,dispatch:e})=>Cc(Q(o,t.schema))(t,e),newlineInCode:()=>({state:o,dispatch:t})=>sa(o,t),resetAttributes:(o,t)=>({tr:e,state:n,dispatch:s})=>{let r=null,i=null;const a=On(typeof o=="string"?o:o.name,n.schema);return!!a&&(a==="node"&&(r=Q(o,n.schema)),a==="mark"&&(i=Rt(o,n.schema)),s&&e.selection.ranges.forEach(l=>{n.doc.nodesBetween(l.$from.pos,l.$to.pos,(c,d)=>{r&&r===c.type&&e.setNodeMarkup(d,void 0,Bo(c.attrs,t)),i&&c.marks.length&&c.marks.forEach(h=>{i===h.type&&e.addMark(d,d+c.nodeSize,i.create(Bo(h.attrs,t)))})})}),!0)},scrollIntoView:()=>({tr:o,dispatch:t})=>(t&&o.scrollIntoView(),!0),selectAll:()=>({tr:o,commands:t})=>t.setTextSelection({from:0,to:o.doc.content.size}),selectNodeBackward:()=>({state:o,dispatch:t})=>Zi(o,t),selectNodeForward:()=>({state:o,dispatch:t})=>na(o,t),selectParentNode:()=>({state:o,dispatch:t})=>((e,n)=>{let s,{$from:r,to:i}=e.selection,a=r.sharedDepth(i);return a!=0&&(s=r.before(a),n&&n(e.tr.setSelection(I.create(e.doc,s))),!0)})(o,t),selectTextblockEnd:()=>({state:o,dispatch:t})=>Sc(o,t),selectTextblockStart:()=>({state:o,dispatch:t})=>bc(o,t),setContent:(o,t=!1,e={})=>({tr:n,editor:s,dispatch:r})=>{const{doc:i}=n,a=fa(o,s.schema,e);return r&&n.replaceWith(0,i.content.size,a).setMeta("preventUpdate",!t),!0},setMark:(o,t={})=>({tr:e,state:n,dispatch:s})=>{const{selection:r}=e,{empty:i,ranges:a}=r,l=Rt(o,n.schema);if(s)if(i){const c=ma(n,l);e.addStoredMark(l.create({...c,...t}))}else a.forEach(c=>{const d=c.$from.pos,h=c.$to.pos;n.doc.nodesBetween(d,h,(u,f)=>{const p=Math.max(f,d),m=Math.min(f+u.nodeSize,h);u.marks.find(g=>g.type===l)?u.marks.forEach(g=>{l===g.type&&e.addMark(p,m,l.create({...g.attrs,...t}))}):e.addMark(p,m,l.create(t))})});return function(c,d,h){var u;const{selection:f}=d;let p=null;if(zo(f)&&(p=f.$cursor),p){const g=(u=c.storedMarks)!==null&&u!==void 0?u:p.marks();return!!h.isInSet(g)||!g.some(y=>y.type.excludes(h))}const{ranges:m}=f;return m.some(({$from:g,$to:y})=>{let v=g.depth===0&&c.doc.inlineContent&&c.doc.type.allowsMarkType(h);return c.doc.nodesBetween(g.pos,y.pos,(w,x,_)=>{if(v)return!1;if(w.isInline){const T=!_||_.type.allowsMarkType(h),E=!!h.isInSet(w.marks)||!w.marks.some(C=>C.type.excludes(h));v=T&&E}return!v}),v})}(n,e,l)},setMeta:(o,t)=>({tr:e})=>(e.setMeta(o,t),!0),setNode:(o,t={})=>({state:e,dispatch:n,chain:s})=>{const r=Q(o,e.schema);return r.isTextblock?s().command(({commands:i})=>!!Ao(r,t)(e)||i.clearNodes()).command(({state:i})=>Ao(r,t)(i,n)).run():(console.warn('[tiptap warn]: Currently "setNode()" only supports text block nodes.'),!1)},setNodeSelection:o=>({tr:t,dispatch:e})=>{if(e){const{doc:n}=t,s=ne(o,0,n.content.size),r=I.create(n,s);t.setSelection(r)}return!0},setTextSelection:o=>({tr:t,dispatch:e})=>{if(e){const{doc:n}=t,{from:s,to:r}=typeof o=="number"?{from:o,to:o}:o,i=A.atStart(n).from,a=A.atEnd(n).to,l=ne(s,i,a),c=ne(r,i,a),d=A.create(n,l,c);t.setSelection(d)}return!0},sinkListItem:o=>({state:t,dispatch:e})=>{return(s=Q(o,t.schema),function(r,i){let{$from:a,$to:l}=r.selection,c=a.blockRange(l,f=>f.childCount>0&&f.firstChild.type==s);if(!c)return!1;let d=c.startIndex;if(d==0)return!1;let h=c.parent,u=h.child(d-1);if(u.type!=s)return!1;if(i){let f=u.lastChild&&u.lastChild.type==h.type,p=b.from(f?s.create():null),m=new k(b.from(s.create(null,b.from(h.type.create(null,p)))),f?3:1,0),g=c.start,y=c.end;i(r.tr.step(new tt(g-(f?3:1),y,g,y,m,1,!0)).scrollIntoView())}return!0})(t,e);var s},splitBlock:({keepMarks:o=!0}={})=>({tr:t,state:e,dispatch:n,editor:s})=>{const{selection:r,doc:i}=t,{$from:a,$to:l}=r,c=dn(s.extensionManager.attributes,a.node().type.name,a.node().attrs);if(r instanceof I&&r.node.isBlock)return!(!a.parentOffset||!Et(i,a.pos))&&(n&&(o&&Vo(e,s.extensionManager.splittableMarks),t.split(a.pos).scrollIntoView()),!0);if(!a.parent.isBlock)return!1;if(n){const d=l.parentOffset===l.parent.content.size;r instanceof A&&t.deleteSelection();const h=a.depth===0?void 0:function(p){for(let m=0;m<p.edgeCount;m+=1){const{type:g}=p.edge(m);if(g.isTextblock&&!g.hasRequiredAttrs())return g}return null}(a.node(-1).contentMatchAt(a.indexAfter(-1)));let u=d&&h?[{type:h,attrs:c}]:void 0,f=Et(t.doc,t.mapping.map(a.pos),1,u);if(u||f||!Et(t.doc,t.mapping.map(a.pos),1,h?[{type:h}]:void 0)||(f=!0,u=h?[{type:h,attrs:c}]:void 0),f&&(t.split(t.mapping.map(a.pos),1,u),h&&!d&&!a.parentOffset&&a.parent.type!==h)){const p=t.mapping.map(a.before()),m=t.doc.resolve(p);a.node(-1).canReplaceWith(m.index(),m.index()+1,h)&&t.setNodeMarkup(t.mapping.map(a.before()),h)}o&&Vo(e,s.extensionManager.splittableMarks),t.scrollIntoView()}return!0},splitListItem:o=>({tr:t,state:e,dispatch:n,editor:s})=>{var r;const i=Q(o,e.schema),{$from:a,$to:l}=e.selection,c=e.selection.node;if(c&&c.isBlock||a.depth<2||!a.sameParent(l))return!1;const d=a.node(-1);if(d.type!==i)return!1;const h=s.extensionManager.attributes;if(a.parent.content.size===0&&a.node(-1).childCount===a.indexAfter(-1)){if(a.depth===2||a.node(-3).type!==i||a.index(-2)!==a.node(-2).childCount-1)return!1;if(n){let g=b.empty;const y=a.index(-1)?1:a.index(-2)?2:3;for(let E=a.depth-y;E>=a.depth-3;E-=1)g=b.from(a.node(E).copy(g));const v=a.indexAfter(-1)<a.node(-2).childCount?1:a.indexAfter(-2)<a.node(-3).childCount?2:3,w=dn(h,a.node().type.name,a.node().attrs),x=((r=i.contentMatch.defaultType)===null||r===void 0?void 0:r.createAndFill(w))||void 0;g=g.append(b.from(i.createAndFill(null,x)||void 0));const _=a.before(a.depth-(y-1));t.replace(_,a.after(-v),new k(g,4-y,0));let T=-1;t.doc.nodesBetween(_,t.doc.content.size,(E,C)=>{if(T>-1)return!1;E.isTextblock&&E.content.size===0&&(T=C+1)}),T>-1&&t.setSelection(A.near(t.doc.resolve(T))),t.scrollIntoView()}return!0}const u=l.pos===a.end()?d.contentMatchAt(0).defaultType:null,f=dn(h,d.type.name,d.attrs),p=dn(h,a.node().type.name,a.node().attrs);t.delete(a.pos,l.pos);const m=u?[{type:i,attrs:f},{type:u,attrs:p}]:[{type:i,attrs:f}];if(!Et(t.doc,a.pos,2))return!1;if(n){const{selection:g,storedMarks:y}=e,{splittableMarks:v}=s.extensionManager,w=y||g.$to.parentOffset&&g.$from.marks();if(t.split(a.pos,2,m).scrollIntoView(),!w||!n)return!0;const x=w.filter(_=>v.includes(_.type.name));t.ensureMarks(x)}return!0},toggleList:(o,t,e,n={})=>({editor:s,tr:r,state:i,dispatch:a,chain:l,commands:c,can:d})=>{const{extensions:h,splittableMarks:u}=s.extensionManager,f=Q(o,i.schema),p=Q(t,i.schema),{selection:m,storedMarks:g}=i,{$from:y,$to:v}=m,w=y.blockRange(v),x=g||m.$to.parentOffset&&m.$from.marks();if(!w)return!1;const _=cr(T=>Ho(T.type.name,h))(m);if(w.depth>=1&&_&&w.depth-_.depth<=1){if(_.node.type===f)return c.liftListItem(p);if(Ho(_.node.type.name,h)&&f.validContent(_.node.content)&&a)return l().command(()=>(r.setNodeMarkup(_.pos,f),!0)).command(()=>ys(r,f)).command(()=>vs(r,f)).run()}return e&&x&&a?l().command(()=>{const T=d().wrapInList(f,n),E=x.filter(C=>u.includes(C.type.name));return r.ensureMarks(E),!!T||c.clearNodes()}).wrapInList(f,n).command(()=>ys(r,f)).command(()=>vs(r,f)).run():l().command(()=>!!d().wrapInList(f,n)||c.clearNodes()).wrapInList(f,n).command(()=>ys(r,f)).command(()=>vs(r,f)).run()},toggleMark:(o,t={},e={})=>({state:n,commands:s})=>{const{extendEmptyMarkRange:r=!1}=e,i=Rt(o,n.schema);return Us(n,i,t)?s.unsetMark(i,{extendEmptyMarkRange:r}):s.setMark(i,t)},toggleNode:(o,t,e={})=>({state:n,commands:s})=>{const r=Q(o,n.schema),i=Q(t,n.schema);return Je(n,r,e)?s.setNode(i):s.setNode(r,e)},toggleWrap:(o,t={})=>({state:e,commands:n})=>{const s=Q(o,e.schema);return Je(e,s,t)?n.lift(s):n.wrapIn(s,t)},undoInputRule:()=>({state:o,dispatch:t})=>{const e=o.plugins;for(let n=0;n<e.length;n+=1){const s=e[n];let r;if(s.spec.isInputRules&&(r=s.getState(o))){if(t){const i=o.tr,a=r.transform;for(let l=a.steps.length-1;l>=0;l-=1)i.step(a.steps[l].invert(a.docs[l]));if(r.text){const l=i.doc.resolve(r.from).marks();i.replaceWith(r.from,r.to,o.schema.text(r.text,l))}else i.delete(r.from,r.to)}return!0}}return!1},unsetAllMarks:()=>({tr:o,dispatch:t})=>{const{selection:e}=o,{empty:n,ranges:s}=e;return n||t&&s.forEach(r=>{o.removeMark(r.$from.pos,r.$to.pos)}),!0},unsetMark:(o,t={})=>({tr:e,state:n,dispatch:s})=>{var r;const{extendEmptyMarkRange:i=!1}=t,{selection:a}=e,l=Rt(o,n.schema),{$from:c,empty:d,ranges:h}=a;if(!s)return!0;if(d&&i){let{from:u,to:f}=a;const p=(r=c.marks().find(g=>g.type===l))===null||r===void 0?void 0:r.attrs,m=Fo(c,l,p);m&&(u=m.from,f=m.to),e.removeMark(u,f,l)}else h.forEach(u=>{e.removeMark(u.$from.pos,u.$to.pos,l)});return e.removeStoredMark(l),!0},updateAttributes:(o,t={})=>({tr:e,state:n,dispatch:s})=>{let r=null,i=null;const a=On(typeof o=="string"?o:o.name,n.schema);return!!a&&(a==="node"&&(r=Q(o,n.schema)),a==="mark"&&(i=Rt(o,n.schema)),s&&e.selection.ranges.forEach(l=>{const c=l.$from.pos,d=l.$to.pos;n.doc.nodesBetween(c,d,(h,u)=>{r&&r===h.type&&e.setNodeMarkup(u,void 0,{...h.attrs,...t}),i&&h.marks.length&&h.marks.forEach(f=>{if(i===f.type){const p=Math.max(u,c),m=Math.min(u+h.nodeSize,d);e.addMark(p,m,i.create({...f.attrs,...t}))}})})}),!0)},wrapIn:(o,t={})=>({state:e,dispatch:n})=>function(s,r=null){return function(i,a){let{$from:l,$to:c}=i.selection,d=l.blockRange(c),h=d&&wi(d,s,r);return!!h&&(a&&a(i.tr.wrap(d,h).scrollIntoView()),!0)}}(Q(o,e.schema),t)(e,n),wrapInList:(o,t={})=>({state:e,dispatch:n})=>_c(Q(o,e.schema),t)(e,n)});const qc=It.create({name:"commands",addCommands:()=>({...$c})}),Fc=It.create({name:"editable",addProseMirrorPlugins(){return[new Ut({key:new tn("editable"),props:{editable:()=>this.editor.options.editable}})]}}),zc=It.create({name:"focusEvents",addProseMirrorPlugins(){const{editor:o}=this;return[new Ut({key:new tn("focusEvents"),props:{handleDOMEvents:{focus:(t,e)=>{o.isFocused=!0;const n=o.state.tr.setMeta("focus",{event:e}).setMeta("addToHistory",!1);return t.dispatch(n),!1},blur:(t,e)=>{o.isFocused=!1;const n=o.state.tr.setMeta("blur",{event:e}).setMeta("addToHistory",!1);return t.dispatch(n),!1}}}})]}}),Lc=It.create({name:"keymap",addKeyboardShortcuts(){const o=()=>this.editor.commands.first(({commands:r})=>[()=>r.undoInputRule(),()=>r.command(({tr:i})=>{const{selection:a,doc:l}=i,{empty:c,$anchor:d}=a,{pos:h,parent:u}=d,f=d.parent.isTextblock&&h>0?i.doc.resolve(h-1):d,p=f.parent.type.spec.isolating,m=d.pos-d.parentOffset,g=p&&f.parent.childCount===1?m===d.pos:R.atStart(l).from===h;return!(!c||!u.type.isTextblock||u.textContent.length||!g||g&&d.parent.type.name==="paragraph")&&r.clearNodes()}),()=>r.deleteSelection(),()=>r.joinBackward(),()=>r.selectNodeBackward()]),t=()=>this.editor.commands.first(({commands:r})=>[()=>r.deleteSelection(),()=>r.deleteCurrentNode(),()=>r.joinForward(),()=>r.selectNodeForward()]),e={Enter:()=>this.editor.commands.first(({commands:r})=>[()=>r.newlineInCode(),()=>r.createParagraphNear(),()=>r.liftEmptyBlock(),()=>r.splitBlock()]),"Mod-Enter":()=>this.editor.commands.exitCode(),Backspace:o,"Mod-Backspace":o,"Shift-Backspace":o,Delete:t,"Mod-Delete":t,"Mod-a":()=>this.editor.commands.selectAll()},n={...e},s={...e,"Ctrl-h":o,"Alt-Backspace":o,"Ctrl-d":t,"Ctrl-Alt-Backspace":t,"Alt-Delete":t,"Alt-d":t,"Ctrl-a":()=>this.editor.commands.selectTextblockStart(),"Ctrl-e":()=>this.editor.commands.selectTextblockEnd()};return Vs()||pa()?s:n},addProseMirrorPlugins(){return[new Ut({key:new tn("clearDocument"),appendTransaction:(o,t,e)=>{if(!(o.some(h=>h.docChanged)&&!t.doc.eq(e.doc)))return;const{empty:n,from:s,to:r}=t.selection,i=R.atStart(t.doc).from,a=R.atEnd(t.doc).to;if(n||!(s===i&&r===a)||e.doc.textBetween(0,e.doc.content.size," "," ").length!==0)return;const l=e.tr,c=qn({state:e,transaction:l}),{commands:d}=new Fn({editor:this.editor,state:c});return d.clearNodes(),l.steps.length?l:void 0}})]}}),Bc=It.create({name:"tabindex",addProseMirrorPlugins(){return[new Ut({key:new tn("tabindex"),props:{attributes:this.editor.isEditable?{tabindex:"0"}:{}}})]}});class Qt{constructor(t,e,n=!1,s=null){this.currentNode=null,this.actualDepth=null,this.isBlock=n,this.resolvedPos=t,this.editor=e,this.currentNode=s}get name(){return this.node.type.name}get node(){return this.currentNode||this.resolvedPos.node()}get element(){return this.editor.view.domAtPos(this.pos).node}get depth(){var t;return(t=this.actualDepth)!==null&&t!==void 0?t:this.resolvedPos.depth}get pos(){return this.resolvedPos.pos}get content(){return this.node.content}set content(t){let e=this.from,n=this.to;if(this.isBlock){if(this.content.size===0)return void console.error(`You cant set content on a block node. Tried to set content on ${this.name} at ${this.pos}`);e=this.from+1,n=this.to-1}this.editor.commands.insertContentAt({from:e,to:n},t)}get attributes(){return this.node.attrs}get textContent(){return this.node.textContent}get size(){return this.node.nodeSize}get from(){return this.isBlock?this.pos:this.resolvedPos.start(this.resolvedPos.depth)}get range(){return{from:this.from,to:this.to}}get to(){return this.isBlock?this.pos+this.size:this.resolvedPos.end(this.resolvedPos.depth)+(this.node.isText?0:1)}get parent(){if(this.depth===0)return null;const t=this.resolvedPos.start(this.resolvedPos.depth-1),e=this.resolvedPos.doc.resolve(t);return new Qt(e,this.editor)}get before(){let t=this.resolvedPos.doc.resolve(this.from-(this.isBlock?1:2));return t.depth!==this.depth&&(t=this.resolvedPos.doc.resolve(this.from-3)),new Qt(t,this.editor)}get after(){let t=this.resolvedPos.doc.resolve(this.to+(this.isBlock?2:1));return t.depth!==this.depth&&(t=this.resolvedPos.doc.resolve(this.to+3)),new Qt(t,this.editor)}get children(){const t=[];return this.node.content.forEach((e,n)=>{const s=e.isBlock&&!e.isTextblock,r=this.pos+n+1,i=this.resolvedPos.doc.resolve(r);if(!s&&i.depth<=this.depth)return;const a=new Qt(i,this.editor,s,s?e:null);s&&(a.actualDepth=this.depth+1),t.push(new Qt(i,this.editor,s,s?e:null))}),t}get firstChild(){return this.children[0]||null}get lastChild(){const t=this.children;return t[t.length-1]||null}closest(t,e={}){let n=null,s=this.parent;for(;s&&!n;){if(s.node.type.name===t)if(Object.keys(e).length>0){const r=s.node.attrs,i=Object.keys(e);for(let a=0;a<i.length;a+=1){const l=i[a];if(r[l]!==e[l])break}}else n=s;s=s.parent}return n}querySelector(t,e={}){return this.querySelectorAll(t,e,!0)[0]||null}querySelectorAll(t,e={},n=!1){let s=[];if(!this.children||this.children.length===0)return s;const r=Object.keys(e);return this.children.forEach(i=>{n&&s.length>0||(i.node.type.name===t&&r.every(a=>e[a]===i.node.attrs[a])&&s.push(i),n&&s.length>0||(s=s.concat(i.querySelectorAll(t,e,n))))}),s}setAttribute(t){const e=this.editor.state.selection;this.editor.chain().setTextSelection(this.from).updateAttributes(this.node.type.name,t).setTextSelection(e.from).run()}}class Pd extends kc{constructor(t={}){super(),this.isFocused=!1,this.extensionStorage={},this.options={element:document.createElement("div"),content:"",injectCSS:!0,injectNonce:void 0,extensions:[],autofocus:!1,editable:!0,editorProps:{},parseOptions:{},coreExtensionOptions:{},enableInputRules:!0,enablePasteRules:!0,enableCoreExtensions:!0,onBeforeCreate:()=>null,onCreate:()=>null,onUpdate:()=>null,onSelectionUpdate:()=>null,onTransaction:()=>null,onFocus:()=>null,onBlur:()=>null,onDestroy:()=>null},this.isCapturingTransaction=!1,this.capturedTransaction=null,this.setOptions(t),this.createExtensionManager(),this.createCommandManager(),this.createSchema(),this.on("beforeCreate",this.options.onBeforeCreate),this.emit("beforeCreate",{editor:this}),this.createView(),this.injectCSS(),this.on("create",this.options.onCreate),this.on("update",this.options.onUpdate),this.on("selectionUpdate",this.options.onSelectionUpdate),this.on("transaction",this.options.onTransaction),this.on("focus",this.options.onFocus),this.on("blur",this.options.onBlur),this.on("destroy",this.options.onDestroy),window.setTimeout(()=>{this.isDestroyed||(this.commands.focus(this.options.autofocus),this.emit("create",{editor:this}))},0)}get storage(){return this.extensionStorage}get commands(){return this.commandManager.commands}chain(){return this.commandManager.chain()}can(){return this.commandManager.can()}injectCSS(){this.options.injectCSS&&document&&(this.css=function(t,e,n){const s=document.querySelector("style[data-tiptap-style]");if(s!==null)return s;const r=document.createElement("style");return e&&r.setAttribute("nonce",e),r.setAttribute("data-tiptap-style",""),r.innerHTML=t,document.getElementsByTagName("head")[0].appendChild(r),r}(`.ProseMirror {
  position: relative;
}

.ProseMirror {
  word-wrap: break-word;
  white-space: pre-wrap;
  white-space: break-spaces;
  -webkit-font-variant-ligatures: none;
  font-variant-ligatures: none;
  font-feature-settings: "liga" 0; /* the above doesn't seem to work in Edge */
}

.ProseMirror [contenteditable="false"] {
  white-space: normal;
}

.ProseMirror [contenteditable="false"] [contenteditable="true"] {
  white-space: pre-wrap;
}

.ProseMirror pre {
  white-space: pre-wrap;
}

img.ProseMirror-separator {
  display: inline !important;
  border: none !important;
  margin: 0 !important;
  width: 1px !important;
  height: 1px !important;
}

.ProseMirror-gapcursor {
  display: none;
  pointer-events: none;
  position: absolute;
  margin: 0;
}

.ProseMirror-gapcursor:after {
  content: "";
  display: block;
  position: absolute;
  top: -2px;
  width: 20px;
  border-top: 1px solid black;
  animation: ProseMirror-cursor-blink 1.1s steps(2, start) infinite;
}

@keyframes ProseMirror-cursor-blink {
  to {
    visibility: hidden;
  }
}

.ProseMirror-hideselection *::selection {
  background: transparent;
}

.ProseMirror-hideselection *::-moz-selection {
  background: transparent;
}

.ProseMirror-hideselection * {
  caret-color: transparent;
}

.ProseMirror-focused .ProseMirror-gapcursor {
  display: block;
}

.tippy-box[data-animation=fade][data-state=hidden] {
  opacity: 0
}`,this.options.injectNonce))}setOptions(t={}){this.options={...this.options,...t},this.view&&this.state&&!this.isDestroyed&&(this.options.editorProps&&this.view.setProps(this.options.editorProps),this.view.updateState(this.state))}setEditable(t,e=!0){this.setOptions({editable:t}),e&&this.emit("update",{editor:this,transaction:this.state.tr})}get isEditable(){return this.options.editable&&this.view&&this.view.editable}get state(){return this.view.state}registerPlugin(t,e){const n=la(e)?e(t,[...this.state.plugins]):[...this.state.plugins,t],s=this.state.reconfigure({plugins:n});this.view.updateState(s)}unregisterPlugin(t){if(this.isDestroyed)return;const e=typeof t=="string"?`${t}$`:t.key,n=this.state.reconfigure({plugins:this.state.plugins.filter(s=>!s.key.startsWith(e))});this.view.updateState(n)}createExtensionManager(){var t,e;const n=[...this.options.enableCoreExtensions?[Fc,Ac.configure({blockSeparator:(e=(t=this.options.coreExtensionOptions)===null||t===void 0?void 0:t.clipboardTextSerializer)===null||e===void 0?void 0:e.blockSeparator}),qc,zc,Lc,Bc]:[],...this.options.extensions].filter(s=>["extension","node","mark"].includes(s?.type));this.extensionManager=new ke(n,this)}createCommandManager(){this.commandManager=new Fn({editor:this})}createSchema(){this.schema=this.extensionManager.schema}createView(){const t=fa(this.options.content,this.schema,this.options.parseOptions),e=ha(t,this.options.autofocus);this.view=new fc(this.options.element,{...this.options.editorProps,dispatchTransaction:this.dispatchTransaction.bind(this),state:Ce.create({doc:t,selection:e||void 0})});const n=this.state.reconfigure({plugins:this.extensionManager.plugins});this.view.updateState(n),this.createNodeViews(),this.prependClass(),this.view.dom.editor=this}createNodeViews(){this.view.setProps({nodeViews:this.extensionManager.nodeViews})}prependClass(){this.view.dom.className=`tiptap ${this.view.dom.className}`}captureTransaction(t){this.isCapturingTransaction=!0,t(),this.isCapturingTransaction=!1;const e=this.capturedTransaction;return this.capturedTransaction=null,e}dispatchTransaction(t){if(this.view.isDestroyed)return;if(this.isCapturingTransaction)return this.capturedTransaction?void t.steps.forEach(i=>{var a;return(a=this.capturedTransaction)===null||a===void 0?void 0:a.step(i)}):void(this.capturedTransaction=t);const e=this.state.apply(t),n=!this.state.selection.eq(e.selection);this.view.updateState(e),this.emit("transaction",{editor:this,transaction:t}),n&&this.emit("selectionUpdate",{editor:this,transaction:t});const s=t.getMeta("focus"),r=t.getMeta("blur");s&&this.emit("focus",{editor:this,event:s.event,transaction:t}),r&&this.emit("blur",{editor:this,event:r.event,transaction:t}),t.docChanged&&!t.getMeta("preventUpdate")&&this.emit("update",{editor:this,transaction:t})}getAttributes(t){return Pc(this.state,t)}isActive(t,e){const n=typeof t=="string"?t:null,s=typeof t=="string"?e:t;return function(r,i,a={}){if(!i)return Je(r,null,a)||Us(r,null,a);const l=On(i,r.schema);return l==="node"?Je(r,i,a):l==="mark"&&Us(r,i,a)}(this.state,n,s)}getJSON(){return this.state.doc.toJSON()}getHTML(){return function(t,e){const n=ue.fromSchema(e).serializeFragment(t),s=document.implementation.createHTMLDocument().createElement("div");return s.appendChild(n),s.innerHTML}(this.state.doc.content,this.schema)}getText(t){const{blockSeparator:e=`

`,textSerializers:n={}}=t||{};return function(s,r){return ca(s,{from:0,to:s.content.size},r)}(this.state.doc,{blockSeparator:e,textSerializers:{...da(this.schema),...n}})}get isEmpty(){return function(t){var e;const n=(e=t.type.createAndFill())===null||e===void 0?void 0:e.toJSON(),s=t.toJSON();return JSON.stringify(n)===JSON.stringify(s)}(this.state.doc)}getCharacterCount(){return console.warn('[tiptap warn]: "editor.getCharacterCount()" is deprecated. Please use "editor.storage.characterCount.characters()" instead.'),this.state.doc.content.size-2}destroy(){this.emit("destroy"),this.view&&this.view.destroy(),this.removeAllListeners()}get isDestroyed(){var t;return!(!((t=this.view)===null||t===void 0)&&t.docView)}$node(t,e){var n;return((n=this.$doc)===null||n===void 0?void 0:n.querySelector(t,e))||null}$nodes(t,e){var n;return((n=this.$doc)===null||n===void 0?void 0:n.querySelectorAll(t,e))||null}$pos(t){const e=this.state.doc.resolve(t);return new Qt(e,this)}get $doc(){return this.$pos(0)}}function $d(o){return new Ec({find:o.find,handler:({state:t,range:e,match:n})=>{const s=P(o.getAttributes,void 0,n)||{},{tr:r}=t,i=e.from;let a=e.to;const l=o.type.create(s);if(n[1]){let c=i+n[0].lastIndexOf(n[1]);c>a?c=a:a=c+n[1].length;const d=n[0][n[0].length-1];r.insertText(d,i+n[0].length-1),r.replaceWith(c,a,l)}else n[0]&&r.insert(i-1,o.type.create(s)).delete(r.mapping.map(i),r.mapping.map(a));r.scrollIntoView()}})}class In{constructor(t={}){this.type="mark",this.name="mark",this.parent=null,this.child=null,this.config={name:this.name,defaultOptions:{}},this.config={...this.config,...t},this.name=this.config.name,t.defaultOptions&&Object.keys(t.defaultOptions).length>0&&console.warn(`[tiptap warn]: BREAKING CHANGE: "defaultOptions" is deprecated. Please use "addOptions" instead. Found in extension: "${this.name}".`),this.options=this.config.defaultOptions,this.config.addOptions&&(this.options=P(M(this,"addOptions",{name:this.name}))),this.storage=P(M(this,"addStorage",{name:this.name,options:this.options}))||{}}static create(t={}){return new In(t)}configure(t={}){const e=this.extend();return e.options=zn(this.options,t),e.storage=P(M(e,"addStorage",{name:e.name,options:e.options})),e}extend(t={}){const e=new In({...this.config,...t});return e.parent=this,this.child=e,e.name=t.name?t.name:e.parent.name,t.defaultOptions&&console.warn(`[tiptap warn]: BREAKING CHANGE: "defaultOptions" is deprecated. Please use "addOptions" instead. Found in extension: "${e.name}".`),e.options=P(M(e,"addOptions",{name:e.name})),e.storage=P(M(e,"addStorage",{name:e.name,options:e.options})),e}static handleExit({editor:t,mark:e}){const{tr:n}=t.state,s=t.state.selection.$from;if(s.pos===s.end()){const r=s.marks();if(!r.find(a=>a?.type.name===e.name))return!1;const i=r.find(a=>a?.type.name===e.name);return i&&n.removeStoredMark(i),n.insertText(" ",s.pos),t.view.dispatch(n),!0}return!1}}class Nn{constructor(t={}){this.type="node",this.name="node",this.parent=null,this.child=null,this.config={name:this.name,defaultOptions:{}},this.config={...this.config,...t},this.name=this.config.name,t.defaultOptions&&Object.keys(t.defaultOptions).length>0&&console.warn(`[tiptap warn]: BREAKING CHANGE: "defaultOptions" is deprecated. Please use "addOptions" instead. Found in extension: "${this.name}".`),this.options=this.config.defaultOptions,this.config.addOptions&&(this.options=P(M(this,"addOptions",{name:this.name}))),this.storage=P(M(this,"addStorage",{name:this.name,options:this.options}))||{}}static create(t={}){return new Nn(t)}configure(t={}){const e=this.extend();return e.options=zn(this.options,t),e.storage=P(M(e,"addStorage",{name:e.name,options:e.options})),e}extend(t={}){const e=new Nn({...this.config,...t});return e.parent=this,this.child=e,e.name=t.name?t.name:e.parent.name,t.defaultOptions&&console.warn(`[tiptap warn]: BREAKING CHANGE: "defaultOptions" is deprecated. Please use "addOptions" instead. Found in extension: "${e.name}".`),e.options=P(M(e,"addOptions",{name:e.name})),e.storage=P(M(e,"addStorage",{name:e.name,options:e.options})),e}}function qd(o){return o.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&")}var Hc=ti("<!> Ask a Question",1),Vc=ti("<div><!></div>");function Uc(o,t){let e=wa(t,"isEditable",3,!0);var n=Vc();let s;var r=Sa(n);xa(r,()=>cl.Root,(i,a)=>{a(i,{color:"accent",size:1,variant:"soft",children:(l,c)=>{var d=Hc(),h=ba(d);dl(h,{name:"message-square-text"}),pr(l,d)},$$slots:{default:!0}})}),_a(i=>s=Ca(n,1,"c-ask-mode-badge svelte-eq5ts6",null,s,i),[()=>({"c-ask-mode-badge--block":!e()})]),pr(o,n)}const be=`# For this specific question, follow these ask mode guidelines:
- Focus on providing clear, accurate information
- Use code examples when helpful
- ONLY use retrieval tools (web-fetch, codebase-retrieval, grep-search) to gather information
- Do NOT use any tools that modify files (str-replace-editor, save-file, remove-files, etc.)
- Do NOT make any changes to the codebase - this is for information gathering only
- If the question is unclear, ask for clarification
- If you need to search for information, use the available retrieval tools extensively

User message:
`,Uo=`# Ask mode is now disabled
- You can now make changes to files and use all available tools
- Previous ask mode restrictions no longer apply

User message:
`;class kt{_isAskMode=!1;_editor;static nodeName="askMode";_onAskModeChange;_lastKnownBadgeState=!1;setAskMode(t,e){this._isAskMode!==t&&(this._isAskMode=t,this._onAskModeChange?.(t),this._editor?(t?this._insertBadgeNode(e):(this._removeBadgeNode(),e?.()),this._lastKnownBadgeState=t):e?.())}get isAskMode(){return this._isAskMode}get askModePrompt(){return be}setOnAskModeChange(t){this._onAskModeChange=t}static detectAskModeInContent(t){if(!t||typeof t!="object")return!1;const e=t;return e.type===kt.nodeName||!!Array.isArray(e.content)&&e.content.some(n=>kt.detectAskModeInContent(n))}_insertBadgeNode(t){if(!this._editor||this._findBadgeNode())return void t?.();const e=this._editor.state.selection.from,n=this._editor.getText();this._editor.commands.clearContent(),this._editor.commands.insertContent([{type:kt.nodeName,attrs:{prompt:be}},{type:"text",text:" "},...n?[{type:"text",text:n}]:[]]);const s=this._findBadgeNode();if(s){const r=n?Math.min(e+2,this._editor.state.doc.content.size):s.pos+2;this._editor.commands.setTextSelection(r)}setTimeout(()=>{t?.()},0)}_removeBadgeNode(){if(!this._editor)return;const t=this._findBadgeNode();if(!t)return;const e=t.pos+t.node.nodeSize,n=this._editor.state.doc.textBetween(e,e+1)===" "?e+1:e;this._editor.commands.deleteRange({from:t.pos,to:n})}_findBadgeNode(){if(!this._editor)return null;let t=null;return this._editor.state.doc.descendants((e,n)=>{if(e.type.name===kt.nodeName)return t={pos:n,node:e},!1}),t}get tipTapExtension(){const t=this;return Nn.create({name:kt.nodeName,group:"inline",inline:!0,atom:!0,selectable:!1,addAttributes:()=>({prompt:{default:be,keepOnSplit:!1,parseHTML:e=>e.getAttribute("data-ask-mode-prompt")||be,renderHTML:e=>({"data-ask-mode-prompt":e.prompt||be})}}),onCreate(){t._editor=this.editor,t._lastKnownBadgeState=t._findBadgeNode()!==null},onDestroy(){t._editor=void 0},onUpdate(){const e=t._findBadgeNode()!==null;e!==t._lastKnownBadgeState&&(t._lastKnownBadgeState=e,t._isAskMode!==e&&(t._isAskMode=e,t._onAskModeChange?.(e)))},parseHTML:()=>[{tag:`span[data-type="${kt.nodeName}"]`}],addNodeView:()=>({node:e,editor:n})=>{const s=document.createElement("span");s.setAttribute("data-type",kt.nodeName),s.contentEditable="false";const r=ka(Uc,{target:s,props:{isEditable:n.isEditable}});return{dom:s,contentDOM:void 0,destroy:()=>{Ma(r)},update:i=>i.type.name===kt.nodeName,ignoreMutation:()=>!0}},renderText:()=>""})}}class hn{constructor(){this._disposables=[]}add(t){if(t===void 0)throw new Error("Attempt to add undefined disposable to DisposableCollection");return this._disposables.push(t),t}addAll(...t){t.forEach(e=>this.add(e))}adopt(t){this._disposables.push(...t._disposables),t._disposables.length=0}dispose(){for(const t of this._disposables)t.dispose();this._disposables.length=0}}class jc{constructor(t=new hn,e=new hn){this._disposables=new hn,this._priorityDisposables=new hn,this._disposables.adopt(t),this._priorityDisposables.adopt(e)}addDisposable(t,e=!1){return e?this._priorityDisposables.add(t):this._disposables.add(t)}addDisposables(...t){this._disposables.addAll(...t)}dispose(){this._priorityDisposables.dispose(),this._disposables.dispose()}}const jo="settings.json";class Wc{constructor(){this._logger=Xs()}async loadSettings(){let t;try{t=xt()}catch{return this._logger.warn("Client workspaces not initialized"),null}const e=await t.getWorkspaceRoot();if(!e)return null;const n=(void 0)(e,Dt,Kt,jo);try{const s=await t.getPathInfo(n);if(!s.exists||s.type!==wt.File)return this._logger.debug(`Settings file not found at ${n}`),null;const r=(await t.readFile(n)).contents;if(!r)return this._logger.warn(`Settings file is empty: ${n}`),null;const i=JSON.parse(r);return this._logger.debug(`Loaded settings from ${n}`),i}catch(s){return this._logger.error(`Error loading settings file ${n}: ${String(s)}`),null}}async saveSettings(t){let e;try{e=xt()}catch{return void this._logger.error("Client workspaces not initialized")}const n=await e.getWorkspaceRoot();if(!n)return void this._logger.error("No workspace root found");const s=(void 0)(n,Dt,Kt);(await e.getPathInfo(s)).exists||this._logger.debug(`Creating rules directory at ${s}`);const r=(void 0)(s,jo),i=await e.getQualifiedPathName(r);if(i)try{const a=JSON.stringify(t,null,2);await e.writeFile(i,a),this._logger.debug(`Saved settings to ${r}`)}catch(a){this._logger.error(`Error saving settings file ${r}: ${String(a)}`)}else this._logger.error(`Unable to get qualified path for: ${r}`)}async getSharedRuleType(t){const e=await this.loadSettings();if(!e)return mr;const n=e.sharedRules.find(s=>s.path===t);return n?Ra(n.type):mr}async updateSharedRuleType(t,e){let n=await this.loadSettings();n||(n={sharedRules:[]});const s={type:e,path:t,content:"",description:void 0},r=Gt.formatRuleFileForMarkdown(s),i=Gt.getTypeFrontmatterKey(r),a=n.sharedRules.findIndex(l=>l.path===t);a>=0?n.sharedRules[a].type=i:n.sharedRules.push({path:t,type:i}),await this.saveSettings(n),this._logger.debug(`Updated shared rule type for ${t} to ${i} (${e})`)}isSharedRuleFile(t){const e=(void 0)(t);return Pa.includes(e)}}const Wo="imported",Jc=[".md",".mdc"],Jo=[{directory:".cursor/rules",file:".cursorrules",name:"Cursor"},{directory:".windsurf/rules",file:".windsurfrules",name:"Windsurf"},{directory:".github/instructions",file:".github/copilot-instructions.md",name:"GitHub Copilot"},{directory:".clinerules",file:".clinerules",name:"Cline"},{directory:".roo/rules",file:".roorules",name:"Roo Code"},{directory:".trae/rules",name:"Trae"}];class dr extends jc{constructor(){super(),this._logger=Xs(),this._settingsService=new Wc}async loadRules({includeGuidelines:t=!1,query:e,maxResults:n,contextRules:s}={}){this._logger.debug(`Loading rules with includeGuidelines=${t}, query=${e}, maxResults=${n}`);let r=[];const i=await Promise.all($a.map(async l=>{const c=await this.loadRuleFromFile(l);if(c){const d=await this._settingsService.getSharedRuleType(l);return{...c,type:d,settingsStored:!0}}return null}));if(r.push(...i.filter(l=>l!==null)),t){const l=await this.loadRuleFromFile();this._logger.debug("Loaded guidelines rules"),l&&r.push({...l,settingsStored:!0})}this._logger.debug("Using file system approach to load rules");const a=await this.loadDirectory((void 0)(Dt,Kt));if(this._logger.debug(`Loaded ${a.length} rules from directory`),r.push(...a),e&&e.trim()){const l=e.toLowerCase().trim();r=r.filter(c=>{const d=c.path.toLowerCase().includes(l),h=c.content.toLowerCase().includes(l);return d||h}),this._logger.debug(`Filtered to ${r.length} rules matching query: ${e}`)}return n&&n>0&&(r=r.slice(0,n),this._logger.debug(`Limited to ${r.length} rules`)),this._logger.debug(`Returning ${r.length} total rules`),s!==void 0&&s.length>0&&(r=dr.filterRulesByContext(r,s),this._logger.debug(`Filtered to ${r.length} rules based on context`)),r}static filterRulesByContext(t,e){return[...t.filter(n=>n.type!==Ae.MANUAL),...t.filter(n=>n.type===Ae.MANUAL&&e.some(s=>s.path===n.path))]}static calculateRulesAndGuidelinesCharacterCount(t){const{rules:e,workspaceGuidelinesContent:n,contextRules:s=[]}=t,r=e.filter(c=>c.type===Ae.ALWAYS_ATTACHED).reduce((c,d)=>c+d.content.length+d.path.length,0),i=e.filter(c=>c.type===Ae.AGENT_REQUESTED).reduce((c,d)=>c+100+(d.description?.length??0)+d.path.length,0),a=r+e.filter(c=>c.type===Ae.MANUAL).filter(c=>s.some(d=>d.path===c.path)).reduce((c,d)=>c+d.content.length+d.path.length,0)+i+n.length,l=t.rulesAndGuidelinesLimit&&a>t.rulesAndGuidelinesLimit;return{totalCharacterCount:a,isOverLimit:l,warningMessage:l&&t.rulesAndGuidelinesLimit?`Total number of characters in included rules and workspace guidelines (${a} chars)
        exceeds the limit of ${t.rulesAndGuidelinesLimit} characters, remove some rules
        or reduce the length of your guidelines.`:void 0}}async loadRuleFromFile(t=qa){const e=xt();if(!e)return void this._logger.warn("Client workspaces not initialized");const n=await e.getWorkspaceRoot();if(!n)return;const s=(void 0)(n,t),r=await e.getPathInfo(s);if(r.exists&&r.type===wt.File)try{const i=(await e.readFile(s)).contents;if(!i)return void this._logger.warn(`${t} is empty: ${s}`);const a=Gt.parseRuleFile(i,t);return this._logger.debug(`Loaded rule from ${t}`),{path:t,content:a.content,type:a.type,description:a.description}}catch(i){this._logger.error(`Error loading guidelines file ${s}: ${String(i)}`)}}async loadDirectory(t){const e=[];try{const n=xt();if(!n)return this._logger.warn("Client workspaces not initialized"),e;const s=await n.getWorkspaceRoot();if(!s)return this._logger.warn("No workspace root found"),e;const r=(void 0)(s,t);this._logger.debug(`Looking for rules in: ${r}`);const i=await n.getPathInfo(r);return this._logger.debug(`Path info for ${r}: ${JSON.stringify(i)}`),i.exists&&i.type===wt.Directory?(this._logger.debug(`Rules folder exists at ${r}`),await this.processRuleDirectory(n,r,e,t),this._logger.debug(`Loaded ${e.length} rules from ${r}`),e):(this._logger.debug(`Rules folder not found at ${r}`),e)}catch(n){return this._logger.error(`Error loading rules: ${String(n)}`),e}}async loadDirectoryFromPath(t){const e=[];try{const n=xt();if(!n)return this._logger.warn("Client workspaces not initialized"),e;let s;if(!(void 0)(t)){const i=await n.getWorkspaceRoot();if(!i)return this._logger.warn("No workspace root found"),e;s=(void 0)(i,t),this._logger.debug(`Loading rules from workspace-relative path: ${s}`)}const r=await n.getPathInfo(s);return r.exists&&r.type===wt.Directory?(this._logger.debug(`Rules folder exists at ${s}`),await this.processRuleDirectory(n,s,e,""),this._logger.debug(`Loaded ${e.length} rules from ${s}`),e):(this._logger.debug(`Rules folder not found at ${s}`),e)}catch(n){return this._logger.error(`Error loading rules from path: ${String(n)}`),e}}async processRuleDirectory(t,e,n,s){const r=await t.listDirectory(e,1,!1);if(r.errorMessage)this._logger.error(`Error listing directory ${e}: ${r.errorMessage}`);else{this._logger.debug(`Processing directory: ${e}, found ${r.entries.length} entries`);for(const i of r.entries){const a=(void 0)(e,i),l=(void 0)(s,i),c=await t.getPathInfo(a);if(c.exists)if(c.type===wt.Directory)this._logger.debug(`Processing subdirectory: ${i}`),await this.processRuleDirectory(t,a,n,l);else if(c.type===wt.File&&Jc.some(d=>i.endsWith(d))){this._logger.debug(`Processing rule file: ${i}`);try{const d=(await t.readFile(a)).contents||"",h=Gt.parseRuleFile(d,i);n.push({path:l,content:h.content,type:h.type,description:h.description}),this._logger.debug(`Successfully loaded rule: ${l}`)}catch(d){this._logger.error(`Error loading rule file ${a}: ${String(d)}`)}}else c.type===wt.File&&this._logger.debug(`Skipping non-markdown file: ${i}`)}}}async createRule(t,e=!1){const n=xt();if(!n)throw new Error("Client workspaces not initialized");const s=await n.getWorkspaceRoot();if(!s)throw new Error("No workspace root found");let r=(void 0)(s,Dt,Kt);e&&(r=(void 0)(r,Wo));const i=t.path.endsWith(".md")?t.path:`${t.path}.md`,a=(void 0)(r,i),l=await n.getQualifiedPathName(a);if(!l)throw new Error(`Unable to get qualified path for: ${a}`);if((await n.getPathInfo(a)).exists)throw new Error(`Rule file already exists: ${i}`);const c=Gt.formatRuleFileForMarkdown(t);await n.writeFile(l,c);const d=e?(void 0)(Dt,Kt,Wo,i):(void 0)(Dt,Kt,i);return{...t,path:d}}async deleteRule(t){if(typeof t!="string")throw new Error(`Expected rulePath to be a string, got ${typeof t}: ${String(t)}`);const e=xt();if(!e)throw new Error("Client workspaces not initialized");const n=await e.getWorkspaceRoot();if(!n)throw new Error("No workspace root found");let s;if((void 0)(t)||(s=(void 0)(n,t)),(await e.getPathInfo(s)).exists){const r=await e.getQualifiedPathName(s);r&&(await e.deleteFile(r),this._logger.debug(`Deleted rule file: ${s}`)),this._logger.debug(`Deleted rule file: ${s}`)}}async updateRuleFile(t,e){if(typeof t!="string")throw new Error(`Expected rulePath to be a string, got ${typeof t}: ${String(t)}`);const n=xt();if(!n)throw new Error("Client workspaces not initialized");const s=await n.getWorkspaceRoot();if(!s)throw new Error("No workspace root found");if(this._settingsService.isSharedRuleFile(t)){const a=(void 0)(t),l=Gt.parseRuleFile(e,a).type;return this._logger.debug(`Updating shared rule type for ${t} to ${l}`),void await this._settingsService.updateSharedRuleType(t,l)}let r;(void 0)(t)||(r=t.startsWith(Dt)?(void 0)(s,t):(void 0)(s,Dt,Kt,t));const i=await n.getQualifiedPathName(r);if(!i)throw new Error(`Unable to get qualified path for: ${r}`);await n.writeFile(i,e),this._logger.debug(`Updated rule file: ${r}`)}async updateSharedRuleType(t,e){if(!this._settingsService.isSharedRuleFile(t))throw new Error(`File ${t} is not a shared rule file`);await this._settingsService.updateSharedRuleType(t,e),this._logger.debug(`Updated shared rule type for ${t} to ${e}`)}isSharedRuleFile(t){return this._settingsService.isSharedRuleFile(t)}async importFile(t,e){const n=xt();if(!n)throw new Error("Client workspaces not initialized");let s,r;if(!(void 0)(t)){const a=await n.getWorkspaceRoot();if(!a)throw new Error("No workspace root found");s=(void 0)(a,t),r=t,this._logger.debug(`Importing file from workspace-relative path: ${s}`)}const i=await n.getPathInfo(s);if(!i.exists||i.type!==wt.File)return this._logger.error(`File not found: ${s}`),{successfulImports:0,duplicates:0,totalAttempted:1};try{const a=(await n.readFile(s)).contents;if(!a)return this._logger.error(`File is empty: ${s}`),{successfulImports:0,duplicates:0,totalAttempted:1};const l=Gt.parseRuleFile(a,r),c=(void 0)(r).name.replace(".","");return await this.createRule({path:c,content:l.content,type:l.type},e),{successfulImports:1,duplicates:0,totalAttempted:1}}catch(a){return this._logger.error(`Error importing file ${t}: ${String(a)}`),{successfulImports:0,duplicates:String(a).includes("already exists")?1:0,totalAttempted:1}}}async importDirectory(t,e){try{const n=await this.loadDirectoryFromPath(t);if(n.length===0)return this._logger.debug(`No rules found in directory: ${t}`),{successfulImports:0,duplicates:0,totalAttempted:0};this._logger.debug(`Loaded ${n.length} existing rules from ${t}`);let s=0,r=0;const i=n.length;for(const a of n)try{const l=(void 0)(a.path).name,c=(void 0)(a.path),d=c==="."?l:(void 0)(c,l);await this.createRule({path:d,content:a.content,type:a.type},e),s++,this._logger.debug(`Successfully imported rule: ${a.path} -> ${d}`)}catch(l){this._logger.warn(`Failed to import rule ${a.path}: ${String(l)}`),String(l).includes("already exists")&&r++}return this._logger.info(`Imported ${s} rules from ${t}, ${r} duplicates skipped`),{successfulImports:s,duplicates:r,totalAttempted:i}}catch(n){return this._logger.error(`Error importing directory: ${String(n)}`),{successfulImports:0,duplicates:0,totalAttempted:0}}}async detectAutoImportOptions(){const t=xt();if(!t)return this._logger.warn("No workspace available for auto-import detection"),[];const e=await t.getWorkspaceRoot();if(!e)return this._logger.warn("No workspace root found for auto-import detection"),[];const n=Jo.map(async({directory:s,file:r,name:i})=>{let a=!1,l=!1;if(s)try{const c=(void 0)(e,s),d=await t.getPathInfo(c);a=d.exists===!0&&d.type===wt.Directory}catch(c){this._logger.debug(`Error checking directory ${s}: ${String(c)}`)}if(r)try{const c=(void 0)(e,r),d=await t.getPathInfo(c);l=d.exists===!0&&d.type===wt.File}catch(c){this._logger.debug(`Error checking file ${r}: ${String(c)}`)}return a&&l?{label:i,description:`Import existing rules from ${s} and ${r}`,directory:s,file:r}:a?{label:i,description:`Import existing rules from ${s}`,directory:s}:l?{label:i,description:`Import existing rules from ${r}`,file:r}:null});return(await Promise.all(n)).filter(s=>s!==null)}async processAutoImportSelection(t){const e=Jo.find(l=>l.name===t);if(!e)throw new Error(`Unknown auto-import option: ${t}`);const n=[];e.directory&&n.push(this.importDirectory(e.directory,!0)),e.file&&n.push(this.importFile(e.file,!0));const s=await Promise.all(n),r=s.reduce((l,c)=>l+c.successfulImports,0),i=s.reduce((l,c)=>l+c.duplicates,0),a=s.reduce((l,c)=>l+c.totalAttempted,0);return this._logger.debug(`Auto-import rules completed for ${t}, imported: ${r}, duplicates: ${i}, total attempted: ${a}`),{importedRulesCount:r,duplicatesCount:i,totalAttempted:a,source:t}}autoImportRules(){this._logger.debug("Auto import rules requested")}dispose(){super.dispose()}}function Kc(o,t,e=1e3){let n=null,s=0;const r=Yt(t),i=()=>{const a=(()=>{const l=Date.now();if(n!==null&&l-s<e)return n;const c=o();return n=c,s=l,c})();r.set(a)};return{subscribe:r.subscribe,resetCache:()=>{n=null,i()},updateStore:i}}const ws=new Map,Gc=()=>{let o=Promise.resolve();const t=new Map,e=new Map,n=crypto.randomUUID(),s={end:r=>{const i=t.get(r);return console.debug("END LINK: ",r,n),i?.(),s},start:async(r,i)=>{const{promise:a,unlock:l,reject:c}=(h=>{let u=()=>{},f=()=>{},p=(m,g)=>()=>{g&&clearTimeout(g),m()};return{promise:new Promise((m,g)=>{let y,v=()=>{g("Chain was reset")};h&&h>0&&(y=setTimeout(v,h)),f=p(v,y),u=p(m,y)}),unlock:u,reject:f}})(i),d=o;return o=a.finally(()=>{t.delete(r),e.delete(r)}),t.set(r,()=>{l(),t.delete(r)}),e.set(r,()=>{c(),e.delete(r)}),await d,console.debug("START LINK: ",r,n),s},rejectAll:()=>{o=Promise.resolve();try{e.forEach(r=>{r(new Error("Chain was reset"))})}finally{t.clear(),e.clear()}},unlockAll:()=>{o=Promise.resolve();try{t.forEach(r=>{r()})}finally{t.clear(),e.clear()}}};return s};function Ko(o,t){return function(e,n){if(e.length<=n||e.length===0)return{truncatedText:e};const s=e.split(`
`),r="... additional lines truncated ..."+(s[0].endsWith("\r")?"\r":"");let i,a="";if(s.length<2||s[0].length+s[s.length-1].length+r.length>n){const l=Math.floor(n/2);a=[e.slice(0,l),"<...>",e.slice(-l)].join(""),i=[1,1,s.length,s.length]}else{const l=[],c=[];let d=r.length+1;for(let h=0;h<Math.floor(s.length/2);h++){const u=s[h],f=s[s.length-1-h],p=u.length+f.length+2;if(d+p>n)break;d+=p,l.push(u),c.push(f)}i=[1,l.length,s.length-c.length+1,s.length],l.push(r),l.push(...c.reverse()),a=l.join(`
`)}return{truncatedText:a,shownRangeWhenTruncated:i}}(o,t).truncatedText}function Xc(o){if(!o)return sn.IMAGE_FORMAT_UNSPECIFIED;switch(o.split("/")[1]?.toLowerCase()){case"jpeg":case"jpg":return sn.JPEG;case"png":return sn.PNG;default:return sn.IMAGE_FORMAT_UNSPECIFIED}}function Qc(o,t,e){if(o.phase!==H.cancelled&&o.phase!==H.completed&&o.phase!==H.error)return;let n;return o.result?.contentNodes?(n=function(s,r){return s.map(i=>i.type===_s.ContentText?{type:Un.CONTENT_TEXT,text_content:i.text_content}:i.type===_s.ContentImage&&i.image_content&&r?{type:Un.CONTENT_IMAGE,image_content:{image_data:i.image_content.image_data,format:Xc(i.image_content.media_type)}}:{type:Un.CONTENT_TEXT,text_content:"[Error: Invalid content node]"})}(o.result.contentNodes,e),{content:"",is_error:o.result.isError,request_id:o.result.requestId,tool_use_id:t,content_nodes:n}):o.result?.text!==void 0?{content:o.result.text,is_error:o.result.isError,request_id:o.result.requestId,tool_use_id:t}:void 0}function Yc(o=[]){let t;for(const e of o){if(e.type===j.TOOL_USE)return e;e.type===j.TOOL_USE_START&&(t=e)}return t}function Zc(o,t,e,n){if(!o||!t)return[];let s=!1;return t.filter(r=>{const i=n?.isActive&&r.tool_use?n.getToolUseState(r.tool_use.tool_use_id):e.getToolUseState(r.requestId??o,r.tool_use?.tool_use_id);return s===!1&&i.phase!==H.new&&i.phase!==H.unknown&&i.phase!==H.checkingSafety&&r.tool_use!==void 0||(i.phase===H.runnable&&(s=!0),!1)})}function Fd(o,t){if(o.contentNodes&&o.contentNodes.length>0){const e=o.contentNodes.map(n=>{if(n.type===_s.ContentText){let s="";return n.text_content&&(s=Ko(n.text_content,t/o.contentNodes.length)),{...n,text_content:s}}return n});return{...o,contentNodes:e}}return{...o,text:Ko(o.text,t)}}const Se="__NEW_AGENT__",zd=o=>o.chatItemType===void 0,Ld=o=>{const t=o.chatHistory.at(-1);if(!t||!U(t))return me.notRunning;if(!(t.status===V.success||t.status===V.failed||t.status===V.cancelled))return me.running;const e=t.structured_output_nodes?.filter(s=>s.type===j.TOOL_USE&&!!s.tool_use)??[];let n;if(n=Zc(t.request_id,e,o).at(-1),!n&&e.length>0&&(n=e.at(-1)),!n||!n.tool_use)return me.notRunning;switch(o.getToolUseState(t.request_id,n.tool_use.tool_use_id).phase){case H.runnable:return me.awaitingUserAction;case H.cancelled:return me.notRunning;default:return me.running}},js=o=>U(o)&&!!o.request_message,td=o=>o.chatHistory.findLast(t=>js(t)),Bd=(o,t)=>{const e=td(o);return e?.request_id?o.historyFrom(e.request_id,!0).filter(n=>U(n)&&(!t||t(n))):[]},ed=(o,t,e)=>!o||!t?!1:e.getToolUseState(t,o).phase===H.runnable&&(e.updateToolUseState({requestId:t,toolUseId:o,phase:H.cancelled}),!0),Hd=o=>{const t=o.chatHistory.at(-1),e=t?.request_id,n=(r=>r?.request_id&&U(r)?(r.structured_output_nodes?.filter(i=>i.type===j.TOOL_USE)??[]).map(({tool_use:i})=>i?.tool_use_id).filter(i=>i!==void 0):[])(t);let s=!1;for(const r of n)ed(r,e,o)&&(s=!0);return s},W={triggerOnHistorySizeChars:0,historyTailSizeCharsToExclude:0,triggerOnHistorySizeCharsWhenCacheExpiring:0,prompt:"",cacheTTLMs:0,bufferTimeBeforeCacheExpirationMs:0,summaryNodeRequestMessageTemplate:`
<supervisor>
Conversation history between Agent(you) and the user and history of tool calls was abridged and summarized to reduce context size.
Abridged conversation history:
{abridged_history}

Summary was generated by Agent(you) so 'I' in the summary represents Agent(you).
Here is the summary:
{summary}

Continue the conversation and finish the task given by the user from this point.
</supervisor>`,summaryNodeResponseMessage:"Ok. I will continue the conversation from this point.",abridgedHistoryParams:{totalCharsLimit:1e4,userMessageCharsLimit:1e3,agentResponseCharsLimit:2e3,actionCharsLimit:200,numFilesModifiedLimit:10,numFilesCreatedLimit:10,numFilesDeletedLimit:10,numFilesViewedLimit:10,numTerminalCommandsLimit:10}};function Ws(o,t,e=.5,n=.5){if(o.length<=t||t<=0)return o;if(e+n>1)throw new Error("startRatio + endRatio cannot exceed 1.0");const s="...",r=t-3;if(r<=0)return s.substring(0,t);const i=Math.floor(r*e),a=Math.floor(r*n);return o.substring(0,i)+s+o.substring(o.length-a)}const nt=(o,t)=>o!==void 0?o:t;function nd(o){for(const t of o.filesModified)o.filesViewed.delete(t)}function sd(o,t){try{const e=JSON.parse(o.input_json);switch(o.tool_name){case"str-replace-editor":e.path&&t.filesModified.add(e.path);break;case"save-file":e.path&&t.filesCreated.add(e.path);break;case"remove-files":if(e.file_paths&&Array.isArray(e.file_paths))for(const n of e.file_paths)t.filesDeleted.add(n);break;case"view":e.path&&t.filesViewed.add(e.path);break;case"launch-process":e.command&&t.terminalCommands.add(e.command)}}catch(e){console.warn("Failed to parse tool use input:",e)}}function qe(o,t,e,n="files"){if(o.size===0)return null;const s=Array.from(o).sort((l,c)=>l.localeCompare(c)),r=l=>Ws(l,e);if(s.length<=t)return s.map(r);const i=s.slice(0,t).map(r),a=s.length-t;return i.push(`... ${a} more ${n}`),i}function rd(o,t){let e=o.userMessage,n=o.agentFinalResponse;e.length>t.userMessageCharsLimit&&(e=Ws(e,t.userMessageCharsLimit)),n.length>t.agentResponseCharsLimit&&(n=Ws(n,t.agentResponseCharsLimit));const s=o.agentActionsSummary.filesModified.size>0||o.agentActionsSummary.filesCreated.size>0||o.agentActionsSummary.filesDeleted.size>0||o.agentActionsSummary.filesViewed.size>0||o.agentActionsSummary.terminalCommands.size>0,r={userMessage:e,agentResponse:n&&n.trim()!==""?n:null,hasActions:s,filesModified:qe(o.agentActionsSummary.filesModified,t.numFilesModifiedLimit,t.actionCharsLimit),filesCreated:qe(o.agentActionsSummary.filesCreated,t.numFilesCreatedLimit,t.actionCharsLimit),filesDeleted:qe(o.agentActionsSummary.filesDeleted,t.numFilesDeletedLimit,t.actionCharsLimit),filesViewed:qe(o.agentActionsSummary.filesViewed,t.numFilesViewedLimit,t.actionCharsLimit),terminalCommands:qe(o.agentActionsSummary.terminalCommands,t.numTerminalCommandsLimit,t.actionCharsLimit,"commands"),wasInterrupted:o.wasInterrupted,continues:o.continues};return Fa(r)}function od(o){let t=o.request_message||"";return o.structured_request_nodes?.some(e=>e.image_node||e.image_id_node)&&(t+=`
[User attached image]`),o.structured_request_nodes?.some(e=>e.file_node||e.file_id_node)&&(t+=`
[User attached document]`),t}function xs(o){return o.reduce((t,e)=>t+ga(e),0)}function ga(o){let t=0;return o.request_nodes?t+=JSON.stringify(o.request_nodes).length:t+=(o.request_message||"").length,o.response_nodes?t+=JSON.stringify(o.response_nodes).length:t+=(o.response_text||"").length,t}class id{constructor(){this._controllers=new Set,this._timeoutIds=new Set}addCallback(t,e){const n=new AbortController,s=setTimeout(()=>{t(n.signal),this._controllers.delete(n),this._timeoutIds.delete(s)},e);this._controllers.add(n),this._timeoutIds.add(s)}cancelAll(){this._controllers.forEach(t=>t.abort()),this._timeoutIds.forEach(t=>clearTimeout(t)),this._controllers.clear(),this._timeoutIds.clear()}}class ad{constructor(t,e,n){this._conversationModel=t,this._extensionClient=e,this._config=n,this._params=function(s){try{if(!s)return console.log("historySummaryParams is empty. Using default params"),W;const r=JSON.parse(s),i={triggerOnHistorySizeChars:nt(r.trigger_on_history_size_chars,W.triggerOnHistorySizeChars),historyTailSizeCharsToExclude:nt(r.history_tail_size_chars_to_exclude,W.historyTailSizeCharsToExclude),triggerOnHistorySizeCharsWhenCacheExpiring:nt(r.trigger_on_history_size_chars_when_cache_expiring,W.triggerOnHistorySizeCharsWhenCacheExpiring),prompt:nt(r.prompt,W.prompt),cacheTTLMs:nt(r.cache_ttl_ms,W.cacheTTLMs),bufferTimeBeforeCacheExpirationMs:nt(r.buffer_time_before_cache_expiration_ms,W.bufferTimeBeforeCacheExpirationMs),summaryNodeRequestMessageTemplate:nt(r.summary_node_request_message_template,W.summaryNodeRequestMessageTemplate),summaryNodeResponseMessage:nt(r.summary_node_response_message,W.summaryNodeResponseMessage),abridgedHistoryParams:{totalCharsLimit:nt(r.abridged_history_params?.total_chars_limit,W.abridgedHistoryParams.totalCharsLimit),userMessageCharsLimit:nt(r.abridged_history_params?.user_message_chars_limit,W.abridgedHistoryParams.userMessageCharsLimit),agentResponseCharsLimit:nt(r.abridged_history_params?.agent_response_chars_limit,W.abridgedHistoryParams.agentResponseCharsLimit),actionCharsLimit:nt(r.abridged_history_params?.action_chars_limit,W.abridgedHistoryParams.actionCharsLimit),numFilesModifiedLimit:nt(r.abridged_history_params?.num_files_modified_limit,W.abridgedHistoryParams.numFilesModifiedLimit),numFilesCreatedLimit:nt(r.abridged_history_params?.num_files_created_limit,W.abridgedHistoryParams.numFilesCreatedLimit),numFilesDeletedLimit:nt(r.abridged_history_params?.num_files_deleted_limit,W.abridgedHistoryParams.numFilesDeletedLimit),numFilesViewedLimit:nt(r.abridged_history_params?.num_files_viewed_limit,W.abridgedHistoryParams.numFilesViewedLimit),numTerminalCommandsLimit:nt(r.abridged_history_params?.num_terminal_commands_limit,W.abridgedHistoryParams.numTerminalCommandsLimit)}};i.summaryNodeRequestMessageTemplate.includes("{summary}")||(console.error("summaryNodeRequestMessageTemplate must contain {summary}. Using default template"),i.summaryNodeRequestMessageTemplate=W.summaryNodeRequestMessageTemplate);const a={...i,prompt:i.prompt.slice(0,10)+"..."};return console.log("historySummaryParams updated: ",a),i}catch(r){return console.error("Failed to parse history_summary_params:",r),W}}(this._config.historySummaryParams)}historySummaryVersion=3;_callbacksManager=new id;_params;cancelRunningOrScheduledSummarizations(){this._callbacksManager.cancelAll()}generateAbridgedHistoryText(t){let e=this._conversationModel.chatHistory;if(t){const i=e.findIndex(a=>a.request_id===t);i>=0?e=e.slice(0,i):console.warn(`generateAbridgedHistoryText. Request id ${t} not found in history.`)}const n=function(i){const a=[];let l=null;for(const c of i){if(!U(c))continue;const d=c;if(Da(d)||(l&&(l.agentFinalResponse.trim()===""&&(l.wasInterrupted=!0),a.push(l)),l={userMessage:od(d),agentActionsSummary:{filesModified:new Set,filesCreated:new Set,filesDeleted:new Set,filesViewed:new Set,terminalCommands:new Set},agentFinalResponse:"",wasInterrupted:!1,continues:!1}),!l)continue;let h=!1;if(d.structured_output_nodes)for(const u of d.structured_output_nodes)u.type===j.TOOL_USE&&u.tool_use&&(h=!0,sd(u.tool_use,l.agentActionsSummary));!h&&d.response_text&&(l.agentFinalResponse=d.response_text)}l&&(l.agentFinalResponse.trim()===""&&(l.continues=!0),a.push(l));for(const c of a)nd(c.agentActionsSummary);return a}(e);let s=0;const r=[];for(let i=n.length-1;i>=0;i--){const a=rd(n[i],this._params.abridgedHistoryParams);if(s+a.length>this._params.abridgedHistoryParams.totalCharsLimit)break;r.push(a),s+=a.length}return r.reverse(),r.join(`
`)}clearStaleHistorySummaryNodes(t){const e=t.filter(n=>!_e(n)||n.summaryVersion===this.historySummaryVersion);return Sr(e,t)?t:e}maybeScheduleSummarization(t){if(!this._config.useHistorySummary||this._params.triggerOnHistorySizeCharsWhenCacheExpiring<=0)return;const e=this._params.cacheTTLMs-t-this._params.bufferTimeBeforeCacheExpirationMs;e>0&&this._callbacksManager.addCallback(n=>{this.maybeAddHistorySummaryNode(!0,n)},e)}preprocessChatHistory(t){let e=t.concat();const n=e.findLastIndex(s=>_e(s)&&s.summaryVersion===this.historySummaryVersion);return this._config.useHistorySummary?(n>0&&(console.info(`Using history summary node found at index ${n} with requestId: ${e[n].request_id}`),e=e.slice(n)),e=e.filter(s=>!_e(s)||s.summaryVersion===this.historySummaryVersion)):e=e.filter(s=>!_e(s)),Sr(e,t)?t:e}async maybeAddHistorySummaryNode(t=!1,e){if(console.log("maybeAddHistorySummaryNode. isCacheAboutToExpire: ",t),!this._params.prompt||this._params.prompt.trim()==="")return console.log("maybeAddHistorySummaryNode. empty prompt"),!1;const n=this._conversationModel.convertHistoryToExchanges(this._conversationModel.chatHistory),s=t?this._params.triggerOnHistorySizeCharsWhenCacheExpiring:this._params.triggerOnHistorySizeChars;if(console.log("maybeAddHistorySummaryNode. maxCharsThreshold: ",s),s<=0)return!1;const{head:r,tail:i,headSizeChars:a,tailSizeChars:l}=function(C,S,N,L){if(C.length===0)return{head:[],tail:[],headSizeChars:0,tailSizeChars:0};const D=[],F=[];let O=0,q=0,z=0;for(let G=C.length-1;G>=0;G--){const et=C[G],$=ga(et);O+$<S||F.length<L?(F.push(et),z+=$):(D.push(et),q+=$),O+=$}return O<N?(F.push(...D),{head:[],tail:F.reverse(),headSizeChars:0,tailSizeChars:O}):{head:D.reverse(),tail:F.reverse(),headSizeChars:q,tailSizeChars:z}}(n,this._params.historyTailSizeCharsToExclude,s,1);if(console.log("maybeAddHistorySummaryNode. headSizeChars: ",a," tailSizeChars: ",l),r.length===0)return console.log("maybeAddHistorySummaryNode. head is empty. nothing to summarize"),!1;const c=xs(n),d=xs(r),h=xs(i),u={totalHistoryCharCount:c,totalHistoryExchangeCount:n.length,headCharCount:d,headExchangeCount:r.length,headLastRequestId:r.at(-1)?.request_id??"",tailCharCount:h,tailExchangeCount:i.length,tailLastRequestId:i.at(-1)?.request_id??"",summaryCharCount:0,summarizationDurationMs:0,isCacheAboutToExpire:t,isAborted:!1};let f=r.at(-1)?.response_nodes??[],p=f.filter(C=>C.type===j.TOOL_USE);p.length>0&&(r.at(-1).response_nodes=f.filter(C=>C.type!==j.TOOL_USE)),console.info("Summarizing %d turns of conversation history.",r.length);const m=i[0]?.request_id,g=this.generateAbridgedHistoryText(m);console.info("Abridged history text size: %d characters.",g.length);const y=Date.now(),v=await this._conversationModel.sendSilentExchange({request_message:this._params.prompt,disableRetrieval:!0,disableSelectedCodeDetails:!0,chatHistory:r}),w=Date.now();if(console.info("Summary text size: %d characters.",v.responseText.length),u.summaryCharCount=v.responseText.length,u.summarizationDurationMs=w-y,u.isAborted=!!e?.aborted,this._extensionClient.reportAgentRequestEvent({eventName:Cs.chatHistorySummarization,conversationId:this._conversationModel.conversationId,requestId:v.requestId??"UNKNOWN_REQUEST_ID",chatHistoryLength:this._conversationModel.chatHistory.length,eventData:{chatHistorySummarizationData:u}}),e?.aborted)return console.log("maybeAddHistorySummaryNode. aborted"),!1;if(!v.requestId||v.responseText.trim()==="")return console.log("maybeAddHistorySummaryNode. no request id or empty response"),!1;let x=this._params.summaryNodeRequestMessageTemplate.replace("{summary}",`<summary>
${v.responseText}
</summary>`);x.includes("{abridged_history}")&&(x=x.replace("{abridged_history}",`<abridged_history>
${g}
</abridged_history>`));const _=this._params.summaryNodeResponseMessage,T={chatItemType:Zt.historySummary,summaryVersion:this.historySummaryVersion,request_id:v.requestId,request_message:x,response_text:_,structured_output_nodes:[{id:p.map(C=>C.id).reduce((C,S)=>Math.max(C,S),-1)+1,type:j.RAW_RESPONSE,content:_},...p],status:V.success,seen_state:Tt.seen,timestamp:new Date().toISOString()},E=this._conversationModel.chatHistory.findLastIndex(C=>C.request_id===r.at(-1).request_id)+1;return console.info("Adding a history summary node at index %d",E),this._conversationModel.insertChatItem(E,T),!0}}const Js="POP_ABORTED";class ld{constructor(t=void 0){this.maxQueueSize=t,this.queue=new gr,this.waiters=new gr}push(t){this.maxQueueSize&&this.queue.length>=this.maxQueueSize&&this.waiters.length===0&&this.queue.shift(),this.waiters.length>0?this.waiters.shift()(t):this.queue.push(t)}async pop(t){if(t?.aborted)throw new Error(Js);return this.queue.length>0?this.queue.shift():new Promise((e,n)=>{const s=()=>{const r=this.waiters.toArray().indexOf(e);r!==-1&&this.waiters.removeOne(r)};t?.addEventListener("abort",()=>{s(),n(new Error(Js))},{once:!0}),this.waiters.push(e)})}get size(){return this.queue.length}clear(){this.queue.clear()}}class $t{static _instance;static getInstance(){return $t._instance||($t._instance=new $t),$t._instance}_queues=new Map;_activeConsumers=new Map;_getQueueForType(t){const e=this._queues.get(t);if(e)return e;const n=new ld(500);return this._queues.set(t,n),n}addNotification(t){this._getQueueForType(t.type).push(t)}getStream(t){this._activeConsumers.has(t)&&(console.error(`Consumer already exists for type ${t}. Only one consumer per type is allowed at any given time. Cancelling previous consumer.`),this._activeConsumers.get(t)?.());const e=new AbortController,n=()=>{e.abort(),this._activeConsumers.delete(t)};return this._activeConsumers.set(t,n),{stream:(async function*(){try{const s=this._getQueueForType(t);for(;!e.signal.aborted;)try{const r=s.pop(e.signal),i=await r;if(e.signal.aborted)return;yield i}catch(r){if(r?.message!==Js)throw r}}catch(s){if(console.error("Error in stream for",t,s),!e.signal.aborted)throw s}finally{this._activeConsumers.delete(t)}}).call(this),cancel:n}}dispose(){this._activeConsumers.forEach(t=>t()),this._activeConsumers.clear(),this._queues.forEach(t=>t.clear()),this._queues.clear(),$t._instance=void 0}}const Go="New Chat",Xo="New Remote Agent";function cd(o){if(!o)return Go;if(o.name)return o.name.trim();const t=o.chatHistory?.find(U);if(t?.request_message){const e=t.request_message?.trim();return e?e.charAt(0).toUpperCase()+e.slice(1):""}return ve(o)?"New Agent":Go}function Vd(o){return o?o.title?o.title.trim():o.session_summary?o.session_summary.trim():Xo:Xo}const bs="temp-fe";class J{constructor(t,e,n,s,r,i,a){this._extensionClient=t,this._saveConversation=e,this._config=n,this._reduxStore=s,this._markExchangeDirty=r,this._markToolUseDirty=i,this._state={...J.create(void 0,{forceAgentConversation:a?.forceAgentConversation})},this._totalCharactersStore=this._createTotalCharactersStore(),this._chatHistorySummarizationModel=new ad(this,t,{historySummaryParams:this._config.historySummaryParams,useHistorySummary:this._config.useHistorySummary}),this._subscribeToConversationUpdates()}_state;_subscribers=new Set;_focusModel=new fl;_onTurnCompletedListeners=[];_onSendExchangeListeners=[];_onNewConversationListeners=[];_onHistoryDeleteListeners=[];_onBeforeChangeConversationListeners=[];_eventTracker;_totalCharactersCacheThrottleMs=1e3;_totalCharactersStore;_chatHistorySummarizationModel;_disposers=[];get conversationId(){return this._state.id}insertChatItem(t,e){const n=[...this._state.chatHistory];n.splice(t,0,e),this.update({chatHistory:n})}_subscribeToConversationUpdates=()=>{const t=$t.getInstance(),{stream:e,cancel:n}=t.getStream("conversation_updated"),{stream:s,cancel:r}=t.getStream("exchange_updated");this._disposers.push(()=>{n(),r()}),(async()=>{for await(const i of e)this._handleConversationUpdated(i)})(),(async()=>{for await(const i of s){const{exchange:a}=i.data;a.request_id&&(this._maybeAppendExchange(a),this.updateExchangeById(a,a.request_id))}})()};_handleConversationUpdated=t=>{if(t.data.conversationId!==this._state.id)return;const{exchanges:e}=t.data;e.forEach(this._maybeAppendExchange);const n=new Set(e.map(r=>r.request_id)),s=new Set;this._state.chatHistory.forEach(r=>{const i=r.request_id;i&&!n.has(i)&&s.add(i)}),e.forEach(r=>{r.request_id&&this.updateExchangeById(r,r.request_id)}),this._removeTurnsByRequestId(s)};_maybeAppendExchange=t=>{t.request_id&&(this.exchangeWithRequestId(t.request_id)||this.addExchange({...t,request_message:t.request_message??"",status:V.success}))};_createTotalCharactersStore(){return Kc(()=>{let t=0;const e=this._state.chatHistory;return this.convertHistoryToExchanges(e).forEach(n=>{t+=JSON.stringify(n).length}),this._state.draftExchange&&(t+=JSON.stringify(this._state.draftExchange).length),t},0,this._totalCharactersCacheThrottleMs)}setEventTracker(t){this._eventTracker=t}async decidePersonaType(){try{return((await this._extensionClient.getWorkspaceInfo()).trackedFileCount?.reduce((e,n)=>e+n,0)||0)<=4?Re.PROTOTYPER:Re.DEFAULT}catch(t){return console.error("Error determining persona type:",t),Re.DEFAULT}}static create(t={},e){const n=new Date().toISOString();return{id:t.id||crypto.randomUUID(),name:void 0,createdAtIso:n,lastInteractedAtIso:n,chatHistory:[],feedbackStates:{},toolUseStates:{},draftExchange:void 0,draftActiveContextIds:void 0,selectedModelId:void 0,requestIds:[],isPinned:!1,lastUrl:void 0,isShareable:!1,extraData:{isAgentConversation:!!e?.forceAgentConversation},personaType:Re.DEFAULT,...t}}static toSentenceCase(t){return t.charAt(0).toUpperCase()+t.slice(1)}static getDisplayName(t){return cd(t)}static isNew(t){return t.id===Se}static isEmptyExchanges(t){return!t.chatHistory.some(e=>U(e)||Ss(e))}static isEmpty(t){return J.isEmptyExchanges(t)&&!t.draftExchange?.request_message}static isNamed(t){return t.name!==void 0&&t.name!==""}static getTime(t,e){return e==="lastMessageTimestamp"?J.lastMessageTimestamp(t):e==="lastInteractedAt"?J.lastInteractedAt(t):J.createdAt(t)}static createdAt(t){return new Date(t.createdAtIso)}static lastInteractedAt(t){return new Date(t.lastInteractedAtIso)}static lastMessageTimestamp(t){const e=t.chatHistory.findLast(U)?.timestamp;return e?new Date(e):this.createdAt(t)}static isValid(t){return t.id!==void 0&&(!J.isEmpty(t)||J.isNamed(t))}subscribe=t=>(this._subscribers.add(t),t(this),()=>{this._subscribers.delete(t)});setConversation=(t,e=!0,n=!0)=>{const s=t.id!==this._state.id;s&&n&&(t.toolUseStates=Object.fromEntries(Object.entries(t.toolUseStates??{}).map(([i,a])=>{if(a.requestId&&a.toolUseId){const{requestId:l,toolUseId:c}=br(i);return l===a.requestId&&c===a.toolUseId||console.warn("Tool use state key does not match request and tool use IDs. Got key ",i,"but object has ",Jn(a)),[i,a]}return[i,{...a,...br(i)}]})),(t=this._notifyBeforeChangeConversation(this._state,t)).lastInteractedAtIso=new Date().toISOString()),e&&s&&this.isValid&&(this.saveDraftActiveContextIds(),this._unloadContextFromConversation(this._state),this._clearPinnedItemsOnAgentSwitch());const r=J.isEmpty(t);if(s&&r){const i=this._state.draftExchange;i&&(t.draftExchange=i)}return this._state=t,this._reduxStore.dispatch(za(t)),this._focusModel.setItems(this._state.chatHistory.filter(U)),this._focusModel.initFocusIdx(-1),this._subscribers.forEach(i=>i(this)),this._saveConversation(this._state),s&&(this._loadContextFromConversation(t),this.loadDraftActiveContextIds(),this._onNewConversationListeners.forEach(i=>i())),!0};onBeforeChangeConversation(t){return this._onBeforeChangeConversationListeners.push(t),()=>{this._onBeforeChangeConversationListeners=this._onBeforeChangeConversationListeners.filter(e=>e!==t)}}_notifyBeforeChangeConversation(t,e){let n=e;for(const s of this._onBeforeChangeConversationListeners){const r=s(t,n);r!==void 0&&(n=r)}return n}update=t=>{this.setConversation({...this._state,...t}),this._totalCharactersStore.updateStore()};get extraData(){return this._state.extraData}set extraData(t){this.update({extraData:t})}get focusModel(){return this._focusModel}get isValid(){return J.isValid(this._state)}get id(){return this._state.id}get name(){return this._state.name}get personaType(){return this._state.personaType??Re.DEFAULT}get rootTaskUuid(){return this._state.rootTaskUuid}set rootTaskUuid(t){this.update({rootTaskUuid:t})}get displayName(){return J.getDisplayName(this._state)}get createdAtIso(){return this._state.createdAtIso}get createdAt(){return J.createdAt(this._state)}get chatHistory(){return this._state.chatHistory}get feedbackStates(){return this._state.feedbackStates}get toolUseStates(){return this._state.toolUseStates}get draftExchange(){return this._state.draftExchange}get selectedModelId(){if(this._config.enableModelRegistry&&ve(this._state))return this._state.selectedModelId}get isPinned(){return!!this._state.isPinned}get extensionClient(){return this._extensionClient}toggleIsPinned=()=>{this.update({isPinned:!this.isPinned})};setName=t=>{this.update({name:t})};setSelectedModelId=t=>{this.update({selectedModelId:t})};updateFeedback=(t,e)=>{this.update({feedbackStates:{...this._state.feedbackStates,[t]:e}})};updateToolUseState=t=>{const e=Jn(t);this.update({toolUseStates:{...this._state.toolUseStates,[e]:t}}),this._markToolUseDirty?.(e)};getToolUseState=(t,e)=>t===void 0||e===void 0||this.toolUseStates===void 0?{phase:H.unknown,requestId:t??"",toolUseId:e??""}:this.toolUseStates[Jn({requestId:t,toolUseId:e})]||{phase:H.new};getLastToolUseId=()=>{const t=this.lastExchange;if(!t)return;const e=(t?.structured_output_nodes?.filter(n=>n.type===j.TOOL_USE)??[]).at(-1);return e?e.tool_use?.tool_use_id:void 0};getLastToolUseState=()=>{const t=this.lastExchange;if(!t)return{phase:H.unknown};const e=function(n=[]){let s;for(const r of n){if(r.type===j.TOOL_USE)return r;r.type===j.TOOL_USE_START&&(s=r)}return s}(t?.structured_output_nodes);return e?this.getToolUseState(t.request_id,e.tool_use?.tool_use_id):{phase:H.unknown}};addChatItem(t){this.addExchange(t)}addExchange=(t,e)=>{const n=this._state.chatHistory;let s,r;s=e===void 0?[...n,t]:e===-1?n.length===0?[t]:[...n.slice(0,-1),t,n[n.length-1]]:[...n.slice(0,e),t,...n.slice(e)],U(t)&&(r=t.request_id?{...this._state.feedbackStates,[t.request_id]:{selectedRating:La.unset,feedbackNote:""}}:void 0,this._markExchangeDirty&&t.request_id&&this._markExchangeDirty(t.request_id)),this.update({chatHistory:s,...r?{feedbackStates:r}:{},lastUrl:void 0})};addExchangeBeforeLast=t=>{this.addExchange(t,-1)};resetShareUrl=()=>{this.update({lastUrl:void 0})};updateExchangeById=(t,e,n=!1)=>{const s=this.exchangeWithRequestId(e);if(s===null)return console.warn(`No exchange with request ID '${e}' found.`),!1;if(n&&t.response_text!==void 0&&(t.response_text=(s.response_text??"")+(t.response_text??"")),n)t.structured_output_nodes=function(f=[]){const p=Yc(f);return p&&p.type===j.TOOL_USE?f.filter(m=>m.type!==j.TOOL_USE_START):f}([...s.structured_output_nodes??[],...t.structured_output_nodes??[]]);else if(r=s,i=t,Object.keys(i).every(f=>r[f]===i[f]))return!0;var r,i;t.stop_reason!==s.stop_reason&&s.stop_reason&&t.stop_reason===hl.REASON_UNSPECIFIED&&(t.stop_reason=s.stop_reason),n&&t.workspace_file_chunks!==void 0&&(t.workspace_file_chunks=[...s.workspace_file_chunks??[],...t.workspace_file_chunks??[]]);const a=(t.structured_output_nodes||[]).find(f=>f.type===j.MAIN_TEXT_FINISHED)?.content;a&&a!==t.response_text&&(t.response_text=a);const l=s,c={...s,...t},d=fr(l),h=fr(c);let u=this._state.isShareable||Me(c);if(this.update({chatHistory:this.chatHistory.map(f=>f.request_id===e?{...f,...t}:f),isShareable:u}),this._markExchangeDirty){const f=t.request_id||e;this._markExchangeDirty(f)}return!d&&h&&this._onTurnCompletedListeners.forEach(f=>f(c)),!0};_clearMetadataAndDirtyTracking=(t,e)=>{this._extensionClient.clearMetadataFor({requestIds:t,toolUseIds:e})};clearMessagesFromHistory=t=>{const e=this._collectToolUseIdsFromMessages(this.chatHistory.filter(n=>n.request_id&&t.has(n.request_id)));this.update({chatHistory:this.chatHistory.filter(n=>!n.request_id||!t.has(n.request_id))}),this._clearMetadataAndDirtyTracking(Array.from(t),e)};clearHistory=()=>{const t=this._collectToolUseIdsFromMessages(this.chatHistory);this._extensionClient.clearMetadataFor({requestIds:this.requestIds,toolUseIds:t}),this.update({chatHistory:[]})};clearHistoryFrom=async(t,e=!0)=>{const n=this.historyFrom(t,e),s=n.map(i=>i.request_id).filter(i=>i!==void 0),r=this._collectToolUseIdsFromMessages(n);this.update({chatHistory:this.historyTo(t,!e)}),this._clearMetadataAndDirtyTracking(s,r),n.forEach(i=>{this._onHistoryDeleteListeners.forEach(a=>a(i))})};clearMessageFromHistory=t=>{const e=this.chatHistory.find(s=>s.request_id===t),n=e?this._collectToolUseIdsFromMessages([e]):[];this.update({chatHistory:this.chatHistory.filter(s=>s.request_id!==t)}),this._clearMetadataAndDirtyTracking([t],n)};_collectToolUseIdsFromMessages=t=>{const e=[];for(const n of t)if(U(n)&&n.structured_output_nodes)for(const s of n.structured_output_nodes)s.type===j.TOOL_USE&&s.tool_use?.tool_use_id&&e.push(s.tool_use.tool_use_id);return e};historyTo=(t,e=!1)=>{const n=this.chatHistory.findIndex(s=>s.request_id===t);return n===-1?[]:this.chatHistory.slice(0,e?n+1:n)};historyFrom=(t,e=!0)=>{const n=this.chatHistory.findIndex(s=>s.request_id===t);return n===-1?[]:this.chatHistory.slice(e?n:n+1)};resendLastExchange=async()=>{const t=this.lastExchange;if(t&&!this.awaitingReply)return this.resendTurn(t)};resendTurn=t=>this.awaitingReply?Promise.resolve():(this._removeTurn(t),this.sendExchange({chatItemType:t.chatItemType,request_message:t.request_message,rich_text_json_repr:t.rich_text_json_repr,status:V.draft,mentioned_items:t.mentioned_items,structured_request_nodes:t.structured_request_nodes,disableSelectedCodeDetails:t.disableSelectedCodeDetails,chatHistory:t.chatHistory,model_id:t.model_id},!1,t.request_id));_removeTurn=t=>{this.update({chatHistory:this.chatHistory.filter(e=>e!==t&&(!t.request_id||e.request_id!==t.request_id))})};_removeTurnsByRequestId=t=>{this.update({chatHistory:this.chatHistory.filter(e=>!!e.request_id&&!t.has(e.request_id))})};exchangeWithRequestId=t=>this.chatHistory.find(e=>e.request_id===t)||null;get requestIds(){return this._state.chatHistory.map(t=>t.request_id).filter(t=>t!==void 0)}get hasDraft(){const t=(this.draftExchange?.request_message??"").trim()!=="",e=this.hasImagesInDraft();return t||e}hasImagesInDraft(){const t=this.draftExchange?.rich_text_json_repr;if(!t)return!1;const e=n=>Array.isArray(n)?n.some(e):!!n&&(n.type==="file"||!(!n.content||!Array.isArray(n.content))&&n.content.some(e));return e(t)}get canSendDraft(){return this.hasDraft&&!this.awaitingReply}get canCancelMessage(){return this.awaitingReply}get firstExchange(){return this.chatHistory.find(U)??null}get lastExchange(){return this.chatHistory.findLast(U)??null}get canClearHistory(){return this._state.chatHistory.length!==0&&!this.awaitingReply}get recoverableExchanges(){return this._state.chatHistory.filter(t=>U(t)&&t.status===V.sent)}get successfulMessages(){return this._state.chatHistory.filter(t=>Me(t)||He(t)||_e(t))}resetTotalCharactersCache=()=>{this._totalCharactersStore.resetCache()};get totalCharactersStore(){return this._totalCharactersStore}convertHistoryToExchanges(t){if(t.length===0)return[];t=this._chatHistorySummarizationModel.preprocessChatHistory(t);const e=[];for(const n of t)if(Me(n))e.push(Qo(n));else if(_e(n))e.push(Qo(n));else if(He(n)&&n.fromTimestamp!==void 0&&n.toTimestamp!==void 0&&n.revertTarget){const s=dd(n,1),r={request_message:"",response_text:"",request_id:n.request_id||crypto.randomUUID(),request_nodes:[s],response_nodes:[]};e.push(r)}return e}get awaitingReply(){return this.lastExchange!==null&&this.lastExchange.status===V.sent}get lastInteractedAtIso(){return this._state.lastInteractedAtIso}markSeen=async t=>{t.request_id&&this.updateExchangeById({seen_state:t.seen_state||Tt.unseen},t.request_id,!1)};createStructuredRequestNodes=t=>this._jsonToStructuredRequest(t);saveDraftMentions=t=>{if(!this.draftExchange)return;const e=t.filter(i=>!i.personality&&!i.task),n=this._reduxStore.getState(),s=jn.select(n),r=e.map(i=>{const a=s.find(l=>l.id===i.id);return a?{...i,pinned:Va.select(n,a.id),referenceCount:Ha.select(n,a.id),status:Ba.select(n,a.id)}:{...i,pinned:void 0,referenceCount:void 0,status:void 0}});this.update({draftExchange:{...this.draftExchange,mentioned_items:r}})};get draftActiveContextIds(){return this._state.draftActiveContextIds}saveDraftActiveContextIds=()=>{const t=Ua.select(this._reduxStore.getState()).map(e=>e.id);this.update({draftActiveContextIds:t})};loadDraftActiveContextIds=()=>{const t=new Set(this.draftActiveContextIds??[]),e=this._reduxStore.getState(),n=jn.select(e).filter(r=>t.has(r.id)||yr(r)||vr(r)||wr(r)).map(({id:r})=>r),s=jn.select(e).filter(r=>!(t.has(r.id)||yr(r)||vr(r)||wr(r))).map(({id:r})=>r);this._reduxStore.dispatch(xr(n)),this._reduxStore.dispatch(ja(s))};saveDraftExchange=(t,e)=>{const n=t!==this.draftExchange?.request_message,s=e!==this.draftExchange?.rich_text_json_repr;if(!n&&!s)return;const r=this.draftExchange?.mentioned_items;this.update({draftExchange:{request_message:t,rich_text_json_repr:e,mentioned_items:r,status:V.draft}})};clearDraftExchange=()=>{const t=this.draftExchange;return this.update({draftExchange:void 0}),t};sendDraftExchange=()=>{if(this._extensionClient.triggerUsedChatMetric(),!this.canSendDraft||!this.draftExchange)return!1;const t=this.clearDraftExchange();if(!t)return!1;const e=this._config.enableChatMultimodal&&t.rich_text_json_repr?this._jsonToStructuredRequest(t.rich_text_json_repr):void 0;return this.sendExchange({...t,structured_request_nodes:e,model_id:this.selectedModelId??void 0}).then(()=>{if(!ve(this)){const n=!this.name&&this.chatHistory.length===1&&this.firstExchange?.request_id===this.chatHistory[0].request_id;this._config.summaryTitles&&n&&this.updateConversationTitle()}}).finally(()=>{ve(this)&&this._extensionClient.reportAgentRequestEvent({eventName:Cs.sentUserMessage,conversationId:this.id,requestId:this.lastExchange?.request_id??"UNKNOWN_REQUEST_ID",chatHistoryLength:this.chatHistory.length})}),this.focusModel.setFocusIdx(void 0),!0};cancelMessage=async()=>{const t=this.lastExchange;t?.request_id&&(this.updateExchangeById({status:V.cancelled},t.request_id),await this._extensionClient.cancelChatStream(t.request_id))};sendInstructionExchange=async(t,e)=>{let n=`${bs}-${crypto.randomUUID()}`;const s={status:V.sent,request_id:n,request_message:t,model_id:this.selectedModelId??void 0,structured_output_nodes:[],seen_state:Tt.unseen,timestamp:new Date().toISOString()};this.addExchange(s);for await(const r of this._extensionClient.sendInstructionMessage(s,e)){if(!this.updateExchangeById(r,n,!0))return;n=r.request_id||n}};updateConversationTitle=async()=>{const{responseText:t}=await this.sendSummaryExchange();this.update({name:t})};checkAndGenerateAgentTitle=()=>{if(!(!ve(this)||!this._config.summaryTitles||this.name)){var t;!this.name&&(t=this.chatHistory,t.filter(e=>js(e))).length===1&&!this.extraData?.hasTitleGenerated&&(this.update({extraData:{...this.extraData,hasTitleGenerated:!0}}),this.updateConversationTitle())}};sendSummaryExchange=()=>{const t={status:V.sent,request_message:"Please provide a clear and concise summary of our conversation so far. The summary must be less than 6 words long. The summary must contain the key points of the conversation. The summary must be in the form of a title which will represent the conversation. The response should not include any additional formatting such as wrapping the response with quotation marks.",model_id:this.selectedModelId??void 0,chatItemType:Zt.summaryTitle,disableRetrieval:!0,disableSelectedCodeDetails:!0};return this.sendSilentExchange(t)};generateCommitMessage=async()=>{let t=`${bs}-${crypto.randomUUID()}`;const e={status:V.sent,request_id:t,request_message:"Please generate a commit message based on the diff of my staged and unstaged changes.",model_id:this.selectedModelId??void 0,mentioned_items:[],seen_state:Tt.unseen,chatItemType:Zt.generateCommitMessage,disableSelectedCodeDetails:!0,chatHistory:[],timestamp:new Date().toISOString()};this.addExchange(e);for await(const n of this._extensionClient.generateCommitMessage()){if(!this.updateExchangeById(n,t,!0))return;t=n.request_id||t}};sendExchange=async(t,e=!1,n)=>{this._chatHistorySummarizationModel.cancelRunningOrScheduledSummarizations(),this.updateLastInteraction();let s=`${bs}-${crypto.randomUUID()}`,r=t.model_id;if(r=r&&(Object.values(this._config.modelDisplayNameToId).includes(r)||Object.values(this._config.modelRegistry).includes(r??"")||Object.keys(this._config.modelInfoRegistry).includes(r??""))?t.model_id:void 0,J.isNew(this._state)){const h=crypto.randomUUID(),u=this._state.id;try{await this._extensionClient.migrateConversationId(u,h)}catch(f){console.error("Failed to migrate conversation checkpoints:",f)}this._state={...this._state,id:h},this._saveConversation(this._state,!0),this._extensionClient.setCurrentConversation(h),this._subscribers.forEach(f=>f(this))}t=Yo(t);let i={status:V.sent,request_id:s,request_message:t.request_message,rich_text_json_repr:t.rich_text_json_repr,model_id:r,mentioned_items:t.mentioned_items,structured_output_nodes:t.structured_output_nodes,seen_state:Tt.unseen,chatItemType:t.chatItemType,disableSelectedCodeDetails:t.disableSelectedCodeDetails,chatHistory:t.chatHistory,structured_request_nodes:t.structured_request_nodes,timestamp:new Date().toISOString()};this.addExchange(i),this._loadContextFromExchange(i),this._onSendExchangeListeners.forEach(h=>h(i)),this._config.useHistorySummary&&!t.request_message&&await this._chatHistorySummarizationModel.maybeAddHistorySummaryNode()&&this.update({chatHistory:this._chatHistorySummarizationModel.clearStaleHistorySummaryNodes(this.chatHistory)}),i=await this._addIdeStateNode(i),this.updateExchangeById({structured_request_nodes:i.structured_request_nodes},s,!1);const a=Date.now();let l=!1,c=0;for await(const h of this.sendUserMessage(s,i,e,n)){if(this.exchangeWithRequestId(s)?.status!==V.sent||!this.updateExchangeById(h,s,!0))return;if(s=h.request_id||s,!l&&ve(this)){const u=Date.now();c=u-a,this._extensionClient.reportAgentRequestEvent({eventName:Cs.firstTokenReceived,conversationId:this.id,requestId:s,chatHistoryLength:this.chatHistory.length,eventData:{firstTokenTimingData:{userMessageSentTimestampMs:a,firstTokenReceivedTimestampMs:u,timeToFirstTokenMs:c}}}),l=!0}}const d=Date.now()-a;this._eventTracker?.trackEvent(Wa.MESSAGE_SEND_TIMING,{requestId:s,timeToFirstTokenMs:c,timeToLastTokenMs:d,responseLength:t?.response_text?.length,chatHistoryLength:this.chatHistory.length,modelId:i.model_id}),this._chatHistorySummarizationModel.maybeScheduleSummarization(d)};sendSuggestedQuestion=t=>{this.focusModel.setFocusIdx(void 0),this.sendExchange({request_message:t,status:V.draft}),this._extensionClient.triggerUsedChatMetric(),this._extensionClient.reportWebviewClientEvent(Ta.chatUseSuggestedQuestion)};sendExchangeWithScroll=t=>(this.focusModel.setFocusIdx(void 0),this.sendExchange(t));recoverAllExchanges=async()=>{await Promise.all(this.recoverableExchanges.map(this.recoverExchange))};recoverExchange=async t=>{if(!t.request_id||t.status!==V.sent)return;let e=t.request_id;const n=t.structured_output_nodes?.filter(s=>s.type===j.AGENT_MEMORY);this.updateExchangeById({...t,response_text:t.lastChunkId?t.response_text:"",structured_output_nodes:t.lastChunkId?t.structured_output_nodes??[]:n},e);for await(const s of this.getChatStream(t)){if(!this.updateExchangeById(s,e,!0))return;e=s.request_id||e}};async sendSilentExchange(t){const e=crypto.randomUUID();let n,s="";const r=await this._addIdeStateNode(Yo({...t,request_id:e,status:V.sent,timestamp:new Date().toISOString()}));for await(const i of this.sendUserMessage(e,r,!0))i.response_text&&(s+=i.response_text),i.request_id&&(n=i.request_id);return{responseText:s,requestId:n}}async*getChatStream(t){t.request_id&&(yield*this._extensionClient.getExistingChatStream(t.request_id,t.lastChunkId,{enablePreferenceCollection:this._config.enablePreferenceCollection}))}_resolveUnresolvedToolUses(t,e,n){if(t.length===0)return[t,e];const s=t[t.length-1],r=s.response_nodes?.filter(d=>d.type===j.TOOL_USE)??[];if(r.length===0)return[t,e];const i=new Set;e.structured_request_nodes?.forEach(d=>{d.type===X.TOOL_RESULT&&d.tool_result_node?.tool_use_id&&i.add(d.tool_result_node.tool_use_id)});const a=r.filter(d=>{const h=d.tool_use?.tool_use_id;return h&&!i.has(h)});if(a.length===0)return[t,e];const l=a.map((d,h)=>{const u=d.tool_use.tool_use_id;return function(f,p,m,g){const y=Qc(p,f,g);let v;if(y!==void 0)v=y;else{let w;switch(p.phase){case H.runnable:w="Tool was cancelled before running.";break;case H.new:w="Cancelled by user.";break;case H.checkingSafety:w="Tool was cancelled during safety check.";break;case H.running:w="Tool was cancelled while running.";break;case H.cancelling:w="Tool cancellation was interrupted.";break;case H.cancelled:w="Cancelled by user.";break;case H.error:w="Tool execution failed.";break;case H.completed:w="Tool completed but result was unavailable.";break;case H.unknown:default:w="Cancelled by user.",p.phase!==H.unknown&&console.error(`Unexpected tool state phase: ${p.phase}`)}v={tool_use_id:f,content:w,is_error:!0}}return{id:m,type:X.TOOL_RESULT,tool_result_node:v}}(u,this.getToolUseState(s.request_id,u),Ks(e.structured_request_nodes??[])+h+1,this._config.enableDebugFeatures)});if(e.structured_request_nodes?.some(d=>d.type===X.TOOL_RESULT))return[t,{...e,structured_request_nodes:[...e.structured_request_nodes??[],...l]}];{const d={request_message:"",response_text:"OK.",request_id:crypto.randomUUID(),structured_request_nodes:l,structured_output_nodes:[],status:V.success,hidden:!0};return n||this.addExchangeBeforeLast(d),[t.concat(this.convertHistoryToExchanges([d])),e]}}async*sendUserMessage(t,e,n,s){const r=await((i,a,l)=>{const c=ws.get(i)??Gc();return ws.has(i)||ws.set(i,c),c.start(a,l)})("sendMessage",t);try{for await(const i of this._sendUserMessage(t,e,n,s))yield i}finally{r.end(t)}}async*_sendUserMessage(t,e,n,s){const r=this._reduxStore.getState(),i=Ja.select(r);let a;if(e.chatHistory!==void 0)a=e.chatHistory;else{let u=this.successfulMessages;if(e.chatItemType===Zt.summaryTitle){const f=u.findIndex(p=>p.chatItemType!==Zt.agentOnboarding&&js(p));f!==-1&&(u=u.slice(f))}a=this.convertHistoryToExchanges(u)}[a,e]=this._resolveUnresolvedToolUses(a,e,n);let l=this.personaType;if(e.structured_request_nodes){const u=e.structured_request_nodes.find(f=>f.type===X.CHANGE_PERSONALITY);u&&u.change_personality_node&&(l=u.change_personality_node.personality_type)}let c=[];if(this._config.enableRules&&this._reduxStore){this._reduxStore.dispatch(Ka());const u=Ga.select(this._reduxStore.getState());c=dr.filterRulesByContext(u,i.ruleFiles||[])}const d={text:e.request_message,chatHistory:a,silent:n,modelId:e.model_id,context:i,userSpecifiedFiles:i.userSpecifiedFiles,externalSourceIds:i.externalSources?.map(u=>u.id),disableRetrieval:e.disableRetrieval??!1,disableSelectedCodeDetails:e.disableSelectedCodeDetails??!1,nodes:e.structured_request_nodes,memoriesInfo:e.memoriesInfo,personaType:l,conversationId:this.id,createdTimestamp:Date.now(),requestIdOverride:s,rules:c},h=this._extensionClient.startChatStreamWithRetry(t,d,{enablePreferenceCollection:this._config.enablePreferenceCollection});for await(const u of h)t=u.request_id||t,yield u;this.updateExchangeById({structured_request_nodes:e.structured_request_nodes},t)}_loadContextFromConversation=t=>{t.chatHistory.forEach(e=>{U(e)&&this._loadContextFromExchange(e)})};_loadContextFromExchange=t=>{t.mentioned_items&&(this._reduxStore.dispatch(Xa(t.mentioned_items)),this._reduxStore.dispatch(xr(t.mentioned_items.map(({id:e})=>e))))};_unloadContextFromConversation=t=>{t.chatHistory.forEach(e=>{U(e)&&this._unloadContextFromExchange(e)})};_unloadContextFromExchange=t=>{if(!t.mentioned_items)return;const e=t.mentioned_items.filter(n=>!n.pinned);e.length>0&&this._reduxStore.dispatch(Qa(e.map(({id:n})=>n)))};_clearPinnedItemsOnAgentSwitch=()=>{this._reduxStore.dispatch(Ya())};onSendExchange(t){return this._onSendExchangeListeners.push(t),()=>{this._onSendExchangeListeners=this._onSendExchangeListeners.filter(e=>e!==t)}}onTurnCompleted(t){return this._onTurnCompletedListeners.push(t),()=>{this._onTurnCompletedListeners=this._onTurnCompletedListeners.filter(e=>e!==t)}}onNewConversation(t){return this._onNewConversationListeners.push(t),()=>{this._onNewConversationListeners=this._onNewConversationListeners.filter(e=>e!==t)}}onHistoryDelete(t){return this._onHistoryDeleteListeners.push(t),()=>{this._onHistoryDeleteListeners=this._onHistoryDeleteListeners.filter(e=>e!==t)}}updateChatItem(t,e){let n=!1;const s=this.chatHistory.map(r=>r.request_id!==t||n?r:(n=!0,{...r,...e}));return n&&this._markExchangeDirty&&this._markExchangeDirty(t),this.update({chatHistory:s}),n}updateLastInteraction=()=>{this.update({lastInteractedAtIso:new Date().toISOString()})};_checkPreviousMessageForAskMode(){const t=this.chatHistory.filter(n=>U(n)&&n.request_message).at(-1);if(!t||!U(t))return!1;const e=t.structured_request_nodes;return!!e?.length&&e.some(n=>n.type===X.TEXT&&n.text_node?.content?.startsWith(be))}_jsonToStructuredRequest=t=>{const e=[];let n=!1;const s=this._checkPreviousMessageForAskMode(),r=a=>{const l=e.at(-1);if(l?.type===X.TEXT){const c=l.text_node?.content??"",d={...l,text_node:{content:c+a}};e[e.length-1]=d}else e.push({id:e.length,type:X.TEXT,text_node:{content:a}})},i=a=>{if(a.type==="doc"||a.type==="paragraph")for(const l of a.content??[])i(l);else if(a.type==="hardBreak")r(`
`);else if(a.type==="text")r(a.text??"");else if(a.type==="file"){if(typeof a.attrs?.src!="string")return void console.error("File source is not a string: ",a.attrs?.src);if(a.attrs.isLoading)return;const l=a.attrs?.title,c=Na(l);ei(l)?e.push({id:e.length,type:X.IMAGE_ID,image_id_node:{image_id:a.attrs.src,format:c}}):e.push({id:e.length,type:X.FILE_ID,file_id_node:{file_id:a.attrs.src,file_name:l}})}else if(a.type==="mention"){const l=a.attrs?.data;l&&Za(l)?e.push({id:e.length,type:X.TEXT,text_node:{content:tl(this._config.customPersonalityPrompts,l.personality.type)}}):l&&el(l)?e.push({id:e.length,type:X.TEXT,text_node:{content:nl.getTaskOrchestratorPrompt(l.task)}}):r(`@\`${l?.name??l?.id}\``)}else if(a.type==="askMode"){n=!0;const l=a.attrs?.prompt;l&&e.push({id:e.length,type:X.TEXT,text_node:{content:l}})}};if(i(t),!n&&s&&e.length>0){const[a]=e;if(!(a?.text_node?.content||"").startsWith(Uo)){e.unshift({id:0,type:X.TEXT,text_node:{content:Uo}});for(let l=1;l<e.length;l++)e[l].id=l}}return e};async _addIdeStateNode(t){let e,n=(t.structured_request_nodes??[]).filter(s=>s.type!==X.IDE_STATE);try{e=await this._extensionClient.getChatRequestIdeState()}catch(s){console.error("Failed to add IDE state to exchange:",s)}return e?(n=[...n,{id:Ks(n)+1,type:X.IDE_STATE,ide_state_node:e}],{...t,structured_request_nodes:n}):t}dispose=()=>{this._disposers.forEach(t=>t()),this._disposers=[]}}function dd(o,t){const e=(He(o),o.fromTimestamp),n=(He(o),o.toTimestamp),s=He(o)&&o.revertTarget!==void 0;return{id:t,type:X.CHECKPOINT_REF,checkpoint_ref_node:{request_id:o.request_id||"",from_timestamp:e,to_timestamp:n,source:s?Aa.CHECKPOINT_REVERT:void 0}}}function Qo(o){const t=(o.structured_output_nodes??[]).filter(e=>e.type===j.RAW_RESPONSE||e.type===j.TOOL_USE||e.type===j.TOOL_USE_START||e.type===j.THINKING).map(e=>e.type===j.TOOL_USE_START?{...e,tool_use:{...e.tool_use,input_json:"{}"},type:j.TOOL_USE}:e);return{request_message:o.request_message,response_text:o.response_text??"",request_id:o.request_id||"",request_nodes:o.structured_request_nodes??[],response_nodes:t}}function Ks(o){return o.length>0?Math.max(...o.map(t=>t.id)):0}function Yo(o){if(o.request_message.length>0&&!o.structured_request_nodes?.some(t=>t.type===X.TEXT)){let t=o.structured_request_nodes??[];return t=[...t,{id:Ks(t)+1,type:X.TEXT,text_node:{content:o.request_message}}],{...o,structured_request_nodes:t}}return o}var mn=(o=>(o.send="send",o.addTask="addTask",o))(mn||{});const hd={id:"send",label:"Send to Agent",lucideIcon:"send-horizontal",description:"Send message to agent"},ud={id:"addTask",label:"Add Task",lucideIcon:"plus",description:"Add task with the message content"},Ud=[hd,ud];class pd{_mode=Yt(mn.send);_currentMode=mn.send;constructor(){this._mode.subscribe(t=>{this._currentMode=t})}get mode(){return this._mode}setMode(t){this._mode.set(t)}getCurrentMode(){return this._currentMode}initializeFromState(t){t&&Object.values(mn).includes(t)&&this._mode.set(t)}}class Ze{_dirtyItems=new Set;markDirty=t=>{this._dirtyItems.add(t)};markClean=t=>{this._dirtyItems.delete(t)};isDirty=t=>this._dirtyItems.has(t);getDirtyItems=t=>{const e=Array.from(this._dirtyItems);return t?e.slice(0,t):e};cleanup=t=>{const e=Array.isArray(t)?t:Array.from(t);for(const n of e)this._dirtyItems.delete(n)};clear=()=>{this._dirtyItems.clear()};getAllDirtyItems=()=>Array.from(this._dirtyItems);getStats=()=>({dirtyCount:this._dirtyItems.size})}class fd{constructor(t,e,n=new Ze){this.historyController=t,this.toolStateController=e,this.dirtyCache=n}async dehydrateState(t){const{inMemory:e,beforeDehydration:n}=t;try{const s=await this.historyController.dehydrateState({inMemory:{id:e.id,chatHistory:e.chatHistory},beforeDehydration:{id:n.id,chatHistory:n.chatHistory}}),r={...n,chatHistory:s.afterDehydration.chatHistory},i=await this.toolStateController.dehydrateState({inMemory:{id:e.id,toolUseStates:e.toolUseStates},beforeDehydration:{id:r.id,toolUseStates:r.toolUseStates}});return{inMemory:e,afterDehydration:{...r,toolUseStates:i.afterDehydration.toolUseStates}}}catch(s){return console.error("Failed to dehydrate conversation:",s instanceof Error?s.message:String(s)),{inMemory:e,afterDehydration:n}}}async hydrateState(t){return await Promise.all([this.historyController.hydrateState(t),this.toolStateController.hydrateState(t)]),t}get dirty(){return this.dirtyCache}}class md{constructor(t,e){this.extensionClient=t,this._config=e}exchangeDirtyCache=new Ze;historyDirtyCache=new Ze;get dirty(){return this.exchangeDirtyCache}get historyDirty(){return this.historyDirtyCache}exchangeToStoredExchange(t,e){const n=t.request_id||(crypto?.randomUUID?.()??`fallback-${Date.now()}`);return{uuid:n,conversationId:e,request_message:t.request_message,response_text:t.response_text||"",request_id:n,request_nodes:t.structured_request_nodes,response_nodes:t.structured_output_nodes,rich_text_json_repr:t.rich_text_json_repr,mentioned_items:t.mentioned_items,model_id:t.model_id,chat_item_type:t.chatItemType,questions:t.questions,status:t.status===V.success?"success":t.status===V.failed?"failed":"sent",timestamp:t.timestamp||new Date().toISOString(),seen_state:t.seen_state===Tt.seen?"seen":"unseen"}}exchangeToPointer(t){const e=t.request_id||(crypto?.randomUUID?.()??`fallback-${Date.now()}`);return{chatItemType:Zt.exchangePointer,exchangeUuid:e,timestamp:t.timestamp,request_message:t.request_message,status:t.status,seen_state:t.seen_state}}storedExchangeToExchange(t){const e={request_message:t.request_message,response_text:t.response_text,request_id:t.request_id,structured_request_nodes:t.request_nodes,structured_output_nodes:t.response_nodes,rich_text_json_repr:t.rich_text_json_repr,mentioned_items:t.mentioned_items,model_id:t.model_id,chatItemType:t.chat_item_type,timestamp:t.timestamp,status:t.status==="success"?V.success:t.status==="failed"?V.failed:V.sent,seen_state:t.seen_state==="seen"?Tt.seen:Tt.unseen};return t.questions&&(e.questions=t.questions,e.questionsLoaded=!0),e}async dehydrateState(t){const{inMemory:e,beforeDehydration:n}=t;try{if(!this._config.enableExchangeStorage&&!this._config.enableEnhancedDehydrationMode)return{inMemory:e,afterDehydration:n};const s=!(Array.isArray(e.chatHistory)&&e.chatHistory.some(l=>!Ss(l))),r=e.chatHistory.filter(l=>!!(U(l)&&l.request_id&&this.exchangeDirtyCache.isDirty(l.request_id))),i=!s&&(this.historyDirty.isDirty(e.id)||r.length>0);let a={...n};if(this._config.enableExchangeStorage){if(i&&r.length>0){const l=r.map(c=>this.exchangeToStoredExchange(c,e.id));await this.extensionClient.saveExchanges(e.id,l),r.forEach(c=>{this.exchangeDirtyCache.markClean(c.request_id)})}a={...a,chatHistory:e.chatHistory.map(l=>U(l)?this.exchangeToPointer(l):l)}}return this._config.enableEnhancedDehydrationMode&&(this._config.enableExchangeStorage||(a={...a,chatHistory:e.chatHistory}),i&&await this.extensionClient.saveConversationHistory(e.id,a.chatHistory),a={...a,chatHistory:[]}),this.historyDirty.markClean(e.id),{inMemory:e,afterDehydration:a}}catch(s){return console.error("Failed to dehydrate chat history:",s instanceof Error?s.message:String(s)),{inMemory:e,afterDehydration:n}}}async hydrateState(t){let e=[];e=t.chatHistory&&t.chatHistory.length>0?t.chatHistory:await this.extensionClient.loadConversationHistory(t.id);const n=[];e.forEach((r,i)=>{Ss(r)&&n.push({uuid:r.exchangeUuid,index:i})});let s=new Map;if(n.length>0){const r=n.map(a=>a.uuid),i=await this.extensionClient.loadExchanges(t.id,r);s=new Map(i.map(a=>[a.uuid,a]))}for(const{uuid:r,index:i}of n){const a=s.get(r);a&&(e[i]=this.storedExchangeToExchange(a))}return t.chatHistory=e,{...t,chatHistory:e}}}class gd{constructor(t,e){this.extensionClient=t,this._config=e}_dirtyCache=new Ze;get dirty(){return this._dirtyCache}async dehydrateState(t){const{inMemory:e,beforeDehydration:n}=t;try{if(!this._config.enableToolUseStateStorage)return{inMemory:e,afterDehydration:n};const s=Object.keys(e.toolUseStates||{}),r=new Set(s.filter(a=>this._dirtyCache.isDirty(a)));if(r.size===0)return{inMemory:e,afterDehydration:{...n,toolUseStates:{}}};const i=Object.fromEntries(Object.entries(e.toolUseStates||{}).filter(([a])=>r.has(a)));return await this.extensionClient.saveToolUseStates(e.id,i),r.forEach(a=>this._dirtyCache.markClean(a)),{inMemory:e,afterDehydration:{...n,toolUseStates:{}}}}catch(s){return console.error("Failed to dehydrate tool use states:",s instanceof Error?s.message:String(s)),{inMemory:e,afterDehydration:n}}}async hydrateState(t){try{const e=await this.extensionClient.loadConversationToolUseStates(t.id);t.toolUseStates={...t.toolUseStates,...e}}catch(e){console.error("Failed to hydrate tool use states:",e)}return t}}class yd{constructor(t,e,n,s,r=5){this.host=t,this.conversationController=e,this.historyController=n,this.toolStateController=s,this.maxConversationsPerIteration=r}getState(){const t=this.host.getState();if(t)for(const e of Object.values(t.conversations))this.markDirtyDeep(e);return t}markDirtyDeep(t){const e=this.conversationController;if(t.chatHistory.length>0||Object.keys(t.toolUseStates||{}).length>0){e.dirty.markDirty(t.id),t.chatHistory.length>0&&this.historyController.historyDirty.markDirty(t.id);for(const n of t.chatHistory)U(n)&&n.request_id&&this.historyController.dirty.markDirty(n.request_id);for(const n of Object.keys(t.toolUseStates||{}))this.toolStateController.dirty.markDirty(n)}}async setState(t){const e=await this.dehydrateState({inMemory:t,beforeDehydration:t});return this.host.setState(e.afterDehydration),e.inMemory}async dehydrateState(t){const{inMemory:e,beforeDehydration:n}=t,s=Object.entries(e.conversations),r=this.selectConversationsForDehydration(s,void 0,this.maxConversationsPerIteration),i={...n,conversations:{...n.conversations}};for(const[a,l]of s)try{const c=await this.conversationController.dehydrateState({inMemory:l,beforeDehydration:i.conversations[a]??l});r.includes(a)&&this.conversationController.dirty.markClean(a),i.conversations[a]=c.afterDehydration}catch(c){console.error("Failed to dehydrate conversation:",c),i.conversations[a]=n.conversations[a]??l}return{inMemory:e,afterDehydration:i}}async hydrateState(t,e){if(!e?.targetIds||e.targetIds.length===0)return t;for(const n of e.targetIds){const s=t.conversations[n];s&&await this.conversationController.hydrateState(s)}return t}selectConversationsForDehydration(t,e,n){const s=n??this.maxConversationsPerIteration,r=[],i=[];for(const[a]of t){if(r.length+i.length>=s)break;this.conversationController.dirty.isDirty(a)&&(a===e?r.unshift(a):i.push(a))}return[...r,...i]}get conversationPersistenceController(){return this.conversationController}}class vd{static create(t,e,n){const s=new md(t,{enableExchangeStorage:e.enableExchangeStorage,enableEnhancedDehydrationMode:e.enableEnhancedDehydrationMode}),r=new gd(t,{enableToolUseStateStorage:e.enableToolUseStateStorage}),i=new fd(s,r,new Ze);return new yd(n,i,s,r)}}class wd{constructor(t,e){this.chatController=t,this._debouncedSetState=Ea(async n=>{try{await this.chatController.setState(n)}catch(s){Xs()?.warn("Debounced setState failed:",s)}},e?.wait??5e3,{maxWait:e?.maxWait??3e4})}_debouncedSetState;get historyController(){return this.chatController.historyController}get toolStateController(){return this.chatController.toolStateController}getState(){return this.chatController.getState()}async setState(t,e){const n=this._mergePartialState(t,e?.currentConversationId);return e?.immediate?(this._debouncedSetState(n),this._debouncedSetState.flush(),n):(this._debouncedSetState(n),n)}async loadConversation(t,e){return await this.chatController.hydrateState(t,{targetIds:[e.conversationId]})}get dirty(){return{exchanges:this.historyController.dirty,toolUses:this.toolStateController.dirty,conversations:this.chatController.conversationController.dirty}}_mergePartialState(t,e){return{agentExecutionMode:ya.manual,isPanelCollapsed:!1,displayedAnnouncements:[],...t,conversations:t.conversations??{},...e!==void 0&&{currentConversationId:e}}}}function Zo(o){o>=0&&Gs("num_conversations",o)}function xd(o){o>0&&Gs("conversation_exchange_count",o)}function jd(){Gs("chat_input_completion_requested",1)}const bd=ni(o=>o.chatLayout.displayedAnnouncements);ni((o,t)=>o.chatLayout.displayedAnnouncements.includes(t));const un=Yt("idle");var ya=(o=>(o.manual="manual",o.auto="auto",o))(ya||{});const Sd={enableToolUseStateStorage:!1,enableRules:!1,enablePersonalities:!1,enableExternalSourcesInChat:!1,retryChatStreamTimeouts:!1,enableChatMultimodal:!1,summaryTitles:!1,enableModelRegistry:!1,useHistorySummary:!1,historySummaryParams:"",enableExchangeStorage:!1,enableEnhancedDehydrationMode:!1,modelDisplayNameToId:{},modelRegistry:{},modelInfoRegistry:{},enableDebugFeatures:!1,enablePreferenceCollection:!1};class _d{constructor(t,e,n,s){this._asyncMsgSender=t,this._host=e,this._reduxStore=n;const r=(a=>({...Sd,...a}))(s);this.options=r,this.extensionClient=new sl(this._host,this._asyncMsgSender,{enableRules:r.enableRules,enablePersonalities:r.enablePersonalities,enableExternalSourcesInChat:r.enableExternalSourcesInChat,retryChatStreamTimeouts:r.retryChatStreamTimeouts}),this._currConversationModel=new J(this.extensionClient,this.saveConversation,{enableChatMultimodal:r.enableChatMultimodal,summaryTitles:r.enableChatMultimodal,enableModelRegistry:r.enableModelRegistry,useHistorySummary:r.useHistorySummary,historySummaryParams:r.historySummaryParams,enableRules:r.enableRules,modelDisplayNameToId:r.modelDisplayNameToId,modelRegistry:r.modelRegistry,modelInfoRegistry:r.modelInfoRegistry,enableDebugFeatures:r.enableDebugFeatures,customPersonalityPrompts:r.customPersonalityPrompts||{},enablePreferenceCollection:r.enablePreferenceCollection},n,this.markExchangeDirty,this.markToolUseDirty,{forceAgentConversation:r.forceAgentConversation}),this._disposers.push(this._currConversationModel.onSendExchange(()=>{this.saveImmediate()})),this._disposers.push(this._currConversationModel.onTurnCompleted(()=>{this.saveImmediate()})),this._disposers.push(this._currConversationModel.dispose),this._sendModeModel=new pd,this._persistenceController=function(a,l,c,d){const h=vd.create(a,l,c);return new wd(h,d)}(this.extensionClient,{enableExchangeStorage:r.enableExchangeStorage,enableEnhancedDehydrationMode:r.enableEnhancedDehydrationMode,enableToolUseStateStorage:r.enableToolUseStateStorage},this._host,r.debounceConfig),this.initializeSync(r.initialConversation);const i=this._state.isPanelCollapsed??this._state.isAgentEditsCollapsed??this._state.isTaskListCollapsed??!0;this.isPanelCollapsed=Yt(i),this.agentExecutionMode=Yt(this._state.agentExecutionMode??"manual"),this.sortConversationsBy=Yt(this._state.sortConversationsBy??"lastMessageTimestamp"),this.bulkDeletePromptDismissed=Yt(this._state.bulkDeletePromptDismissed),this.bulkDeletePromptDismissed.subscribe(a=>{this._state.bulkDeletePromptDismissed!==a&&(this._state.bulkDeletePromptDismissed=a,this.save())}),this.agentExecutionMode.subscribe(a=>{this._state.agentExecutionMode!==a&&(this._state.agentExecutionMode=a,this.save())}),this._sendModeModel.initializeFromState(this._state.sendMode),this.onLoaded()}static key="chatModel";_state={conversations:{},agentExecutionMode:"manual",isPanelCollapsed:!0,displayedAnnouncements:[]};extensionClient;_currConversationModel;_chatModeModel;_sendModeModel;_eventTracker;_persistenceController;_disposers=[];options;subscribers=new Set;isPanelCollapsed;agentExecutionMode;sortConversationsBy;bulkDeletePromptDismissed;initializeState=Promise.withResolvers();isInitialized=this.initializeState.promise;get reduxStore(){return this._reduxStore}dispatchReduxAction(t){return this._reduxStore.dispatch(t)}selectFromReduxStore(t){return t(this._reduxStore.getState())}withStore(t){return t.withStore(this._reduxStore)}setChatModeModel(t){this._chatModeModel=t;const e={extensionClient:this.extensionClient,chatModeType:t.chatModeType,currentSendMode:this._sendModeModel.mode,agentExecutionMode:this.agentExecutionMode};this._eventTracker=new pl(e),this._currConversationModel.setEventTracker(this._eventTracker)}get eventTracker(){return this._eventTracker}onLoaded=async()=>{this.options.enableAgentAutoMode||this.agentExecutionMode.set("manual"),await this.initializeAsync(this.options.initialConversation),this.options.onLoaded?.(),this.initializeState.resolve(),this.notifySubscribers()};subscribe=t=>(this.subscribers.add(t),t(this),()=>{this.subscribers.delete(t)});initializeSync=t=>{const e=this._persistenceController.getState();this._state={...this._state,...e},this.dispatchReduxAction(rl(e?.currentConversationId)),this.dispatchReduxAction(ol(this._state.displayedAnnouncements));const n=e?.currentConversationId?this._state.conversations[e?.currentConversationId]:void 0;if(n&&this.dispatchReduxAction(Wn(n)),t&&(this._state.conversations={...this._state.conversations,[t.id]:t},this.dispatchReduxAction(il(t))),this.options.fullFeatured&&(t?.id!==rn&&this.currentConversationId!==rn||(delete this._state.conversations[rn],this.dispatchReduxAction(al(rn)),this.setCurrentConversationToWelcome())),this.currentConversationId&&this.currentConversationId!==this.currentConversationModel.id){const s=this.conversations[this.currentConversationId];s&&this.currentConversationModel.setConversation(s)}this.initializeIsShareableState()};async initializeAsync(t){const e=t?.id||this.currentConversationId;if(e){const{conversations:n}=await this._persistenceController.loadConversation({conversations:this._state.conversations},{conversationId:e});this._state.conversations=n}if(this._subscribeToChatNotifications(),t)await this.setCurrentConversation(t.id);else if(this.currentConversationId){const n=this.conversations[this.currentConversationId];n&&J.isValid(n)?await this.setCurrentConversation(this.currentConversationId):(n&&delete this._state.conversations[this.currentConversationId],await this.setCurrentConversation(void 0))}else await this.setCurrentConversation(void 0)}_subscribeToChatNotifications=()=>{const t=$t.getInstance(),{stream:e,cancel:n}=t.getStream("conversation_id_changed");this._disposers.push(()=>{n()}),(async()=>{for await(const s of e){const r=s.data.conversationId;this._state.conversations[r]!==void 0||(this._state.conversations[r]={...J.create({id:r},{forceAgentConversation:this.options?.forceAgentConversation})}),await this.setCurrentConversation(r)}})()};initializeIsShareableState=()=>{const t={...this._state.conversations};for(const[e,n]of Object.entries(t)){if(n.isShareable)continue;const s=n.chatHistory.some(r=>Me(r));t[e]={...n,isShareable:s}}this._state.conversations=t};pullFromRedux=()=>{this._state.displayedAnnouncements=this.selectFromReduxStore(bd.select)};save=()=>{this.pullFromRedux(),this._persistenceController.setState(this._state,{currentConversationId:this.currentConversationId})};notifyAndSave=()=>{this.notifySubscribers(),this.save()};saveImmediate=()=>{this.pullFromRedux(),this._persistenceController.setState(this._state,{currentConversationId:this.currentConversationId,immediate:!0})};notifySubscribers=()=>{this.subscribers.forEach(t=>t(this))};withWebviewClientEvent=(t,e)=>(...n)=>(this.extensionClient.reportWebviewClientEvent(t),e(...n));setCurrentConversationToWelcome=()=>{this.setCurrentConversation(),this._currConversationModel.setName("Welcome to Augment"),this._currConversationModel.addChatItem({chatItemType:Zt.educateFeatures,request_id:crypto.randomUUID(),seen_state:Tt.seen})};popCurrentConversation=async()=>{const t=this.currentConversationId;t&&await this.deleteConversation(t,this.nextConversation?.id??this.previousConversation?.id)};setCurrentConversation=async(t,e=!0,n)=>{if(t===this.currentConversationId&&n?.noopIfSameConversation)return;const s=this.currentConversationId;s&&xd(this.getConversationExchangeCount(s));let r;t===void 0&&(t=Se);const i=this._state.conversations[t];i?r=(await this._persistenceController.loadConversation({conversations:{[t]:i}},{conversationId:t})).conversations[t]:r=J.create({personaType:await this._currConversationModel.decidePersonaType(),rootTaskUuid:n?.newTaskUuid},{forceAgentConversation:this.options?.forceAgentConversation}),t===Se&&(r.id=Se),n?.newTaskUuid&&(r.rootTaskUuid=n.newTaskUuid);const a=this.conversations[this._currConversationModel.id]===void 0;this._currConversationModel.setConversation(r,!a,e),this.dispatchReduxAction(Wn(r)),this._state.conversations[r.id]=r,this.notifyAndSave(),Zo(this.totalConversationsCount),this._currConversationModel.recoverAllExchanges(),this._currConversationModel.resetTotalCharactersCache()};get currentConversationId(){return ll.select(this._reduxStore.getState())}get currentConversationModel(){return this._currConversationModel}get conversations(){return this._state.conversations}get sendModeModel(){return this._sendModeModel}get chatModeModel(){return this._chatModeModel}orderedConversations(t,e="desc",n){const s=t||this._state.sortConversationsBy||"lastMessageTimestamp";let r=Object.values(this._state.conversations);return n&&(r=r.filter(n)),r.sort((i,a)=>{const l=J.getTime(i,s).getTime(),c=J.getTime(a,s).getTime();return e==="asc"?l-c:c-l})}get nextConversation(){if(!this.currentConversationId)return;const t=this.orderedConversations(),e=t.findIndex(n=>n.id===this.currentConversationId);return t.length>e+1?t[e+1]:void 0}get previousConversation(){if(!this.currentConversationId)return;const t=this.orderedConversations(),e=t.findIndex(n=>n.id===this.currentConversationId);return e>0?t[e-1]:void 0}get host(){return this._host}saveConversation=async(t,e)=>{this._persistenceController.dirty.conversations.markDirty(t.id),this._state.conversations[t.id]=t,e&&delete this._state.conversations[Se],this.notifyAndSave(),this.dispatchReduxAction(Wn(t)),this.notifyAndSave()};markExchangeDirty=t=>{this._persistenceController.dirty.exchanges.markDirty(t)};markToolUseDirty=t=>{this._persistenceController.dirty.toolUses.markDirty(t)};isConversationShareable=t=>this._state.conversations[t]?.isShareable??!0;setSortConversationsBy=t=>{this.sortConversationsBy.set(t),this.notifyAndSave()};getConversationUrl=async t=>{const e=this._state.conversations[t];if(e.lastUrl)return e.lastUrl;un.set("copying");const n=e?.chatHistory,s=n.reduce((a,l)=>(Me(l)&&a.push({request_id:l.request_id||"",request_message:l.request_message,response_text:l.response_text||""}),a),[]);if(s.length===0)throw new Error("No chat history to share");const r=J.getDisplayName(e),i=await this.extensionClient.saveChat(t,s,r);if(i.data){let a=i.data.url;return this._state={...this._state,conversations:{...this._state.conversations,[t]:{...e,lastUrl:a}}},this.notifyAndSave(),a}throw new Error("Failed to create URL")};shareConversation=async t=>{if(t!==void 0)try{const e=await this.getConversationUrl(t);if(!e)return void un.set("idle");navigator.clipboard.writeText(e),un.set("copied")}catch{un.set("failed")}};deleteConversations=async(t,e=void 0,n=[],s)=>{const r=t.length+n.length;if(await this.extensionClient.openConfirmationModal({title:"Delete Conversation",message:`Are you sure you want to delete ${r>1?"these conversations":"this conversation"}?`,confirmButtonText:"Delete",cancelButtonText:"Cancel"})){if(t.length>0){const i=new Set(t);await this.deleteConversationIds(i)}if(n.length>0&&s)for(const i of n)try{await s.deleteAgent(i,!0)}catch(a){console.error(`Failed to delete remote agent ${i}:`,a)}this.currentConversationId&&t.includes(this.currentConversationId)&&this.setCurrentConversation(e)}};deleteConversation=async(t,e=void 0)=>{await this.deleteConversations([t],e)};deleteConversationIds=async t=>{const e=[],n=[];for(const s of t){const r=this._state.conversations[s]?.requestIds??[];e.push(...r);const i=this._state.conversations[s]?.toolUseStates??{};for(const l of Object.keys(i)){const{toolUseId:c}=i[l];c&&n.push(c)}const a=this._state.conversations[s];if(a){for(const l of a.chatHistory)if(U(l)&&l.structured_output_nodes)for(const c of l.structured_output_nodes)c.type===j.TOOL_USE&&c.tool_use?.tool_use_id&&n.push(c.tool_use.tool_use_id)}}for(const s of Object.values(this._state.conversations))if(t.has(s.id)){for(const i of s.chatHistory)U(i)&&this.deleteImagesInExchange(i);const r=s.draftExchange;r&&this.deleteImagesInExchange(r)}for(const s of t){try{await this.extensionClient.deleteConversationExchanges(s)}catch(r){console.error(`Failed to delete exchanges for conversation ${s}:`,r)}if(this.options.enableToolUseStateStorage)try{await this.extensionClient.deleteConversationToolUseStates(s)}catch(r){console.error(`Failed to delete tool use states for conversation ${s}:`,r)}}this._persistenceController.dirty.conversations.cleanup(t),this._state={...this._state,conversations:Object.fromEntries(Object.entries(this._state.conversations).filter(([s])=>!t.has(s)))},this.notifyAndSave(),Zo(this.totalConversationsCount),this.extensionClient.clearMetadataFor({requestIds:e,conversationIds:Array.from(t),toolUseIds:n})};deleteImagesInExchange=t=>{const e=new Set([...t.rich_text_json_repr?this.findImagesInJson(t.rich_text_json_repr):[],...t.structured_request_nodes?this.findImagesInStructuredRequest(t.structured_request_nodes):[]]);for(const n of e)this.deleteImage(n)};findImagesInJson=t=>{const e=[],n=s=>{if(s.type==="file"&&s.attrs?.src){const r=s.attrs?.src;ei(r)&&e.push(s.attrs.src)}else if((s.type==="doc"||s.type==="paragraph")&&s.content)for(const r of s.content)n(r)};return n(t),e};findImagesInStructuredRequest=t=>t.reduce((e,n)=>(n.type===X.IMAGE_ID&&n.image_id_node&&e.push(n.image_id_node.image_id),e),[]);toggleConversationPinned=t=>{const e=this._state.conversations[t],n={...e,isPinned:!e.isPinned};this._state={...this._state,conversations:{...this._state.conversations,[t]:n}},this.notifyAndSave(),t===this.currentConversationId&&this._currConversationModel.toggleIsPinned()};renameConversation=(t,e)=>{const n={...this._state.conversations[t],name:e};this._state={...this._state,conversations:{...this._state.conversations,[t]:n}},this.notifyAndSave(),t===this.currentConversationId&&this._currConversationModel.setName(e)};static NEW_AGENT_KEY=Se;smartPaste=(t,e,n,s)=>{const r=this._currConversationModel.historyTo(t,!0).filter(i=>Me(i)).map(i=>({request_message:i.request_message,response_text:i.response_text||"",request_id:i.request_id||""}));this.extensionClient.smartPaste({generatedCode:e,chatHistory:r,targetFile:n??void 0,options:s})};saveImage=async t=>await this.extensionClient.saveImage(t);saveAttachment=async t=>await this.extensionClient.saveAttachment(t);deleteImage=async t=>await this.extensionClient.deleteImage(t);renderImage=async t=>await this.extensionClient.loadImage(t);get lastMessageTimestamp(){return this.currentConversationModel.lastExchange?.timestamp}get totalConversationsCount(){return Object.keys(this._state.conversations).length}getConversationExchangeCount(t){const e=this._state.conversations[t];return e?e.chatHistory.filter(U).length:0}handleMessageFromExtension(t){const e=t.data;if(e.type===Oa.newThread){if("data"in e&&e.data){const n=e.data.mode;(async()=>(await this.setCurrentConversation(),n&&this._chatModeModel?n.toLowerCase()==="agent"?await this._chatModeModel.handleSetToThreadType("localAgent","manual"):n.toLowerCase()==="chat"?await this._chatModeModel.handleSetToThreadType("chat"):console.warn("Unknown chat mode:",n):n&&console.warn("ChatModeModel not available, cannot set mode:",n)))()}else this.setCurrentConversation();return!0}return!1}dispose=()=>{this._disposers.forEach(t=>t()),this._disposers=[]}}function Wd(){return Ia(_d.key).currentConversationModel}export{ya as A,Zc as B,_d as C,Y as D,It as E,fl as F,Yc as G,Qc as H,Fd as I,Hd as J,bn as M,Nn as N,Ut as P,mn as S,A as T,tn as a,Pd as b,yt as c,Se as d,qd as e,Vd as f,cd as g,J as h,kt as i,zd as j,wc as k,td as l,Mc as m,$d as n,Bd as o,Ld as p,Qo as q,hd as r,ud as s,Ud as t,jd as u,bd as v,Wd as w,bs as x,$t as y,xd as z};
//# sourceMappingURL=chat-model-DaVfYv7o.js.map
